<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="graphics," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="0x1 ArchitectureFrom the doc of swiftshader in the following link, we can see the architecture introduction of it.https://github.com/google/swiftshader/blob/master/docs/Index.md The API layer is an im">
<meta name="keywords" content="graphics">
<meta property="og:type" content="article">
<meta property="og:title" content="Analysis of SwiftShader">
<meta property="og:url" content="http://yoursite.com/2018/02/25/Analysis-of-SwiftShader/index.html">
<meta property="og:site_name" content="Kevin Wen&#39;s Blog">
<meta property="og:description" content="0x1 ArchitectureFrom the doc of swiftshader in the following link, we can see the architecture introduction of it.https://github.com/google/swiftshader/blob/master/docs/Index.md The API layer is an im">
<meta property="og:image" content="http://yoursite.com/2018/02/25/Analysis-of-SwiftShader/architecture.png">
<meta property="og:image" content="http://yoursite.com/2018/02/25/Analysis-of-SwiftShader/graphic_pipeline.png">
<meta property="og:image" content="http://yoursite.com/2018/02/25/Analysis-of-SwiftShader/generate_ir.png">
<meta property="og:image" content="http://yoursite.com/2018/02/25/Analysis-of-SwiftShader/vertex_processor.png">
<meta property="og:image" content="http://yoursite.com/2018/02/25/Analysis-of-SwiftShader/multithread.png">
<meta property="og:image" content="http://yoursite.com/2018/02/25/Analysis-of-SwiftShader/task_producer.png">
<meta property="og:image" content="http://yoursite.com/2018/02/25/Analysis-of-SwiftShader/task_consumer.png">
<meta property="og:image" content="http://yoursite.com/2018/02/25/Analysis-of-SwiftShader/task_consumer_pixel.png">
<meta property="og:updated_time" content="2018-03-13T14:51:56.686Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Analysis of SwiftShader">
<meta name="twitter:description" content="0x1 ArchitectureFrom the doc of swiftshader in the following link, we can see the architecture introduction of it.https://github.com/google/swiftshader/blob/master/docs/Index.md The API layer is an im">
<meta name="twitter:image" content="http://yoursite.com/2018/02/25/Analysis-of-SwiftShader/architecture.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/02/25/Analysis-of-SwiftShader/"/>





  <title>Analysis of SwiftShader | Kevin Wen's Blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kevin Wen's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/25/Analysis-of-SwiftShader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Analysis of SwiftShader</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-25T20:50:24+09:00">
                2018-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/02/25/Analysis-of-SwiftShader/" class="leancloud_visitors" data-flag-title="Analysis of SwiftShader">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="0x1-Architecture"><a href="#0x1-Architecture" class="headerlink" title="0x1 Architecture"></a>0x1 Architecture</h1><p>From the doc of swiftshader in the following link, we can see the architecture introduction of it.<br><a href="https://github.com/google/swiftshader/blob/master/docs/Index.md" target="_blank" rel="external">https://github.com/google/swiftshader/blob/master/docs/Index.md</a><br><img src="/2018/02/25/Analysis-of-SwiftShader/architecture.png" alt="swiftshader1"></p>
<p>The API layer is an implementation of a graphics API, such as OpenGL (ES) or Direct3D, on top of the Renderer interface. It is responsible for managing API-level resources and rendering state, as well as compiling high-level shaders to bytecode form.</p>
<p>The Renderer layer generates specialized processing routines for draw calls and coordinates the execution of rendering tasks. It defines the data structures used and how the processing is performed.</p>
<p>Reactor is an embedded language for C++ to dynamically generate code in a WYSIWYG fashion. It allows to specialize the processing routines for the state and shaders used by each draw call. Its syntax closely resembles C and shading languages, to make the code generation easily readable.</p>
<p>The JIT layer is a run-time compiler, such as LLVM’s JIT, or Subzero. Reactor records its operations in an in-memory intermediate form which can be materialized by the JIT into a function which can be called directly.</p>
<p>To achieve exceptional performance, SwiftShader is built around two major optimizations that affect its architecture: dynamic code generation, and parallel processing. Generating code at run-time allows to eliminate code branches and optimizes register usage, specializing the processing routines for exactly the operations required by each draw call. Parallel processing means both utilizing the CPU’s multiple cores and processing multiple elements accoss the width of the SIMD vector units.</p>
<h1 id="0x2-Graphics-Pipeline"><a href="#0x2-Graphics-Pipeline" class="headerlink" title="0x2 Graphics Pipeline"></a>0x2 Graphics Pipeline</h1><p>Here is the graphics pipeline diagram from the following OpenGL ES spec. SwiftShader supports the pipeline by JIT through LLVM then executes it on CPU.<br><a href="https://www.khronos.org/registry/OpenGL/specs/es/2.0/es_full_spec_2.0.pdf" target="_blank" rel="external">https://www.khronos.org/registry/OpenGL/specs/es/2.0/es_full_spec_2.0.pdf</a></p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/graphic_pipeline.png" alt="swiftshader2"></p>
<h1 id="0x3-JIT-through-LLVM"><a href="#0x3-JIT-through-LLVM" class="headerlink" title="0x3 JIT through LLVM"></a>0x3 JIT through LLVM</h1><h2 id="0x31-GLSL-compiler-frontend"><a href="#0x31-GLSL-compiler-frontend" class="headerlink" title="0x31 GLSL compiler frontend"></a>0x31 GLSL compiler frontend</h2><p>SwiftShader uses glslang as its glsl compiler frontend, it consumes glsl source code, and produces AST, then outputs its IR with recursive traverse method, here is the IR definition.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> Opcode</div><div class="line">&#123;</div><div class="line">	<span class="comment">// Matches order in d3d9types.h</span></div><div class="line">	OPCODE_NOP = <span class="number">0</span>,</div><div class="line">	OPCODE_MOV,</div><div class="line">	OPCODE_ADD,</div><div class="line">	OPCODE_SUB,</div><div class="line">	OPCODE_MAD,</div><div class="line">	OPCODE_MUL,</div><div class="line">	OPCODE_RCPX,</div><div class="line">	OPCODE_RSQX,</div><div class="line">	OPCODE_DP3,</div><div class="line">	OPCODE_DP4,</div><div class="line">	OPCODE_MIN,</div><div class="line">	OPCODE_MAX,</div><div class="line">	OPCODE_SLT,</div><div class="line">	OPCODE_SGE,</div><div class="line">	OPCODE_EXP2X,   <span class="comment">// D3DSIO_EXP</span></div><div class="line">	OPCODE_LOG2X,   <span class="comment">// D3DSIO_LOG</span></div><div class="line">	OPCODE_LIT,</div><div class="line">	OPCODE_ATT,   <span class="comment">// D3DSIO_DST</span></div><div class="line">	OPCODE_LRP,</div><div class="line">	OPCODE_FRC,</div><div class="line">	OPCODE_M4X4,</div><div class="line">	OPCODE_M4X3,</div><div class="line">	OPCODE_M3X4,</div><div class="line">	OPCODE_M3X3,</div><div class="line">	OPCODE_M3X2,</div><div class="line">	OPCODE_CALL,</div><div class="line">	OPCODE_CALLNZ,</div><div class="line">	OPCODE_LOOP,</div><div class="line">	OPCODE_RET,</div><div class="line">	OPCODE_ENDLOOP,</div><div class="line">	OPCODE_LABEL,</div><div class="line">	OPCODE_DCL,</div><div class="line">	OPCODE_POWX,</div><div class="line">	OPCODE_CRS,</div><div class="line">	OPCODE_SGN,</div><div class="line">	OPCODE_ABS,</div><div class="line">	OPCODE_NRM3,   <span class="comment">// D3DSIO_NRM</span></div><div class="line">	OPCODE_SINCOS,</div><div class="line">	OPCODE_REP,</div><div class="line">	OPCODE_ENDREP,</div><div class="line">	OPCODE_IF,</div><div class="line">	OPCODE_IFC,</div><div class="line">	OPCODE_ELSE,</div><div class="line">	OPCODE_ENDIF,</div><div class="line">	OPCODE_BREAK,</div><div class="line">	OPCODE_BREAKC,</div><div class="line">	OPCODE_MOVA,</div><div class="line">	OPCODE_DEFB,</div><div class="line">	OPCODE_DEFI,</div><div class="line"></div><div class="line">	OPCODE_TEXCOORD = <span class="number">64</span>,</div><div class="line">	OPCODE_TEXKILL,</div><div class="line">	OPCODE_TEX,</div><div class="line">	OPCODE_TEXBEM,</div><div class="line">	OPCODE_TEXBEML,</div><div class="line">	OPCODE_TEXREG2AR,</div><div class="line">	OPCODE_TEXREG2GB,</div><div class="line">	OPCODE_TEXM3X2PAD,</div><div class="line">	OPCODE_TEXM3X2TEX,</div><div class="line">	OPCODE_TEXM3X3PAD,</div><div class="line">	OPCODE_TEXM3X3TEX,</div><div class="line">	OPCODE_RESERVED0,</div><div class="line">	OPCODE_TEXM3X3SPEC,</div><div class="line">	OPCODE_TEXM3X3VSPEC,</div><div class="line">	OPCODE_EXPP,</div><div class="line">	OPCODE_LOGP,</div><div class="line">	OPCODE_CND,</div><div class="line">	OPCODE_DEF,</div><div class="line">	OPCODE_TEXREG2RGB,</div><div class="line">	OPCODE_TEXDP3TEX,</div><div class="line">	OPCODE_TEXM3X2DEPTH,</div><div class="line">	OPCODE_TEXDP3,</div><div class="line">	OPCODE_TEXM3X3,</div><div class="line">	OPCODE_TEXDEPTH,</div><div class="line">	OPCODE_CMP0,   <span class="comment">// D3DSIO_CMP</span></div><div class="line">	OPCODE_BEM,</div><div class="line">	OPCODE_DP2ADD,</div><div class="line">	OPCODE_DFDX,   <span class="comment">// D3DSIO_DSX</span></div><div class="line">	OPCODE_DFDY,   <span class="comment">// D3DSIO_DSY</span></div><div class="line">	OPCODE_TEXLDD,</div><div class="line">	OPCODE_CMP,   <span class="comment">// D3DSIO_SETP</span></div><div class="line">	OPCODE_TEXLDL,</div><div class="line">	OPCODE_BREAKP,</div><div class="line"></div><div class="line">	OPCODE_PHASE = <span class="number">0xFFFD</span>,</div><div class="line">	OPCODE_COMMENT = <span class="number">0xFFFE</span>,</div><div class="line">	OPCODE_END = <span class="number">0xFFFF</span>,</div><div class="line"></div><div class="line">	OPCODE_PS_1_0 = <span class="number">0xFFFF0100</span>,</div><div class="line">	OPCODE_PS_1_1 = <span class="number">0xFFFF0101</span>,</div><div class="line">	OPCODE_PS_1_2 = <span class="number">0xFFFF0102</span>,</div><div class="line">	OPCODE_PS_1_3 = <span class="number">0xFFFF0103</span>,</div><div class="line">	OPCODE_PS_1_4 = <span class="number">0xFFFF0104</span>,</div><div class="line">	OPCODE_PS_2_0 = <span class="number">0xFFFF0200</span>,</div><div class="line">	OPCODE_PS_2_x = <span class="number">0xFFFF0201</span>,</div><div class="line">	OPCODE_PS_3_0 = <span class="number">0xFFFF0300</span>,</div><div class="line"></div><div class="line">	OPCODE_VS_1_0 = <span class="number">0xFFFE0100</span>,</div><div class="line">	OPCODE_VS_1_1 = <span class="number">0xFFFE0101</span>,</div><div class="line">	OPCODE_VS_2_0 = <span class="number">0xFFFE0200</span>,</div><div class="line">	OPCODE_VS_2_x = <span class="number">0xFFFE0201</span>,</div><div class="line">	OPCODE_VS_2_sw = <span class="number">0xFFFE02FF</span>,</div><div class="line">	OPCODE_VS_3_0 = <span class="number">0xFFFE0300</span>,</div><div class="line">	OPCODE_VS_3_sw = <span class="number">0xFFFE03FF</span>,</div><div class="line"></div><div class="line">	OPCODE_NULL = <span class="number">0x10000000</span>,   <span class="comment">// Dead instruction, to be eliminated</span></div><div class="line">	OPCODE_WHILE,</div><div class="line">	OPCODE_ENDWHILE,</div><div class="line">	OPCODE_COS,</div><div class="line">	OPCODE_SIN,</div><div class="line">	OPCODE_TAN,</div><div class="line">	OPCODE_ACOS,</div><div class="line">	OPCODE_ASIN,</div><div class="line">	OPCODE_ATAN,</div><div class="line">	OPCODE_ATAN2,</div><div class="line">	OPCODE_COSH,</div><div class="line">	OPCODE_SINH,</div><div class="line">	OPCODE_TANH,</div><div class="line">	OPCODE_ACOSH,</div><div class="line">	OPCODE_ASINH,</div><div class="line">	OPCODE_ATANH,</div><div class="line">	OPCODE_DP1,</div><div class="line">	OPCODE_DP2,</div><div class="line">	OPCODE_TRUNC,</div><div class="line">	OPCODE_FLOOR,</div><div class="line">	OPCODE_ROUND,</div><div class="line">	OPCODE_ROUNDEVEN,</div><div class="line">	OPCODE_CEIL,</div><div class="line">	OPCODE_SQRT,</div><div class="line">	OPCODE_RSQ,</div><div class="line">	OPCODE_LEN2,</div><div class="line">	OPCODE_LEN3,</div><div class="line">	OPCODE_LEN4,</div><div class="line">	OPCODE_DIST1,</div><div class="line">	OPCODE_DIST2,</div><div class="line">	OPCODE_DIST3,</div><div class="line">	OPCODE_DIST4,</div><div class="line">	OPCODE_NRM2,</div><div class="line">	OPCODE_NRM4,</div><div class="line">	OPCODE_DIV,</div><div class="line">	OPCODE_MOD,</div><div class="line">	OPCODE_EXP2,</div><div class="line">	OPCODE_LOG2,</div><div class="line">	OPCODE_EXP,</div><div class="line">	OPCODE_LOG,</div><div class="line">	OPCODE_POW,</div><div class="line">	OPCODE_F2B,   <span class="comment">// Float to bool</span></div><div class="line">	OPCODE_B2F,   <span class="comment">// Bool to float</span></div><div class="line">	OPCODE_F2I,   <span class="comment">// Float to int</span></div><div class="line">	OPCODE_I2F,   <span class="comment">// Int to float</span></div><div class="line">	OPCODE_F2U,   <span class="comment">// Float to uint</span></div><div class="line">	OPCODE_U2F,   <span class="comment">// Uint to float</span></div><div class="line">	OPCODE_I2B,   <span class="comment">// Int to bool</span></div><div class="line">	OPCODE_B2I,   <span class="comment">// Bool to int</span></div><div class="line">	OPCODE_DET2,</div><div class="line">	OPCODE_DET3,</div><div class="line">	OPCODE_DET4,</div><div class="line">	OPCODE_ALL,</div><div class="line">	OPCODE_ANY,</div><div class="line">	OPCODE_NEG,</div><div class="line">	OPCODE_NOT,</div><div class="line">	OPCODE_OR,</div><div class="line">	OPCODE_XOR,</div><div class="line">	OPCODE_AND,</div><div class="line">	OPCODE_EQ,</div><div class="line">	OPCODE_NE,</div><div class="line">	OPCODE_STEP,</div><div class="line">	OPCODE_SMOOTH,</div><div class="line">	OPCODE_ISNAN,</div><div class="line">	OPCODE_ISINF,</div><div class="line">	OPCODE_TEXOFFSET,</div><div class="line">	OPCODE_TEXLODOFFSET,</div><div class="line">	OPCODE_TEXELFETCH,</div><div class="line">	OPCODE_TEXELFETCHOFFSET,</div><div class="line">	OPCODE_TEXGRAD,</div><div class="line">	OPCODE_TEXGRADOFFSET,</div><div class="line">	OPCODE_TEXBIAS,</div><div class="line">	OPCODE_TEXLOD,</div><div class="line">	OPCODE_TEXOFFSETBIAS,</div><div class="line">	OPCODE_TEXRECT,</div><div class="line">	OPCODE_TEXSIZE,</div><div class="line">	OPCODE_FLOATBITSTOINT,</div><div class="line">	OPCODE_FLOATBITSTOUINT,</div><div class="line">	OPCODE_INTBITSTOFLOAT,</div><div class="line">	OPCODE_UINTBITSTOFLOAT,</div><div class="line">	OPCODE_PACKSNORM2x16,</div><div class="line">	OPCODE_PACKUNORM2x16,</div><div class="line">	OPCODE_PACKHALF2x16,</div><div class="line">	OPCODE_UNPACKSNORM2x16,</div><div class="line">	OPCODE_UNPACKUNORM2x16,</div><div class="line">	OPCODE_UNPACKHALF2x16,</div><div class="line">	OPCODE_FORWARD1,</div><div class="line">	OPCODE_FORWARD2,</div><div class="line">	OPCODE_FORWARD3,</div><div class="line">	OPCODE_FORWARD4,</div><div class="line">	OPCODE_REFLECT1,</div><div class="line">	OPCODE_REFLECT2,</div><div class="line">	OPCODE_REFLECT3,</div><div class="line">	OPCODE_REFLECT4,</div><div class="line">	OPCODE_REFRACT1,</div><div class="line">	OPCODE_REFRACT2,</div><div class="line">	OPCODE_REFRACT3,</div><div class="line">	OPCODE_REFRACT4,</div><div class="line">	OPCODE_ICMP,</div><div class="line">	OPCODE_UCMP,</div><div class="line">	OPCODE_SELECT,</div><div class="line">	OPCODE_EXTRACT,</div><div class="line">	OPCODE_INSERT,</div><div class="line">	OPCODE_DISCARD,</div><div class="line">	OPCODE_FWIDTH,</div><div class="line">	OPCODE_LEAVE,   <span class="comment">// Return before the end of the function</span></div><div class="line">	OPCODE_CONTINUE,</div><div class="line">	OPCODE_TEST,   <span class="comment">// Marks the end of the code that can be skipped by 'continue'</span></div><div class="line">	OPCODE_SWITCH,</div><div class="line">	OPCODE_ENDSWITCH,</div><div class="line"></div><div class="line">	<span class="comment">// Integer opcodes</span></div><div class="line">	OPCODE_INEG,</div><div class="line">	OPCODE_IABS,</div><div class="line">	OPCODE_ISGN,</div><div class="line">	OPCODE_IADD,</div><div class="line">	OPCODE_ISUB,</div><div class="line">	OPCODE_IMUL,</div><div class="line">	OPCODE_IDIV,</div><div class="line">	OPCODE_IMAD,</div><div class="line">	OPCODE_IMOD,</div><div class="line">	OPCODE_SHL,</div><div class="line">	OPCODE_ISHR,</div><div class="line">	OPCODE_IMIN,</div><div class="line">	OPCODE_IMAX,</div><div class="line"></div><div class="line">	<span class="comment">// Unsigned integer opcodes</span></div><div class="line">	OPCODE_UDIV,</div><div class="line">	OPCODE_UMOD,</div><div class="line">	OPCODE_USHR,</div><div class="line">	OPCODE_UMIN,</div><div class="line">	OPCODE_UMAX,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>Here is the callstack about how IR is generated, it is done by traversing the AST.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/generate_ir.png" alt="swiftshader3"></p>
<p>Once IR is ready, swiftshader will consume those IR and generate LLVM IR, some fixed pipeline and graphic state will also be programmed into LLVM IR at the same time.</p>
<p>We will discuss the three processors, vertex processor, setup processor and pixel processor, all the three processor will generate LLVM IR accoring to graphic state.</p>
<h2 id="0x31-Vertex-processor"><a href="#0x31-Vertex-processor" class="headerlink" title="0x31 Vertex processor"></a>0x31 Vertex processor</h2><p>Here is diagram about how vertex processor produces LLVM IR.<br><img src="/2018/02/25/Analysis-of-SwiftShader/vertex_processor.png" alt="swiftshader4"></p>
<h3 id="Prepare-the-draw-state"><a href="#Prepare-the-draw-state" class="headerlink" title="Prepare the draw state"></a>Prepare the draw state</h3><p>It prepare thes draw state by updating the structe State according to the graphic state.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> VertexProcessor::State VertexProcessor::update(DrawType drawType)</div><div class="line">&#123;</div><div class="line">		<span class="keyword">if</span>(isFixedFunction())</div><div class="line">		&#123;</div><div class="line">			updateTransform();</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(updateLighting)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</div><div class="line">				&#123;</div><div class="line">					<span class="keyword">if</span>(context-&gt;vertexLightActive(i))</div><div class="line">					&#123;</div><div class="line">						<span class="comment">// Light position in camera coordinates</span></div><div class="line">						setLightViewPosition(i, B * V * context-&gt;getLightPosition(i));</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				updateLighting = <span class="literal">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		State state;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(context-&gt;vertexShader)</div><div class="line">		&#123;</div><div class="line">			state.shaderID = context-&gt;vertexShader-&gt;getSerialID();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			state.shaderID = <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		state.fixedFunction = !context-&gt;vertexShader &amp;&amp; context-&gt;pixelShaderModel() &lt; <span class="number">0x0300</span>;</div><div class="line">		state.textureSampling = context-&gt;vertexShader ? context-&gt;vertexShader-&gt;containsTextureSampling() : <span class="literal">false</span>;</div><div class="line">		state.positionRegister = context-&gt;vertexShader ? context-&gt;vertexShader-&gt;getPositionRegister() : Pos;</div><div class="line">		state.pointSizeRegister = context-&gt;vertexShader ? context-&gt;vertexShader-&gt;getPointSizeRegister() : Pts;</div><div class="line"></div><div class="line">		state.vertexBlendMatrixCount = context-&gt;vertexBlendMatrixCountActive();</div><div class="line">		state.indexedVertexBlendEnable = context-&gt;indexedVertexBlendActive();</div><div class="line">		state.vertexNormalActive = context-&gt;vertexNormalActive();</div><div class="line">		state.normalizeNormals = context-&gt;normalizeNormalsActive();</div><div class="line">		state.vertexLightingActive = context-&gt;vertexLightingActive();</div><div class="line">		state.diffuseActive = context-&gt;diffuseActive();</div><div class="line">		state.specularActive = context-&gt;specularActive();</div><div class="line">		state.vertexSpecularActive = context-&gt;vertexSpecularActive();</div><div class="line"></div><div class="line">		state.vertexLightActive = context-&gt;vertexLightActive(<span class="number">0</span>) &lt;&lt; <span class="number">0</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">1</span>) &lt;&lt; <span class="number">1</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">2</span>) &lt;&lt; <span class="number">2</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">3</span>) &lt;&lt; <span class="number">3</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">4</span>) &lt;&lt; <span class="number">4</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">5</span>) &lt;&lt; <span class="number">5</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">6</span>) &lt;&lt; <span class="number">6</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">7</span>) &lt;&lt; <span class="number">7</span>;</div><div class="line"></div><div class="line">		state.vertexDiffuseMaterialSourceActive = context-&gt;vertexDiffuseMaterialSourceActive();</div><div class="line">		state.vertexSpecularMaterialSourceActive = context-&gt;vertexSpecularMaterialSourceActive();</div><div class="line">		state.vertexAmbientMaterialSourceActive = context-&gt;vertexAmbientMaterialSourceActive();</div><div class="line">		state.vertexEmissiveMaterialSourceActive = context-&gt;vertexEmissiveMaterialSourceActive();</div><div class="line">		state.fogActive = context-&gt;fogActive();</div><div class="line">		state.vertexFogMode = context-&gt;vertexFogModeActive();</div><div class="line">		state.rangeFogActive = context-&gt;rangeFogActive();</div><div class="line">		state.localViewerActive = context-&gt;localViewerActive();</div><div class="line">		state.pointSizeActive = context-&gt;pointSizeActive();</div><div class="line">		state.pointScaleActive = context-&gt;pointScaleActive();</div><div class="line"></div><div class="line">		state.preTransformed = context-&gt;preTransformed;</div><div class="line">		state.superSampling = context-&gt;getSuperSampleCount() &gt; <span class="number">1</span>;</div><div class="line">		state.multiSampling = context-&gt;getMultiSampleCount() &gt; <span class="number">1</span>;</div><div class="line"></div><div class="line">		state.transformFeedbackQueryEnabled = context-&gt;transformFeedbackQueryEnabled;</div><div class="line">		state.transformFeedbackEnabled = context-&gt;transformFeedbackEnabled;</div><div class="line"></div><div class="line">		<span class="comment">// Note: Quads aren't handled for verticesPerPrimitive, but verticesPerPrimitive is used for transform feedback,</span></div><div class="line">		<span class="comment">//       which is an OpenGL ES 3.0 feature, and OpenGL ES 3.0 doesn't support quads as a primitive type.</span></div><div class="line">		DrawType type = <span class="keyword">static_cast</span>&lt;DrawType&gt;(<span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(drawType) &amp; <span class="number">0xF</span>);</div><div class="line">		state.verticesPerPrimitive = <span class="number">1</span> + (type &gt;= DRAW_LINELIST) + (type &gt;= DRAW_TRIANGLELIST);</div><div class="line"></div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_VERTEX_INPUTS; i++)</div><div class="line">		&#123;</div><div class="line">			state.input[i].type = context-&gt;input[i].type;</div><div class="line">			state.input[i].count = context-&gt;input[i].count;</div><div class="line">			state.input[i].normalized = context-&gt;input[i].normalized;</div><div class="line">			state.input[i].attribType = context-&gt;vertexShader ? context-&gt;vertexShader-&gt;getAttribType(i) : VertexShader::ATTRIBTYPE_FLOAT;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(!context-&gt;vertexShader)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</div><div class="line">			&#123;</div><div class="line">			<span class="comment">//	state.textureState[i].vertexTextureActive = context-&gt;vertexTextureActive(i, 0);</span></div><div class="line">				state.textureState[i].texGenActive = context-&gt;texGenActive(i);</div><div class="line">				state.textureState[i].textureTransformCountActive = context-&gt;textureTransformCountActive(i);</div><div class="line">				state.textureState[i].texCoordIndexActive = context-&gt;texCoordIndexActive(i);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; VERTEX_TEXTURE_IMAGE_UNITS; i++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span>(context-&gt;vertexShader-&gt;usesSampler(i))</div><div class="line">				&#123;</div><div class="line">					state.sampler[i] = context-&gt;sampler[TEXTURE_IMAGE_UNITS + i].samplerState();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(context-&gt;vertexShader)   <span class="comment">// <span class="doctag">FIXME:</span> Also when pre-transformed?</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_VERTEX_OUTPUTS; i++)</div><div class="line">			&#123;</div><div class="line">				state.output[i].xWrite = context-&gt;vertexShader-&gt;getOutput(i, <span class="number">0</span>).active();</div><div class="line">				state.output[i].yWrite = context-&gt;vertexShader-&gt;getOutput(i, <span class="number">1</span>).active();</div><div class="line">				state.output[i].zWrite = context-&gt;vertexShader-&gt;getOutput(i, <span class="number">2</span>).active();</div><div class="line">				state.output[i].wWrite = context-&gt;vertexShader-&gt;getOutput(i, <span class="number">3</span>).active();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(!context-&gt;preTransformed || context-&gt;pixelShaderModel() &lt; <span class="number">0x0300</span>)</div><div class="line">		&#123;</div><div class="line">			state.output[Pos].write = <span class="number">0xF</span>;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;diffuseActive() &amp;&amp; (context-&gt;lightingEnable || context-&gt;input[Color0]))</div><div class="line">			&#123;</div><div class="line">				state.output[C0].write = <span class="number">0xF</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;specularActive())</div><div class="line">			&#123;</div><div class="line">				state.output[C1].write = <span class="number">0xF</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> stage = <span class="number">0</span>; stage &lt; <span class="number">8</span>; stage++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span>(context-&gt;texCoordActive(stage, <span class="number">0</span>)) state.output[T0 + stage].write |= <span class="number">0x01</span>;</div><div class="line">				<span class="keyword">if</span>(context-&gt;texCoordActive(stage, <span class="number">1</span>)) state.output[T0 + stage].write |= <span class="number">0x02</span>;</div><div class="line">				<span class="keyword">if</span>(context-&gt;texCoordActive(stage, <span class="number">2</span>)) state.output[T0 + stage].write |= <span class="number">0x04</span>;</div><div class="line">				<span class="keyword">if</span>(context-&gt;texCoordActive(stage, <span class="number">3</span>)) state.output[T0 + stage].write |= <span class="number">0x08</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;fogActive())</div><div class="line">			&#123;</div><div class="line">				state.output[Fog].xWrite = <span class="literal">true</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;pointSizeActive())</div><div class="line">			&#123;</div><div class="line">				state.output[Pts].yWrite = <span class="literal">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			state.output[Pos].write = <span class="number">0xF</span>;</div><div class="line"></div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span>(context-&gt;input[Color0 + i])</div><div class="line">				&#123;</div><div class="line">					state.output[C0 + i].write = <span class="number">0xF</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span>(context-&gt;input[TexCoord0 + i])</div><div class="line">				&#123;</div><div class="line">					state.output[T0 + i].write = <span class="number">0xF</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;input[PointSize])</div><div class="line">			&#123;</div><div class="line">				state.output[Pts].yWrite = <span class="literal">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(context-&gt;vertexShaderModel() &lt; <span class="number">0x0300</span>)</div><div class="line">		&#123;</div><div class="line">			state.output[C0].clamp = <span class="number">0xF</span>;</div><div class="line">			state.output[C1].clamp = <span class="number">0xF</span>;</div><div class="line">			state.output[Fog].xClamp = <span class="literal">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		state.hash = state.computeHash();</div><div class="line"></div><div class="line">		<span class="keyword">return</span> state;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Generate-LLVM-IR"><a href="#Generate-LLVM-IR" class="headerlink" title="Generate LLVM IR"></a>Generate LLVM IR</h3><p>Then it generates the LLVM IR with reactor method based on the state which is updated in the previous step.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> VertexRoutine::generate()</div><div class="line">&#123;</div><div class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> textureSampling = state.textureSampling;</div><div class="line"></div><div class="line">		Pointer&lt;Byte&gt; cache = task + OFFSET(VertexTask,vertexCache);</div><div class="line">		Pointer&lt;Byte&gt; vertexCache = cache + OFFSET(VertexCache,vertex);</div><div class="line">		Pointer&lt;Byte&gt; tagCache = cache + OFFSET(VertexCache,tag);</div><div class="line"></div><div class="line">		UInt vertexCount = *Pointer&lt;UInt&gt;(task + OFFSET(VertexTask,vertexCount));</div><div class="line">		UInt primitiveNumber = *Pointer&lt;UInt&gt;(task + OFFSET(VertexTask, primitiveStart));</div><div class="line">		UInt indexInPrimitive = <span class="number">0</span>;</div><div class="line"></div><div class="line">		constants = *Pointer&lt;Pointer&lt;Byte&gt;&gt;(data + OFFSET(DrawData,constants));</div><div class="line"></div><div class="line">		Do</div><div class="line">		&#123;</div><div class="line">			UInt index = *Pointer&lt;UInt&gt;(batch);</div><div class="line">			UInt tagIndex = index &amp; <span class="number">0x0000003C</span>;</div><div class="line">			UInt indexQ = !textureSampling ? UInt(index &amp; <span class="number">0xFFFFFFFC</span>) : index;   <span class="comment">// <span class="doctag">FIXME:</span> TEXLDL hack to have independent LODs, hurts performance.</span></div><div class="line"></div><div class="line">			If(*Pointer&lt;UInt&gt;(tagCache + tagIndex) != indexQ)</div><div class="line">			&#123;</div><div class="line">				*Pointer&lt;UInt&gt;(tagCache + tagIndex) = indexQ;</div><div class="line"></div><div class="line">				readInput(indexQ);</div><div class="line">				pipeline(indexQ);</div><div class="line">				postTransform();</div><div class="line">				computeClipFlags();</div><div class="line"></div><div class="line">				Pointer&lt;Byte&gt; cacheLine0 = vertexCache + tagIndex * UInt((<span class="keyword">int</span>)<span class="keyword">sizeof</span>(Vertex));</div><div class="line">				writeCache(cacheLine0);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			UInt cacheIndex = index &amp; <span class="number">0x0000003F</span>;</div><div class="line">			Pointer&lt;Byte&gt; cacheLine = vertexCache + cacheIndex * UInt((<span class="keyword">int</span>)<span class="keyword">sizeof</span>(Vertex));</div><div class="line">			writeVertex(vertex, cacheLine);</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(state.transformFeedbackEnabled != <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				transformFeedback(vertex, primitiveNumber, indexInPrimitive);</div><div class="line"></div><div class="line">				indexInPrimitive++;</div><div class="line">				If(indexInPrimitive == <span class="number">3</span>)</div><div class="line">				&#123;</div><div class="line">					primitiveNumber++;</div><div class="line">					indexInPrimitive = <span class="number">0</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			vertex += <span class="keyword">sizeof</span>(Vertex);</div><div class="line">			batch += <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span>);</div><div class="line">			vertexCount--;</div><div class="line">		&#125;</div><div class="line">		Until(vertexCount == <span class="number">0</span>)</div><div class="line"></div><div class="line">		Return();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x32-Setup-processor"><a href="#0x32-Setup-processor" class="headerlink" title="0x32 Setup processor"></a>0x32 Setup processor</h2><p>The LLVM IR generation process of setup processor is similar to Vertex processor’s.</p>
<h2 id="0x33-Pixel-processor"><a href="#0x33-Pixel-processor" class="headerlink" title="0x33 Pixel processor"></a>0x33 Pixel processor</h2><p>The LLVM IR generation process of pixel processor is similar to Vertex processor’s.</p>
<h1 id="0x4-Multithread"><a href="#0x4-Multithread" class="headerlink" title="0x4 Multithread"></a>0x4 Multithread</h1><p>Here is the timeline diagram about how multithread is supported in swiftshader.<br>It split the draw task into several batches, each batch is executed in one thread.vertex processor and setup processor is executed together, pixel processor is executed after that.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/multithread.png" alt="swiftshader6"></p>
<h2 id="0x41-Task-producer"><a href="#0x41-Task-producer" class="headerlink" title="0x41 Task producer."></a>0x41 Task producer.</h2><p>Task producer produces the task in the main thread, then push the task in the queue and waits for the consumer to get those task for cosuming.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/task_producer.png" alt="swiftshader7"></p>
<h2 id="0x42-Task-consumer"><a href="#0x42-Task-consumer" class="headerlink" title="0x42 Task consumer."></a>0x42 Task consumer.</h2><p>Task consumer finds the task in the queue, then exeucute the task in the specific thread.<br>Here is the diagram about how vertex processor and setup processor is executed in one thread.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/task_consumer.png" alt="swiftshader8"></p>
<p>Here is the diagram about how pixel processor is executed in one thread.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/task_consumer_pixel.png" alt="swiftshader9"></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/graphics/" rel="tag"># graphics</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/07/08/Timer-support-in-event-driven-network-framework/" rel="next" title="Timer support in event driven network framework">
                <i class="fa fa-chevron-left"></i> Timer support in event driven network framework
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/13/how-renderscript-supports-parallel-compution/" rel="prev" title="How renderscript supports parallel compution">
                How renderscript supports parallel compution <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Kevin Wen" />
          <p class="site-author-name" itemprop="name">Kevin Wen</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">40</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0x1-Architecture"><span class="nav-number">1.</span> <span class="nav-text">0x1 Architecture</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x2-Graphics-Pipeline"><span class="nav-number">2.</span> <span class="nav-text">0x2 Graphics Pipeline</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x3-JIT-through-LLVM"><span class="nav-number">3.</span> <span class="nav-text">0x3 JIT through LLVM</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x31-GLSL-compiler-frontend"><span class="nav-number">3.1.</span> <span class="nav-text">0x31 GLSL compiler frontend</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x31-Vertex-processor"><span class="nav-number">3.2.</span> <span class="nav-text">0x31 Vertex processor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Prepare-the-draw-state"><span class="nav-number">3.2.1.</span> <span class="nav-text">Prepare the draw state</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Generate-LLVM-IR"><span class="nav-number">3.2.2.</span> <span class="nav-text">Generate LLVM IR</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x32-Setup-processor"><span class="nav-number">3.3.</span> <span class="nav-text">0x32 Setup processor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x33-Pixel-processor"><span class="nav-number">3.4.</span> <span class="nav-text">0x33 Pixel processor</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x4-Multithread"><span class="nav-number">4.</span> <span class="nav-text">0x4 Multithread</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x41-Task-producer"><span class="nav-number">4.1.</span> <span class="nav-text">0x41 Task producer.</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x42-Task-consumer"><span class="nav-number">4.2.</span> <span class="nav-text">0x42 Task consumer.</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kevin Wen</span>
</div>


<div> <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
访问量 <span id="busuanzi_value_site_pv"></span>
访问人数 <span id="busuanzi_value_site_uv"></span>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("orq8xxsDQDXKiHdqSRcjlflB-gzGzoHsz", "ecCFdIcWDfbJKQOCiLFf1EBm");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
