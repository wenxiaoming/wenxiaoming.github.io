<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="Kevin Wen&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Kevin Wen&#39;s Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kevin Wen&#39;s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>Kevin Wen's Blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kevin Wen's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/01/Waterfall-test-of-escher-in-fuchsia/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/" itemprop="url">Waterfall test of escher in fuchsia</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-01T23:21:36+08:00">
                2019-02-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/" class="leancloud_visitors" data-flag-title="Waterfall test of escher in fuchsia">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Escher-Introduction"><a href="#0x1-Escher-Introduction" class="headerlink" title="0x1 Escher Introduction"></a>0x1 Escher Introduction</h1><p>Escher is physical rendering engine in fuchsia os</p>
<p>It aims to support Mixed Reality(MR), MR will mix virtual 3D objects with reality world.</p>
<p>It only supports vulkan as its rendering backend.</p>
<p>Here is the escher’s architecture view.</p>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/escher.png" alt="architecture"></p>
<h1 id="0x2-Waterfall-execution-flow"><a href="#0x2-Waterfall-execution-flow" class="headerlink" title="0x2 Waterfall execution flow"></a>0x2 Waterfall execution flow</h1><p>Waterfall is the demo of how echer is running.</p>
<p>Here is the draw main loop of Waterfall.</p>
<ol>
<li><p>Create objects in scene, place them into Model</p>
</li>
<li><p>Create shadow through DrawFrameWithMomentShadowMapShadows</p>
</li>
<li><p>Draw objects with shadow in PaperRenderer</p>
</li>
</ol>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/drawloop.png" alt="main loop"></p>
<p>Here is the sequence diagram of creating shadowmap</p>
<ol>
<li><p>DrawShadowPass of ShadowMapRenderer is entrypoint for drawing shadow</p>
</li>
<li><p>Create CreateDisplayList in ModelRenderer</p>
</li>
<li><p>ModelRenderer call GetPipeline to create or reuse pipeline</p>
</li>
<li><p>It will call SPIR-V compiler if need to create a new pipeline</p>
</li>
</ol>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/createshadowmap.png" alt="create shadowmap"></p>
<p>Here is the sequence diagram of drawing objects with shadowmap</p>
<ol>
<li><p>Call DrawFrameWithMomentShadowMapShadows</p>
</li>
<li><p>Create CreateDisplayList in ModelRenderer</p>
</li>
<li><p>Draw each item in ModelRenderer::Draw()</p>
</li>
<li><p>Do following operations in command buffer</p>
<p>vk_command_buffer.bindPipeline()   </p>
<p>vk_command_buffer.setStencilReference()</p>
<p>vk_command_buffer.bindDescriptorSets()</p>
</li>
<li><p>Call CommandBuffer::DrawMesh() to draw mesh,it will bind vertex data and index data(similar as OpenGL ES)</p>
<p> command<em>buffer</em>.bindVertexBuffers()</p>
<p> command<em>buffer</em>.bindIndexBuffer()</p>
<p> command<em>buffer</em>.drawIndexed()</p>
</li>
</ol>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/drawframe.png" alt="draw frame"></p>
<h1 id="0x3-Waterfall-snapshot"><a href="#0x3-Waterfall-snapshot" class="headerlink" title="0x3 Waterfall snapshot"></a>0x3 Waterfall snapshot</h1><p>Here are snapshots when Waterfall is running.</p>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/waterfall_2.png" alt="waterfall_2"></p>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/waterfall_3.png" alt="waterfall_3"></p>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/waterfall_4.png" alt="waterfall_4"></p>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/waterfall_5.png" alt="waterfall_5"></p>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/waterfall_8.png" alt="waterfall_8"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/18/analysis-of-cntv-streaming/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/18/analysis-of-cntv-streaming/" itemprop="url">analysis of cntv streaming</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-18T09:02:32+08:00">
                2018-07-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/07/18/analysis-of-cntv-streaming/" class="leancloud_visitors" data-flag-title="analysis of cntv streaming">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x0-总体流程"><a href="#0x0-总体流程" class="headerlink" title="0x0 总体流程"></a>0x0 总体流程</h1><p>下图表示CBox播放的总体流程。<br>播放正式内容之前先播放广告。先访问Advertisement DNS得到视频广告文件保存的服务器，然后访问该服务器下载广告文件并播放。视频广告文件采用MP4格式保存。<br>节目内容采用HLS(HTTP Live Streaming)协议的方式进行播放，CBox先从HLS Server下载m3u8文件，得到需要下载的ts文件，然后再连接上HLS Server来下载ts文件并播放。</p>
<p><img src="/2018/07/18/analysis-of-cntv-streaming/architecture.png" alt="architecture"></p>
<h1 id="0x1-播放视频广告"><a href="#0x1-播放视频广告" class="headerlink" title="0x1 播放视频广告"></a>0x1 播放视频广告</h1><p>播放视频广告的总体流程抓包如下。<br><img src="/2018/07/18/analysis-of-cntv-streaming/playing_advertisement.png" alt="playing_advertisement"></p>
<h2 id="0x11-通过HTTP获得广告文件的URL"><a href="#0x11-通过HTTP获得广告文件的URL" class="headerlink" title="0x11 通过HTTP获得广告文件的URL"></a>0x11 通过HTTP获得广告文件的URL</h2><p>CBox通过下面的GET方法获取。<br>GET /flash/vd/473fae2b16855f408335283ec9a3e29df44d4a9499406413ccc222e91bc93d85.mp4 HTTP/1.1<br><img src="/2018/07/18/analysis-of-cntv-streaming/get_advertisement_url.png" alt="get_advertisement_url"></p>
<h2 id="0x12-服务器返回广告文件的URL"><a href="#0x12-服务器返回广告文件的URL" class="headerlink" title="0x12 服务器返回广告文件的URL"></a>0x12 服务器返回广告文件的URL</h2><p>服务器对上一步GET方法进行响应，返回广告文件的URL。<br>Location: <a href="http://218.78.185.62/v.cctv.com/flash/vd/473fae2b16855f408335283ec9a3e29df44d4a9499406413ccc222e91bc93d85.mp4?wsrid_tag=5b4dfebd_PSshzjdxiu61_28643-17287&amp;wsiphost=local\r\n" target="_blank" rel="external">http://218.78.185.62/v.cctv.com/flash/vd/473fae2b16855f408335283ec9a3e29df44d4a9499406413ccc222e91bc93d85.mp4?wsrid_tag=5b4dfebd_PSshzjdxiu61_28643-17287&amp;wsiphost=local\r\n</a></p>
<p><img src="/2018/07/18/analysis-of-cntv-streaming/advertisement_url.png" alt="advertisement_url"></p>
<h2 id="0x13-获取广告文件"><a href="#0x13-获取广告文件" class="headerlink" title="0x13 获取广告文件"></a>0x13 获取广告文件</h2><p>通过下面的GET方法获取广告文件。<br>GET /v.cctv.com/flash/vd/473fae2b16855f408335283ec9a3e29df44d4a9499406413ccc222e91bc93d85.mp4</p>
<p><img src="/2018/07/18/analysis-of-cntv-streaming/get_advertisement.png" alt="get_advertisement"></p>
<h2 id="0x14-服务器发送广告文件给CBox"><a href="#0x14-服务器发送广告文件给CBox" class="headerlink" title="0x14 服务器发送广告文件给CBox"></a>0x14 服务器发送广告文件给CBox</h2><p>服务器通过http把视频广告文件发送给CBox。<br><img src="/2018/07/18/analysis-of-cntv-streaming/playing_advertisement.png" alt="playing_advertisement"></p>
<h1 id="0x2-播放节目"><a href="#0x2-播放节目" class="headerlink" title="0x2 播放节目"></a>0x2 播放节目</h1><h2 id="0x21-更新EPG"><a href="#0x21-更新EPG" class="headerlink" title="0x21 更新EPG"></a>0x21 更新EPG</h2><p>EPG是Electronic Program Guide的英文缩写，意思是电子节目指南，提供节目播放列表功能和节目单功能。<br><img src="/2018/07/18/analysis-of-cntv-streaming/update_epg.png" alt="update_epg"></p>
<h2 id="0x22-和服务器之间进行安全认证"><a href="#0x22-和服务器之间进行安全认证" class="headerlink" title="0x22 和服务器之间进行安全认证"></a>0x22 和服务器之间进行安全认证</h2><p>在播放之前对客户端进行安全认证。<br><img src="/2018/07/18/analysis-of-cntv-streaming/tls.png" alt="tls"></p>
<h2 id="0x23-获取HLS的m3u8文件"><a href="#0x23-获取HLS的m3u8文件" class="headerlink" title="0x23 获取HLS的m3u8文件"></a>0x23 获取HLS的m3u8文件</h2><p>m3u8 是一种基于HLS的文件视频格式，它主要存放整个视频的基本信息和分片(Segment)组成。Segment一般是ts格式的视频文件。<br><img src="/2018/07/18/analysis-of-cntv-streaming/hls_m3u8.png" alt="hls_download"></p>
<h2 id="0x24-从服务器中下载ts流并播放"><a href="#0x24-从服务器中下载ts流并播放" class="headerlink" title="0x24 从服务器中下载ts流并播放"></a>0x24 从服务器中下载ts流并播放</h2><p>解析上面下载得到的m3u8文件，得到需要下载的ts文件列表，然后访问服务器，通过http下载这些ts文件到本地并播放。<br><img src="/2018/07/18/analysis-of-cntv-streaming/hls.png" alt="hls"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/27/STUN-in-P2P-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/27/STUN-in-P2P-network/" itemprop="url">STUN in P2P network</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-27T09:22:15+08:00">
                2018-06-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/06/27/STUN-in-P2P-network/" class="leancloud_visitors" data-flag-title="STUN in P2P network">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-STUN简介"><a href="#0x1-STUN简介" class="headerlink" title="0x1 STUN简介"></a>0x1 STUN简介</h1><p>STUN(Session Traversal Utilities for NAT)是一种协助穿越NAT的工具，并不独立提供穿越的解决方案。详细请参考<br><a href="https://datatracker.ietf.org/doc/rfc3489/" target="_blank" rel="external">RFC3489</a>，升级版协议是<a href="https://tools.ietf.org/html/rfc5389" target="_blank" rel="external">RFC5389</a>和<a href="https://tools.ietf.org/html/rfc7350" target="_blank" rel="external">RFC7350</a>。</p>
<p>STUN的使用场景如下，Interactive Connectivity Establishment (ICE) [MMUSIC-ICE], Client-initiated<br>connections for SIP [SIP-OUTBOUND], and NAT Behavior Discovery [BEHAVE-NAT]。</p>
<h1 id="0x2-NAT检测"><a href="#0x2-NAT检测" class="headerlink" title="0x2 NAT检测"></a>0x2 NAT检测</h1><p>RFC3489中将NAT的实现分为四大类：<br>1.Full Cone NAT （完全锥形NAT）<br>2.Restricted Cone NAT （限制锥形NAT ，可以理解为IP限制，Port不限制）<br>3.Port Restricted Cone NAT （端口限制锥形NAT，IP+Port 限制）<br>4.Symmetric NAT （对称NAT）<br>其中完全最上层的完全锥形NAT的穿透性最好，而最下层的对称形NAT需要借助TURN服务器进行数据转发，两个client之间不能进行Peer to Peer的通信。</p>
<p>NAT类型检测过程如下<br><img src="https://upload.wikimedia.org/wikipedia/commons/6/63/STUN_Algorithm3.svg" alt="nat_check"></p>
<p>如上图所示，一旦路经到达红色节点时，Peer to Peer的连接是没有可能性的，需要借助服务器进行转发。一旦通过黄色或是绿色的节点，Peer to Peer的连接是可以成功的。</p>
<p>下面介绍STUN是如何判断NAT的类型的。<br>内容来自<a href="https://www.jianshu.com/p/84e8c78ca61d" target="_blank" rel="external">ICE协议下NAT穿越的实现</a></p>
<p>假设B是客户端，C是STUN服务器，C有两个IP分别为IP1和IP2（至于为什么要两个IP，接着往下看）：</p>
<p>STEP1.判断客户端是否在NAT后：</p>
<p>B向C的IP1的pot1端口发送一个UDP包。C收到这个包后，会把它收到包的源IP和port写到UDP包中，然后把此包通过IP1和port1发还给B。这个IP和port也就是NAT的外网 IP和port（如果你不理解，那么请你去看我的BLOG里面的NAT的原理和分类），也就是说你在STEP1中就得到了NAT的外网IP。</p>
<p>熟悉NAT工作原理的朋友可以知道，C返回给B的这个UDP包B一定收到。如果在你的应用中，向一个STUN服务器发送数据包后，你没有收到STUN的任何回应包，那只有两种可能：1、STUN服务器不存在，或者你弄错了port。2、你的NAT拒绝一切UDP包从外部向内部通过。</p>
<p>当B收到此UDP后，把此UDP中的IP和自己的IP做比较，如果是一样的，就说明自己是在公网，下步NAT将去探测防火墙类型，我不想多说。如果不一样，说明有NAT的存在，系统进行STEP2的操作。</p>
<p>STEP2.判断是否处于Full Cone Nat下：</p>
<p>B向C的IP1发送一个UDP包，请求C通过另外一个IP2和PORT（不同与SETP1的IP1）向B返回一个UDP数据包（现在知道为什么C要有两个IP了吧，虽然还不理解为什么，呵呵）。</p>
<p>我们来分析一下，如果B收到了这个数据包，那说明什么？说明NAT来着不拒，不对数据包进行任何过滤，这也就是STUN标准中的full cone NAT。遗憾的是，Full Cone Nat太少了，这也意味着你能收到这个数据包的可能性不大。如果没收到，那么系统进行STEP3的操作。</p>
<p>STEP3.判断是否处于对称NAT下：</p>
<p>B向C的IP2的port2发送一个数据包，C收到数据包后，把它收到包的源IP和port写到UDP包中，然后通过自己的IP2和port2把此包发还给B。</p>
<p>和step1一样，B肯定能收到这个回应UDP包。此包中的port是我们最关心的数据，下面我们来分析：</p>
<p>如果这个port和step1中的port一样，那么可以肯定这个NAT是个CONE NAT，否则是对称NAT。道理很简单：根据对称NAT的规则，当目的地址的IP和port有任何一个改变，那么NAT都会重新分配一个port使用，而在step3中，和step1对应，我们改变了IP和port。因此，如果是对称NAT,那这两个port肯定是不同的。</p>
<p>如果在你的应用中，到此步的时候PORT是不同的，那么这个它就是处在一个对称NAT下了。如果相同，那么只剩下了restrict cone 和port restrict cone。系统用step4探测是是那一种。</p>
<p>STEP4.判断是处于Restrict Cone NAT还是Port Restrict NAT之下：</p>
<p>B向C的IP2的一个端口PD发送一个数据请求包，要求C用IP2和不同于PD的port返回一个数据包给B。</p>
<p>我们来分析结果：如果B收到了，那也就意味着只要IP相同，即使port不同，NAT也允许UDP包通过。显然这是Restrict Cone NAT。如果没收到，没别的好说，Port Restrict NAT.</p>
<h1 id="0x3-StunServer实现分析"><a href="#0x3-StunServer实现分析" class="headerlink" title="0x3 StunServer实现分析"></a>0x3 StunServer实现分析</h1><p>STUN协议是一个客户机/服务器协议。StunServer可能和其他服务器(如web server, turn server）集成在一起。而stun client也可以在p2p的客户端中实现。<br>在核心的STUN协议中，只有一种称为“Binding”的方法。STUN客户端使用Binding来创建和发现NAT映射。当STUN服务器收到STUN Binding时，它会记录请求来着哪个公网IP和端口，此公网IP和端口会发生给STUN客户端，这样收到STUN Binding响应的客户端会根据这些信息判断NAT的类型。<br><img src="/2018/06/27/STUN-in-P2P-network/stun.png" alt="stun"></p>
<h1 id="0x4-StunServer测试"><a href="#0x4-StunServer测试" class="headerlink" title="0x4 StunServer测试"></a>0x4 StunServer测试</h1><p>测试结果如下，<br>kevin@ubuntu:~/Kevin/nat/stunserver$ ./stunclient 68.xxx.xxx.xxx 3478<br>Binding test: success<br>Local address: 192.168.40.200:47045<br>Mapped address: 116.xxx.xxx.xxx:56077</p>
<p>其中68.xxx.xxx.xxx是运行StunServer服务器的公网IP地址。<br>返回给Stun客户端的信息中包括了Stun客户端的公网IP为116.xxx.xxx.xxx，和内网地址(192.168.40.200)不一致，说明位于NAT之后。至于是哪种NAT类型，需要参考前面的流程进行多次测试。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/29/check-the-execution-of-tensorflow-with-gdb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/29/check-the-execution-of-tensorflow-with-gdb/" itemprop="url">check the execution of tensorflow with gdb</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-29T09:03:29+08:00">
                2018-04-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/04/29/check-the-execution-of-tensorflow-with-gdb/" class="leancloud_visitors" data-flag-title="check the execution of tensorflow with gdb">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Here I list some callstack of tensorflow which is collected through gdb.</p>
<h1 id="0x1-Session-Run"><a href="#0x1-Session-Run" class="headerlink" title="0x1 Session::Run()"></a>0x1 Session::Run()</h1><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">(gdb) bt </div><div class="line">#0 tensorflow::DirectSession::Run (this=0x55a688ed3660, run_options=..., inputs=std::vector of length 3, capacity 3 = &#123;...&#125;,   output_names=std::vector of length 0, capacity 0, target_nodes=std::vector of length 1, capacity 1 = &#123;...&#125;, outputs=0x7f375da478e0,   run_metadata=0x7f375da47930) at tensorflow/core/common_runtime/direct_session.cc:439 </div><div class="line">#1 0x00007f3784cea307 in TF_Run_Helper (session=0x55a688ed3660, handle=0x0, run_options=0x0,   input_pairs=std::vector of length 3, capacity 3 = &#123;...&#125;, output_tensor_names=std::vector of length 0, capacity 0,   c_outputs=0x7f375da47d00, target_oper_names=std::vector of length 1, capacity 1 = &#123;...&#125;, run_metadata=0x0, status=0x7f37200d5e80)  at tensorflow/c/c_api.cc:680 </div><div class="line">#2 0x00007f3784cea874 in TF_Run (s=0x55a688ed2af0, run_options=0x0, c_input_names=0x7f375da47c60, c_inputs=0x7f375da47cb0, ninputs=3,   c_output_names=0x7f375da48060, c_outputs=0x7f375da47d00, noutputs=0, c_target_oper_names=0x7f375da480b0, ntargets=1, run_metadata=0x0,   status=0x7f37200d5e80) at tensorflow/c/c_api.cc:735 </div><div class="line">#3 0x00007f37847382dd in tensorflow::TF_Run_wrapper_helper (session=0x55a688ed2af0, handle=0x0, run_options=0x0, feed_dict=0x7f3762b029d8,   output_names=..., target_nodes=..., out_status=0x7f37200d5e80, out_values=0x7f375da48100, run_outputs=0x0)  at tensorflow/python/client/tf_session_helper.cc:96 </div><div class="line">#4 0x00007f3784738936 in tensorflow::TF_Run_wrapper (session=0x55a688ed2af0, run_options=0x0, feed_dict=0x7f3762b029d8, output_names=...,   target_nodes=..., out_status=0x7f37200d5e80, out_values=0x7f375da48100, run_outputs=0x0)  at tensorflow/python/client/tf_session_helper.cc:149 </div><div class="line">#5 0x00007f37846bf7e4 in _wrap_TF_Run (args=0x7f376350cdb0) at bazel-out/k8-py3-dbg/bin/tensorflow/python/pywrap_tensorflow_internal.cc:15067 </div><div class="line">#6 0x000055a68528b2a1 in _PyCFunction_FastCallDict () </div><div class="line">#7 0x000055a68531e0a0 in call_function () </div><div class="line">#8 0x000055a68533f62a in _PyEval_EvalFrameDefault () </div><div class="line">#9 0x000055a685318c78 in PyEval_EvalCodeEx ()</div></pre></td></tr></table></figure>
<h1 id="0x2-OpKernel-Compute"><a href="#0x2-OpKernel-Compute" class="headerlink" title="0x2 OpKernel::Compute()"></a>0x2 OpKernel::Compute()</h1><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">(gdb) bt</div><div class="line">#0 0x00007f377fe7ee70 in tensorflow::OpKernelContext::input(int)@plt ()from /home/kevin/anaconda3/lib/python3.6/site-packages/tensorflow/python/../libtensorflow_framework.so</div><div class="line">#1 0x00007f378001d8dd in tensorflow::HandleFromInput (ctx=0x7f3724169150, input=0) at tensorflow/core/framework/resource_mgr.cc:279</div><div class="line">#2 0x00007f37859298b8 in tensorflow::QueueOpKernel::ComputeAsync(tensorflow::OpKernelContext*, std::function&lt;void ()&gt;) (this=0x7f37200cbfb0, ctx=0x7f3724169150, callback=...) at tensorflow/core/kernels/queue_ops.cc:37</div><div class="line">#3 0x00007f378482cab8 in tensorflow::Device::ComputeAsync(tensorflow::AsyncOpKernel*, tensorflow::OpKernelContext*, std::function&lt;void ()&gt;)(this=0x55a688ee3260, op_kernel=0x7f37200cbfb0, context=0x7f3724169150, done=...) at ./tensorflow/core/common_runtime/device.h:89</div><div class="line">#4 0x00007f37806b1b6e in tensorflow::(anonymous namespace)::ExecutorState::Process (this=0x7f37200d3440, tagged_node=..., scheduled_usec=0)at tensorflow/core/common_runtime/executor.cc:1647</div><div class="line">#5 0x00007f37806c01a7 in std::_Mem_fn_base&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long), true&gt;::operator()&lt;tensorflow::(anonymous namespace)::ExecutorState::TaggedNode&amp;, long long&amp;, void&gt; (this=0x7f37240337a0, __object=0x7f37200d3440) at /usr/include/c++/5/functional:600</div><div class="line">#6 0x00007f37806bfc62 in std::_Bind&lt;std::_Mem_fn&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;(tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;::__call&lt;void, 0ul, 1ul, 2ul&gt;(&lt;unknown type in /home/kevin/anaconda3/lib/python3.6/site-packages/tensorflow/python/../libtensorflow_framework.so, CU 0x314f884, DIE 0x31e50c1&gt;, std::_Index_tuple&lt;0ul, 1ul, 2ul&gt;) (this=0x7f37240337a0, __args=&lt;unknown type in /home/kevin/anaconda3/lib/python3.6/site-packages/tensorflow/python/../libtensorflow_framework.so, CU 0x314f884, DIE 0x31e50c1&gt;) at /usr/include/c++/5/functional:1074</div><div class="line">#7 0x00007f37806bda06 in std::_Bind&lt;std::_Mem_fn&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;(tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;::operator()&lt;, void&gt;(void) (this=0x7f37240337a0) at /usr/include/c++/5/functional:1133</div><div class="line">#8 0x00007f37806bb2ac in std::_Function_handler&lt;void(), std::_Bind&lt;std::_Mem_fn&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;(tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt; &gt;::_M_invoke(const std::_Any_data &amp;) (__functor=...)at /usr/include/c++/5/functional:1871</div><div class="line">#9 0x00007f377ff7f984 in std::function&lt;void ()&gt;::operator()() const (this=0x7f372407f320) at /usr/include/c++/5/functional:2267</div><div class="line">#10 0x00007f3780197b9e in tensorflow::thread::EigenEnvironment::ExecuteTask (this=0x55a688ed3c58, t=...)at tensorflow/core/lib/core/threadpool.cc:81</div><div class="line">#11 0x00007f378019a65c in Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::WorkerLoop (this=0x55a688ed3c50, thread_id=1) at external/eigen_archive/unsupported/Eigen/CXX11/src/ThreadPool/NonBlockingThreadPool.h:232</div><div class="line">#12 0x00007f3780198aae in Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::NonBlockingThreadPoolTempl(int, bool, tensorflow::thread::EigenEnvironment)::&#123;lambda()#1&#125;::operator()() const ()at external/eigen_archive/unsupported/Eigen/CXX11/src/ThreadPool/NonBlockingThreadPool.h:65</div><div class="line">#13 0x00007f378019bc7c in std::_Function_handler&lt;void (), Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::NonBlockingThreadPoolTempl(int, bool, tensorflow::thread::EigenEnvironment)::&#123;lambda()#1&#125;&gt;::_M_invoke(std::_Any_data const&amp;) (__functor=...)at /usr/include/c++/5/functional:1871</div><div class="line">#14 0x00007f377ff7f984 in std::function&lt;void ()&gt;::operator()() const (this=0x55a688ed3050) at /usr/include/c++/5/functional:2267</div><div class="line">#15 0x00007f3780197907 in tensorflow::thread::EigenEnvironment::CreateThread(std::function&lt;void ()&gt;)::&#123;lambda()#1&#125;::operator()() const (__closure=0x55a688ed3050) at tensorflow/core/lib/core/threadpool.cc:56</div><div class="line">#16 0x00007f37801998d8 in std::_Function_handler&lt;void (), tensorflow::thread::EigenEnvironment::CreateThread(std::function&lt;void ()&gt;)::&#123;lambda()#1&#125;&gt;::_M_invoke(std::_Any_data const&amp;) (__functor=...) at /usr/include/c++/5/functional:1871</div><div class="line">#17 0x00007f377ff7f984 in std::function&lt;void ()&gt;::operator()() const (this=0x55a688f199b8) at /usr/include/c++/5/functional:2267</div><div class="line">#18 0x00007f37801dcf38 in std::_Bind_simple&lt;std::function&lt;void ()&gt; ()&gt;::_M_invoke&lt;&gt;(std::_Index_tuple&lt;&gt;) (this=0x55a688f199b8)at /usr/include/c++/5/functional:1531</div><div class="line">#19 0x00007f37801dcea1 in std::_Bind_simple&lt;std::function&lt;void ()&gt; ()&gt;::operator()() (this=0x55a688f199b8)at /usr/include/c++/5/functional:1520</div><div class="line">#20 0x00007f37801dce40 in std::thread::_Impl&lt;std::_Bind_simple&lt;std::function&lt;void ()&gt; ()&gt; &gt;::_M_run() (this=0x55a688f199a0)at /usr/include/c++/5/thread:115</div><div class="line">#21 0x00007f377ed4fc80 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6</div><div class="line">#22 0x00007f3796f746ba in start_thread (arg=0x7f3760247700) at pthread_create.c:333#23 0x00007f3796caa3dd in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109</div></pre></td></tr></table></figure>
<h1 id="0x3-Producer-of-tenforflow"><a href="#0x3-Producer-of-tenforflow" class="headerlink" title="0x3 Producer of tenforflow"></a>0x3 Producer of tenforflow</h1><p>It is trigged by test.py to send command to tenforflow native code.<br><img src="/2018/04/29/check-the-execution-of-tensorflow-with-gdb/producer.jpg" alt="producer"></p>
<h1 id="0x4-Consumer-of-tenforflow"><a href="#0x4-Consumer-of-tenforflow" class="headerlink" title="0x4 Consumer of tenforflow"></a>0x4 Consumer of tenforflow</h1><p>Tensorflow’s thread pull task from the queue then execute it<br><img src="/2018/04/29/check-the-execution-of-tensorflow-with-gdb/consumer.jpg" alt="consumer"></p>
<h1 id="0x5-gdb-debug-of-convolutional-network-py"><a href="#0x5-gdb-debug-of-convolutional-network-py" class="headerlink" title="0x5 gdb debug of convolutional_network.py"></a>0x5 gdb debug of convolutional_network.py</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(gdb) bt</div><div class="line">#<span class="number">0</span> <span class="number">0x00007f90a7e2d8f0</span> in tensorflow::ConvBackpropComputeDimensions(tensorflow::StringPiece, <span class="keyword">int</span>, tensorflow::TensorShape <span class="keyword">const</span>&amp;, tensorflow::TensorShape <span class="keyword">const</span>&amp;, tensorflow::TensorShape <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt; &gt; <span class="keyword">const</span>&amp;, tensorflow::Padding, tensorflow::TensorFormat, tensorflow::ConvBackpropDimensions*)@plt ()  from /home/kevin/anaconda3/lib/python3<span class="number">.6</span>/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so </div><div class="line">#<span class="number">1</span> <span class="number">0x00007f90ab73bb73</span> in tensorflow::Conv2DCustomBackpropInputOp&lt;Eigen::ThreadPoolDevice, <span class="keyword">float</span>&gt;::Compute (<span class="keyword">this</span>=<span class="number">0x556909e28fa0</span>, context=<span class="number">0x7f9083774840</span>)  at tensorflow/core/kernels/conv_grad_input_ops.cc:<span class="number">311</span> </div><div class="line">#<span class="number">2</span> <span class="number">0x00007f90a3ee091b</span> in tensorflow::ThreadPoolDevice::Compute (  <span class="keyword">this</span>=<span class="number">0x5569092d1f30</span>, op_kernel=<span class="number">0x556909e28fa0</span>, context=<span class="number">0x7f9083774840</span>)  at tensorflow/core/common_runtime/threadpool_device.cc:<span class="number">59</span> </div><div class="line">#<span class="number">3</span> <span class="number">0x00007f90a3e7bc0a</span> in tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::Process (<span class="keyword">this</span>=<span class="number">0x556909f04770</span>, tagged_node=..., scheduled_usec=<span class="number">0</span>)  at tensorflow/core/common_runtime/executor.cc:<span class="number">1652</span> </div><div class="line">#<span class="number">4</span> <span class="number">0x00007f90a3e8a1a7</span> in <span class="built_in">std</span>::_Mem_fn_base&lt;<span class="keyword">void</span> (tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::*)(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span>), <span class="literal">true</span>&gt;::<span class="keyword">operator</span>()&lt;tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode&amp;, <span class="keyword">long</span> <span class="keyword">long</span>&amp;, <span class="keyword">void</span>&gt; (<span class="keyword">this</span>=<span class="number">0x7f904c695d50</span>,   __object=<span class="number">0x556909f04770</span>) at /usr/include/c++/<span class="number">5</span>/functional:<span class="number">600</span> </div><div class="line">#<span class="number">5</span> <span class="number">0x00007f90a3e89c62</span> in <span class="built_in">std</span>::_Bind&lt;<span class="built_in">std</span>::_Mem_fn&lt;<span class="keyword">void</span> (tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::*)(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt;(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState*, tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt;::__call&lt;<span class="keyword">void</span>, <span class="number">0u</span>l, <span class="number">1u</span>l, <span class="number">2u</span>l&gt;(&lt;unknown type in /home/kevin/anaconda3/lib/python3<span class="number">.6</span>/site-packages/tensorflow/python/../libtensorflow_framework.so, CU <span class="number">0x314f884</span>, DIE <span class="number">0x31e50c1</span>&gt;, <span class="built_in">std</span>::_Index_tuple&lt;<span class="number">0u</span>l, <span class="number">1u</span>l, <span class="number">2u</span>l&gt;) (<span class="keyword">this</span>=<span class="number">0x7f904c695d50</span>,  ---Type &lt;<span class="keyword">return</span>&gt; to <span class="keyword">continue</span>, <span class="keyword">or</span> q &lt;<span class="keyword">return</span>&gt; to quit---  __args=&lt;unknown type in /home/kevin/anaconda3/lib/python3<span class="number">.6</span>/site-packages/tensorflow/python/../libtensorflow_framework.so, CU <span class="number">0x314f884</span>, DIE <span class="number">0x31e50c1</span>&gt;)  at /usr/include/c++/<span class="number">5</span>/functional:<span class="number">1074</span> </div><div class="line">#<span class="number">6</span> <span class="number">0x00007f90a3e87a06</span> in <span class="built_in">std</span>::_Bind&lt;<span class="built_in">std</span>::_Mem_fn&lt;<span class="keyword">void</span> (tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::*)(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt;(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState*, tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt;::<span class="keyword">operator</span>()&lt;, <span class="keyword">void</span>&gt;(<span class="keyword">void</span>) (<span class="keyword">this</span>=<span class="number">0x7f904c695d50</span>)  at /usr/include/c++/<span class="number">5</span>/functional:<span class="number">1133</span> </div><div class="line">#<span class="number">7</span> <span class="number">0x00007f90a3e852ac</span> in <span class="built_in">std</span>::_Function_handler&lt;<span class="keyword">void</span>(), <span class="built_in">std</span>::_Bind&lt;<span class="built_in">std</span>::_Mem_fn&lt;<span class="keyword">void</span> (tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::*)(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt;(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState*, tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt; &gt;::_M_invoke(<span class="keyword">const</span> <span class="built_in">std</span>::_Any_data &amp;) (__functor=...)  at /usr/include/c++/<span class="number">5</span>/functional:<span class="number">1871</span> </div><div class="line">#<span class="number">8</span> <span class="number">0x00007f90a3749984</span> in <span class="built_in">std</span>::function&lt;<span class="keyword">void</span> ()&gt;::<span class="keyword">operator</span>()() <span class="keyword">const</span> (  <span class="keyword">this</span>=<span class="number">0x7f904c6c5d40</span>) at /usr/include/c++/<span class="number">5</span>/functional:<span class="number">2267</span> #<span class="number">9</span> <span class="number">0x00007f90a3961b9e</span> in tensorflow::thread::EigenEnvironment::ExecuteTask (  <span class="keyword">this</span>=<span class="number">0x5569091d82c8</span>, t=...) at tensorflow/core/lib/core/threadpool.cc:<span class="number">81</span> </div><div class="line">#<span class="number">10</span> <span class="number">0x00007f90a396465c</span> in Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::WorkerLoop (<span class="keyword">this</span>=<span class="number">0x5569091d82c0</span>, thread_id=<span class="number">1</span>)  at external/eigen_archive/unsupported/Eigen/CXX11/src/ThreadPool/NonBlockingThreadPool.h:<span class="number">232</span> </div><div class="line">#<span class="number">11</span> <span class="number">0x00007f90a3962aae</span> in Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::NonBlockingThreadPoolTempl(<span class="keyword">int</span>, <span class="keyword">bool</span>, tensorflow::thread::EigenEnvironment)::&#123;lambda()#<span class="number">1</span>&#125;::<span class="keyword">operator</span>()() <span class="keyword">const</span> ()  at external/eigen_archive/unsupported/Eigen/CXX11/src/ThreadPool/NonBlockingThreadPool.h:<span class="number">65</span></div></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(gdb) c Continuing. </div><div class="line">[Switching to Thread <span class="number">0x7f9083775700</span> (LWP <span class="number">3586</span>)]   </div><div class="line">Thread <span class="number">13</span> <span class="string">"python"</span> hit Breakpoint <span class="number">5</span>, <span class="number">0x00007f90a7e2d8f0</span> in tensorflow::ConvBackpropComputeDimensions(tensorflow::StringPiece, <span class="keyword">int</span>, tensorflow::TensorShape <span class="keyword">const</span>&amp;, tensorflow::TensorShape <span class="keyword">const</span>&amp;, tensorflow::TensorShape <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt; &gt; <span class="keyword">const</span>&amp;, tensorflow::Padding, tensorflow::TensorFormat, tensorflow::ConvBackpropDimensions*)@plt ()  from /home/kevin/anaconda3/lib/python3<span class="number">.6</span>/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so </div><div class="line">(gdb) n </div><div class="line">Single stepping until <span class="built_in">exit</span> from function _ZN10tensorflow29ConvBackpropComputeDimensionsENS_11StringPieceEiRKNS_11TensorShapeES3_S3_RKSt6vectorIiSaIiEENS_7PaddingENS_12TensorFormatEPNS_22ConvBackpropDimensionsE@plt, which has no line number information. [Switching to Thread <span class="number">0x7f90819b9700</span> (LWP <span class="number">3587</span>)]   Thread <span class="number">14</span> <span class="string">"python"</span> hit Breakpoint <span class="number">5</span>, <span class="number">0x00007f90a7e2d8f0</span> in tensorflow::ConvBackpropComputeDimensions(tensorflow::StringPiece, <span class="keyword">int</span>, tensorflow::TensorShape <span class="keyword">const</span>&amp;, tensorflow::TensorShape <span class="keyword">const</span>&amp;, tensorflow::TensorShape <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt; &gt; <span class="keyword">const</span>&amp;, tensorflow::Padding, tensorflow::TensorFormat, tensorflow::ConvBackpropDimensions*)@plt ()  from /home/kevin/anaconda3/lib/python3<span class="number">.6</span>/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so </div><div class="line">(gdb)  </div><div class="line">Single stepping until <span class="built_in">exit</span> from function _ZN10tensorflow29ConvBackpropComputeDimensionsENS_11StringPieceEiRKNS_11TensorShapeES3_S3_RKSt6vectorIiSaIiEENS_7PaddingENS_12TensorFormatEPNS_22ConvBackpropDimensionsE@plt, which has no line number information. tensorflow::ConvBackpropComputeDimensions (label=..., num_spatial_dims=<span class="number">32656</span>,   input_shape=..., filter_shape=..., out_backprop_shape=...,   strides=<span class="built_in">std</span>::<span class="built_in">vector</span> of length <span class="number">4</span>, capacity <span class="number">4</span> = &#123;...&#125;,   padding=tensorflow::VALID, data_format=tensorflow::FORMAT_NHWC,   dims=<span class="number">0x7f90819b8240</span>) at tensorflow/core/kernels/conv_grad_ops.cc:<span class="number">156</span> <span class="number">156</span>  ConvBackpropDimensions* dims) &#123; (gdb) n [Switching to Thread <span class="number">0x7f9083775700</span> (LWP <span class="number">3586</span>)]   Thread <span class="number">13</span> <span class="string">"python"</span> hit Breakpoint <span class="number">5</span>, tensorflow::ConvBackpropComputeDimensions  (label=..., num_spatial_dims=<span class="number">2</span>, input_shape=..., filter_shape=...,   out_backprop_shape=...,   strides=<span class="built_in">std</span>::<span class="built_in">vector</span> of length <span class="number">4</span>, capacity <span class="number">4</span> = &#123;...&#125;,   padding=tensorflow::VALID, data_format=tensorflow::FORMAT_NHWC,   dims=<span class="number">0x7f9083774240</span>) at tensorflow/core/kernels/conv_grad_ops.cc:<span class="number">160</span> <span class="number">160</span>  one_dilations, strides, padding, data_format, dims);</div></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">(gdb)</div><div class="line">#<span class="number">0</span> <span class="built_in">std</span>::<span class="keyword">operator</span>==&lt;tensorflow::Status::State, <span class="built_in">std</span>::default_delete&lt;tensorflow::Status::State&gt; &gt;(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;tensorflow::Status::State, <span class="built_in">std</span>::default_delete&lt;tensorflow::Status::State&gt; &gt; <span class="keyword">const</span>&amp;, <span class="keyword">decltype</span>(<span class="literal">nullptr</span>)) (  __x=<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;tensorflow::Status::State&gt; containing <span class="number">0x0</span>)  at /usr/include/c++/<span class="number">5</span>/bits/<span class="built_in">unique_ptr</span>.h:<span class="number">631</span> </div><div class="line">#<span class="number">1</span> <span class="number">0x00007f90a7e9e41d</span> in tensorflow::Status::ok (<span class="keyword">this</span>=<span class="number">0x7f90819b8150</span>)  at ./tensorflow/core/lib/core/status.h:<span class="number">53</span> </div><div class="line">#<span class="number">2</span> <span class="number">0x00007f90ab73bb86</span> in tensorflow::Conv2DCustomBackpropInputOp&lt;Eigen::ThreadPoolDevice, <span class="keyword">float</span>&gt;::Compute (<span class="keyword">this</span>=<span class="number">0x556909e5c730</span>, context=<span class="number">0x7f90819b8840</span>)  at tensorflow/core/kernels/conv_grad_input_ops.cc:<span class="number">311</span> </div><div class="line">#<span class="number">3</span> <span class="number">0x00007f90a3ee091b</span> in tensorflow::ThreadPoolDevice::Compute (  <span class="keyword">this</span>=<span class="number">0x5569092d1f30</span>, op_kernel=<span class="number">0x556909e5c730</span>, context=<span class="number">0x7f90819b8840</span>)  at tensorflow/core/common_runtime/threadpool_device.cc:<span class="number">59</span> </div><div class="line">#<span class="number">4</span> <span class="number">0x00007f90a3e7bc0a</span> in tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::Process (<span class="keyword">this</span>=<span class="number">0x55690a0f5150</span>, tagged_node=..., scheduled_usec=<span class="number">0</span>)  at tensorflow/core/common_runtime/executor.cc:<span class="number">1652</span> </div><div class="line">#<span class="number">5</span> <span class="number">0x00007f90a3e8a1a7</span> in <span class="built_in">std</span>::_Mem_fn_base&lt;<span class="keyword">void</span> (tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::*)(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span>), <span class="literal">true</span>&gt;::<span class="keyword">operator</span>()&lt;tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode&amp;, <span class="keyword">long</span> <span class="keyword">long</span>&amp;, <span class="keyword">void</span>&gt; (<span class="keyword">this</span>=<span class="number">0x7f90508b25b0</span>,   __object=<span class="number">0x55690a0f5150</span>) at /usr/include/c++/<span class="number">5</span>/functional:<span class="number">600</span> </div><div class="line">#<span class="number">6</span> <span class="number">0x00007f90a3e89c62</span> in <span class="built_in">std</span>::_Bind&lt;<span class="built_in">std</span>::_Mem_fn&lt;<span class="keyword">void</span> (tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::*)(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt;(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState*, tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt;::__call&lt;<span class="keyword">void</span>, <span class="number">0u</span>l, <span class="number">1u</span>l, <span class="number">2u</span>l&gt;(&lt;unknown type in /home/kevin/anaconda3/lib/python3<span class="number">.6</span>/site-packages/tensorflow/python/../libtensorflow_framework.so, CU <span class="number">0x314f884</span>, DIE <span class="number">0x31e50c1</span>&gt;, <span class="built_in">std</span>::_Index_tuple&lt;<span class="number">0u</span>l, <span class="number">1u</span>l, <span class="number">2u</span>l&gt;) (<span class="keyword">this</span>=<span class="number">0x7f90508b25b0</span>,   __args=&lt;unknown type in /home/kevin/anaconda3/lib/python3<span class="number">.6</span>/site-packages/tensorflow/python/../libtensorflow_framework.so, CU <span class="number">0x314f884</span>, DIE <span class="number">0x31e50c1</span>&gt;)  at /usr/include/c++/<span class="number">5</span>/functional:<span class="number">1074</span> ---Type &lt;<span class="keyword">return</span>&gt; to <span class="keyword">continue</span>, <span class="keyword">or</span> q &lt;<span class="keyword">return</span>&gt; to quit---   </div><div class="line">(gdb) n </div><div class="line">tensorflow::Conv2DCustomBackpropInputOp&lt;Eigen::ThreadPoolDevice, <span class="keyword">float</span>&gt;::Compute (<span class="keyword">this</span>=<span class="number">0x556909e5c730</span>, context=<span class="number">0x7f90819b8840</span>)  at tensorflow/core/kernels/conv_grad_input_ops.cc:<span class="number">317</span> <span class="number">317</span>  Tensor* in_backprop = <span class="literal">nullptr</span>;</div><div class="line">(gdb) <span class="built_in">list</span></div><div class="line"> <span class="number">312</span>  ConvBackpropComputeDimensions( <span class="number">313</span>  <span class="string">"Conv2DCustomBackpropInput"</span>, <span class="comment">/*num_spatial_dims=*/</span><span class="number">2</span>, <span class="number">314</span>  input_shape, filter.shape(), out_backprop.shape(), <span class="number">315</span>  strides_, padding_, data_format_, &amp;dims)); <span class="number">316</span>  <span class="number">317</span>  Tensor* in_backprop = <span class="literal">nullptr</span>; <span class="number">318</span>  OP_REQUIRES_OK(context, <span class="number">319</span>  context-&gt;allocate_output(<span class="number">0</span>, input_shape, &amp;in_backprop)); <span class="number">320</span>  <span class="number">321</span> <span class="comment">// TODO(andydavis) Consider moving code shared with </span></div><div class="line">(gdb) n</div><div class="line"><span class="number">318</span>  OP_REQUIRES_OK(context, </div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Thread info</div><div class="line">(gdb) info threads</div><div class="line">  Id Target Id Frame   </div><div class="line">  1 Thread 0x7f90bab09700 (LWP 3530) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  2 Thread 0x7f90b6a6a700 (LWP 3531) "python" 0x00007f90ba6f387f in __libc_recv (fd=4, buf=0x7f90b6a7afc8, n=4, flags=0)  at ../sysdeps/unix/sysv/linux/x86_64/recv.c:28  </div><div class="line">  3 Thread 0x7f908fc55700 (LWP 3560) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  4 Thread 0x7f908f454700 (LWP 3561) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  5 Thread 0x7f908ec53700 (LWP 3562) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  6 Thread 0x7f908e452700 (LWP 3563) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  7 Thread 0x7f908693b700 (LWP 3578) "python" 0x00007f90ba6f2827 in futex_abstimed_wait_cancelable (private=0, abstime=0x0, expected=0,   futex_word=0x7f9068013280)  at ../sysdeps/unix/sysv/linux/futex-internal.h:205 </div><div class="line">  8 Thread 0x7f9085f7a700 (LWP 3581) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  9 Thread 0x7f9085779700 (LWP 3582) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  10 Thread 0x7f9084f78700 (LWP 3583) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  11 Thread 0x7f9084777700 (LWP 3584) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  12 Thread 0x7f9083f76700 (LWP 3585) "python" tensorflow::ConvBackpropComputeDimensions (label=..., num_spatial_dims=2, input_shape=...,   filter_shape=..., out_backprop_shape=...,   strides=std::vector of length 4, capacity 4 = &#123;...&#125;,   padding=tensorflow::VALID, data_format=tensorflow::FORMAT_NHWC,  ---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---  dims=0x7f9083f75240) at tensorflow/core/kernels/conv_grad_ops.cc:160  </div><div class="line">  13 Thread 0x7f9083775700 (LWP 3586) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185 * </div><div class="line">  14 Thread 0x7f90819b9700 (LWP 3587) "python" tensorflow::ConvBackpropComputeDimensions (label=..., num_spatial_dims=2, input_shape=...,   filter_shape=..., out_backprop_shape=...,   strides=std::vector of length 4, capacity 4 = &#123;...&#125;,   padding=tensorflow::VALID, data_format=tensorflow::FORMAT_NHWC,   dims=0x7f90819b8240) at tensorflow/core/kernels/conv_grad_ops.cc:160  </div><div class="line">  15 Thread 0x7f90811b8700 (LWP 3588) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  16 Thread 0x7f90809b7700 (LWP 3589) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  17 Thread 0x7f907dde7700 (LWP 3590) "python" 0x00007f90ba6f2827 in futex_abstimed_wait_cancelable (private=0, abstime=0x0, expected=0,   futex_word=0x7f9038001380)  at ../sysdeps/unix/sysv/linux/futex-internal.h:205</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/" itemprop="url">Design p2p streaming capturer based on flv</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-22T09:36:10+08:00">
                2018-04-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/" class="leancloud_visitors" data-flag-title="Design p2p streaming capturer based on flv">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Introduction"><a href="#0x1-Introduction" class="headerlink" title="0x1     Introduction"></a>0x1     Introduction</h1><p>streaming capturer用于接收client端发送过来的媒体数据，client端类似于目前市面上的直播客户端，通过RTMP/RTSP协议把数据发送给streaming capturer。streaming capturer对接收到的数据进行解包，如果需要可以进行transcoding，然后把数据发送给后续的模块进行处理，这些模块可以把数据发送给其他服务器提供流媒体服务。下面介绍的p2p streaming capturer是把接收到和转码后的数据打包成P2P协议包，这些P2P协议包被发送给种子节点p2p seed node，p2p seed node提供p2p streaming的种子节点功能。播放器先连接到这个p2p seed node，获取播放所需要的媒体数据，而且后面进来的播放器可以从前面的播放器中得到部分播放数据，不需要都从p2p seed node处获取数据，从而显著地降低流媒体服务器的带宽负担。<br>Adobe FLV格式是一种流媒体格式，p2p streaming capturer接收到client发送过来的数据流以后，打包成FLV格式, 然后在FLV的基础上打包成P2P数据包的格式。</p>
<p>下面是系统架构图。<br><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/architecture.png" alt="architecture"></p>
<h1 id="0x2-flv数据格式"><a href="#0x2-flv数据格式" class="headerlink" title="0x2   flv数据格式"></a>0x2   flv数据格式</h1><p>下面简单介绍一下FLV数据格式。<br>如下所示，首先是9个byte的flv header。</p>
<h2 id="0x21-The-flv-header"><a href="#0x21-The-flv-header" class="headerlink" title="0x21  The flv header"></a>0x21  The flv header</h2><p><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/flv_header.png" alt="flv_header"></p>
<p>在flv header之后，是Tag和Size交织组成的数据部分。</p>
<h2 id="0x22-The-flv-file-body"><a href="#0x22-The-flv-file-body" class="headerlink" title="0x22  The flv file body"></a>0x22  The flv file body</h2><p><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/flv_file_body.png" alt="flv_file_body"></p>
<h2 id="0x23-flv-tag"><a href="#0x23-flv-tag" class="headerlink" title="0x23  flv tag"></a>0x23  flv tag</h2><p>下面是flv tag数据部分。<br><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/flv_tag.png" alt="flv_tag"></p>
<h1 id="0x3-基于flv的p2p-streaming-capturer的设计"><a href="#0x3-基于flv的p2p-streaming-capturer的设计" class="headerlink" title="0x3  基于flv的p2p streaming capturer的设计"></a>0x3  基于flv的p2p streaming capturer的设计</h1><p>流程图如下，</p>
<p><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/sequence.png" alt="sequence"></p>
<p>左边是p2p streaming capturer, 它与p2p seed node进行交互，p2p streaming capturer接收client发送的RTMP/RTSP数据包，经过解包/转码以后生成FLV数据，这个时候需要把FLV header和类似SPS/PPS之类的媒体类型信息保存起来，p2p streaming capturer还需要实现内部缓存buffer, 把打包好的FLV数据缓存起来，为了后面打包成P2P数据包发送给p2p seed node。<br>p2p streaming capturer连接上p2p seed node以后，先发送注册(Register)信息，然后发送媒体类型(MediaType)信息，MediaType包括SPS/PPS等信息，然后开始把前面缓存起来的数据按固定大小(16384)打包成P2P格式，然后发送给p2p seed node.<br>p2p seed node在p2p streaming capturer连接上来以后，需要把相关信息发送给tracker server，这样相当于tracker server增加了一个节目源。<br>播放器player可以连接到p2p seed node来得到播放数据。对于直播来说，由于player刚连接到p2p seed node的时候获取的数据可能并不是关键帧，这个时候不能立即播放，需要等待下一个关键帧的到来。为了减少播放等待时候，可以在p2p seed node上实现gop cache的功能，把最近一个关键帧开始的数据都保存到gop cache中，等播放器连接上来的时候，把gop cache中的数据发送给播放器，这样播放器就不需要等待。当有新的关键帧到来的时候，需要把gop cache中的数据清空，然后保存当前关键帧开始的数据。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/Implement-yuv2rgb-gpu-filter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/Implement-yuv2rgb-gpu-filter/" itemprop="url">Implement yuv2rgb gpu filter</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-15T21:02:13+08:00">
                2018-04-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/04/15/Implement-yuv2rgb-gpu-filter/" class="leancloud_visitors" data-flag-title="Implement yuv2rgb gpu filter">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Introduction"><a href="#0x1-Introduction" class="headerlink" title="0x1     Introduction"></a>0x1     Introduction</h1><p>本文我们将在GPU上实现yuv420p到rgb的转换，转换代码采用opengl es glsl实现。该转换代码在GPU上运行，为了更好地展示这个实现过程和体现转换效果，我们在Android平台上实现一个app应用。<br>详细代码请参考 <a href="https://github.com/wenxiaoming/YUVRender" target="_blank" rel="external">YUVRender</a></p>
<p>YUV2RGB转换的算法原理如下，其中Y/U/V是从yuv420p数据中读取的三个分量。<br>    B=1.164(Y−16)+2.018(U−128)<br>    G=1.164(Y−16)−0.813(V−128)−0.391(U−128)<br>    R=1.164(Y−16)+1.596(V−128)</p>
<h1 id="0x2-Shader代码"><a href="#0x2-Shader代码" class="headerlink" title="0x2     Shader代码"></a>0x2     Shader代码</h1><h2 id="0x21-vertex-shader代码"><a href="#0x21-vertex-shader代码" class="headerlink" title="0x21 vertex shader代码"></a>0x21 vertex shader代码</h2><p>vertex shader代码首先输入顶点坐标和纹理坐标。<br>输出变量gl_Position用于在计算顶点位置以后将其写入裁剪坐标。<br>输出变量vtexcoord是输入给fragment shader作为纹理坐标的。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">precision mediump <span class="keyword">float</span>;</div><div class="line">varying   mediump vec2 vtexcoord;</div><div class="line">attribute mediump vec4 position;</div><div class="line">attribute mediump vec2 texcoord;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">	gl_Position  = position;</div><div class="line">	vtexcoord = texcoord;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x22-fragment-shader代码"><a href="#0x22-fragment-shader代码" class="headerlink" title="0x22 fragment shader代码"></a>0x22 fragment shader代码</h2><p>fragment shader代码首先输入texture坐标, 该坐标首先经过了vertex shader处理，<br>然后又经过了Primitive Assembly阶段的clip和插值处理。<br>然后输入三个sampler2D，这三个sampler2D分别对应yuv420p的Y/U/V数据，通过texture2D这个内置的纹理访问函数，我们可以读取对应纹理坐标下的Y/U/V数据。<br>接下面的代码就是执行YUV到RGB的转换矩阵了，具体的矩阵可以参考前面的介绍。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">precision mediump <span class="keyword">float</span>;</div><div class="line">varying   mediump vec2 vtexcoord;</div><div class="line">uniform   lowp  sampler2D samplerY;</div><div class="line">uniform   lowp  sampler2D samplerU;</div><div class="line">uniform   lowp  sampler2D samplerV;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    mediump <span class="keyword">float</span> y;</div><div class="line">    mediump <span class="keyword">float</span> u;</div><div class="line">    mediump <span class="keyword">float</span> v;</div><div class="line">    lowp  vec3 rgb;</div><div class="line">    mat3 convmatrix = mat3(vec3(<span class="number">1.164</span>,  <span class="number">1.164</span>, <span class="number">1.164</span>),</div><div class="line">                           vec3(<span class="number">0.0</span>,   <span class="number">-0.392</span>, <span class="number">2.017</span>),</div><div class="line">                           vec3(<span class="number">1.596</span>, <span class="number">-0.813</span>, <span class="number">0.0</span>));</div><div class="line"></div><div class="line">    y = (texture2D(samplerY, vtexcoord).r - (<span class="number">16.0</span> / <span class="number">255.0</span>));</div><div class="line">    u = (texture2D(samplerU, vtexcoord).r - (<span class="number">128.0</span> / <span class="number">255.0</span>));</div><div class="line">    v = (texture2D(samplerV, vtexcoord).r - (<span class="number">128.0</span> / <span class="number">255.0</span>));</div><div class="line"></div><div class="line">    rgb = convmatrix * vec3(y, u, v);</div><div class="line">    gl_FragColor = vec4(rgb, <span class="number">1.0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="0x3-具体实现"><a href="#0x3-具体实现" class="headerlink" title="0x3     具体实现"></a>0x3     具体实现</h1><h2 id="0x31-texture的创建"><a href="#0x31-texture的创建" class="headerlink" title="0x31 texture的创建"></a>0x31 texture的创建</h2><p>为了让GPU能读取到YUV的数据，需要创建3个texture, 这三个texture分别存放Y/U/V分量。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">GLES20.glGenTextures(<span class="number">3</span>, mTexture, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</div><div class="line">&#123;</div><div class="line">    GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + i);</div><div class="line">    GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, mTexture[i]);</div><div class="line">    GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR);</div><div class="line">    GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_LINEAR);</div><div class="line">    GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_CLAMP_TO_EDGE);</div><div class="line">    GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_CLAMP_TO_EDGE);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x32-yuv420p数据的读取"><a href="#0x32-yuv420p数据的读取" class="headerlink" title="0x32 yuv420p数据的读取"></a>0x32 yuv420p数据的读取</h2><p>我们读取的yuv420p数据是foreman.qcif，分辨率是qcif(176x144), 从数据布局来看，首先是176x144大小的Y分量，然后是88x72大小的U分量, 最后是88x72大小的V分量。下面是读取YUV数据的详细代码。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getYuvData</span><span class="params">(String fileName)</span></span></div><div class="line">&#123;</div><div class="line">    String res=<span class="string">""</span>;</div><div class="line">    <span class="keyword">try</span>&#123;</div><div class="line">        InputStream in = getResources().getAssets().open(fileName);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> length = in.available();</div><div class="line">        byte [] buffer = <span class="keyword">new</span> byte[length];</div><div class="line"></div><div class="line">        ByteBuffer byteBuffer = ByteBuffer.allocateDirect(length);</div><div class="line">        mYuvBuffer = byteBuffer;</div><div class="line"></div><div class="line">        in.read(buffer);</div><div class="line">        in.close();</div><div class="line"></div><div class="line">        mYuvBuffer.put(buffer);</div><div class="line">        mYuvBuffer.position(<span class="number">0</span>);</div><div class="line"></div><div class="line">        mBufferU = ByteBuffer.allocateDirect(<span class="number">88</span>*<span class="number">72</span>);</div><div class="line">        mBufferV = ByteBuffer.allocateDirect(<span class="number">88</span>*<span class="number">72</span>);</div><div class="line"></div><div class="line">        mBufferU.put(buffer,<span class="number">176</span>*<span class="number">144</span>,<span class="number">88</span>*<span class="number">72</span>);</div><div class="line">        mBufferU.position(<span class="number">0</span>);</div><div class="line"></div><div class="line">        mBufferV.put(buffer,<span class="number">176</span>*<span class="number">144</span>+<span class="number">88</span>*<span class="number">72</span>,<span class="number">88</span>*<span class="number">72</span>);</div><div class="line">        mBufferV.position(<span class="number">0</span>);</div><div class="line">    &#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x33-texture的更新"><a href="#0x33-texture的更新" class="headerlink" title="0x33 texture的更新"></a>0x33 texture的更新</h2><p>YUV数据保持在pixels数组中，通过调用glTexImage2D把YUV数据输入到GPU driver中。<br>因为需要给YUV的三个texture分别输入，所以需要循环3次。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span>[] planes    = &#123; <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span> &#125;;</div><div class="line"><span class="keyword">int</span>[] widths    = &#123; width, width/<span class="number">2</span>, width/<span class="number">2</span> &#125;;</div><div class="line"><span class="keyword">int</span>[] heights  = &#123; height, height/<span class="number">2</span>, height/<span class="number">2</span> &#125;;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> plane = planes[i];</div><div class="line">    GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + i);</div><div class="line"></div><div class="line">    GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, mTexture[i]);</div><div class="line">    ShaderManager.checkGlError(<span class="string">"glBindTexture"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(pixels[plane] == null)</div><div class="line">        Log.e(<span class="string">"YUV2RGBFilter"</span>, <span class="string">"pixels[plane] == null"</span>);</div><div class="line"></div><div class="line">    GLES20.glTexImage2D(</div><div class="line">            GLES20.GL_TEXTURE_2D,</div><div class="line">            <span class="number">0</span>,</div><div class="line">            GLES20.GL_LUMINANCE,</div><div class="line">            widths[plane],</div><div class="line">            heights[plane],</div><div class="line">            <span class="number">0</span>,</div><div class="line">            GLES20.GL_LUMINANCE,</div><div class="line">            GLES20.GL_UNSIGNED_BYTE,</div><div class="line">            pixels[plane]);</div><div class="line"></div><div class="line">    ShaderManager.checkGlError(<span class="string">"glTexImage2D"</span>);</div><div class="line"></div><div class="line">    GLES20.glUniform1i(mTextureHandle[i], i);</div><div class="line"></div><div class="line">    ShaderManager.checkGlError(<span class="string">"glUniform1i"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x34-更新其他参数"><a href="#0x34-更新其他参数" class="headerlink" title="0x34 更新其他参数"></a>0x34 更新其他参数</h2><p>下面的代码是把顶点坐标和纹理坐标输入给GPU driver。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">GLES20.glVertexAttribPointer(mPositionHandle, <span class="number">3</span>, GLES20.GL_FLOAT,</div><div class="line">        <span class="literal">false</span>, <span class="number">0</span>, mVertexBuffer);</div><div class="line">ShaderManager.checkGlError(<span class="string">"glVertexAttribPointer"</span>);</div><div class="line"></div><div class="line">GLES20.glEnableVertexAttribArray(mPositionHandle);</div><div class="line"></div><div class="line">ShaderManager.checkGlError(<span class="string">"glEnableVertexAttribArray"</span>);</div><div class="line"></div><div class="line">GLES20.glVertexAttribPointer(mTexCoordHandle, <span class="number">2</span>, GLES20.GL_FLOAT,</div><div class="line">        <span class="literal">false</span>, <span class="number">0</span>, mTexCoorBuffer);</div><div class="line">ShaderManager.checkGlError(<span class="string">"glVertexAttribPointer"</span>);</div><div class="line"></div><div class="line">GLES20.glEnableVertexAttribArray(mTexCoordHandle);</div></pre></td></tr></table></figure></p>
<h1 id="0x4-调试中碰到的问题"><a href="#0x4-调试中碰到的问题" class="headerlink" title="0x4 调试中碰到的问题"></a>0x4 调试中碰到的问题</h1><p>代码写好以后，一运行，不能出来正确的图像，一直是绿屏。下面介绍一下解决绿屏的过程。<br>首先检查api调用是否正确，通过启用swiftshader，我们可以打印出所有的opengl es api调用log, 检查该app调用的opengl es api，没有发现问题。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.439</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: ClearColor external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">710</span> ((GLclampf red = <span class="number">1.000000</span>, GLclampf green = <span class="number">0.000000</span>, GLclampf blue = <span class="number">1.000000</span>, GLclampf alpha = <span class="number">1.000000</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.439</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Clear external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">692</span> ((GLbitfield mask = <span class="number">4100</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.451</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: UseProgram external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">5925</span> ((GLuint program = <span class="number">3</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.451</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: BindTexture external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">354</span> ((GLenum target = <span class="number">0xDE1</span>, GLuint texture = <span class="number">1</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Uniform1iv external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">5545</span> ((GLint location = <span class="number">0</span>, GLsizei count = <span class="number">1</span>, <span class="keyword">const</span> GLint* v = <span class="number">0x7b00d3a1621c</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: BindTexture external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">354</span> ((GLenum target = <span class="number">0xDE1</span>, GLuint texture = <span class="number">2</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Uniform1iv external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">5545</span> ((GLint location = <span class="number">1</span>, GLsizei count = <span class="number">1</span>, <span class="keyword">const</span> GLint* v = <span class="number">0x7b00d3a1621c</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: BindTexture external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">354</span> ((GLenum target = <span class="number">0xDE1</span>, GLuint texture = <span class="number">3</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Uniform1iv external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">5545</span> ((GLint location = <span class="number">2</span>, GLsizei count = <span class="number">1</span>, <span class="keyword">const</span> GLint* v = <span class="number">0x7b00d3a1621c</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: VertexAttribPointer external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">6127</span> ((GLuint index = <span class="number">0</span>, GLint size = <span class="number">3</span>, GLenum type = <span class="number">0x1406</span>, GLboolean normalized = <span class="number">0</span>, GLsizei stride = <span class="number">0</span>, <span class="keyword">const</span> GLvoid* ptr = <span class="number">0x740e1d10</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">3300</span>  <span class="number">3300</span> E libGLESv2_swiftshader: BindTexture external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">354</span> ((GLenum target = <span class="number">0x8D65</span>, GLuint texture = <span class="number">4</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">3300</span>  <span class="number">3300</span> E libGLESv2_swiftshader: EGLImageTargetTexture2DOES external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">6659</span> ((GLenum target = <span class="number">0x8D65</span>, GLeglImageOES image = <span class="number">0x8</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: EnableVertexAttribArray external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1865</span> ((GLuint index = <span class="number">0</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: VertexAttribPointer external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">6127</span> ((GLuint index = <span class="number">1</span>, GLint size = <span class="number">2</span>, GLenum type = <span class="number">0x1406</span>, GLboolean normalized = <span class="number">0</span>, GLsizei stride = <span class="number">0</span>, <span class="keyword">const</span> GLvoid* ptr = <span class="number">0x740e0b80</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.453</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: EnableVertexAttribArray external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1865</span> ((GLuint index = <span class="number">1</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.453</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: DrawArrays external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1537</span> ((GLenum mode = <span class="number">0x5</span>, GLint first = <span class="number">0</span>, GLsizei count = <span class="number">4</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.453</span>  <span class="number">3300</span>  <span class="number">3300</span> E libGLESv2_swiftshader: Disable external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1493</span> ((GLenum cap = <span class="number">0xC11</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.454</span>  <span class="number">3300</span>  <span class="number">3300</span> E libGLESv2_swiftshader: Viewport external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">6189</span> ((GLint x = <span class="number">0</span>, GLint y = <span class="number">0</span>, GLsizei width = <span class="number">1080</span>, GLsizei height = <span class="number">1920</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.468</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Finish external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1922</span> (())</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.728</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: DisableVertexAttribArray external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1520</span> ((GLuint index = <span class="number">0</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.729</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: DisableVertexAttribArray external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1520</span> ((GLuint index = <span class="number">1</span>))</div></pre></td></tr></table></figure></p>
<p>再怀疑是因为texture没有被正确地送入到GPU中，通过dump glTexImage2D()输入的pixel，发现也是正确的。</p>
<p>最后在fragment shader中写hard code, 强制输出某种颜色，也是正确的，说明整个流程没有问题。</p>
<p>最后怀疑是texture的坐标没有正确地设置，在打印glVertexAttribPointer()的输入参数，发现这个时候的texture坐标都是0，明显不是正确的值，一步一步往上debug， 发现是因为Java ByteBuffer的order没有被设置成本机字节顺序(ByteOrder.nativeOrder()), 设置了以后，texture的坐标就正确了。</p>
<p>解决了绿屏的问题以后，yuv420p的数据能在Android上正确显示了，显示效果如下<br><img src="/2018/04/15/Implement-yuv2rgb-gpu-filter/screencap.jpg" alt="result"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/08/How-swiftshader-supports-texture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/08/How-swiftshader-supports-texture/" itemprop="url">How swiftshader supports texture</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-08T12:59:57+08:00">
                2018-04-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/04/08/How-swiftshader-supports-texture/" class="leancloud_visitors" data-flag-title="How swiftshader supports texture">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Introduction"><a href="#0x1-Introduction" class="headerlink" title="0x1     Introduction"></a>0x1     Introduction</h1><p>Here is the OpenGL ES pipeline, the pink color box represents the data buffer in the pipeline, the gray blue box represents the operation in the pipeline.</p>
<p>In the following of this article, I will show you how texture is used in the OpenGL ES pipeline. In order to explains it more clearly, I will dig into the texture support in Swiftshader, since Swiftshader is the software implementation of OpenGL ES pipeline, we can see the detail implementation of it.</p>
<p><img src="/2018/04/08/How-swiftshader-supports-texture/pipeline.png" alt="pipeline"></p>
<h1 id="0x2-Application-code"><a href="#0x2-Application-code" class="headerlink" title="0x2    Application code."></a>0x2    Application code.</h1><p>Here is the code for texture generation.<br>It generates and binds texture, and sets the parameter for it.<br>GL_TEXTURE_MAG_FILTER and GL_TEXTURE_MIN_FILTER is used to set up the filtering mode for mipmaps. GL_TEXTURE_WRAP_S and GL_TEXTURE_WRAP_T is used to set up texture wrap modes when texture coordinate is outside the range[0.0, 1.0].</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">glGenTextures(<span class="number">1</span>, mTexture, <span class="number">0</span>);</div><div class="line">glActiveTexture(GL_TEXTURE0);</div><div class="line">glBindTexture(GL_TEXTURE_2D, mTexture);</div><div class="line">glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</div><div class="line">glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</div><div class="line">glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);</div><div class="line">glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);</div></pre></td></tr></table></figure>
<p>Here is the code for texture upload.<br>The texture’s content is passed by parameter pixel, the GPU driver will copy pixel into its managed internal buffer, If the GPU hardware supports tile rendering, typically there is a conversion from linear buffer to tile buffer at the same time.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">glBindTexture(GL_TEXTURE_2D, mTexture);</div><div class="line">glTexImage2D(GL_TEXTURE_2D,</div><div class="line">            <span class="number">0</span>,</div><div class="line">            GL_LUMINANCE,</div><div class="line">            width,</div><div class="line">            height,</div><div class="line">            <span class="number">0</span>,</div><div class="line">            GL_LUMINANCE,</div><div class="line">            GL_UNSIGNED_BYTE,</div><div class="line">            pixel);</div><div class="line"></div><div class="line">glUniform1i(mTextureHandle, i);</div></pre></td></tr></table></figure></p>
<h1 id="0x3-Texture-in-Shader-code"><a href="#0x3-Texture-in-Shader-code" class="headerlink" title="0x3    Texture in Shader code."></a>0x3    Texture in Shader code.</h1><p>Here is one example of glsl shader code.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">static const char simplevs[] =</div><div class="line">    attribute vec4 position;</div><div class="line">    attribute vec2 texCoords;</div><div class="line">    varying vec2 outTexCoords;</div><div class="line">    void main(void) &#123;</div><div class="line">        outTexCoords = texCoords;</div><div class="line">        gl_Position = position;</div><div class="line">    &#125;";</div><div class="line">static const char simplefs[] =</div><div class="line">    precision mediump float;</div><div class="line">    varying vec2 outTexCoords;</div><div class="line">    uniform sampler2D texture;</div><div class="line">    void main(void) &#123;</div><div class="line">        gl_FragColor = texture2D(texture, outTexCoords);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>In the vertex shader code, the texture’s coordinate is input by attribute texCoords, then it is output in vertex shader as outTexCoords,<br>Then in primitive assembly and rasterization stage, it is clipped and interpolated.<br>Then in fragment shader code, the clipped and interpolated texture coordinate is used to fetching specific position’s pixel from the texture.<br>Here is the diagram to explain the execution sequence.<br><img src="/2018/04/08/How-swiftshader-supports-texture/sequence.png" alt="sequence"></p>
<h1 id="0x4-Texture-support-in-swiftshader"><a href="#0x4-Texture-support-in-swiftshader" class="headerlink" title="0x4    Texture support in swiftshader"></a>0x4    Texture support in swiftshader</h1><p>Let’s to see how texture is supported in swiftshader, Here is the draft diagram in swiftshader about texture support.</p>
<p><img src="/2018/04/08/How-swiftshader-supports-texture/texture_in_swiftshader.png" alt="texture_in_swiftshader"></p>
<h2 id="0x41-Set-texture-for-pipeline-in-glDrawXX"><a href="#0x41-Set-texture-for-pipeline-in-glDrawXX" class="headerlink" title="0x41 Set texture for pipeline in glDrawXX()"></a>0x41 Set texture for pipeline in glDrawXX()</h2><p>At this time, texture is uploaded through glTexImage2D(), glDrawXX() is triggered. applyTexture() is used to setup texture for current draw context.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Context::applyTexture(sw::SamplerType type, <span class="keyword">int</span> index, Texture *baseTexture)</div><div class="line">&#123;</div><div class="line">        ……</div><div class="line">		<span class="keyword">switch</span>(baseTexture-&gt;getTarget())</div><div class="line">		&#123;</div><div class="line">		<span class="keyword">case</span> GL_TEXTURE_2D:</div><div class="line">		&#123;</div><div class="line">			Texture2D *texture = <span class="keyword">static_cast</span>&lt;Texture2D*&gt;(baseTexture);</div><div class="line"></div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> mipmapLevel = <span class="number">0</span>; mipmapLevel &lt; sw::MIPMAP_LEVELS; mipmapLevel++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">int</span> surfaceLevel = mipmapLevel + baseLevel;</div><div class="line"></div><div class="line">				<span class="keyword">if</span>(surfaceLevel &gt; maxLevel)</div><div class="line">				&#123;</div><div class="line">					surfaceLevel = maxLevel;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				egl::Image *surface = texture-&gt;getImage(surfaceLevel);</div><div class="line">				device-&gt;setTextureLevel(sampler, <span class="number">0</span>, mipmapLevel, surface, sw::TEXTURE_2D);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">        ……</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x42-Calculate-texture’s-coordinate-in-VertexProcessor"><a href="#0x42-Calculate-texture’s-coordinate-in-VertexProcessor" class="headerlink" title="0x42 Calculate texture’s coordinate in VertexProcessor."></a>0x42 Calculate texture’s coordinate in VertexProcessor.</h2><p>It generate LLVM IR for texture coordinate calculation in vertex shader code.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> VertexProgram::program(UInt&amp; index)</div><div class="line">&#123;</div><div class="line">    ……</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; shader-&gt;getLength(); i++)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">const</span> Shader::Instruction *instruction = shader-&gt;getInstruction(i);</div><div class="line">		Shader::Opcode opcode = instruction-&gt;opcode;</div><div class="line">        ……</div><div class="line">    &#125;</div><div class="line">    ……</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x43-Clip-and-interpolate-texture-coordinate-in-SetupProcessor"><a href="#0x43-Clip-and-interpolate-texture-coordinate-in-SetupProcessor" class="headerlink" title="0x43 Clip and interpolate texture coordinate in SetupProcessor()"></a>0x43 Clip and interpolate texture coordinate in SetupProcessor()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> SetupRoutine::generate()</div><div class="line">&#123;</div><div class="line">    <span class="comment">// Culling</span></div><div class="line">	<span class="keyword">if</span>(solidTriangle)</div><div class="line">	&#123;</div><div class="line">        Float A = (y2 - y0) * x1 + (y1 - y2) * x0 + (y0 - y1) * x2; <span class="comment">// Area</span></div><div class="line"></div><div class="line">		If(A == <span class="number">0.0f</span>)</div><div class="line">		&#123;</div><div class="line">			Return(<span class="literal">false</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Int w0w1w2 = *Pointer&lt;Int&gt;(v0 + pos * <span class="number">16</span> + <span class="number">12</span>) ^</div><div class="line">				 *Pointer&lt;Int&gt;(v1 + pos * <span class="number">16</span> + <span class="number">12</span>) ^</div><div class="line">				 *Pointer&lt;Int&gt;(v2 + pos * <span class="number">16</span> + <span class="number">12</span>);</div><div class="line"></div><div class="line">		A = IfThenElse(w0w1w2 &lt; <span class="number">0</span>, -A, A);</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(state.cullMode == CULL_CLOCKWISE)</div><div class="line">		&#123;</div><div class="line">			If(A &gt;= <span class="number">0.0f</span>) Return(<span class="literal">false</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(state.cullMode == CULL_COUNTERCLOCKWISE)</div><div class="line">		&#123;</div><div class="line">			If(A &lt;= <span class="number">0.0f</span>) Return(<span class="literal">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    ……</div><div class="line">	Int n = *Pointer&lt;Int&gt;(polygon + OFFSET(Polygon,n));</div><div class="line">	Int m = *Pointer&lt;Int&gt;(polygon + OFFSET(Polygon,i));</div><div class="line"></div><div class="line">    If(m != <span class="number">0</span> || Bool(!solidTriangle))<span class="comment">// Clipped triangle</span></div><div class="line">	&#123;</div><div class="line">        ……</div><div class="line">        For(Int q = <span class="number">0</span>, q &lt; state.multiSample, q++)</div><div class="line">		&#123;</div><div class="line">            ……</div><div class="line">			Xq[n] = Xq[<span class="number">0</span>];</div><div class="line">			Yq[n] = Yq[<span class="number">0</span>];</div><div class="line"></div><div class="line">			<span class="comment">// Setup edge for Rasterize</span></div><div class="line">			&#123;</div><div class="line">				Int i = <span class="number">0</span>;</div><div class="line"></div><div class="line">                Do</div><div class="line">				&#123;</div><div class="line">					edge(primitive, data, Xq[i + <span class="number">1</span> - d], Yq[i + <span class="number">1</span> - d], Xq[i + d], Yq[i + d], q);</div><div class="line"></div><div class="line">					i++;</div><div class="line">				&#125;</div><div class="line">				Until(i &gt;= n)</div><div class="line">			&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">        </div><div class="line">    ……</div><div class="line">	<span class="keyword">if</span>(state.interpolateW)</div><div class="line">	&#123;</div><div class="line">        ……</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(state.interpolateZ)</div><div class="line">	&#123;</div><div class="line">        ……</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> interpolant = <span class="number">0</span>; interpolant &lt; MAX_FRAGMENT_INPUTS; interpolant++)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> component = <span class="number">0</span>; component &lt; <span class="number">4</span>; component++)</div><div class="line">		&#123;</div><div class="line">            <span class="keyword">int</span> attribute = state.gradient[interpolant][component].attribute;</div><div class="line">                </div><div class="line">			<span class="keyword">bool</span> flat = state.gradient[interpolant][component].flat;</div><div class="line">			<span class="keyword">bool</span> wrap = state.gradient[interpolant][component].wrap;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(attribute != Unused)</div><div class="line">			&#123;</div><div class="line">				setupGradient(primitive, tri, w012, M, v0, v1, v2, OFFSET(Vertex,v[attribute][component]), OFFSET(Primitive,V[interpolant][component]), flat, sprite, state.perspective, wrap, component);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x44-Pass-parameter-for-pixel-shader"><a href="#0x44-Pass-parameter-for-pixel-shader" class="headerlink" title="0x44 Pass parameter for pixel shader"></a>0x44 Pass parameter for pixel shader</h2><p> The parameter includes texture sampler and texture’s coordinate. These parameter is encapsulated in DrawData.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DrawData</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">const</span> Constants *constants;</div><div class="line">	<span class="keyword">const</span> <span class="keyword">void</span> *input[MAX_VERTEX_INPUTS];</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> stride[MAX_VERTEX_INPUTS];</div><div class="line">	Texture mipmap[TOTAL_IMAGE_UNITS];</div><div class="line">	<span class="keyword">const</span> <span class="keyword">void</span> *indices;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> Renderer::executeTask(<span class="keyword">int</span> threadIndex)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">switch</span>(task[threadIndex].type)</div><div class="line">	&#123;</div><div class="line">	    <span class="keyword">case</span> Task::PRIMITIVES:</div><div class="line">            ……</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> Task::PIXELS:</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">int</span> unit = task[threadIndex].primitiveUnit;</div><div class="line">				<span class="keyword">int</span> visible = primitiveProgress[unit].visible;</div><div class="line"></div><div class="line">				<span class="keyword">if</span>(visible &gt; <span class="number">0</span>)</div><div class="line">				&#123;</div><div class="line">					<span class="keyword">int</span> cluster = task[threadIndex].pixelCluster;</div><div class="line">					Primitive *primitive = primitiveBatch[unit];</div><div class="line">					DrawCall *draw = drawList[pixelProgress[cluster].drawCall &amp; DRAW_COUNT_BITS];</div><div class="line">					DrawData *data = draw-&gt;data;</div><div class="line">					PixelProcessor::RoutinePointer pixelRoutine = draw-&gt;pixelPointer;</div><div class="line"></div><div class="line">					pixelRoutine(primitive, visible, cluster, data);</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				finishRendering(task[threadIndex]);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">        ……</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">``` C++</div><div class="line"></div><div class="line">## <span class="number">0x45</span> Fetch pixel from texture</div><div class="line">PixelProgram fetch pixel from texture by passing the clipped <span class="keyword">and</span> interpolated texture coordinate. </div><div class="line">uvwq is the texture coordinate. the following code is executed in LLVM JIT.</div><div class="line"></div><div class="line">``` C++</div><div class="line">Vector4f PixelProgram::sampleTexture(<span class="keyword">int</span> samplerIndex, Vector4f &amp;uvwq, Float4 &amp;bias, Vector4f &amp;dsx, Vector4f &amp;dsy, Vector4f &amp;offset, SamplerFunction function)</div><div class="line">&#123;</div><div class="line">	</div><div class="line">	Pointer&lt;Byte&gt; texture = data + OFFSET(DrawData, mipmap) + samplerIndex * <span class="keyword">sizeof</span>(Texture);</div><div class="line">	Vector4f c = SamplerCore(constants, state.sampler[samplerIndex]).sampleTexture(texture, uvwq.x, uvwq.y, uvwq.z, uvwq.w, bias, dsx, dsy, offset, function);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> c;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Here is the detail texture sample algorithm, from the following code, we can see SwiftShader uses Bilinear interpolation to sample the texture.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">Vector4s SamplerCore::sampleQuad2D(Pointer&lt;Byte&gt; &amp;texture, Float4 &amp;u, Float4 &amp;v, Float4 &amp;w, Vector4f &amp;offset, Float &amp;lod, Int face[<span class="number">4</span>], <span class="keyword">bool</span> secondLOD, SamplerFunction function)</div><div class="line">&#123;</div><div class="line">	<span class="comment">// Bilinear interpolation</span></div><div class="line">	<span class="keyword">if</span>(componentCount &gt;= <span class="number">1</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span>(has16bitTextureComponents() &amp;&amp; hasUnsignedTextureComponent(<span class="number">0</span>))</div><div class="line">		&#123;</div><div class="line">			c0.x = As&lt;UShort4&gt;(c0.x) - MulHigh(As&lt;UShort4&gt;(c0.x), f0u) + MulHigh(As&lt;UShort4&gt;(c1.x), f0u);</div><div class="line">			c2.x = As&lt;UShort4&gt;(c2.x) - MulHigh(As&lt;UShort4&gt;(c2.x), f0u) + MulHigh(As&lt;UShort4&gt;(c3.x), f0u);</div><div class="line">			c.x  = As&lt;UShort4&gt;(c0.x) - MulHigh(As&lt;UShort4&gt;(c0.x), f0v) + MulHigh(As&lt;UShort4&gt;(c2.x), f0v);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span>(hasUnsignedTextureComponent(<span class="number">0</span>))</div><div class="line">			&#123;</div><div class="line">				c0.x = MulHigh(As&lt;UShort4&gt;(c0.x), f1u1v);</div><div class="line">				c1.x = MulHigh(As&lt;UShort4&gt;(c1.x), f0u1v);</div><div class="line">				c2.x = MulHigh(As&lt;UShort4&gt;(c2.x), f1u0v);</div><div class="line">				c3.x = MulHigh(As&lt;UShort4&gt;(c3.x), f0u0v);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				c0.x = MulHigh(c0.x, f1u1vs);</div><div class="line">				c1.x = MulHigh(c1.x, f0u1vs);</div><div class="line">				c2.x = MulHigh(c2.x, f1u0vs);</div><div class="line">				c3.x = MulHigh(c3.x, f0u0vs);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">            c.x = (c0.x + c1.x) + (c2.x + c3.x);</div><div class="line">			<span class="keyword">if</span>(!hasUnsignedTextureComponent(<span class="number">0</span>)) c.x = AddSat(c.x, c.x);<span class="comment">// Correct for signed fractions</span></div><div class="line">	    &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/01/learning-rate-in-neural-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/01/learning-rate-in-neural-network/" itemprop="url">learning rate in neural network</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-01T20:58:40+08:00">
                2018-04-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/04/01/learning-rate-in-neural-network/" class="leancloud_visitors" data-flag-title="learning rate in neural network">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-学习率简介"><a href="#0x1-学习率简介" class="headerlink" title="0x1 学习率简介"></a>0x1 学习率简介</h1><p>学习率是一个重要的超参数，在大多数神经网络优化算法（如SGD、Adam）中都会用到，它控制着我们基于损失梯度调整神经网络权值的速度。如果学习率过大，可能会错过最小值，并且可能造成不能收敛，损失在某一个值附近反复震荡。如果学习率过小，我们沿着损失梯度下降的速度就很慢，收敛的速度也很慢。</p>
<p>神经网络优化算法的功能是，控制方差，寻找最小值，更新模型参数，最终使模型收敛。<br>神经网络更新参数的公式为：θ=θ−η×∇(θ).J(θ)，其中η是学习率，∇(θ).J(θ)是损失函数J(θ)的梯度。</p>
<p>学习率是神经网络中难以设置的超参数之一，它对模型的性能有很大的影响。目前出现了很多自适应学习率算法，如下文测试中用到的Adam。在下面的测试中发现，虽然Adam会在优化的过程中动态调整学习率，初始的学习率设置还是会对模型的准确率有很大影响。</p>
<h1 id="0x2-构造计算图"><a href="#0x2-构造计算图" class="headerlink" title="0x2 构造计算图"></a>0x2 构造计算图</h1><p>用python编写tensorflow测试代码，构造如下图所示的卷积神经网络，用来对MNIST数据集进行0～9分类。</p>
<p>从下图神经网络图可知，首先载入MNIST数据，然后进行处理，包括卷积层layer1, 卷积层layer2, 接下来是一个全连接层fc_layer, 接下来是dropout层，最后连接上softmax层layer3, 得到概率输出。</p>
<p>优化算法采用Adam，在设置Adam优化器的时候设置需要初始学习率，其代码如下。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">train_step = tf.train.AdamOptimizer(learning_rate).minimize(cross_entropy)</div></pre></td></tr></table></figure></p>
<p>总体网络图如下<br><img src="/2018/04/01/learning-rate-in-neural-network/computation graph.png" alt="computation_graph"><br>layer1内部结构如下所示<br>首先初始化权重和偏置参数。然后使用conv2d进行卷积操作并加上偏置，卷积参数为[5, 5, 1, 32], 代表卷积核的大小为5x5, 1个颜色通道，32个不同的卷积核。然后使用relu激活函数进行非线性化处理。然后使用池化函数对卷积的结果进行1/2下采样处理，MNIST数据中图片大小为28x28，经过下采样以后变为14x14。<br><img src="/2018/04/01/learning-rate-in-neural-network/layer1.png" alt="layer1"><br>layer2内部结构如下所示<br>和layer1结构类似，只是卷积参数设置为[5, 5, 32, 64]，因为layer1中经过32个不同卷积核的处理，所以每个数据的通道变成了32，另外卷积核的数量变成64，经过池化函数以后，数据由14x14变成7x7。<br><img src="/2018/04/01/learning-rate-in-neural-network/layer2.png" alt="layer2"><br>后面再连接一个全连接层fc_layer，输出为1024个隐含节点，并使用relu激活函数。</p>
<p>下面是dropout层，使用keep_prob参数来控制以减轻过拟合。</p>
<p>接下来是layer3层，首先把1024个隐含节点通过矩阵变换转换成10个节点，矩阵变换的参数是权重参数和偏置参数，然后再连接softmax函数，得到对应数字0~9的概率输出。</p>
<p>优化器是Adam，该优化器对定义好的损失函数进行优化。</p>
<h1 id="0x3-高学习率的测试结果"><a href="#0x3-高学习率的测试结果" class="headerlink" title="0x3 高学习率的测试结果"></a>0x3 高学习率的测试结果</h1><p>这个时候初始学习率被设置为0.5，从训练集上的测试准确率上来看，准确率是很低的，在0.05～0.15之间来回震荡。<br><img src="/2018/04/01/learning-rate-in-neural-network/high_learning_rate.png" alt="high_learning_rate"></p>
<h1 id="0x4-低学习率的测试结果"><a href="#0x4-低学习率的测试结果" class="headerlink" title="0x4 低学习率的测试结果"></a>0x4 低学习率的测试结果</h1><p>这个时候初始学习率被设置为0.001，从训练集上的测试准确率上来看，准确率是慢慢升高的，最后稳定在0.95以上。<br><img src="/2018/04/01/learning-rate-in-neural-network/low_learning_rate.png" alt="low_learning_rate"></p>
<h1 id="0x5-Adam优化器"><a href="#0x5-Adam优化器" class="headerlink" title="0x5 Adam优化器"></a>0x5 Adam优化器</h1><p>通过gdb调试可知，tensorflow中Adam优化器调用堆栈如下。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">(gdb) bt</div><div class="line">#0  tensorflow::functor::ApplyAdamNonCuda&lt;Eigen::ThreadPoolDevice, float&gt;::operator()(Eigen::ThreadPoolDevice const&amp;, Eigen::TensorMap&lt;Eigen::Tensor&lt;float, 1, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::Tensor&lt;float, 1, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::Tensor&lt;float, 1, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::TensorFixedSize&lt;float const, Eigen::Sizes&lt;&gt;, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::TensorFixedSize&lt;float const, Eigen::Sizes&lt;&gt;, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::TensorFixedSize&lt;float const, Eigen::Sizes&lt;&gt;, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::TensorFixedSize&lt;float const, Eigen::Sizes&lt;&gt;, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::TensorFixedSize&lt;float const, Eigen::Sizes&lt;&gt;, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::TensorFixedSize&lt;float const, Eigen::Sizes&lt;&gt;, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::Tensor&lt;float const, 1, 1, long&gt;, 16, Eigen::MakePointer&gt;, bool) (this=0x7fffc58d8260, d=..., var=..., m=..., v=..., beta1_power=..., </div><div class="line">    beta2_power=..., lr=..., beta1=..., beta2=..., epsilon=..., grad=..., use_nesterov=false) at tensorflow/core/kernels/training_ops.cc:293</div><div class="line">#1  0x00007fffede52e6d in tensorflow::ApplyAdamOp&lt;Eigen::ThreadPoolDevice, float&gt;::Compute (this=0x555558f61cf0, ctx=0x7fffc58d8840)</div><div class="line">    at tensorflow/core/kernels/training_ops.cc:2523</div><div class="line">#2  0x00007fffe6a2e91b in tensorflow::ThreadPoolDevice::Compute (this=0x555557f25fa0, op_kernel=0x555558f61cf0, context=0x7fffc58d8840)</div><div class="line">    at tensorflow/core/common_runtime/threadpool_device.cc:59</div><div class="line">#3  0x00007fffe69c9c0a in tensorflow::(anonymous namespace)::ExecutorState::Process (this=0x55555945b6c0, tagged_node=..., scheduled_usec=0)</div><div class="line">    at tensorflow/core/common_runtime/executor.cc:1652</div><div class="line">#4  0x00007fffe69d81a7 in std::_Mem_fn_base&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long), true&gt;::operator()&lt;tensorflow::(anonymous namespace)::ExecutorState::TaggedNode&amp;, long long&amp;, void&gt; (</div><div class="line">    this=0x7fff8c04b440, __object=0x55555945b6c0) at /usr/include/c++/5/functional:600</div><div class="line">#5  0x00007fffe69d7c62 in std::_Bind&lt;std::_Mem_fn&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;(tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;::__call&lt;void, 0ul, 1ul, 2ul&gt;(&lt;unknown type in /home/kevin/anaconda3/lib/python3.6/site-packages/tensorflow/python/../libtensorflow_framework.so, CU 0x314f884, DIE 0x31e50c1&gt;, std::_Index_tuple&lt;0ul, 1ul, 2ul&gt;) (this=0x7fff8c04b440, </div><div class="line">    __args=&lt;unknown type in /home/kevin/anaconda3/lib/python3.6/site-packages/tensorflow/python/../libtensorflow_framework.so, CU 0x314f884, DIE 0x31e50c1&gt;) at /usr/include/c++/5/functional:1074</div><div class="line">#6  0x00007fffe69d5a06 in std::_Bind&lt;std::_Mem_fn&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;(tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;::operator()&lt;, void&gt;(void) (this=0x7fff8c04b440) at /usr/include/c++/5/functional:1133</div><div class="line">#7  0x00007fffe69d32ac in std::_Function_handler&lt;void(), std::_Bind&lt;std::_Mem_fn&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;(tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt; &gt;::_M_invoke(const std::_Any_data &amp;) (__functor=...)</div><div class="line">    at /usr/include/c++/5/functional:1871</div><div class="line">#8  0x00007fffe6297984 in std::function&lt;void ()&gt;::operator()() const (this=0x7fff8c04a930) at /usr/include/c++/5/functional:2267</div><div class="line">#9  0x00007fffe64afb9e in tensorflow::thread::EigenEnvironment::ExecuteTask (this=0x555557f5ca48, t=...)</div><div class="line">    at tensorflow/core/lib/core/threadpool.cc:81</div><div class="line">#10 0x00007fffe64b265c in Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::WorkerLoop (this=0x555557f5ca40, </div><div class="line">    thread_id=1) at external/eigen_archive/unsupported/Eigen/CXX11/src/ThreadPool/NonBlockingThreadPool.h:232</div><div class="line">#11 0x00007fffe64b0aae in Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::NonBlockingThreadPoolTempl(int, bool, tensorflow::thread::EigenEnvironment)::&#123;lambda()#1&#125;::operator()() const ()</div><div class="line">    at external/eigen_archive/unsupported/Eigen/CXX11/src/ThreadPool/NonBlockingThreadPool.h:65</div><div class="line">#12 0x00007fffe64b3c7c in std::_Function_handler&lt;void (), Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::NonBlockingThreadPoolTempl(int, bool, tensorflow::thread::EigenEnvironment)::&#123;lambda()#1&#125;&gt;::_M_invoke(std::_Any_data const&amp;) (__functor=...)</div><div class="line">    at /usr/include/c++/5/functional:1871</div><div class="line">#13 0x00007fffe6297984 in std::function&lt;void ()&gt;::operator()() const (this=0x555557f6d0b0) at /usr/include/c++/5/functional:2267</div><div class="line">#14 0x00007fffe64af907 in tensorflow::thread::EigenEnvironment::CreateThread(std::function&lt;void ()&gt;)::&#123;lambda()#1&#125;::operator()() const (</div><div class="line">    __closure=0x555557f6d0b0) at tensorflow/core/lib/core/threadpool.cc:56</div><div class="line">#15 0x00007fffe64b18d8 in std::_Function_handler&lt;void (), tensorflow::thread::EigenEnvironment::CreateThread(std::function&lt;void ()&gt;)::&#123;lambda()#1&#125;&gt;::_M_invoke(std::_Any_data const&amp;) (__functor=...) at /usr/include/c++/5/functional:1871</div><div class="line">#16 0x00007fffe6297984 in std::function&lt;void ()&gt;::operator()() const (this=0x555557f6d108) at /usr/include/c++/5/functional:2267</div><div class="line">#17 0x00007fffe64f4f38 in std::_Bind_simple&lt;std::function&lt;void ()&gt; ()&gt;::_M_invoke&lt;&gt;(std::_Index_tuple&lt;&gt;) (this=0x555557f6d108)</div><div class="line">    at /usr/include/c++/5/functional:1531</div><div class="line">#18 0x00007fffe64f4ea1 in std::_Bind_simple&lt;std::function&lt;void ()&gt; ()&gt;::operator()() (this=0x555557f6d108)</div><div class="line">    at /usr/include/c++/5/functional:1520</div><div class="line">#19 0x00007fffe64f4e40 in std::thread::_Impl&lt;std::_Bind_simple&lt;std::function&lt;void ()&gt; ()&gt; &gt;::_M_run() (this=0x555557f6d0f0)</div><div class="line">    at /usr/include/c++/5/thread:115</div><div class="line">#20 0x00007fffe5067c80 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6</div><div class="line">#21 0x00007ffff7bc16ba in start_thread (arg=0x7fffc58d9700) at pthread_create.c:333</div><div class="line">#22 0x00007ffff78f741d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109</div></pre></td></tr></table></figure></p>
<p>tensorflow中Adam优化器更新参数的代码如下。<br>tensorflow/core/kernels/training_ops.cc<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Device, <span class="keyword">typename</span> T&gt;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ApplyAdamNonCuda</span> &#123;</span></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">const</span> Device&amp; d, <span class="keyword">typename</span> TTypes&lt;T&gt;::Flat var,</span></span></div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::Flat m, <span class="keyword">typename</span> TTypes&lt;T&gt;::Flat v,</div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::ConstScalar beta1_power,</div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::ConstScalar beta2_power,</div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::ConstScalar lr,</div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::ConstScalar beta1,</div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::ConstScalar beta2,</div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::ConstScalar epsilon,</div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::ConstFlat grad, <span class="keyword">bool</span> use_nesterov) &#123;</div><div class="line">    <span class="keyword">const</span> T alpha = lr() * Eigen::numext::<span class="built_in">sqrt</span>(T(<span class="number">1</span>) - beta2_power()) /</div><div class="line">                    (T(<span class="number">1</span>) - beta1_power());</div><div class="line">    <span class="comment">// beta1 == μ</span></div><div class="line">    <span class="comment">// beta2 == ν</span></div><div class="line">    <span class="comment">// v     == n</span></div><div class="line">    <span class="comment">// var   == θ</span></div><div class="line"></div><div class="line">    m.device(d) += (grad - m) * (T(<span class="number">1</span>) - beta1());</div><div class="line">    v.device(d) += (grad.square() - v) * (T(<span class="number">1</span>) - beta2());</div><div class="line">    <span class="keyword">if</span> (use_nesterov) &#123;</div><div class="line">      var.device(d) -= ((grad * (T(<span class="number">1</span>) - beta1()) + beta1() * m) * alpha) /</div><div class="line">                       (v.<span class="built_in">sqrt</span>() + epsilon());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      var.device(d) -= (m * alpha) / (v.<span class="built_in">sqrt</span>() + epsilon());</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>算法描述如下<br>如下所示，虽然在Adam算法中，学习率lr_t是动态调整的，但是也是和初始设置的学习率learning_rate有关，如果learning_rate设置不当，也会影响训练模型的收敛。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">t &lt;- t + 1</div><div class="line">lr_t &lt;- learning_rate * sqrt(1 - beta2^t) / (1 - beta1^t)//计算动态学习率</div><div class="line"></div><div class="line">m_t &lt;- beta1 * m_&#123;t-1&#125; + (1 - beta1) * g</div><div class="line">v_t &lt;- beta2 * v_&#123;t-1&#125; + (1 - beta2) * g * g</div><div class="line">variable &lt;- variable - lr_t * m_t / (sqrt(v_t) + epsilon)//更新参数</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/25/douyin-streaming-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/25/douyin-streaming-analysis/" itemprop="url">douyin streaming analysis</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-25T22:11:03+08:00">
                2018-03-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/03/25/douyin-streaming-analysis/" class="leancloud_visitors" data-flag-title="douyin streaming analysis">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-简介"><a href="#0x1-简介" class="headerlink" title="0x1    简介"></a>0x1    简介</h1><p>抖音是最近火热的短视频app, 本文通过抓包来分析douyin的在线视频播放过程。<br>通过分析，可以知道其播放流程如下，<br><img src="/2018/03/25/douyin-streaming-analysis/architecture.png" alt="architecture"><br>server是指保存用户上传内容(UGC)的服务器，客户端连接到该服务器下载需要播放的内容。</p>
<p>其它三个模块(downloader, local streamer, local player)都是在客户端实现的, 其中downloader负责把数据从远端server下载下来，并把下载下来的数据送给local streamer进行本地streaming, 然后local player连接到local streamer来得到需要播放的数据进行播放。通过下面的抓包分析可知，downloader是通过http协议来从远端server下载数据，local streamer也是通过提供本地http服务把播放数据提供给local player.</p>
<p>下面分析android平台上douyin下载数据并播放的过程。</p>
<h1 id="0x2-下载"><a href="#0x2-下载" class="headerlink" title="0x2  下载"></a>0x2  下载</h1><h2 id="0x21-dns查询服务器的ip地址"><a href="#0x21-dns查询服务器的ip地址" class="headerlink" title="0x21 dns查询服务器的ip地址"></a>0x21 dns查询服务器的ip地址</h2><p>通过dns查询v1-dy.ixiguavideo.com的ip地址，这一步是为后面的http连接服务的。<br>如下图所示，第49号包是发送dns查询请求，第56号包是返回dns查询结果。<br><img src="/2018/03/25/douyin-streaming-analysis/dns.png" alt="dns"></p>
<p>dns查询结果如下，可以看到对应服务器的ip地址, 其中返回好几个ip地址，下面的http连接采用的是第一个ip地址。<br><img src="/2018/03/25/douyin-streaming-analysis/dns_result.png" alt="dns_result"></p>
<h2 id="0x22-http连接到服务器并下载数据"><a href="#0x22-http连接到服务器并下载数据" class="headerlink" title="0x22 http连接到服务器并下载数据"></a>0x22 http连接到服务器并下载数据</h2><p>如下所示，通过http连接到服务器。<br>可以看到http url如下, 这个地址是经过加密的，直接在浏览器中去访问是连接不上去的。<br><a href="http://v1-dy.ixiguavideo.com/9980b014844ac5185d899a1af1e41554/5acf7425/video/m/220fea4bc73a1c54023a9819c71b52a9b3e115640520000a8c154141acc/?device_platform=android&amp;device_type=myandroid&amp;version_code=179" target="_blank" rel="external">http://v1-dy.ixiguavideo.com/9980b014844ac5185d899a1af1e41554/5acf7425/video/m/220fea4bc73a1c54023a9819c71b52a9b3e115640520000a8c154141acc/?device_platform=android&amp;device_type=myandroid&amp;version_code=179</a><br><img src="/2018/03/25/douyin-streaming-analysis/connection.png" alt="http_connection"></p>
<p>然后可以看到客户端不停地从服务器上下载数据。<br><img src="/2018/03/25/douyin-streaming-analysis/download.png" alt="http_download"></p>
<h1 id="0x3-播放"><a href="#0x3-播放" class="headerlink" title="0x3  播放"></a>0x3  播放</h1><p>下载过程中，启动本地http服务, 播放器通过访问这个http服务来得到播放数据，<br>前面三个包(1130, 1131, 1132)是三次握手的过程。<br>后面的包是发送给播放器的播放数据。<br><img src="/2018/03/25/douyin-streaming-analysis/local_playback.png" alt="http_playback"></p>
<p>下面是douyin app中的lib，从其中可以看到其播放架构是基于ffmpeg实现的。通过分析可知，这里面有好几个库都包括了ffmpeg的代码，感觉模块之间划分不是很清楚，代码有冗余。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">libaudiocore.so             libdaemon.so          libijkffmpeg.so      libst_mobile.so     libttnativecrash.so</div><div class="line">libaudiofp.so               libdys.so             libijkplayer.so      libstatic-webp.so   libttvideouploader.so</div><div class="line">libbdEASRAndroid.v1<span class="number">.5</span><span class="number">.6</span>.so  libeffect.so          libijksdl.so         libsupervisor.so    libuserinfo.so</div><div class="line">libbspatch.so               libffmpeg.so          libimagepipeline.so  libtnet<span class="number">-3.1</span><span class="number">.11</span>.so   libweibosdkcore.so</div><div class="line">libBugly.so                 libffmpeg-invoker.so  liblivestream.so     libtongdun.so       libyuv.so</div><div class="line">libcocklogic<span class="number">-1.1</span><span class="number">.3</span>.so       libffmpeg-main.so     libmain.so           libttEncrypt.so</div><div class="line">libcrashlytics.so           libgif.so             libNailSLAM_jni.so   libttmplayer.so</div><div class="line">libcrashlytics-envelope.so  libgifimage.so        libSDL2.so           libttmplayer_mc.so</div></pre></td></tr></table></figure>
<p>其中libeffect.so实现了对用户拍摄好的视频内容进行编辑，加特效等工作，如下所示，其中包括了CV相关的代码。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="number">00493</span>ecd T cvGetImage</div><div class="line"><span class="number">00494511</span> T cvGetImageCOI</div><div class="line"><span class="number">0049439</span>d T cvGetImageROI</div><div class="line"><span class="number">00491261</span> T cvGetMat</div><div class="line"><span class="number">0048f</span>e41 T cvGetND</div><div class="line"><span class="number">0053</span>d33d T cvGetNumThreads</div><div class="line"><span class="number">004b</span>a981 T cvGetOptimalDFTSize</div><div class="line"><span class="number">0041f</span>609 T cvGetPerspectiveTransform</div><div class="line"><span class="number">0048f</span>4f5 T cvGetRawData</div><div class="line"><span class="number">0048f</span>ea1 T cvGetReal1D</div><div class="line"><span class="number">004900</span>d9 T cvGetReal2D</div><div class="line"><span class="number">00545685</span> T cvGetRootFileNode</div><div class="line"><span class="number">00490321</span> T cvGetReal3D</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/19/analysis-of-ijkplayer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/19/analysis-of-ijkplayer/" itemprop="url">ijkplayer介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-19T22:12:28+08:00">
                2018-03-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/03/19/analysis-of-ijkplayer/" class="leancloud_visitors" data-flag-title="ijkplayer介绍">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-系统架构"><a href="#0x1-系统架构" class="headerlink" title="0x1    系统架构"></a>0x1    系统架构</h1><p>ijkplayer是由b站开源的播放器项目，底层基于ffmpeg, 支持Android和iOS。下面我们来简单介绍一下Android上的实现。<br>Android上的系统架构图如下。<br><img src="/2018/03/19/analysis-of-ijkplayer/architecture.png" alt="architecture"><br>下面分别对各个模块进行介绍。<br>ijkplayer-example是app的实现，主要是ui逻辑的实现，包括activity的实现，ui控件的组织，窗口的定制，数据的存储。<br>ijkplayer-example通过调用ijkmediaplayer，android mediaplayer， google exoplayer这三种mediaplayer来实现媒体播放。<br>ijkplayer-java是对底层实现的ijkmediaplayer和android mediaplayer的java封装，对ijkmediaplayer的封装是通过调用底层jni对应的java接口，对android mediaplayer的封装是调用android系统实现的默认mediaplayer接口。<br>ijkplayer-exo是对google exoplayer的封装，除了android默认的播放器之外，ExoPlayer是Google提供的在android平台上的另外一种播放器。<br>libijkplayer提供了ijkmediaplayer的jni实现ijkplayer_jni.c，然后调用封装过的ffplayer.c, 再调用底层实现的解码库libijkffmpeg和显示库libijksdl。<br>libijkffmpeg实现了媒体文件的demux, decode等功能。<br>libijksdl实现对解码后的数据进行显示。</p>
<h1 id="0x2-Java层关键模块分析"><a href="#0x2-Java层关键模块分析" class="headerlink" title="0x2   Java层关键模块分析"></a>0x2   Java层关键模块分析</h1><h2 id="0x21-三种不同的mediaplayer实现"><a href="#0x21-三种不同的mediaplayer实现" class="headerlink" title="0x21 三种不同的mediaplayer实现."></a>0x21 三种不同的mediaplayer实现.</h2><p>这三种mediaplayer的类图如下图所示。<br><img src="/2018/03/19/analysis-of-ijkplayer/mediaplayer.png" alt="mediaplayers"><br>AndroidMediaPlayer是对Andoid默认播放器的封装。<br>IjkMediaPlayer是基于ffmpeg的播放器实现。<br>IjkExoMediaPlayer是基于Goodle开源的ExoPlayer的封装。</p>
<h2 id="0x22-设置不同的Render"><a href="#0x22-设置不同的Render" class="headerlink" title="0x22    设置不同的Render"></a>0x22    设置不同的Render</h2><p>不同Render的类图如下图所示。<br><img src="/2018/03/19/analysis-of-ijkplayer/render.png" alt="renders"><br>SurfaceRenderView是基于SurfaceView的显示实现。<br>TextureRenderView是基于TextureView的显示实现。<br>上述两种显示实现方式都实现了接口IRenderView。</p>
<h2 id="0x23-IjkMediaPlayer的JNI接口"><a href="#0x23-IjkMediaPlayer的JNI接口" class="headerlink" title="0x23    IjkMediaPlayer的JNI接口"></a>0x23    IjkMediaPlayer的JNI接口</h2><p>详细的JNI接口如下图所示。<br> <img src="/2018/03/19/analysis-of-ijkplayer/jni.png" alt="jni"><br>这些JNI接口提供了播放器的基本接口，包括播放准备(_setDataSource, _setVideoSurface, setVolume，_prepareAsync), 播放控制(_start, _stop, seekTo，_release， _reset)等功能。</p>
<h1 id="0x3-关键流程"><a href="#0x3-关键流程" class="headerlink" title="0x3    关键流程"></a>0x3    关键流程</h1><h2 id="0x31-设置surface"><a href="#0x31-设置surface" class="headerlink" title="0x31    设置surface"></a>0x31    设置surface</h2><p>设置surface的流程图如下图所示。<br><img src="/2018/03/19/analysis-of-ijkplayer/setsurface.png" alt="setsurface"><br>从上面的流程图可知，通过接口_setVideoSurface(), 把UI层的Surface对象(可以理解为显示窗口)设置给SDL显示对象，作为其显示窗口(native_window), 这样SDL有需要显示的内容可以直接在这个显示窗口上显示输出即可。</p>
<h2 id="0x32-显示流程"><a href="#0x32-显示流程" class="headerlink" title="0x32    显示流程"></a>0x32    显示流程</h2><p>显示的流程图如下图所示。<br><img src="/2018/03/19/analysis-of-ijkplayer/display.png" alt="display"><br>下面对上面的流程图简单说明。<br>解码线程ffp_video_thread解码完成以后，调用接口queue_picture把需要显示的buffer往SDL模块发送。<br>然后调用func_fill_frame()填充显示buffer, 这个时候需要判断是通过ffmpeg还是mediacodec实现的解码。<br>如果是ffmpeg实现的话则调用ijksdl_vout_overlay_ffmpeg.c中的函数func_fill_frame()。<br>否则调用ijksdl_vout_overlay_android_mediacodec.c中的func_fill_frame()。<br>然后显示线程video_refresh_thread就可以开始显示了。如果是GPU支持的格式则调用GPU进行输出，这个时候调用的是IJK_EGL_display，否则调用ANativeWindow_lock和ANativeWindow_unlockAndPost进行输出。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Kevin Wen" />
          <p class="site-author-name" itemprop="name">Kevin Wen</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">38</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kevin Wen</span>
</div>


<div> <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
访问量 <span id="busuanzi_value_site_pv"></span>
访问人数 <span id="busuanzi_value_site_uv"></span>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("orq8xxsDQDXKiHdqSRcjlflB-gzGzoHsz", "ecCFdIcWDfbJKQOCiLFf1EBm");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
