<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="Kevin Wen&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Kevin Wen&#39;s Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kevin Wen&#39;s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>Kevin Wen's Blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kevin Wen's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/25/douyin-streaming-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/25/douyin-streaming-analysis/" itemprop="url">douyin streaming analysis</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-25T22:11:03+09:00">
                2018-03-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/03/25/douyin-streaming-analysis/" class="leancloud_visitors" data-flag-title="douyin streaming analysis">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-简介"><a href="#0x1-简介" class="headerlink" title="0x1    简介"></a>0x1    简介</h1><p>抖音是最近火热的短视频app, 本文通过抓包来分析douyin的在线视频播放过程。<br>通过分析，可以知道其播放流程如下，<br><img src="/2018/03/25/douyin-streaming-analysis/architecture.png" alt="architecture"><br>server是指保存用户上传内容(UGC)的服务器，客户端连接到该服务器下载需要播放的内容。</p>
<p>其它三个模块(downloader, local streamer, local player)都是在客户端实现的, 其中downloader负责把数据从远端server下载下来，并把下载下来的数据送给local streamer进行本地streaming, 然后local player连接到local streamer来得到需要播放的数据进行播放。通过下面的抓包分析可知，downloader是通过http协议来从远端server下载数据，local streamer也是通过提供本地http服务把播放数据提供给local player.</p>
<p>下面分析android平台上douyin下载数据并播放的过程。</p>
<h1 id="0x2-下载"><a href="#0x2-下载" class="headerlink" title="0x2  下载"></a>0x2  下载</h1><h2 id="0x21-dns查询服务器的ip地址"><a href="#0x21-dns查询服务器的ip地址" class="headerlink" title="0x21 dns查询服务器的ip地址"></a>0x21 dns查询服务器的ip地址</h2><p>通过dns查询v1-dy.ixiguavideo.com的ip地址，这一步是为后面的http连接服务的。<br>如下图所示，第49号包是发送dns查询请求，第56号包是返回dns查询结果。<br><img src="/2018/03/25/douyin-streaming-analysis/dns.png" alt="dns"></p>
<p>dns查询结果如下，可以看到对应服务器的ip地址, 其中返回好几个ip地址，下面的http连接采用的是第一个ip地址。<br><img src="/2018/03/25/douyin-streaming-analysis/dns_result.png" alt="dns_result"></p>
<h2 id="0x22-http连接到服务器并下载数据"><a href="#0x22-http连接到服务器并下载数据" class="headerlink" title="0x22 http连接到服务器并下载数据"></a>0x22 http连接到服务器并下载数据</h2><p>如下所示，通过http连接到服务器。<br>可以看到http url如下, 这个地址是经过加密的，直接在浏览器中去访问是连接不上去的。<br><a href="http://v1-dy.ixiguavideo.com/9980b014844ac5185d899a1af1e41554/5acf7425/video/m/220fea4bc73a1c54023a9819c71b52a9b3e115640520000a8c154141acc/?device_platform=android&amp;device_type=myandroid&amp;version_code=179" target="_blank" rel="external">http://v1-dy.ixiguavideo.com/9980b014844ac5185d899a1af1e41554/5acf7425/video/m/220fea4bc73a1c54023a9819c71b52a9b3e115640520000a8c154141acc/?device_platform=android&amp;device_type=myandroid&amp;version_code=179</a><br><img src="/2018/03/25/douyin-streaming-analysis/connection.png" alt="http_connection"></p>
<p>然后可以看到客户端不停地从服务器上下载数据。<br><img src="/2018/03/25/douyin-streaming-analysis/download.png" alt="http_download"></p>
<h1 id="0x3-播放"><a href="#0x3-播放" class="headerlink" title="0x3  播放"></a>0x3  播放</h1><p>下载过程中，启动本地http服务, 播放器通过访问这个http服务来得到播放数据，<br>前面三个包(1130, 1131, 1132)是三次握手的过程。<br>后面的包是发送给播放器的播放数据。<br><img src="/2018/03/25/douyin-streaming-analysis/local_playback.png" alt="http_playback"></p>
<p>下面是douyin app中的lib，从其中可以看到其播放架构是基于ffmpeg实现的。通过分析可知，这里面有好几个库都包括了ffmpeg的代码，感觉模块之间划分不是很清楚，代码有冗余。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">libaudiocore.so             libdaemon.so          libijkffmpeg.so      libst_mobile.so     libttnativecrash.so</div><div class="line">libaudiofp.so               libdys.so             libijkplayer.so      libstatic-webp.so   libttvideouploader.so</div><div class="line">libbdEASRAndroid.v1<span class="number">.5</span><span class="number">.6</span>.so  libeffect.so          libijksdl.so         libsupervisor.so    libuserinfo.so</div><div class="line">libbspatch.so               libffmpeg.so          libimagepipeline.so  libtnet<span class="number">-3.1</span><span class="number">.11</span>.so   libweibosdkcore.so</div><div class="line">libBugly.so                 libffmpeg-invoker.so  liblivestream.so     libtongdun.so       libyuv.so</div><div class="line">libcocklogic<span class="number">-1.1</span><span class="number">.3</span>.so       libffmpeg-main.so     libmain.so           libttEncrypt.so</div><div class="line">libcrashlytics.so           libgif.so             libNailSLAM_jni.so   libttmplayer.so</div><div class="line">libcrashlytics-envelope.so  libgifimage.so        libSDL2.so           libttmplayer_mc.so</div></pre></td></tr></table></figure>
<p>其中libeffect.so实现了对用户拍摄好的视频内容进行编辑，加特效等工作，如下所示，其中包括了CV相关的代码。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="number">00493</span>ecd T cvGetImage</div><div class="line"><span class="number">00494511</span> T cvGetImageCOI</div><div class="line"><span class="number">0049439</span>d T cvGetImageROI</div><div class="line"><span class="number">00491261</span> T cvGetMat</div><div class="line"><span class="number">0048f</span>e41 T cvGetND</div><div class="line"><span class="number">0053</span>d33d T cvGetNumThreads</div><div class="line"><span class="number">004b</span>a981 T cvGetOptimalDFTSize</div><div class="line"><span class="number">0041f</span>609 T cvGetPerspectiveTransform</div><div class="line"><span class="number">0048f</span>4f5 T cvGetRawData</div><div class="line"><span class="number">0048f</span>ea1 T cvGetReal1D</div><div class="line"><span class="number">004900</span>d9 T cvGetReal2D</div><div class="line"><span class="number">00545685</span> T cvGetRootFileNode</div><div class="line"><span class="number">00490321</span> T cvGetReal3D</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/19/analysis-of-ijkplayer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/19/analysis-of-ijkplayer/" itemprop="url">ijkplayer介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-19T22:12:28+09:00">
                2018-03-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/03/19/analysis-of-ijkplayer/" class="leancloud_visitors" data-flag-title="ijkplayer介绍">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-系统架构"><a href="#0x1-系统架构" class="headerlink" title="0x1    系统架构"></a>0x1    系统架构</h1><p>ijkplayer是由b站开源的播放器项目，底层基于ffmpeg, 支持Android和iOS。下面我们来简单介绍一下Android上的实现。<br>Android上的系统架构图如下。<br><img src="/2018/03/19/analysis-of-ijkplayer/architecture.png" alt="architecture"><br>下面分别对各个模块进行介绍。<br>ijkplayer-example是app的实现，主要是ui逻辑的实现，包括activity的实现，ui控件的组织，窗口的定制，数据的存储。<br>ijkplayer-example通过调用ijkmediaplayer，android mediaplayer， google exoplayer这三种mediaplayer来实现媒体播放。<br>ijkplayer-java是对底层实现的ijkmediaplayer和android mediaplayer的java封装，对ijkmediaplayer的封装是通过调用底层jni对应的java接口，对android mediaplayer的封装是调用android系统实现的默认mediaplayer接口。<br>ijkplayer-exo是对google exoplayer的封装，除了android默认的播放器之外，ExoPlayer是Google提供的在android平台上的另外一种播放器。<br>libijkplayer提供了ijkmediaplayer的jni实现ijkplayer_jni.c，然后调用封装过的ffplayer.c, 再调用底层实现的解码库libijkffmpeg和显示库libijksdl。<br>libijkffmpeg实现了媒体文件的demux, decode等功能。<br>libijksdl实现对解码后的数据进行显示。</p>
<h1 id="0x2-Java层关键模块分析"><a href="#0x2-Java层关键模块分析" class="headerlink" title="0x2   Java层关键模块分析"></a>0x2   Java层关键模块分析</h1><h2 id="0x21-三种不同的mediaplayer实现"><a href="#0x21-三种不同的mediaplayer实现" class="headerlink" title="0x21 三种不同的mediaplayer实现."></a>0x21 三种不同的mediaplayer实现.</h2><p>这三种mediaplayer的类图如下图所示。<br><img src="/2018/03/19/analysis-of-ijkplayer/mediaplayer.png" alt="mediaplayers"><br>AndroidMediaPlayer是对Andoid默认播放器的封装。<br>IjkMediaPlayer是基于ffmpeg的播放器实现。<br>IjkExoMediaPlayer是基于Goodle开源的ExoPlayer的封装。</p>
<h2 id="0x22-设置不同的Render"><a href="#0x22-设置不同的Render" class="headerlink" title="0x22    设置不同的Render"></a>0x22    设置不同的Render</h2><p>不同Render的类图如下图所示。<br><img src="/2018/03/19/analysis-of-ijkplayer/render.png" alt="renders"><br>SurfaceRenderView是基于SurfaceView的显示实现。<br>TextureRenderView是基于TextureView的显示实现。<br>上述两种显示实现方式都实现了接口IRenderView。</p>
<h2 id="0x23-IjkMediaPlayer的JNI接口"><a href="#0x23-IjkMediaPlayer的JNI接口" class="headerlink" title="0x23    IjkMediaPlayer的JNI接口"></a>0x23    IjkMediaPlayer的JNI接口</h2><p>详细的JNI接口如下图所示。<br> <img src="/2018/03/19/analysis-of-ijkplayer/jni.png" alt="jni"><br>这些JNI接口提供了播放器的基本接口，包括播放准备(_setDataSource, _setVideoSurface, setVolume，_prepareAsync), 播放控制(_start, _stop, seekTo，_release， _reset)等功能。</p>
<h1 id="0x3-关键流程"><a href="#0x3-关键流程" class="headerlink" title="0x3    关键流程"></a>0x3    关键流程</h1><h2 id="0x31-设置surface"><a href="#0x31-设置surface" class="headerlink" title="0x31    设置surface"></a>0x31    设置surface</h2><p>设置surface的流程图如下图所示。<br><img src="/2018/03/19/analysis-of-ijkplayer/setsurface.png" alt="setsurface"><br>从上面的流程图可知，通过接口_setVideoSurface(), 把UI层的Surface对象(可以理解为显示窗口)设置给SDL显示对象，作为其显示窗口(native_window), 这样SDL有需要显示的内容可以直接在这个显示窗口上显示输出即可。</p>
<h2 id="0x32-显示流程"><a href="#0x32-显示流程" class="headerlink" title="0x32    显示流程"></a>0x32    显示流程</h2><p>显示的流程图如下图所示。<br><img src="/2018/03/19/analysis-of-ijkplayer/display.png" alt="display"><br>下面对上面的流程图简单说明。<br>解码线程ffp_video_thread解码完成以后，调用接口queue_picture把需要显示的buffer往SDL模块发送。<br>然后调用func_fill_frame()填充显示buffer, 这个时候需要判断是通过ffmpeg还是mediacodec实现的解码。<br>如果是ffmpeg实现的话则调用ijksdl_vout_overlay_ffmpeg.c中的函数func_fill_frame()。<br>否则调用ijksdl_vout_overlay_android_mediacodec.c中的func_fill_frame()。<br>然后显示线程video_refresh_thread就可以开始显示了。如果是GPU支持的格式则调用GPU进行输出，这个时候调用的是IJK_EGL_display，否则调用ANativeWindow_lock和ANativeWindow_unlockAndPost进行输出。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/13/how-renderscript-supports-parallel-compution/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/13/how-renderscript-supports-parallel-compution/" itemprop="url">How renderscript supports parallel compution</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-13T20:47:43+09:00">
                2018-03-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/03/13/how-renderscript-supports-parallel-compution/" class="leancloud_visitors" data-flag-title="How renderscript supports parallel compution">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Architecture"><a href="#0x1-Architecture" class="headerlink" title="0x1 Architecture"></a>0x1 Architecture</h1><p>RenderScript is a framework for running computationally intensive tasks at high performance on Android. It is similar to OpenCL which is cross platform spec for parallel computation. RenderScript is primarily oriented for use with data-parallel computation. The RenderScript runtime will parallelize work across all processors available on a device, such as multi-core CPUs, GPUs, or DSPs. RenderScript is especially useful for applications performing image processing, computational photography, or computer vision. <a href="https://developer.android.com/guide/topics/renderscript/compute.html" target="_blank" rel="external">Android’s doc</a></p>
<p>Here is the architecture of RenderScript.<br><img src="/2018/03/13/how-renderscript-supports-parallel-compution/architecture.png" alt="architecture"></p>
<p>RS Wrapper acts as the wrapper layer for RenderScript, provides the RenderScript api mapping and resource management.<br>cpu ref is the software implementation of RenderScript on CPU.<br>gpu rs is the hardware implementation of RenderScript on GPU.<br>slang/llvm provides the front and backend compiler support for RenderScript’s C99-derived language.</p>
<p>In this article, we will discuss how software RenderScript is suported on multi-core CPU.</p>
<h1 id="0x2-Software-Implementation"><a href="#0x2-Software-Implementation" class="headerlink" title="0x2 Software Implementation"></a>0x2 Software Implementation</h1><p><img src="/2018/03/13/how-renderscript-supports-parallel-compution/cpu_rs.png" alt="cpu_rs"></p>
<h2 id="0x21-Create-Threads"><a href="#0x21-Create-Threads" class="headerlink" title="0x21 Create Threads"></a>0x21 Create Threads</h2><p>Create threads for parallel computing based on cpu core’s number<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> RsdCpuReferenceImpl::init(<span class="keyword">uint32_t</span> version_major, <span class="keyword">uint32_t</span> version_minor,</div><div class="line">                               <span class="keyword">sym_lookup_t</span> lfn, <span class="keyword">script_lookup_t</span> slfn) &#123;</div><div class="line">    … …</div><div class="line">    GetCpuInfo();</div><div class="line"></div><div class="line">    <span class="keyword">int</span> cpu = sysconf(_SC_NPROCESSORS_CONF);</div><div class="line">    <span class="keyword">if</span>(mRSC-&gt;props.mDebugMaxThreads) &#123;</div><div class="line">        cpu = mRSC-&gt;props.mDebugMaxThreads;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (cpu &lt; <span class="number">2</span>) &#123;</div><div class="line">        mWorkers.mCount = <span class="number">0</span>;</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Subtract one from the cpu count because we also use the command thread as a worker.</span></div><div class="line">    mWorkers.mCount = (<span class="keyword">uint32_t</span>)(cpu - <span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> ct=<span class="number">0</span>; ct &lt; mWorkers.mCount; ct++) &#123;</div><div class="line">        status = pthread_create(&amp;mWorkers.mThreadId[ct], &amp;threadAttr, helperThreadProc, <span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (status) &#123;</div><div class="line">            mWorkers.mCount = ct;</div><div class="line">            ALOGE(<span class="string">"Created fewer than expected number of RS threads."</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x22-Thread-implementation"><a href="#0x22-Thread-implementation" class="headerlink" title="0x22 Thread implementation"></a>0x22 Thread implementation</h2><p>Here is the thread’s source code.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> * RsdCpuReferenceImpl::helperThreadProc(<span class="keyword">void</span> *vrsc) &#123;</div><div class="line">    RsdCpuReferenceImpl *dc = (RsdCpuReferenceImpl *)vrsc;</div><div class="line"></div><div class="line">    <span class="keyword">uint32_t</span> idx = __sync_fetch_and_add(&amp;dc-&gt;mWorkers.mLaunchCount, <span class="number">1</span>);</div><div class="line"></div><div class="line">    dc-&gt;mWorkers.mLaunchSignals[idx].init();</div><div class="line">    dc-&gt;mWorkers.mNativeThreadId[idx] = gettid();</div><div class="line"></div><div class="line">    <span class="built_in">memset</span>(&amp;dc-&gt;mTlsStruct, <span class="number">0</span>, <span class="keyword">sizeof</span>(dc-&gt;mTlsStruct));</div><div class="line">    <span class="keyword">int</span> status = pthread_setspecific(gThreadTLSKey, &amp;dc-&gt;mTlsStruct);</div><div class="line">    <span class="keyword">if</span> (status) &#123;</div><div class="line">        ALOGE(<span class="string">"pthread_setspecific %i"</span>, status);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span> (!dc-&gt;mExit) &#123;</div><div class="line">        dc-&gt;mWorkers.mLaunchSignals[idx].wait();</div><div class="line">        <span class="keyword">if</span> (dc-&gt;mWorkers.mLaunchCallback) &#123;</div><div class="line">           <span class="comment">// idx +1 is used because the calling thread is always worker 0.</span></div><div class="line">           dc-&gt;mWorkers.mLaunchCallback(dc-&gt;mWorkers.mLaunchData, idx+<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        __sync_fetch_and_sub(&amp;dc-&gt;mWorkers.mRunningCount, <span class="number">1</span>);</div><div class="line">        dc-&gt;mWorkers.mCompleteSignal.<span class="built_in">set</span>();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>dc-&gt;mWorkers.mLaunchSignals[idx].wait() is used to wait for the task to be processed.</p>
<p>dc-&gt;mWorkers.mLaunchCallback will call the actual processing routine.</p>
<p>dc-&gt;mWorkers.mCompleteSignal.set() is used to indicate the processing is complete.</p>
<h2 id="0x23-Launch-Thread"><a href="#0x23-Launch-Thread" class="headerlink" title="0x23 Launch Thread"></a>0x23 Launch Thread</h2><p>dc-&gt;mWorkers.mLaunchSignals[idx].wait() is signed in RsdCpuReferenceImpl::launchThreads().</p>
<p>And in RsdCpuReferenceImpl::launchThreads(), we can see mWorkers.mCompleteSignal.wait() is used to wait for the finish of the executing threads.</p>
<p>And the ‘WorkerCallback_t cbk’ is passed in to do the actual processing.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> RsdCpuReferenceImpl::launchThreads(WorkerCallback_t cbk, <span class="keyword">void</span> *data) &#123;</div><div class="line">    mWorkers.mLaunchData = data;</div><div class="line">    mWorkers.mLaunchCallback = cbk;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> ct = <span class="number">0</span>; ct &lt; mWorkers.mCount; ct++) &#123;</div><div class="line">        mWorkers.mLaunchSignals[ct].<span class="built_in">set</span>();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// We use the calling thread as one of the workers so we can start without</span></div><div class="line">    <span class="comment">// the delay of the thread wakeup.</span></div><div class="line">    <span class="keyword">if</span> (mWorkers.mLaunchCallback) &#123;</div><div class="line">        mWorkers.mLaunchCallback(mWorkers.mLaunchData, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (__sync_fetch_and_or(&amp;mWorkers.mRunningCount, <span class="number">0</span>) != <span class="number">0</span>) &#123;</div><div class="line">        mWorkers.mCompleteSignal.wait();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here is the code about how launchThreads is used.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Line <span class="number">767</span>:             launchThreads(walk_3d_reduce, mtls);</div><div class="line">Line <span class="number">770</span>:             launchThreads(walk_2d_reduce, mtls);</div><div class="line">Line <span class="number">773</span>:             launchThreads(walk_1d_reduce, mtls);</div><div class="line">Line <span class="number">851</span>:             launchThreads(walk_general_foreach, mtls);</div><div class="line">Line <span class="number">873</span>:             launchThreads(walk_2d_foreach, mtls);</div><div class="line">Line <span class="number">895</span>:             launchThreads(walk_1d_foreach, mtls);</div></pre></td></tr></table></figure></p>
<h2 id="0x24-Thread-Execution"><a href="#0x24-Thread-Execution" class="headerlink" title="0x24 Thread Execution"></a>0x24 Thread Execution</h2><p>Each thread setups the task according to the current mSliceNum,<br>Then it setups yStart and yEnd, then executes kernel from yStart to yEnd.<br>The kernel is set in RsdCpuScriptIntrinsic::invokeForEach()<br>or RsdCpuScriptImpl::forEachKernelSetup.</p>
<p>RsdCpuScriptIntrinsic::invokeForEach() is used to setup kernel for Intrinsic.</p>
<p>RsdCpuScriptImpl::forEachKernelSetup() is used to setup user defined kernel in *.rs files.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">walk_2d_foreach</span><span class="params">(<span class="keyword">void</span> *usr, <span class="keyword">uint32_t</span> idx)</span> </span>&#123;</div><div class="line">    MTLaunchStructForEach *mtls = (MTLaunchStructForEach *)usr;</div><div class="line">    RsExpandKernelDriverInfo fep = mtls-&gt;fep;</div><div class="line">    fep.lid = idx;</div><div class="line">    ForEachFunc_t fn = mtls-&gt;kernel;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">uint32_t</span> slice  = (<span class="keyword">uint32_t</span>)__sync_fetch_and_add(&amp;mtls-&gt;mSliceNum, <span class="number">1</span>);</div><div class="line">        <span class="keyword">uint32_t</span> yStart = mtls-&gt;start.y + slice * mtls-&gt;mSliceSize;</div><div class="line">        <span class="keyword">uint32_t</span> yEnd   = yStart + mtls-&gt;mSliceSize;</div><div class="line"></div><div class="line">        yEnd = rsMin(yEnd, mtls-&gt;end.y);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (yEnd &lt;= yStart) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (fep.current.y = yStart; fep.current.y &lt; yEnd; fep.current.y++) &#123;</div><div class="line">            FepPtrSetup(mtls, &amp;fep, mtls-&gt;start.x, fep.current.y);</div><div class="line"></div><div class="line">            fn(&amp;fep, mtls-&gt;start.x, mtls-&gt;end.x, fep.outStride[<span class="number">0</span>]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x25-Kernel-implementation"><a href="#0x25-Kernel-implementation" class="headerlink" title="0x25 Kernel implementation"></a>0x25 Kernel implementation</h2><p>Let’s use IntrinsicBlur as the example, in its kernel function kernelU1(), it will produce output pixel from xstart to xend.<br>the algorithm is based on Gaussian Weights which are initialized in ComputeGaussianWeights().</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> RsdCpuScriptIntrinsicBlur::kernelU1(<span class="keyword">const</span> RsExpandKernelDriverInfo *info,</div><div class="line">                                         <span class="keyword">uint32_t</span> xstart, <span class="keyword">uint32_t</span> xend,</div><div class="line">                                         <span class="keyword">uint32_t</span> outstep) &#123;</div><div class="line">    <span class="keyword">float</span> buf[<span class="number">4</span> * <span class="number">2048</span>];</div><div class="line">    RsdCpuScriptIntrinsicBlur *cp = (RsdCpuScriptIntrinsicBlur *)info-&gt;usr;</div><div class="line">    <span class="keyword">if</span> (!cp-&gt;mAlloc.get()) &#123;</div><div class="line">        ALOGE(<span class="string">"Blur executed without input, skipping"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">const</span> uchar *pin = (<span class="keyword">const</span> uchar *)cp-&gt;mAlloc-&gt;mHal.drvState.lod[<span class="number">0</span>].mallocPtr;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> stride = cp-&gt;mAlloc-&gt;mHal.drvState.lod[<span class="number">0</span>].stride;</div><div class="line"></div><div class="line">    uchar *out = (uchar *)info-&gt;outPtr[<span class="number">0</span>];</div><div class="line">    <span class="keyword">uint32_t</span> x1 = xstart;</div><div class="line">    <span class="keyword">uint32_t</span> x2 = xend;</div><div class="line"></div><div class="line">    <span class="keyword">float</span> *fout = (<span class="keyword">float</span> *)buf;</div><div class="line">    <span class="keyword">int</span> y = info-&gt;current.y;</div><div class="line">    <span class="keyword">if</span> ((y &gt; cp-&gt;mIradius) &amp;&amp; (y &lt; ((<span class="keyword">int</span>)info-&gt;dim.y - cp-&gt;mIradius <span class="number">-1</span>))) &#123;</div><div class="line">        <span class="keyword">const</span> uchar *pi = pin + (y - cp-&gt;mIradius) * stride;</div><div class="line">        OneVFU1(fout, pi, stride, cp-&gt;mFp, cp-&gt;mIradius * <span class="number">2</span> + <span class="number">1</span>, <span class="number">0</span>, info-&gt;dim.x);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        x1 = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>(info-&gt;dim.x &gt; x1) &#123;</div><div class="line">            OneVU1(info, fout, x1, y, pin, stride, cp-&gt;mFp, cp-&gt;mIradius);</div><div class="line">            fout++;</div><div class="line">            x1++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    x1 = xstart;</div><div class="line">    <span class="keyword">while</span> ((x1 &lt; x2) &amp;&amp;</div><div class="line">           ((x1 &lt; (<span class="keyword">uint32_t</span>)cp-&gt;mIradius) || (((<span class="keyword">uintptr_t</span>)out) &amp; <span class="number">0x3</span>))) &#123;</div><div class="line">        OneHU1(info, out, x1, buf, cp-&gt;mFp, cp-&gt;mIradius);</div><div class="line">        out++;</div><div class="line">        x1++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">while</span>(x2 &gt; x1) &#123;</div><div class="line">        OneHU1(info, out, x1, buf, cp-&gt;mFp, cp-&gt;mIradius);</div><div class="line">        out++;</div><div class="line">        x1++;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/25/Analysis-of-SwiftShader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/25/Analysis-of-SwiftShader/" itemprop="url">Analysis of SwiftShader</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-25T20:50:24+09:00">
                2018-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/02/25/Analysis-of-SwiftShader/" class="leancloud_visitors" data-flag-title="Analysis of SwiftShader">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Architecture"><a href="#0x1-Architecture" class="headerlink" title="0x1 Architecture"></a>0x1 Architecture</h1><p>From the doc of swiftshader in the following link, we can see the architecture introduction of it.<br><a href="https://github.com/google/swiftshader/blob/master/docs/Index.md" target="_blank" rel="external">https://github.com/google/swiftshader/blob/master/docs/Index.md</a><br><img src="/2018/02/25/Analysis-of-SwiftShader/architecture.png" alt="swiftshader1"></p>
<p>The API layer is an implementation of a graphics API, such as OpenGL (ES) or Direct3D, on top of the Renderer interface. It is responsible for managing API-level resources and rendering state, as well as compiling high-level shaders to bytecode form.</p>
<p>The Renderer layer generates specialized processing routines for draw calls and coordinates the execution of rendering tasks. It defines the data structures used and how the processing is performed.</p>
<p>Reactor is an embedded language for C++ to dynamically generate code in a WYSIWYG fashion. It allows to specialize the processing routines for the state and shaders used by each draw call. Its syntax closely resembles C and shading languages, to make the code generation easily readable.</p>
<p>The JIT layer is a run-time compiler, such as LLVM’s JIT, or Subzero. Reactor records its operations in an in-memory intermediate form which can be materialized by the JIT into a function which can be called directly.</p>
<p>To achieve exceptional performance, SwiftShader is built around two major optimizations that affect its architecture: dynamic code generation, and parallel processing. Generating code at run-time allows to eliminate code branches and optimizes register usage, specializing the processing routines for exactly the operations required by each draw call. Parallel processing means both utilizing the CPU’s multiple cores and processing multiple elements accoss the width of the SIMD vector units.</p>
<h1 id="0x2-Graphics-Pipeline"><a href="#0x2-Graphics-Pipeline" class="headerlink" title="0x2 Graphics Pipeline"></a>0x2 Graphics Pipeline</h1><p>Here is the graphics pipeline diagram from the following OpenGL ES spec. SwiftShader supports the pipeline by JIT through LLVM then executes it on CPU.<br><a href="https://www.khronos.org/registry/OpenGL/specs/es/2.0/es_full_spec_2.0.pdf" target="_blank" rel="external">https://www.khronos.org/registry/OpenGL/specs/es/2.0/es_full_spec_2.0.pdf</a></p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/graphic_pipeline.png" alt="swiftshader2"></p>
<h1 id="0x3-JIT-through-LLVM"><a href="#0x3-JIT-through-LLVM" class="headerlink" title="0x3 JIT through LLVM"></a>0x3 JIT through LLVM</h1><h2 id="0x31-GLSL-compiler-frontend"><a href="#0x31-GLSL-compiler-frontend" class="headerlink" title="0x31 GLSL compiler frontend"></a>0x31 GLSL compiler frontend</h2><p>SwiftShader uses glslang as its glsl compiler frontend, it consumes glsl source code, and produces AST, then outputs its IR with recursive traverse method, here is the IR definition.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> Opcode</div><div class="line">&#123;</div><div class="line">	<span class="comment">// Matches order in d3d9types.h</span></div><div class="line">	OPCODE_NOP = <span class="number">0</span>,</div><div class="line">	OPCODE_MOV,</div><div class="line">	OPCODE_ADD,</div><div class="line">	OPCODE_SUB,</div><div class="line">	OPCODE_MAD,</div><div class="line">	OPCODE_MUL,</div><div class="line">	OPCODE_RCPX,</div><div class="line">	OPCODE_RSQX,</div><div class="line">	OPCODE_DP3,</div><div class="line">	OPCODE_DP4,</div><div class="line">	OPCODE_MIN,</div><div class="line">	OPCODE_MAX,</div><div class="line">	OPCODE_SLT,</div><div class="line">	OPCODE_SGE,</div><div class="line">	OPCODE_EXP2X,   <span class="comment">// D3DSIO_EXP</span></div><div class="line">	OPCODE_LOG2X,   <span class="comment">// D3DSIO_LOG</span></div><div class="line">	OPCODE_LIT,</div><div class="line">	OPCODE_ATT,   <span class="comment">// D3DSIO_DST</span></div><div class="line">	OPCODE_LRP,</div><div class="line">	OPCODE_FRC,</div><div class="line">	OPCODE_M4X4,</div><div class="line">	OPCODE_M4X3,</div><div class="line">	OPCODE_M3X4,</div><div class="line">	OPCODE_M3X3,</div><div class="line">	OPCODE_M3X2,</div><div class="line">	OPCODE_CALL,</div><div class="line">	OPCODE_CALLNZ,</div><div class="line">	OPCODE_LOOP,</div><div class="line">	OPCODE_RET,</div><div class="line">	OPCODE_ENDLOOP,</div><div class="line">	OPCODE_LABEL,</div><div class="line">	OPCODE_DCL,</div><div class="line">	OPCODE_POWX,</div><div class="line">	OPCODE_CRS,</div><div class="line">	OPCODE_SGN,</div><div class="line">	OPCODE_ABS,</div><div class="line">	OPCODE_NRM3,   <span class="comment">// D3DSIO_NRM</span></div><div class="line">	OPCODE_SINCOS,</div><div class="line">	OPCODE_REP,</div><div class="line">	OPCODE_ENDREP,</div><div class="line">	OPCODE_IF,</div><div class="line">	OPCODE_IFC,</div><div class="line">	OPCODE_ELSE,</div><div class="line">	OPCODE_ENDIF,</div><div class="line">	OPCODE_BREAK,</div><div class="line">	OPCODE_BREAKC,</div><div class="line">	OPCODE_MOVA,</div><div class="line">	OPCODE_DEFB,</div><div class="line">	OPCODE_DEFI,</div><div class="line"></div><div class="line">	OPCODE_TEXCOORD = <span class="number">64</span>,</div><div class="line">	OPCODE_TEXKILL,</div><div class="line">	OPCODE_TEX,</div><div class="line">	OPCODE_TEXBEM,</div><div class="line">	OPCODE_TEXBEML,</div><div class="line">	OPCODE_TEXREG2AR,</div><div class="line">	OPCODE_TEXREG2GB,</div><div class="line">	OPCODE_TEXM3X2PAD,</div><div class="line">	OPCODE_TEXM3X2TEX,</div><div class="line">	OPCODE_TEXM3X3PAD,</div><div class="line">	OPCODE_TEXM3X3TEX,</div><div class="line">	OPCODE_RESERVED0,</div><div class="line">	OPCODE_TEXM3X3SPEC,</div><div class="line">	OPCODE_TEXM3X3VSPEC,</div><div class="line">	OPCODE_EXPP,</div><div class="line">	OPCODE_LOGP,</div><div class="line">	OPCODE_CND,</div><div class="line">	OPCODE_DEF,</div><div class="line">	OPCODE_TEXREG2RGB,</div><div class="line">	OPCODE_TEXDP3TEX,</div><div class="line">	OPCODE_TEXM3X2DEPTH,</div><div class="line">	OPCODE_TEXDP3,</div><div class="line">	OPCODE_TEXM3X3,</div><div class="line">	OPCODE_TEXDEPTH,</div><div class="line">	OPCODE_CMP0,   <span class="comment">// D3DSIO_CMP</span></div><div class="line">	OPCODE_BEM,</div><div class="line">	OPCODE_DP2ADD,</div><div class="line">	OPCODE_DFDX,   <span class="comment">// D3DSIO_DSX</span></div><div class="line">	OPCODE_DFDY,   <span class="comment">// D3DSIO_DSY</span></div><div class="line">	OPCODE_TEXLDD,</div><div class="line">	OPCODE_CMP,   <span class="comment">// D3DSIO_SETP</span></div><div class="line">	OPCODE_TEXLDL,</div><div class="line">	OPCODE_BREAKP,</div><div class="line"></div><div class="line">	OPCODE_PHASE = <span class="number">0xFFFD</span>,</div><div class="line">	OPCODE_COMMENT = <span class="number">0xFFFE</span>,</div><div class="line">	OPCODE_END = <span class="number">0xFFFF</span>,</div><div class="line"></div><div class="line">	OPCODE_PS_1_0 = <span class="number">0xFFFF0100</span>,</div><div class="line">	OPCODE_PS_1_1 = <span class="number">0xFFFF0101</span>,</div><div class="line">	OPCODE_PS_1_2 = <span class="number">0xFFFF0102</span>,</div><div class="line">	OPCODE_PS_1_3 = <span class="number">0xFFFF0103</span>,</div><div class="line">	OPCODE_PS_1_4 = <span class="number">0xFFFF0104</span>,</div><div class="line">	OPCODE_PS_2_0 = <span class="number">0xFFFF0200</span>,</div><div class="line">	OPCODE_PS_2_x = <span class="number">0xFFFF0201</span>,</div><div class="line">	OPCODE_PS_3_0 = <span class="number">0xFFFF0300</span>,</div><div class="line"></div><div class="line">	OPCODE_VS_1_0 = <span class="number">0xFFFE0100</span>,</div><div class="line">	OPCODE_VS_1_1 = <span class="number">0xFFFE0101</span>,</div><div class="line">	OPCODE_VS_2_0 = <span class="number">0xFFFE0200</span>,</div><div class="line">	OPCODE_VS_2_x = <span class="number">0xFFFE0201</span>,</div><div class="line">	OPCODE_VS_2_sw = <span class="number">0xFFFE02FF</span>,</div><div class="line">	OPCODE_VS_3_0 = <span class="number">0xFFFE0300</span>,</div><div class="line">	OPCODE_VS_3_sw = <span class="number">0xFFFE03FF</span>,</div><div class="line"></div><div class="line">	OPCODE_NULL = <span class="number">0x10000000</span>,   <span class="comment">// Dead instruction, to be eliminated</span></div><div class="line">	OPCODE_WHILE,</div><div class="line">	OPCODE_ENDWHILE,</div><div class="line">	OPCODE_COS,</div><div class="line">	OPCODE_SIN,</div><div class="line">	OPCODE_TAN,</div><div class="line">	OPCODE_ACOS,</div><div class="line">	OPCODE_ASIN,</div><div class="line">	OPCODE_ATAN,</div><div class="line">	OPCODE_ATAN2,</div><div class="line">	OPCODE_COSH,</div><div class="line">	OPCODE_SINH,</div><div class="line">	OPCODE_TANH,</div><div class="line">	OPCODE_ACOSH,</div><div class="line">	OPCODE_ASINH,</div><div class="line">	OPCODE_ATANH,</div><div class="line">	OPCODE_DP1,</div><div class="line">	OPCODE_DP2,</div><div class="line">	OPCODE_TRUNC,</div><div class="line">	OPCODE_FLOOR,</div><div class="line">	OPCODE_ROUND,</div><div class="line">	OPCODE_ROUNDEVEN,</div><div class="line">	OPCODE_CEIL,</div><div class="line">	OPCODE_SQRT,</div><div class="line">	OPCODE_RSQ,</div><div class="line">	OPCODE_LEN2,</div><div class="line">	OPCODE_LEN3,</div><div class="line">	OPCODE_LEN4,</div><div class="line">	OPCODE_DIST1,</div><div class="line">	OPCODE_DIST2,</div><div class="line">	OPCODE_DIST3,</div><div class="line">	OPCODE_DIST4,</div><div class="line">	OPCODE_NRM2,</div><div class="line">	OPCODE_NRM4,</div><div class="line">	OPCODE_DIV,</div><div class="line">	OPCODE_MOD,</div><div class="line">	OPCODE_EXP2,</div><div class="line">	OPCODE_LOG2,</div><div class="line">	OPCODE_EXP,</div><div class="line">	OPCODE_LOG,</div><div class="line">	OPCODE_POW,</div><div class="line">	OPCODE_F2B,   <span class="comment">// Float to bool</span></div><div class="line">	OPCODE_B2F,   <span class="comment">// Bool to float</span></div><div class="line">	OPCODE_F2I,   <span class="comment">// Float to int</span></div><div class="line">	OPCODE_I2F,   <span class="comment">// Int to float</span></div><div class="line">	OPCODE_F2U,   <span class="comment">// Float to uint</span></div><div class="line">	OPCODE_U2F,   <span class="comment">// Uint to float</span></div><div class="line">	OPCODE_I2B,   <span class="comment">// Int to bool</span></div><div class="line">	OPCODE_B2I,   <span class="comment">// Bool to int</span></div><div class="line">	OPCODE_DET2,</div><div class="line">	OPCODE_DET3,</div><div class="line">	OPCODE_DET4,</div><div class="line">	OPCODE_ALL,</div><div class="line">	OPCODE_ANY,</div><div class="line">	OPCODE_NEG,</div><div class="line">	OPCODE_NOT,</div><div class="line">	OPCODE_OR,</div><div class="line">	OPCODE_XOR,</div><div class="line">	OPCODE_AND,</div><div class="line">	OPCODE_EQ,</div><div class="line">	OPCODE_NE,</div><div class="line">	OPCODE_STEP,</div><div class="line">	OPCODE_SMOOTH,</div><div class="line">	OPCODE_ISNAN,</div><div class="line">	OPCODE_ISINF,</div><div class="line">	OPCODE_TEXOFFSET,</div><div class="line">	OPCODE_TEXLODOFFSET,</div><div class="line">	OPCODE_TEXELFETCH,</div><div class="line">	OPCODE_TEXELFETCHOFFSET,</div><div class="line">	OPCODE_TEXGRAD,</div><div class="line">	OPCODE_TEXGRADOFFSET,</div><div class="line">	OPCODE_TEXBIAS,</div><div class="line">	OPCODE_TEXLOD,</div><div class="line">	OPCODE_TEXOFFSETBIAS,</div><div class="line">	OPCODE_TEXRECT,</div><div class="line">	OPCODE_TEXSIZE,</div><div class="line">	OPCODE_FLOATBITSTOINT,</div><div class="line">	OPCODE_FLOATBITSTOUINT,</div><div class="line">	OPCODE_INTBITSTOFLOAT,</div><div class="line">	OPCODE_UINTBITSTOFLOAT,</div><div class="line">	OPCODE_PACKSNORM2x16,</div><div class="line">	OPCODE_PACKUNORM2x16,</div><div class="line">	OPCODE_PACKHALF2x16,</div><div class="line">	OPCODE_UNPACKSNORM2x16,</div><div class="line">	OPCODE_UNPACKUNORM2x16,</div><div class="line">	OPCODE_UNPACKHALF2x16,</div><div class="line">	OPCODE_FORWARD1,</div><div class="line">	OPCODE_FORWARD2,</div><div class="line">	OPCODE_FORWARD3,</div><div class="line">	OPCODE_FORWARD4,</div><div class="line">	OPCODE_REFLECT1,</div><div class="line">	OPCODE_REFLECT2,</div><div class="line">	OPCODE_REFLECT3,</div><div class="line">	OPCODE_REFLECT4,</div><div class="line">	OPCODE_REFRACT1,</div><div class="line">	OPCODE_REFRACT2,</div><div class="line">	OPCODE_REFRACT3,</div><div class="line">	OPCODE_REFRACT4,</div><div class="line">	OPCODE_ICMP,</div><div class="line">	OPCODE_UCMP,</div><div class="line">	OPCODE_SELECT,</div><div class="line">	OPCODE_EXTRACT,</div><div class="line">	OPCODE_INSERT,</div><div class="line">	OPCODE_DISCARD,</div><div class="line">	OPCODE_FWIDTH,</div><div class="line">	OPCODE_LEAVE,   <span class="comment">// Return before the end of the function</span></div><div class="line">	OPCODE_CONTINUE,</div><div class="line">	OPCODE_TEST,   <span class="comment">// Marks the end of the code that can be skipped by 'continue'</span></div><div class="line">	OPCODE_SWITCH,</div><div class="line">	OPCODE_ENDSWITCH,</div><div class="line"></div><div class="line">	<span class="comment">// Integer opcodes</span></div><div class="line">	OPCODE_INEG,</div><div class="line">	OPCODE_IABS,</div><div class="line">	OPCODE_ISGN,</div><div class="line">	OPCODE_IADD,</div><div class="line">	OPCODE_ISUB,</div><div class="line">	OPCODE_IMUL,</div><div class="line">	OPCODE_IDIV,</div><div class="line">	OPCODE_IMAD,</div><div class="line">	OPCODE_IMOD,</div><div class="line">	OPCODE_SHL,</div><div class="line">	OPCODE_ISHR,</div><div class="line">	OPCODE_IMIN,</div><div class="line">	OPCODE_IMAX,</div><div class="line"></div><div class="line">	<span class="comment">// Unsigned integer opcodes</span></div><div class="line">	OPCODE_UDIV,</div><div class="line">	OPCODE_UMOD,</div><div class="line">	OPCODE_USHR,</div><div class="line">	OPCODE_UMIN,</div><div class="line">	OPCODE_UMAX,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>Here is the callstack about how IR is generated, it is done by traversing the AST.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/generate_ir.png" alt="swiftshader3"></p>
<p>Once IR is ready, swiftshader will consume those IR and generate LLVM IR, some fixed pipeline and graphic state will also be programmed into LLVM IR at the same time.</p>
<p>We will discuss the three processors, vertex processor, setup processor and pixel processor, all the three processor will generate LLVM IR accoring to graphic state.</p>
<h2 id="0x31-Vertex-processor"><a href="#0x31-Vertex-processor" class="headerlink" title="0x31 Vertex processor"></a>0x31 Vertex processor</h2><p>Here is diagram about how vertex processor produces LLVM IR.<br><img src="/2018/02/25/Analysis-of-SwiftShader/vertex_processor.png" alt="swiftshader4"></p>
<h3 id="Prepare-the-draw-state"><a href="#Prepare-the-draw-state" class="headerlink" title="Prepare the draw state"></a>Prepare the draw state</h3><p>It prepare thes draw state by updating the structe State according to the graphic state.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> VertexProcessor::State VertexProcessor::update(DrawType drawType)</div><div class="line">&#123;</div><div class="line">		<span class="keyword">if</span>(isFixedFunction())</div><div class="line">		&#123;</div><div class="line">			updateTransform();</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(updateLighting)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</div><div class="line">				&#123;</div><div class="line">					<span class="keyword">if</span>(context-&gt;vertexLightActive(i))</div><div class="line">					&#123;</div><div class="line">						<span class="comment">// Light position in camera coordinates</span></div><div class="line">						setLightViewPosition(i, B * V * context-&gt;getLightPosition(i));</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				updateLighting = <span class="literal">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		State state;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(context-&gt;vertexShader)</div><div class="line">		&#123;</div><div class="line">			state.shaderID = context-&gt;vertexShader-&gt;getSerialID();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			state.shaderID = <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		state.fixedFunction = !context-&gt;vertexShader &amp;&amp; context-&gt;pixelShaderModel() &lt; <span class="number">0x0300</span>;</div><div class="line">		state.textureSampling = context-&gt;vertexShader ? context-&gt;vertexShader-&gt;containsTextureSampling() : <span class="literal">false</span>;</div><div class="line">		state.positionRegister = context-&gt;vertexShader ? context-&gt;vertexShader-&gt;getPositionRegister() : Pos;</div><div class="line">		state.pointSizeRegister = context-&gt;vertexShader ? context-&gt;vertexShader-&gt;getPointSizeRegister() : Pts;</div><div class="line"></div><div class="line">		state.vertexBlendMatrixCount = context-&gt;vertexBlendMatrixCountActive();</div><div class="line">		state.indexedVertexBlendEnable = context-&gt;indexedVertexBlendActive();</div><div class="line">		state.vertexNormalActive = context-&gt;vertexNormalActive();</div><div class="line">		state.normalizeNormals = context-&gt;normalizeNormalsActive();</div><div class="line">		state.vertexLightingActive = context-&gt;vertexLightingActive();</div><div class="line">		state.diffuseActive = context-&gt;diffuseActive();</div><div class="line">		state.specularActive = context-&gt;specularActive();</div><div class="line">		state.vertexSpecularActive = context-&gt;vertexSpecularActive();</div><div class="line"></div><div class="line">		state.vertexLightActive = context-&gt;vertexLightActive(<span class="number">0</span>) &lt;&lt; <span class="number">0</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">1</span>) &lt;&lt; <span class="number">1</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">2</span>) &lt;&lt; <span class="number">2</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">3</span>) &lt;&lt; <span class="number">3</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">4</span>) &lt;&lt; <span class="number">4</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">5</span>) &lt;&lt; <span class="number">5</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">6</span>) &lt;&lt; <span class="number">6</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">7</span>) &lt;&lt; <span class="number">7</span>;</div><div class="line"></div><div class="line">		state.vertexDiffuseMaterialSourceActive = context-&gt;vertexDiffuseMaterialSourceActive();</div><div class="line">		state.vertexSpecularMaterialSourceActive = context-&gt;vertexSpecularMaterialSourceActive();</div><div class="line">		state.vertexAmbientMaterialSourceActive = context-&gt;vertexAmbientMaterialSourceActive();</div><div class="line">		state.vertexEmissiveMaterialSourceActive = context-&gt;vertexEmissiveMaterialSourceActive();</div><div class="line">		state.fogActive = context-&gt;fogActive();</div><div class="line">		state.vertexFogMode = context-&gt;vertexFogModeActive();</div><div class="line">		state.rangeFogActive = context-&gt;rangeFogActive();</div><div class="line">		state.localViewerActive = context-&gt;localViewerActive();</div><div class="line">		state.pointSizeActive = context-&gt;pointSizeActive();</div><div class="line">		state.pointScaleActive = context-&gt;pointScaleActive();</div><div class="line"></div><div class="line">		state.preTransformed = context-&gt;preTransformed;</div><div class="line">		state.superSampling = context-&gt;getSuperSampleCount() &gt; <span class="number">1</span>;</div><div class="line">		state.multiSampling = context-&gt;getMultiSampleCount() &gt; <span class="number">1</span>;</div><div class="line"></div><div class="line">		state.transformFeedbackQueryEnabled = context-&gt;transformFeedbackQueryEnabled;</div><div class="line">		state.transformFeedbackEnabled = context-&gt;transformFeedbackEnabled;</div><div class="line"></div><div class="line">		<span class="comment">// Note: Quads aren't handled for verticesPerPrimitive, but verticesPerPrimitive is used for transform feedback,</span></div><div class="line">		<span class="comment">//       which is an OpenGL ES 3.0 feature, and OpenGL ES 3.0 doesn't support quads as a primitive type.</span></div><div class="line">		DrawType type = <span class="keyword">static_cast</span>&lt;DrawType&gt;(<span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(drawType) &amp; <span class="number">0xF</span>);</div><div class="line">		state.verticesPerPrimitive = <span class="number">1</span> + (type &gt;= DRAW_LINELIST) + (type &gt;= DRAW_TRIANGLELIST);</div><div class="line"></div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_VERTEX_INPUTS; i++)</div><div class="line">		&#123;</div><div class="line">			state.input[i].type = context-&gt;input[i].type;</div><div class="line">			state.input[i].count = context-&gt;input[i].count;</div><div class="line">			state.input[i].normalized = context-&gt;input[i].normalized;</div><div class="line">			state.input[i].attribType = context-&gt;vertexShader ? context-&gt;vertexShader-&gt;getAttribType(i) : VertexShader::ATTRIBTYPE_FLOAT;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(!context-&gt;vertexShader)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</div><div class="line">			&#123;</div><div class="line">			<span class="comment">//	state.textureState[i].vertexTextureActive = context-&gt;vertexTextureActive(i, 0);</span></div><div class="line">				state.textureState[i].texGenActive = context-&gt;texGenActive(i);</div><div class="line">				state.textureState[i].textureTransformCountActive = context-&gt;textureTransformCountActive(i);</div><div class="line">				state.textureState[i].texCoordIndexActive = context-&gt;texCoordIndexActive(i);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; VERTEX_TEXTURE_IMAGE_UNITS; i++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span>(context-&gt;vertexShader-&gt;usesSampler(i))</div><div class="line">				&#123;</div><div class="line">					state.sampler[i] = context-&gt;sampler[TEXTURE_IMAGE_UNITS + i].samplerState();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(context-&gt;vertexShader)   <span class="comment">// <span class="doctag">FIXME:</span> Also when pre-transformed?</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_VERTEX_OUTPUTS; i++)</div><div class="line">			&#123;</div><div class="line">				state.output[i].xWrite = context-&gt;vertexShader-&gt;getOutput(i, <span class="number">0</span>).active();</div><div class="line">				state.output[i].yWrite = context-&gt;vertexShader-&gt;getOutput(i, <span class="number">1</span>).active();</div><div class="line">				state.output[i].zWrite = context-&gt;vertexShader-&gt;getOutput(i, <span class="number">2</span>).active();</div><div class="line">				state.output[i].wWrite = context-&gt;vertexShader-&gt;getOutput(i, <span class="number">3</span>).active();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(!context-&gt;preTransformed || context-&gt;pixelShaderModel() &lt; <span class="number">0x0300</span>)</div><div class="line">		&#123;</div><div class="line">			state.output[Pos].write = <span class="number">0xF</span>;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;diffuseActive() &amp;&amp; (context-&gt;lightingEnable || context-&gt;input[Color0]))</div><div class="line">			&#123;</div><div class="line">				state.output[C0].write = <span class="number">0xF</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;specularActive())</div><div class="line">			&#123;</div><div class="line">				state.output[C1].write = <span class="number">0xF</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> stage = <span class="number">0</span>; stage &lt; <span class="number">8</span>; stage++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span>(context-&gt;texCoordActive(stage, <span class="number">0</span>)) state.output[T0 + stage].write |= <span class="number">0x01</span>;</div><div class="line">				<span class="keyword">if</span>(context-&gt;texCoordActive(stage, <span class="number">1</span>)) state.output[T0 + stage].write |= <span class="number">0x02</span>;</div><div class="line">				<span class="keyword">if</span>(context-&gt;texCoordActive(stage, <span class="number">2</span>)) state.output[T0 + stage].write |= <span class="number">0x04</span>;</div><div class="line">				<span class="keyword">if</span>(context-&gt;texCoordActive(stage, <span class="number">3</span>)) state.output[T0 + stage].write |= <span class="number">0x08</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;fogActive())</div><div class="line">			&#123;</div><div class="line">				state.output[Fog].xWrite = <span class="literal">true</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;pointSizeActive())</div><div class="line">			&#123;</div><div class="line">				state.output[Pts].yWrite = <span class="literal">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			state.output[Pos].write = <span class="number">0xF</span>;</div><div class="line"></div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span>(context-&gt;input[Color0 + i])</div><div class="line">				&#123;</div><div class="line">					state.output[C0 + i].write = <span class="number">0xF</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span>(context-&gt;input[TexCoord0 + i])</div><div class="line">				&#123;</div><div class="line">					state.output[T0 + i].write = <span class="number">0xF</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;input[PointSize])</div><div class="line">			&#123;</div><div class="line">				state.output[Pts].yWrite = <span class="literal">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(context-&gt;vertexShaderModel() &lt; <span class="number">0x0300</span>)</div><div class="line">		&#123;</div><div class="line">			state.output[C0].clamp = <span class="number">0xF</span>;</div><div class="line">			state.output[C1].clamp = <span class="number">0xF</span>;</div><div class="line">			state.output[Fog].xClamp = <span class="literal">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		state.hash = state.computeHash();</div><div class="line"></div><div class="line">		<span class="keyword">return</span> state;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Generate-LLVM-IR"><a href="#Generate-LLVM-IR" class="headerlink" title="Generate LLVM IR"></a>Generate LLVM IR</h3><p>Then it generates the LLVM IR with reactor method based on the state which is updated in the previous step.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> VertexRoutine::generate()</div><div class="line">&#123;</div><div class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> textureSampling = state.textureSampling;</div><div class="line"></div><div class="line">		Pointer&lt;Byte&gt; cache = task + OFFSET(VertexTask,vertexCache);</div><div class="line">		Pointer&lt;Byte&gt; vertexCache = cache + OFFSET(VertexCache,vertex);</div><div class="line">		Pointer&lt;Byte&gt; tagCache = cache + OFFSET(VertexCache,tag);</div><div class="line"></div><div class="line">		UInt vertexCount = *Pointer&lt;UInt&gt;(task + OFFSET(VertexTask,vertexCount));</div><div class="line">		UInt primitiveNumber = *Pointer&lt;UInt&gt;(task + OFFSET(VertexTask, primitiveStart));</div><div class="line">		UInt indexInPrimitive = <span class="number">0</span>;</div><div class="line"></div><div class="line">		constants = *Pointer&lt;Pointer&lt;Byte&gt;&gt;(data + OFFSET(DrawData,constants));</div><div class="line"></div><div class="line">		Do</div><div class="line">		&#123;</div><div class="line">			UInt index = *Pointer&lt;UInt&gt;(batch);</div><div class="line">			UInt tagIndex = index &amp; <span class="number">0x0000003C</span>;</div><div class="line">			UInt indexQ = !textureSampling ? UInt(index &amp; <span class="number">0xFFFFFFFC</span>) : index;   <span class="comment">// <span class="doctag">FIXME:</span> TEXLDL hack to have independent LODs, hurts performance.</span></div><div class="line"></div><div class="line">			If(*Pointer&lt;UInt&gt;(tagCache + tagIndex) != indexQ)</div><div class="line">			&#123;</div><div class="line">				*Pointer&lt;UInt&gt;(tagCache + tagIndex) = indexQ;</div><div class="line"></div><div class="line">				readInput(indexQ);</div><div class="line">				pipeline(indexQ);</div><div class="line">				postTransform();</div><div class="line">				computeClipFlags();</div><div class="line"></div><div class="line">				Pointer&lt;Byte&gt; cacheLine0 = vertexCache + tagIndex * UInt((<span class="keyword">int</span>)<span class="keyword">sizeof</span>(Vertex));</div><div class="line">				writeCache(cacheLine0);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			UInt cacheIndex = index &amp; <span class="number">0x0000003F</span>;</div><div class="line">			Pointer&lt;Byte&gt; cacheLine = vertexCache + cacheIndex * UInt((<span class="keyword">int</span>)<span class="keyword">sizeof</span>(Vertex));</div><div class="line">			writeVertex(vertex, cacheLine);</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(state.transformFeedbackEnabled != <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				transformFeedback(vertex, primitiveNumber, indexInPrimitive);</div><div class="line"></div><div class="line">				indexInPrimitive++;</div><div class="line">				If(indexInPrimitive == <span class="number">3</span>)</div><div class="line">				&#123;</div><div class="line">					primitiveNumber++;</div><div class="line">					indexInPrimitive = <span class="number">0</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			vertex += <span class="keyword">sizeof</span>(Vertex);</div><div class="line">			batch += <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span>);</div><div class="line">			vertexCount--;</div><div class="line">		&#125;</div><div class="line">		Until(vertexCount == <span class="number">0</span>)</div><div class="line"></div><div class="line">		Return();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x32-Setup-processor"><a href="#0x32-Setup-processor" class="headerlink" title="0x32 Setup processor"></a>0x32 Setup processor</h2><p>The LLVM IR generation process of setup processor is similar to Vertex processor’s.</p>
<h2 id="0x33-Pixel-processor"><a href="#0x33-Pixel-processor" class="headerlink" title="0x33 Pixel processor"></a>0x33 Pixel processor</h2><p>The LLVM IR generation process of pixel processor is similar to Vertex processor’s.</p>
<h1 id="0x4-Multithread"><a href="#0x4-Multithread" class="headerlink" title="0x4 Multithread"></a>0x4 Multithread</h1><p>Here is the timeline diagram about how multithread is supported in swiftshader.<br>It split the draw task into several batches, each batch is executed in one thread.vertex processor and setup processor is executed together, pixel processor is executed after that.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/multithread.png" alt="swiftshader6"></p>
<h2 id="0x41-Task-producer"><a href="#0x41-Task-producer" class="headerlink" title="0x41 Task producer."></a>0x41 Task producer.</h2><p>Task producer produces the task in the main thread, then push the task in the queue and waits for the consumer to get those task for cosuming.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/task_producer.png" alt="swiftshader7"></p>
<h2 id="0x42-Task-consumer"><a href="#0x42-Task-consumer" class="headerlink" title="0x42 Task consumer."></a>0x42 Task consumer.</h2><p>Task consumer finds the task in the queue, then exeucute the task in the specific thread.<br>Here is the diagram about how vertex processor and setup processor is executed in one thread.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/task_consumer.png" alt="swiftshader8"></p>
<p>Here is the diagram about how pixel processor is executed in one thread.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/task_consumer_pixel.png" alt="swiftshader9"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/08/Timer-support-in-event-driven-network-framework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/08/Timer-support-in-event-driven-network-framework/" itemprop="url">Timer support in event driven network framework</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-08T19:02:31+09:00">
                2017-07-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/07/08/Timer-support-in-event-driven-network-framework/" class="leancloud_visitors" data-flag-title="Timer support in event driven network framework">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Introduction"><a href="#0x1-Introduction" class="headerlink" title="0x1 Introduction"></a>0x1 Introduction</h1><p>  Typically there is one event loop in event driven asynchronous network framework, it waits on the file descriptors to become ready then to perform specific operations, typically the event loop is executed in one thread. And such network framework also supports timer, one type of timer is to process some operation after some time, another type of timer is to process some operation at some intervals.</p>
<p>  Next we will look into the detail timer’s support in serveral network framework.</p>
<h1 id="0x2-Nginx’s-implementation"><a href="#0x2-Nginx’s-implementation" class="headerlink" title="0x2 Nginx’s implementation"></a>0x2 Nginx’s implementation</h1><p>  In Nginx, ngx_process_events_and_timers() will handle timer, it detects the expired timers then call its handler to do further operation.</p>
<p>  From the following code, there is one variable ngx_timer_resolution, it is used to handle timer in two different ways. </p>
<p>  If ngx_timer_resolution is not zero, the timeout parameter is set as -1, then it will pass to ngx_process_events(), if timeout parameter is -1, epoll_wait() will wait infinitely until some file descriptors become ready, so the timer seems not accurate at that time. And ngx_timer_resolution is configured in nginx’s configuration file.</p>
<p>  If ngx_timer_resolution is zero, it will call ngx_event_find_timer() to get the delta time between the next expired time and current time, the next expired time is sotred in the rbtree.</p>
<p>  In ngx_process_events_and_timers(), it will call ngx_event_expire_timers() to process the expired timers, and call the timer’handler.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ngx_process_events_and_timers</span><span class="params">(<span class="keyword">ngx_cycle_t</span> *cycle)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">ngx_uint_t</span>  flags;</div><div class="line">    <span class="keyword">ngx_msec_t</span>  timer, delta;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ngx_timer_resolution) &#123;</div><div class="line">        timer = NGX_TIMER_INFINITE;</div><div class="line">        flags = <span class="number">0</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        timer = ngx_event_find_timer();</div><div class="line">        flags = NGX_UPDATE_TIME;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    delta = ngx_current_msec;</div><div class="line">    (<span class="keyword">void</span>) ngx_process_events(cycle, timer, flags);</div><div class="line">    delta = ngx_current_msec - delta;</div><div class="line">    ngx_event_process_posted(cycle, &amp;ngx_posted_accept_events);</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (delta) &#123;</div><div class="line">        ngx_event_expire_timers();</div><div class="line">    &#125;</div><div class="line">    ngx_event_process_posted(cycle, &amp;ngx_posted_events);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ngx_int_t <span class="title">ngx_epoll_process_events</span><span class="params">(<span class="keyword">ngx_cycle_t</span> *cycle, <span class="keyword">ngx_msec_t</span> timer, <span class="keyword">ngx_uint_t</span> flags)</span></span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    events = epoll_wait(ep, event_list, (<span class="keyword">int</span>) nevents, timer);</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (flags &amp; NGX_UPDATE_TIME || ngx_event_timer_alarm) &#123;</div><div class="line">        ngx_time_update();</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; events; i++) &#123;</div><div class="line">        c = event_list[i].data.ptr;</div><div class="line">        ...</div><div class="line">        revents = event_list[i].events;</div><div class="line">        ...        </div><div class="line">        wev = c-&gt;write;</div><div class="line">        ...</div><div class="line">        <span class="keyword">if</span> (flags &amp; NGX_POST_EVENTS) &#123;</div><div class="line">                ngx_post_event(wev, &amp;ngx_posted_events);</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                wev-&gt;handler(wev);</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In ngx_epoll_process_events(), if will call ngx_time_update() to update time, and ngx_time_update() will call the system function gettimeofday(), and the system performance will be impacted if we call gettimeofday() frequently.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ngx_time_update</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    ngx_gettimeofday(&amp;tv);</div><div class="line">    ...</div><div class="line">    sec = tv.tv_sec;</div><div class="line">    msec = tv.tv_usec / <span class="number">1000</span>;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ngx_event_expire_timers</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">for</span> ( ;; ) &#123;</div><div class="line">        root = ngx_event_timer_rbtree.root;</div><div class="line">        ...</div><div class="line">        <span class="keyword">if</span> (root == sentinel) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">        node = ngx_rbtree_min(root, sentinel);</div><div class="line">        ...</div><div class="line">        <span class="keyword">if</span> ((<span class="keyword">ngx_msec_int_t</span>) (node-&gt;key - ngx_current_msec) &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        ev = (<span class="keyword">ngx_event_t</span> *) ((<span class="keyword">char</span> *) node - offsetof(<span class="keyword">ngx_event_t</span>, timer));</div><div class="line">        ngx_rbtree_delete(&amp;ngx_event_timer_rbtree, &amp;ev-&gt;timer);</div><div class="line">        ev-&gt;timer_set = <span class="number">0</span>;</div><div class="line">        ev-&gt;timedout = <span class="number">1</span>;</div><div class="line">        ev-&gt;handler(ev);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="0x3-Redis’s-implementation"><a href="#0x3-Redis’s-implementation" class="headerlink" title="0x3 Redis’s implementation"></a>0x3 Redis’s implementation</h1><p>Here are the functions of Redis to add/delete timer, the timer’s user can use those functions to get timer service from the event loop thread. In Redis, the serverCron() is register as the timer’s callback when calling aeCreateTimeEvent(), then serverCron() will be called at some interval to do resource and status checking of Redis Server.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">aeCreateTimeEvent</span><span class="params">(aeEventLoop *eventLoop, <span class="keyword">long</span> <span class="keyword">long</span> milliseconds,</span></span></div><div class="line">        aeTimeProc *proc, <span class="keyword">void</span> *clientData,</div><div class="line">        aeEventFinalizerProc *finalizerProc)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> id = eventLoop-&gt;timeEventNextId++;</div><div class="line">    aeTimeEvent *te;</div><div class="line"></div><div class="line">    te = zmalloc(<span class="keyword">sizeof</span>(*te));</div><div class="line">    <span class="keyword">if</span> (te == <span class="literal">NULL</span>) <span class="keyword">return</span> AE_ERR;</div><div class="line">    te-&gt;id = id;</div><div class="line">    aeAddMillisecondsToNow(milliseconds,&amp;te-&gt;when_sec,&amp;te-&gt;when_ms);</div><div class="line">    te-&gt;timeProc = proc;</div><div class="line">    te-&gt;finalizerProc = finalizerProc;</div><div class="line">    te-&gt;clientData = clientData;</div><div class="line">    te-&gt;next = eventLoop-&gt;timeEventHead;</div><div class="line">    eventLoop-&gt;timeEventHead = te;</div><div class="line">    <span class="keyword">return</span> id;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">aeDeleteTimeEvent</span><span class="params">(aeEventLoop *eventLoop, <span class="keyword">long</span> <span class="keyword">long</span> id)</span></span></div><div class="line">&#123;</div><div class="line">    aeTimeEvent *te = eventLoop-&gt;timeEventHead;</div><div class="line">    <span class="keyword">while</span>(te) &#123;</div><div class="line">        <span class="keyword">if</span> (te-&gt;id == id) &#123;</div><div class="line">            te-&gt;id = AE_DELETED_EVENT_ID;</div><div class="line">            <span class="keyword">return</span> AE_OK;</div><div class="line">        &#125;</div><div class="line">        te = te-&gt;next;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> AE_ERR;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here is the code about how timer is handled in the event loop, it searches the nearnest timer in the timer list, then calculates the timout parameter for the aeApiPoll(), then aeApiPoll() will wait on the file descriptors within the timout setting, after aeApiPoll(), it uses processTimeEvents() to process the timers and call its callback of the specific timer.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">aeProcessEvents</span><span class="params">(aeEventLoop *eventLoop, <span class="keyword">int</span> flags)</span></span></div><div class="line">&#123;</div><div class="line">        ...</div><div class="line">        aeTimeEvent *shortest = <span class="literal">NULL</span>;</div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>, *<span class="title">tvp</span>;</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (flags &amp; AE_TIME_EVENTS &amp;&amp; !(flags &amp; AE_DONT_WAIT))</div><div class="line">            shortest = aeSearchNearestTimer(eventLoop);</div><div class="line">        <span class="keyword">if</span> (shortest) &#123;</div><div class="line">            <span class="keyword">long</span> now_sec, now_ms;</div><div class="line"></div><div class="line">            aeGetTime(&amp;now_sec, &amp;now_ms);</div><div class="line">            tvp = &amp;tv;</div><div class="line"></div><div class="line">            <span class="keyword">long</span> <span class="keyword">long</span> ms =</div><div class="line">                (shortest-&gt;when_sec - now_sec)*<span class="number">1000</span> +</div><div class="line">                shortest-&gt;when_ms - now_ms;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (ms &gt; <span class="number">0</span>) &#123;</div><div class="line">                tvp-&gt;tv_sec = ms/<span class="number">1000</span>;</div><div class="line">                tvp-&gt;tv_usec = (ms % <span class="number">1000</span>)*<span class="number">1000</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                tvp-&gt;tv_sec = <span class="number">0</span>;</div><div class="line">                tvp-&gt;tv_usec = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (flags &amp; AE_DONT_WAIT) &#123;</div><div class="line">                tv.tv_sec = tv.tv_usec = <span class="number">0</span>;</div><div class="line">                tvp = &amp;tv;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                tvp = <span class="literal">NULL</span>; <span class="comment">/* wait forever */</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">        numevents = aeApiPoll(eventLoop, tvp);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (flags &amp; AE_TIME_EVENTS)</div><div class="line">        processed += processTimeEvents(eventLoop);</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">aeApiPoll</span><span class="params">(aeEventLoop *eventLoop, struct timeval *tvp)</span> </span>&#123;</div><div class="line">    aeApiState *state = eventLoop-&gt;apidata;</div><div class="line">    <span class="keyword">int</span> retval, numevents = <span class="number">0</span>;</div><div class="line"></div><div class="line">    retval = epoll_wait(state-&gt;epfd,state-&gt;events,eventLoop-&gt;setsize,</div><div class="line">            tvp ? (tvp-&gt;tv_sec*<span class="number">1000</span> + tvp-&gt;tv_usec/<span class="number">1000</span>) : <span class="number">-1</span>);</div><div class="line">    <span class="keyword">if</span> (retval &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">int</span> j;</div><div class="line">        ...</div><div class="line">        numevents = retval;</div><div class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; numevents; j++) &#123;</div><div class="line">            <span class="keyword">int</span> mask = <span class="number">0</span>;</div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> *<span class="title">e</span> = <span class="title">state</span>-&gt;<span class="title">events</span>+<span class="title">j</span>;</span></div><div class="line">            ...</div><div class="line">            <span class="keyword">if</span> (e-&gt;events &amp; EPOLLIN) mask |= AE_READABLE;</div><div class="line">            <span class="keyword">if</span> (e-&gt;events &amp; EPOLLOUT) mask |= AE_WRITABLE;</div><div class="line">            <span class="keyword">if</span> (e-&gt;events &amp; EPOLLERR) mask |= AE_WRITABLE;</div><div class="line">            <span class="keyword">if</span> (e-&gt;events &amp; EPOLLHUP) mask |= AE_WRITABLE;</div><div class="line">            eventLoop-&gt;fired[j].fd = e-&gt;data.fd;</div><div class="line">            eventLoop-&gt;fired[j].mask = mask;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> numevents;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">processTimeEvents</span><span class="params">(aeEventLoop *eventLoop)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> processed = <span class="number">0</span>;</div><div class="line">    aeTimeEvent *te, *prev;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> maxId;</div><div class="line">    <span class="keyword">time_t</span> now = time(<span class="literal">NULL</span>);</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (now &lt; eventLoop-&gt;lastTime) &#123;</div><div class="line">        te = eventLoop-&gt;timeEventHead;</div><div class="line">        <span class="keyword">while</span>(te) &#123;</div><div class="line">            te-&gt;when_sec = <span class="number">0</span>;</div><div class="line">            te = te-&gt;next;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    eventLoop-&gt;lastTime = now;</div><div class="line">    ...</div><div class="line">    prev = <span class="literal">NULL</span>;</div><div class="line">    te = eventLoop-&gt;timeEventHead;</div><div class="line">    maxId = eventLoop-&gt;timeEventNextId<span class="number">-1</span>;</div><div class="line">    <span class="keyword">while</span>(te) &#123;</div><div class="line">        <span class="keyword">long</span> now_sec, now_ms;</div><div class="line">        <span class="keyword">long</span> <span class="keyword">long</span> id;</div><div class="line">        ...</div><div class="line">        aeGetTime(&amp;now_sec, &amp;now_ms);</div><div class="line">        <span class="keyword">if</span> (now_sec &gt; te-&gt;when_sec ||</div><div class="line">            (now_sec == te-&gt;when_sec &amp;&amp; now_ms &gt;= te-&gt;when_ms))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">int</span> retval;</div><div class="line"></div><div class="line">            id = te-&gt;id;</div><div class="line">            retval = te-&gt;timeProc(eventLoop, id, te-&gt;clientData);</div><div class="line">            processed++;</div><div class="line">            <span class="keyword">if</span> (retval != AE_NOMORE) &#123;</div><div class="line">                aeAddMillisecondsToNow(retval,&amp;te-&gt;when_sec,&amp;te-&gt;when_ms);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                te-&gt;id = AE_DELETED_EVENT_ID;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        prev = te;</div><div class="line">        te = te-&gt;next;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> processed;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="0x4-Libevent’s-implementation"><a href="#0x4-Libevent’s-implementation" class="headerlink" title="0x4 Libevent’s implementation"></a>0x4 Libevent’s implementation</h1><p>libevent uses timerfd to handle timer when USING_TIMERFD is set, here is the code, it uses timerfd_create() to create timefd.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> * <span class="title">epoll_init</span><span class="params">(struct event_base *base)</span></span></div><div class="line">&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USING_TIMERFD</span></div><div class="line">	<span class="keyword">if</span> ((base-&gt;flags &amp; EVENT_BASE_FLAG_PRECISE_TIMER) &amp;&amp;</div><div class="line">	    base-&gt;monotonic_timer.monotonic_clock == CLOCK_MONOTONIC) &#123;</div><div class="line">		<span class="keyword">int</span> fd;</div><div class="line">		fd = epollop-&gt;timerfd = timerfd_create(CLOCK_MONOTONIC, TFD_NONBLOCK|TFD_CLOEXEC);</div><div class="line">		<span class="keyword">if</span> (epollop-&gt;timerfd &gt;= <span class="number">0</span>) &#123;</div><div class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">epev</span>;</span></div><div class="line">			<span class="built_in">memset</span>(&amp;epev, <span class="number">0</span>, <span class="keyword">sizeof</span>(epev));</div><div class="line">			epev.data.fd = epollop-&gt;timerfd;</div><div class="line">			epev.events = EPOLLIN;</div><div class="line">			<span class="keyword">if</span> (epoll_ctl(epollop-&gt;epfd, EPOLL_CTL_ADD, fd, &amp;epev) &lt; <span class="number">0</span>) &#123;</div><div class="line">				event_warn(<span class="string">"epoll_ctl(timerfd)"</span>);</div><div class="line">				close(fd);</div><div class="line">				epollop-&gt;timerfd = <span class="number">-1</span>;</div><div class="line">			&#125;</div><div class="line">        &#125; </div><div class="line">        ...</div><div class="line">	&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here is the code to set the timeout for timerfd, it call timerfd_settime() to set the timeout. When timeout happens, it will trigger the timerfd which is waiting on epoll_wait(), then the event loop can process the timer handler.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">epoll_dispatch</span><span class="params">(struct event_base *base, struct timeval *tv)</span></span></div><div class="line">&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USING_TIMERFD</span></div><div class="line">	<span class="keyword">if</span> (epollop-&gt;timerfd &gt;= <span class="number">0</span>) &#123;</div><div class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">itimerspec</span> <span class="title">is</span>;</span></div><div class="line">		is.it_interval.tv_sec = <span class="number">0</span>;</div><div class="line">		is.it_interval.tv_nsec = <span class="number">0</span>;</div><div class="line">		<span class="keyword">if</span> (tv == <span class="literal">NULL</span>) &#123;</div><div class="line">			is.it_value.tv_sec = <span class="number">0</span>;</div><div class="line">			is.it_value.tv_nsec = <span class="number">0</span>;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (tv-&gt;tv_sec == <span class="number">0</span> &amp;&amp; tv-&gt;tv_usec == <span class="number">0</span>) &#123;</div><div class="line">				timeout = <span class="number">0</span>;</div><div class="line">			&#125;</div><div class="line">			is.it_value.tv_sec = tv-&gt;tv_sec;</div><div class="line">			is.it_value.tv_nsec = tv-&gt;tv_usec * <span class="number">1000</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (timerfd_settime(epollop-&gt;timerfd, <span class="number">0</span>, &amp;is, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</div><div class="line">			event_warn(<span class="string">"timerfd_settime"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    ...</div><div class="line">    res = epoll_wait(epollop-&gt;epfd, events, epollop-&gt;nevents, timeout);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Timerfd’s kernel implementation</p>
<p>In Linux kernel, timerfd’s implementation uses hrtimer to support timer, the corresponding code is placed in kernel/fs/timerfd.c.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/01/try-vulkan-on-windows/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/01/try-vulkan-on-windows/" itemprop="url">Try vulkan on windows</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-01T23:21:36+09:00">
                2017-07-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/07/01/try-vulkan-on-windows/" class="leancloud_visitors" data-flag-title="Try vulkan on windows">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Vulkan简介"><a href="#0x1-Vulkan简介" class="headerlink" title="0x1 Vulkan简介"></a>0x1 Vulkan简介</h1><p>Vulkan是轻量级、更贴近底层硬件的接口，可使GPU驱动程序充分利用多核CPU性能.</p>
<p>对于CPU处理是瓶颈的3D场景，采用Vulkan能提升性能.</p>
<p>Vulkan可以节省shader编译的时间，因为Vulkan只需要处理SPIR-V中间代码.</p>
<p>Vulkan不负责内存的管理，多线程的管理和并发访问保护，由应用程序去负责这些工作.</p>
<p>下面介绍一下如何在Windows下编译和测试Vulkan，显卡是Intel HD Graphics 520.</p>
<h1 id="0x2-安装支持Vulkan的graphics驱动"><a href="#0x2-安装支持Vulkan的graphics驱动" class="headerlink" title="0x2 安装支持Vulkan的graphics驱动"></a>0x2 安装支持Vulkan的graphics驱动</h1><p>下载并安装最新的graphics驱动</p>
<p><a href="https://communities.intel.com/external-link.jspa?url=https%3A%2F%2Fdownloadmirror.intel.com%2F26563%2Feng%2Fwin64_154514.4590.zip" target="_blank" rel="external">https://communities.intel.com/external-link.jspa?url=https%3A%2F%2Fdownloadmirror.intel.com%2F26563%2Feng%2Fwin64_154514.4590.zip</a></p>
<h1 id="0x3-安装Lunarg-Vulkan-SDK"><a href="#0x3-安装Lunarg-Vulkan-SDK" class="headerlink" title="0x3 安装Lunarg Vulkan SDK"></a>0x3 安装Lunarg Vulkan SDK</h1><p>下载地址如下</p>
<p><a href="https://vulkan.lunarg.com/sdk/home#sdk/downloadConfirm/1.0.51.0/windows/VulkanSDK-1.0.51.0-Installer.exe" target="_blank" rel="external">https://vulkan.lunarg.com/sdk/home#sdk/downloadConfirm/1.0.51.0/windows/VulkanSDK-1.0.51.0-Installer.exe</a></p>
<h1 id="0x4-安装Vulkan-Hardware-Capability-Viewer"><a href="#0x4-安装Vulkan-Hardware-Capability-Viewer" class="headerlink" title="0x4 安装Vulkan Hardware Capability Viewer"></a>0x4 安装Vulkan Hardware Capability Viewer</h1><p>用于查看系统中vulkan支持信息</p>
<p>可执行程序如下</p>
<p><a href="http://vulkan.gpuinfo.org/downloads/vulkancapsviewer_1_4_win64.zip" target="_blank" rel="external">http://vulkan.gpuinfo.org/downloads/vulkancapsviewer_1_4_win64.zip</a></p>
<p>代码如下</p>
<p><a href="https://github.com/SaschaWillems/VulkanCapsViewer" target="_blank" rel="external">https://github.com/SaschaWillems/VulkanCapsViewer</a></p>
<p>运行效果如下</p>
<p><img src="/2017/07/01/try-vulkan-on-windows/vulkan_hardware_capability_viewer.png" alt="vulkan1"></p>
<h1 id="0x5-编译运行Vulkan-demo"><a href="#0x5-编译运行Vulkan-demo" class="headerlink" title="0x5 编译运行Vulkan demo"></a>0x5 编译运行Vulkan demo</h1><p>代码如下</p>
<p><a href="https://github.com/GameTechDev/stardust_vulkan" target="_blank" rel="external">https://github.com/GameTechDev/stardust_vulkan</a></p>
<p>运行效果如下</p>
<p><img src="/2017/07/01/try-vulkan-on-windows/stardust_demo.png" alt="vulkan2"></p>
<p>下载gpu-z，查看gpu使用情况</p>
<p><a href="https://www.techpowerup.com/download/techpowerup-gpu-z/" target="_blank" rel="external">https://www.techpowerup.com/download/techpowerup-gpu-z/</a></p>
<p>从gpu-z的使用情况可知，gpu一直很忙，说明vulkan已经工作</p>
<p><img src="/2017/07/01/try-vulkan-on-windows/stardust_demo_gpu-z.png" alt="vulkan3"></p>
<h1 id="0x6-编译运行Vulkan-example"><a href="#0x6-编译运行Vulkan-example" class="headerlink" title="0x6 编译运行Vulkan example"></a>0x6 编译运行Vulkan example</h1><p>测试代码如下</p>
<p><a href="https://github.com/SaschaWillems/Vulkan" target="_blank" rel="external">https://github.com/SaschaWillems/Vulkan</a></p>
<p>运行效果如下</p>
<p><img src="/2017/07/01/try-vulkan-on-windows/vulkan_example.png" alt="vulkan4"></p>
<h1 id="0x7-Vulkan-Architecture-on-Windows"><a href="#0x7-Vulkan-Architecture-on-Windows" class="headerlink" title="0x7 Vulkan Architecture on Windows"></a>0x7 Vulkan Architecture on Windows</h1><p><img src="/2017/07/01/try-vulkan-on-windows/vulkan_on_windows.png" alt="vulkan5"></p>
<p>vulkan-1.dll, The Vulkan loader.</p>
<p>ig9icd64.dll/igc64.dll/igvk64.dll, Intel vulkan driver.</p>
<h1 id="0x8-Vulkan-Architecture-on-Android"><a href="#0x8-Vulkan-Architecture-on-Android" class="headerlink" title="0x8 Vulkan Architecture on Android"></a>0x8 Vulkan Architecture on Android</h1><p><img src="/2017/07/01/try-vulkan-on-windows/vulkan_on_android.png" alt="vulkan6"></p>
<p>libvulkan.so</p>
<p>Android vulkan HAL library, this library will load IHV’s vulkan library in /system/lib/hw automatically, application will load this library then map vulkan api call to IHV’s vulkan driver library.</p>
<p>vulkan.xxx.so</p>
<p>IHV’s vulkan driver library, it supports SPIR-V shader input, and implements vulkan API, will trigger GPU HW to do acutal graphics processing.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/17/design-rsplayer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/17/design-rsplayer/" itemprop="url">P2P直播客户端RsPlayer的设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-17T21:59:26+09:00">
                2017-06-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/06/17/design-rsplayer/" class="leancloud_visitors" data-flag-title="P2P直播客户端RsPlayer的设计">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-客户端总体框架"><a href="#0x1-客户端总体框架" class="headerlink" title="0x1 客户端总体框架"></a>0x1 客户端总体框架</h1><p>传统的直播客户端只能从流媒体服务器下载流媒体数据，RsPlayer作为一个P2P(peer to peer)的直播客户端，可以同时从流媒体服务器和其他客户端请求媒体数据，比传统的直播客户端相比可以节省流媒体服务器的带宽.</p>
<p>下图显示了客户端的框架图.</p>
<p>最上层是UI层，提供用户的交互操作，用来显示播放视频窗口.</p>
<p>然后是P2PCore层，该层采用P2P方式接收和发送媒体数据.</p>
<p>P2PCore的下面是network层，用来处理socket接收和发送.</p>
<p>ffmpeg层用来处理媒体数据，音视频分离，音视频解码，音视频输出等.</p>
<p><img src="/2017/06/17/design-rsplayer/architecture.png" alt="architecture"></p>
<h1 id="0x2-P2PCore模块"><a href="#0x2-P2PCore模块" class="headerlink" title="0x2 P2PCore模块"></a>0x2 P2PCore模块</h1><p>如下图所示，p2pcore模块需要和三类服务器进行通讯，先从web server得到需要播放的流媒体链接，然后从tracker得到super peer的相关信息，然后再连接到super peer下载所需要的直播流数据，同时也会从其他p2pcore处下载直播流数据.</p>
<p>下面会详细介绍一下和这三类服务器的交互，也会介绍一下和其他p2pcore的交互过程.<br><img src="/2017/06/17/design-rsplayer/p2pcore.png" alt="p2pcore"></p>
<h2 id="与web服务器交互"><a href="#与web服务器交互" class="headerlink" title="与web服务器交互"></a>与web服务器交互</h2><p>RsStreamer把p2p直播流链接存储在web服务器上，RsPlayer读取存储在web服务器上的p2p直播流链接，然后解析该链接，从中读取tracker服务器的地址，然后建立和tracker服务器的tcp连接.</p>
<h2 id="与tracker服务器交互"><a href="#与tracker服务器交互" class="headerlink" title="与tracker服务器交互"></a>与tracker服务器交互</h2><p>p2pcore发送登录消息到tracker服务器.</p>
<p>p2pcore把p2p直播流链接（从web服务器下载得到）解析得到的直播流信息发送给tracker服务器.</p>
<p>tracker服务器返回消息给p2pcore，告诉将要播放的直播流对应的super peer地址信息，同时也告诉播放同一直播流的其他p2pcore的地址信息.</p>
<p>p2pcore得到super peer地址以后，请求与其建立连接，并请求其发送相应的媒体数据.</p>
<p>p2pcore得到其他p2pcore地址以后也会请求与其建立相应的连接.</p>
<p>p2pcore还会定期向tracker服务器请求直播流的相关信息, 如当前播放的数据包的编号.</p>
<p>tracker服务器发送信息告诉p2pcore当前直播播放的数据包的编号.</p>
<h2 id="与super-peer交互"><a href="#与super-peer交互" class="headerlink" title="与super peer交互"></a>与super peer交互</h2><p>p2pcore建立和super peer的连接以后，把需要播放的直播流资源的信息发送给super peer, 并把直播流的数据包编号发送给super peer.</p>
<p>super peer然后把需要播放的直播流的头文件信息发送给p2p client, 然后根据其请求的资源编号发送直播流数据包.</p>
<p>上面提到了直播流的数据包编号，这个编号用来标记直播数据包，可以在p2p服务器和客户端之间统一管理直播数据. 如客户端需要哪个数据包，只需要把编号发送给服务器或其他客户端.</p>
<h2 id="与其他p2pcore交互"><a href="#与其他p2pcore交互" class="headerlink" title="与其他p2pcore交互"></a>与其他p2pcore交互</h2><p>这部分是体现RsPlayer直播客户端中p2p的部分，RsPlayer的p2pcore模块需要分析哪些数据需要从super peer得到，哪些数据需要从其他p2pcore处得到。</p>
<p>p2pcore建立和其他p2pcore的连接以后，需要查询其他p2pcore上有哪些数据包，其他p2pcore把其拥有的数据包信息发送过来以后，RsPlayer经过分析，决定需要从其接收哪些数据包，然后把需要的数据包信息发送给其他p2pcore, 其他p2pcore根据其请求的数据包编号发送相应的媒体数据包.</p>
<h1 id="0x3-多媒体解码模块"><a href="#0x3-多媒体解码模块" class="headerlink" title="0x3 多媒体解码模块"></a>0x3 多媒体解码模块</h1><p>p2pcore模块中的接收线程接收网络码流放到buffer中，ffmpeg中的解码线程从buffer中取出码流并解码输出.<br><img src="/2017/06/17/design-rsplayer/buffer_manager.png" alt="buffer_manager"></p>
<h2 id="ffmpeg介绍"><a href="#ffmpeg介绍" class="headerlink" title="ffmpeg介绍"></a>ffmpeg介绍</h2><p>ffmpeg是一套开源的音视频处理库，包括文件格式处理库libavformat, 音视频编解码库libavcodec等，，目前各大视频网站提供的应用程序中都集成了ffmpeg.</p>
<h2 id="p2pcore模块与ffmpeg模块的交互"><a href="#p2pcore模块与ffmpeg模块的交互" class="headerlink" title="p2pcore模块与ffmpeg模块的交互"></a>p2pcore模块与ffmpeg模块的交互</h2><p>修改ffmpeg中libavformat的代码，在ffmpeg中添加buffer protocol的输入接口，通过调用buffer protocol的输入接口，把外部读取buffer的函数指针作为参数传入到ffmpeg中，ffmpeg的解码线程需要数据的时候就调用这个函数指针，从而读取到需要的码流数据.</p>
<p>ffmpeg中添加buffer protocol的输入接口代码如下.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* buffer protocol */</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">buff_open</span><span class="params">(URLContext *h, <span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> flags)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> fd;</div><div class="line">	<span class="keyword">char</span> *context = <span class="built_in">strstr</span>(filename,<span class="string">"context"</span>);</div><div class="line">	av_strstart(filename, <span class="string">"buff:"</span>, &amp;filename);</div><div class="line"></div><div class="line">	fd = atoi(filename);</div><div class="line">	h-&gt;priv_data = (<span class="keyword">void</span> *) (<span class="keyword">intptr_t</span>) fd;</div><div class="line"></div><div class="line">	av_strstart(context, <span class="string">"context:"</span>, &amp;context);</div><div class="line">	h-&gt;priv_data2 = (<span class="keyword">void</span> *) (atoi(context));</div><div class="line"></div><div class="line">	h-&gt;is_streamed = <span class="number">1</span>;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*read_callback_fcn)</span><span class="params">(<span class="keyword">void</span>* param, <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> size)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">buff_read</span><span class="params">(URLContext *h, <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> size)</span></span></div><div class="line">&#123;</div><div class="line">	read_callback_fcn read_callback = (read_callback_fcn ) h-&gt;priv_data;</div><div class="line">	<span class="keyword">return</span> read_callback(h-&gt;priv_data2, buf, size);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">buff_write</span><span class="params">(URLContext *h, <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> size)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">URLProtocol buff_protocol = &#123;</div><div class="line">	<span class="string">"buff"</span>,</div><div class="line">	buff_open,</div><div class="line">	buff_read,</div><div class="line">	buff_write,</div><div class="line">	<span class="literal">NULL</span>,</div><div class="line">	<span class="literal">NULL</span>,</div><div class="line">	<span class="literal">NULL</span>,</div><div class="line">	<span class="literal">NULL</span>,</div><div class="line">	<span class="literal">NULL</span>,</div><div class="line">	file_get_handle</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>如何调用这个buffer protocol呢，我们的播放采用ffplay的流程，把按如下所示生成的mediafeeder_str作为ffplay的参数即可，mediafeeder_context是下面提到的类mediadatafeeder的对象指针，mediafeeder_handle是下面提到的类mediadatafeeder成员函数readdata()指针. ffplay先解析mediafeeder_str的内容，根据buff关键字匹配到buffer protocol的输入接口, buffer protocol的输入接口然后来调用mediadatafeeder::readdata().<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">sprintf</span>(mediafeeder_str,<span class="string">"buff:%dcontext:%d\0"</span>,mediafeeder_handle, mediafeeder_context);</div></pre></td></tr></table></figure></p>
<p>前面提到ffmpeg解码的时候会调用buffer protocol中的buff_read()函数，然后再调用p2pcore中的mediadatafeeder::readdata ()函数. 然后再调用livebuffermgr::getblock()读取到码流.</p>
<p>下面是在p2pcore中实现buffer读取的函数.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> mediadatafeeder::readdata(<span class="keyword">void</span>* param, <span class="keyword">unsigned</span> <span class="keyword">char</span>* buffer, <span class="keyword">int</span> size)</div><div class="line">&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>p2pcore中的buffer管理如下.<br>getblock()接口供上面的readdata函数调用, 相当于ffmpeg线程中调用该函数.<br>putblock()会被p2pcore中的网络接收线程调用.</p>
<p>由于livebuffermgr的getblock()和putblock()会被不同的线程调用，所以里面的buffer数据访问需要加锁以避免多线程之间的数据访问冲突.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> livebuffermgr::getblock(<span class="keyword">int</span> blockID, <span class="keyword">int</span> blockSize, <span class="keyword">unsigned</span> <span class="keyword">char</span>* data)</div><div class="line">&#123;</div><div class="line">&#125;</div><div class="line"><span class="keyword">void</span> livebuffermgr::putblock(<span class="keyword">int</span> blockID, <span class="keyword">int</span> blockSize, <span class="keyword">unsigned</span> <span class="keyword">char</span>*  data)</div><div class="line">&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="0x4-在Android平台上的实现"><a href="#0x4-在Android平台上的实现" class="headerlink" title="0x4 在Android平台上的实现"></a>0x4 在Android平台上的实现</h1><p>在Android平台上实现RsPlayer客户端的话，p2pcore和ffmpeg都封装成相应的so库, 需要设置Android NDK开发环境, 采用Android Studio来开发.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/10/optimize-jpeg-decoder-on-multicore-cpu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/10/optimize-jpeg-decoder-on-multicore-cpu/" itemprop="url">optimize jpeg decoder on multicore cpu</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-10T20:14:25+09:00">
                2017-06-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/06/10/optimize-jpeg-decoder-on-multicore-cpu/" class="leancloud_visitors" data-flag-title="optimize jpeg decoder on multicore cpu">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-jpeg解码流程"><a href="#0x1-jpeg解码流程" class="headerlink" title="0x1 jpeg解码流程"></a>0x1 jpeg解码流程</h1><p>JPEG是Joint Photographic Expert Group的缩写，按照解码算法的基本结构进行分类的话，可以分为两种方式，</p>
<p>有失真的非可逆的DCT方式.</p>
<p>无失真的可逆的Spatial方式.</p>
<h2 id="DCT方式的解码流程"><a href="#DCT方式的解码流程" class="headerlink" title="DCT方式的解码流程"></a>DCT方式的解码流程</h2><p><img src="/2017/06/10/optimize-jpeg-decoder-on-multicore-cpu/dct_jpeg.png" alt="dct_jpeg"></p>
<h2 id="Spatial方式的解码流程"><a href="#Spatial方式的解码流程" class="headerlink" title="Spatial方式的解码流程"></a>Spatial方式的解码流程</h2><p><img src="/2017/06/10/optimize-jpeg-decoder-on-multicore-cpu/spatial_jpeg.png" alt="spatial_jpeg"></p>
<h1 id="0x2-多核优化介绍"><a href="#0x2-多核优化介绍" class="headerlink" title="0x2 多核优化介绍"></a>0x2 多核优化介绍</h1><p>我们对应用程序采用多线程化来充分利用多核的性能，下面介绍一下多线程框架.</p>
<h2 id="多线程框架介绍"><a href="#多线程框架介绍" class="headerlink" title="多线程框架介绍"></a>多线程框架介绍</h2><p>典型的多线程框架包括一个主线程，多个工作线程，一个工作队列.</p>
<p>主线程负责接收外部分配过来的任务，把任务拆分成子任务并保存到工作队列中，然后调度工作线程进行具体的操作.</p>
<p>工作线程执行具体的操作，工作线程完成一个操作以后通知主线程，并更新当前子任务的状态到工作队列中，工作线程进入空闲状态.</p>
<p>主线程根据工作队列中子任务的状态，分配子任务到刚才空闲的工作线程中，工作线程继续执行分配到的子任务.</p>
<p>多线程框架可以表示如下图所示</p>
<p><img src="/2017/06/10/optimize-jpeg-decoder-on-multicore-cpu/multithread_framework.png" alt="multithread_framework"></p>
<h2 id="多线程并行执行和线程间同步"><a href="#多线程并行执行和线程间同步" class="headerlink" title="多线程并行执行和线程间同步"></a>多线程并行执行和线程间同步</h2><p>多个工作线程之间是并行执行的，这样可以充分利用多核的优势.</p>
<p>但是工作线程执行完成以后，需要和其他工作线程进行同步，因为工作线程执行的子任务之间可能有依赖关系，也就是说某一个子任务可能需要等其他子任务执行完成以后才能继续执行.</p>
<h2 id="多线程程序框架"><a href="#多线程程序框架" class="headerlink" title="多线程程序框架"></a>多线程程序框架</h2><p>下面列出各个模块的代码.</p>
<p>工作线程<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">workthread</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">      <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">threadproc</span><span class="params">()</span></span>;</div><div class="line">      <span class="function"><span class="keyword">bool</span> <span class="title">start</span><span class="params">()</span></span>;</div><div class="line">      <span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span></span>;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">      workerqueue* worker_queue;         </div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>工作队列<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">task</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">      <span class="keyword">int</span> start;</div><div class="line">      <span class="keyword">int</span> end;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">workerqueue</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">      <span class="function"><span class="keyword">void</span> <span class="title">puttask</span><span class="params">()</span></span>;</div><div class="line">      <span class="function"><span class="keyword">void</span> <span class="title">gettask</span><span class="params">()</span></span>;</div><div class="line">      <span class="function"><span class="keyword">void</span> <span class="title">updatetask</span><span class="params">()</span></span>;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">      <span class="built_in">vector</span>&lt;task*&gt; task_vector;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>主线程<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">mainthread</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">      <span class="function"><span class="keyword">void</span> <span class="title">schedule_workerthread</span><span class="params">()</span></span>;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">      <span class="built_in">vector</span>&lt;workthread*&gt; thread_vector;</div><div class="line">      workerqueue* worker_queue;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h1 id="0x3-jpeg解码多核优化分析"><a href="#0x3-jpeg解码多核优化分析" class="headerlink" title="0x3 jpeg解码多核优化分析"></a>0x3 jpeg解码多核优化分析</h1><h2 id="解码模块分解"><a href="#解码模块分解" class="headerlink" title="解码模块分解"></a>解码模块分解</h2><p>从上面的解码流程图可知，一个jpeg解码包括熵解码, 反量化，idct，加上后处理如颜色空间转换csc等.</p>
<p>先分析各个模块在整个解码过程中占用多少时间，这个过程可以通过运行典型的测试来得到，通过计算典型jpeg文件的解码时间在各个模块中的分布，可以知道这几个子模块在jpeg解码器中占用多少时间。通过分析各个模块的时间，我们可以把这个解码流程分成几个时间差不多的子模块，如可以分解成这三个子模块，huffman decoder, iq和idct, csc. 进行这样的分析是为了使各个模块的执行时间差不多，这样采用多核执行的时候能使各个核的运行更balance.</p>
<p>另外我们可以把整个图像分解成几部分，对这几部分分别进行解码。可以按照16/32/64/128的高度进行分解，这样可以把图像分解成很多份，如1920*1080的jpeg图像，分解成1920/16 = 120份，这120份的图像分别进行解码，可以提高解码效率，当然这个120份之间还有一些前后依赖关系，所以不能完全并行，需要进行同步和调度，下面会提到如何进行同步和调度. 另外具体是按16的高度，还是按照其他高度进行分解，需要进行tuning，需要参考图像的大小和工作线程的个数（一般等同于cpu的核数），进行各个高度分解下的性能比较，得出一个性能最好的分解方式.</p>
<h2 id="解码模块实现"><a href="#解码模块实现" class="headerlink" title="解码模块实现"></a>解码模块实现</h2><p>把jpeg解码器的模块独立成子模块来实现. 下面简单介绍一下这些模块.</p>
<p>1.熵解码器，记为huffman decoder</p>
<p>扩展系统中也包括算术解码器，这里仅以huffman decoder来代替.</p>
<p>分别对DC和AC系数进行解码，根据DC/AC的解码表来解码.</p>
<p>DC系数的解码还需要参考前一个像素块的DC系数，因为huffman decoder解码出来的只是和前一个像素块的DC系数的查分值，把查分值加上前一个像素块的DC系数就得到了当前像素块的DC值.</p>
<p>AC系数的解码是根据解码表计算出非零AC系数和该AC系数前面的零的个数，就是通常所说的run和level, 然后根据zigzag的扫描方式还原成8*8的系数.</p>
<p>2.反量化器和反DCT，记为iq/idct</p>
<p>对前面得到的8*8的系数，查找量化表，然后进行IDCT计算，得到解码以后的像素值.</p>
<p>3.颜色空间转换，记为csc</p>
<p>执行yuv到rgb的转换.</p>
<h2 id="解码模块之间的同步"><a href="#解码模块之间的同步" class="headerlink" title="解码模块之间的同步"></a>解码模块之间的同步</h2><p>前面提到把整个解码流程分解成huffman decoder, inverse quantizer/idct, csc.</p>
<p>对于某一个8*8的像素块来说，只能是按照前面的解码流程来进行解码，不能有跳跃</p>
<p>我们整个图像分解成几部分以后，只有前面一部分的huffman decoder解码完成以后，后面一部分的huffman decoder才能开始，因为前后部分的码流只有在解码以后才能分清楚从具体什么位置开始是后面一部分的码流，也就是说不经过解码，前后部分的码流没办法分割，另外一个原因是DC值得解码需要参考前面一个像素块的DC.</p>
<p>前面一部分完成了huffman解码以后，可以开始inverse quantizer和idct，在这个时候后面一部分可以开始huffman解码，以此类推.</p>
<h2 id="解码模块的执行过程演示"><a href="#解码模块的执行过程演示" class="headerlink" title="解码模块的执行过程演示"></a>解码模块的执行过程演示</h2><p>下图演示了多线程解码的过程.</p>
<p>我们把一个解码图像分成多块block1,block2,block3,block4,… 对每块图像分别执行上面介绍的解码子模块.</p>
<p>T0时间点，只有block1进行huffman解码. block1的解码工作由线程1完成.</p>
<p>T1时间点，block1进行iq/idct, block2进行huffman解码. block1的解码工作由线程1完成，block2的解码工作由线程2完成.</p>
<p>T2时间点，block1进行csc, block2进行iq/idct解码, block3进行huffman解码. block1的解码工作由线程1完成，block2的解码工作由线程2完成，block3的解码工作由线程3完成</p>
<p>T3时间点，block2进行csc解码, block3进行iq/idct解码, block4进行huffman解码. block2的解码工作由线程2完成，block3的解码工作由线程3完成，block4的解码工作由线程1完成</p>
<p>如上分析所示，这个多线程解码的过程只能保证3个线程被利用到，如果cpu的核比较多的话，并不能很好地利用cpu资源. 这个时候可以考虑多个jpeg同时解码来充分利用cpu资源.</p>
<p><img src="/2017/06/10/optimize-jpeg-decoder-on-multicore-cpu/execution_flow.png" alt="multithread_framework"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/04/design-monitor-interface-for-rsstreamer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/04/design-monitor-interface-for-rsstreamer/" itemprop="url">RsStreamer监控模块设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-04T09:19:08+09:00">
                2017-06-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/06/04/design-monitor-interface-for-rsstreamer/" class="leancloud_visitors" data-flag-title="RsStreamer监控模块设计">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-需求分析"><a href="#0x1-需求分析" class="headerlink" title="0x1 需求分析"></a>0x1 需求分析</h1><h2 id="0x10-HTTP监控"><a href="#0x10-HTTP监控" class="headerlink" title="0x10 HTTP监控"></a>0x10 HTTP监控</h2><p>   RsStreamer作为P2P流媒体服务器，需要和很多并发连接的P2P播放器进行通讯，把媒体数据发送给这些P2P播放器进行播放，另外还需要和其他如认证服务器进行通讯，进行用户验证等操作.</p>
<p>   RsStreamer在运行的过程中，很多内部状态需要及时地提供给用户，如统计有多少个用户观看了某部影片，提供某部影片流媒体服务的总带宽是多少，通过http服务的形式提供这些内部状态的监控信息，用户可以通过浏览器来直观地访问这些数据，从而了解系统运行的相关信息.</p>
<p>   另外用户还可以通过浏览器来配置RsStreamer，如限制某个用户的带宽，对某个特定的媒体频道限制用户数目.</p>
<p>   其他流媒体平台如helix server也提供网页形式的界面供用户查看运行状态和进行相关配置管理.</p>
<p>   其他开源软件如nginx也有类似的功能.</p>
<h2 id="0x11-数据分析"><a href="#0x11-数据分析" class="headerlink" title="0x11 数据分析"></a>0x11 数据分析</h2><p>   通过RsStreamer提供的http服务，把系统运行的相关信息通过RESTful接口的形式提供给数据分析系统(如elasticsearch)，进行分析以后，可以对用户播放流媒体影片的行为进行数据挖掘，训练影片推荐系统，从而提供更好的用户体验.</p>
<p>   下面先分析一下haproxy系统中监控模块是如何实现的，然后再提出RsStreamer中监控模块的设计方案.</p>
<h1 id="0x2-HAProxy的实现"><a href="#0x2-HAProxy的实现" class="headerlink" title="0x2 HAProxy的实现"></a>0x2 HAProxy的实现</h1><h2 id="0x20-总体结构"><a href="#0x20-总体结构" class="headerlink" title="0x20 总体结构"></a>0x20 总体结构</h2><p>haproxy中有关监控模块的总体结构图如下所示.<br><img src="/2017/06/04/design-monitor-interface-for-rsstreamer/haproxy_stats_architecture.png" alt="haproxy stats architecture"></p>
<p>http service基于epoll对外提供http服务，接受浏览器的请求，建立和浏览器之间的tcp连接，根据运行状态生成对应的html格式数据，通过tcp把html数据发送给浏览器，浏览器接收到数据以后显示haproxy的运行状态.</p>
<h2 id="0x21-代码流程"><a href="#0x21-代码流程" class="headerlink" title="0x21 代码流程"></a>0x21 代码流程</h2><h3 id="程序执行流程图如下"><a href="#程序执行流程图如下" class="headerlink" title="程序执行流程图如下"></a>程序执行流程图如下</h3><p><img src="/2017/06/04/design-monitor-interface-for-rsstreamer/haproxy_stats_sequence_diagram.png" alt="haproxy sequence"></p>
<p>程序的执行从main函数开始，然后调用poller函数等待事件的触发.<br>有stats的请求到来，poller函数触发.<br>然后根据运行状态生成html格式数据，通过tcp发生给浏览器.<br>下面对这个流程图的执行过程进行进一步的分析.</p>
<h2 id="0x22-相关代码模块分析"><a href="#0x22-相关代码模块分析" class="headerlink" title="0x22 相关代码模块分析"></a>0x22 相关代码模块分析</h2><h3 id="处理网络连接的主循环"><a href="#处理网络连接的主循环" class="headerlink" title="处理网络连接的主循环"></a>处理网络连接的主循环</h3><p>该循环调用poller的poll函数，检测是否有socket事件发生，用户在浏览器中输入<a href="http://127.0.0.1:1080/stats" target="_blank" rel="external">http://127.0.0.1:1080/stats</a>, haproxy收到请求，run_poll_loop()检测到有client来连接，建立tcp连接，然后调用applet_run_active()来处理这些事件.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Runs the polling loop */</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run_poll_loop</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">		<span class="comment">/* Process a few tasks */</span></div><div class="line">		process_runnable_tasks();</div><div class="line"></div><div class="line">		<span class="comment">/* check if we caught some signals and process them */</span></div><div class="line">		signal_process_queue();</div><div class="line"></div><div class="line">		<span class="comment">/* Check if we can expire some tasks */</span></div><div class="line">		next = wake_expired_tasks();</div><div class="line"></div><div class="line">		<span class="comment">/* stop when there's nothing left to do */</span></div><div class="line">		<span class="keyword">if</span> (jobs == <span class="number">0</span>)</div><div class="line">			<span class="keyword">break</span>;</div><div class="line"></div><div class="line">		<span class="comment">/* expire immediately if events are pending */</span></div><div class="line">		<span class="keyword">if</span> (fd_cache_num || tasks_run_queue || signal_queue_len || applets_active_queue)</div><div class="line">			next = now_ms;</div><div class="line"></div><div class="line">		<span class="comment">/* The poller will ensure it returns around &lt;next&gt; */</span></div><div class="line">		cur_poller.poll(&amp;cur_poller, next);</div><div class="line">		fd_process_cached_events();</div><div class="line">		applet_run_active();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="poller的poll-函数实现"><a href="#poller的poll-函数实现" class="headerlink" title="poller的poll()函数实现"></a>poller的poll()函数实现</h3><p>1.首先扫描fd更新列表fd_updt，找到需要处理的fd，再调用epoll_ctl()来往内核来注册epoll事件.<br>2.然后调用epoll_wait()等待事件的发生，事件触发以后，epoll_wait()函数返回，返回值是触发的事件数目.<br>3.再遍历已经触发的事件，根据是要读还是写分别调用fd_may_recv()和fd_may_send().<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">REGPRM2 <span class="keyword">static</span> <span class="keyword">void</span> _do_poll(struct poller *p, <span class="keyword">int</span> <span class="built_in">exp</span>)</div><div class="line">&#123;</div><div class="line">      ... ...</div><div class="line">      <span class="comment">/* first, scan the update list to find polling changes */</span></div><div class="line">      <span class="keyword">for</span> (updt_idx = <span class="number">0</span>; updt_idx &lt; fd_nbupdt; updt_idx++) &#123;</div><div class="line">          fd = fd_updt[updt_idx];</div><div class="line">          <span class="keyword">if</span> ((eo ^ en) &amp; FD_EV_POLLED_RW) &#123;</div><div class="line">             <span class="comment">/* poll status changed */</span></div><div class="line">             ... ...</div><div class="line">             epoll_ctl(epoll_fd, opcode, fd, &amp;ev);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      ... ...</div><div class="line">      <span class="comment">/* now let's wait for polled events */</span></div><div class="line">      status = epoll_wait(epoll_fd, epoll_events, global.tune.maxpollevents, wait_time);</div><div class="line">      <span class="comment">/* process polled events */</span></div><div class="line">      <span class="keyword">for</span> (count = <span class="number">0</span>; count &lt; status; count++) &#123;</div><div class="line">              ... ...</div><div class="line">              fd = epoll_events[count].data.fd;</div><div class="line">              ... ...</div><div class="line">              <span class="keyword">if</span> (n &amp; (FD_POLL_IN | FD_POLL_HUP | FD_POLL_ERR))</div><div class="line">                      fd_may_recv(fd);</div><div class="line">              <span class="keyword">if</span> (n &amp; (FD_POLL_OUT | FD_POLL_ERR))</div><div class="line">                      fd_may_send(fd);</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="applet-run-active-函数实现"><a href="#applet-run-active-函数实现" class="headerlink" title="applet_run_active()函数实现"></a>applet_run_active()函数实现</h3><p>从applet队列中找到需要执行的任务，调用相应的handler函数，对stats模块，其handler函数为http_stats_io_handler().</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">applet_run_active</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">       ... ...</div><div class="line">       <span class="keyword">while</span> (!LIST_ISEMPTY(&amp;applet_cur_queue)) &#123;</div><div class="line">             curr = LIST_ELEM(applet_cur_queue.n, typeof(curr), runq);</div><div class="line">             ... ...</div><div class="line">             si_applet_cant_get(si);</div><div class="line">             si_applet_stop_put(si);</div><div class="line">             curr-&gt;applet-&gt;fct(curr);</div><div class="line">             si_applet_wake_cb(si);</div><div class="line">             channel_release_buffer(si_ic(si), &amp;curr-&gt;buffer_wait);</div><div class="line">             ... ...</div><div class="line">       &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="stats模块在applet中的注册"><a href="#stats模块在applet中的注册" class="headerlink" title="stats模块在applet中的注册"></a>stats模块在applet中的注册</h3><p>把stats的处理函数http_stats_io_handler注册到applet中.<br>请注意关键字<strong>attribute</strong>((constructor))是gcc的关键字，表明这个函数是在main()函数执行之前被调用.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">truct applet http_stats_applet = &#123;</div><div class="line">         .obj_type = OBJ_TYPE_APPLET,</div><div class="line">         .name = <span class="string">"&lt;STATS&gt;"</span>, <span class="comment">/* used for logging */</span></div><div class="line">         .fct = http_stats_io_handler,</div><div class="line">         .release = <span class="literal">NULL</span>,</div><div class="line"> &#125;;</div><div class="line"></div><div class="line"> __attribute__((constructor))</div><div class="line"> <span class="keyword">static</span> <span class="keyword">void</span> __stat_init(<span class="keyword">void</span>)</div><div class="line"> &#123;</div><div class="line">         cli_register_kw(&amp;cli_kws);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="生成html格式监控数据"><a href="#生成html格式监控数据" class="headerlink" title="生成html格式监控数据"></a>生成html格式监控数据</h3><p>生成html格式监控数据的调用堆栈如下.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(gdb) bt</div><div class="line">#0  stats_fill_be_stats (px=px@entry=0x74fc30, flags=flags@entry=17, stats=stats@entry=0x7328e0 &lt;stats&gt;, len=len@entry=83)</div><div class="line">    at src/stats.c:1725</div><div class="line">#1  0x000000000046d238 in stats_dump_be_stats (si=si@entry=0x7a1a50, px=px@entry=0x74fc30, flags=flags@entry=17)</div><div class="line">    at src/stats.c:1814</div><div class="line">#2  0x000000000046edff in stats_dump_proxy_to_buffer (si=si@entry=0x7a1a50, px=px@entry=0x74fc30, uri=uri@entry=0x751a60)</div><div class="line">    at src/stats.c:2112</div><div class="line">#3  0x000000000046f967 in stats_dump_stat_to_buffer (si=si@entry=0x7a1a50, uri=0x751a60) at src/stats.c:2570</div><div class="line">#4  0x000000000046ffe7 in http_stats_io_handler (appctx=0x7a1e00) at src/stats.c:3072</div><div class="line">#5  0x00000000004dc208 in applet_run_active () at src/applet.c:66</div><div class="line">#6  0x000000000040a3d8 in run_poll_loop () at src/haproxy.c:2194</div><div class="line">#7  main (argc=&lt;optimized out&gt;, argv=0x7fffffffddb8) at src/haproxy.c:2700</div></pre></td></tr></table></figure></p>
<h2 id="0x23-监控相关配置"><a href="#0x23-监控相关配置" class="headerlink" title="0x23 监控相关配置"></a>0x23 监控相关配置</h2><p>在配置文件中加入下面的内容，然后启动haproxy，这样haproxy就支持状态监控了.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">listen admin_stats  </div><div class="line">       <span class="built_in">bind</span> 0.0.0.0:1080               </div><div class="line">       mode http                       <span class="comment">#http的7层模式  </span></div><div class="line">       option httplog                  <span class="comment">#http日志格式  </span></div><div class="line">       maxconn 10                      <span class="comment">#最大连接数  </span></div><div class="line">       stats refresh 30s               <span class="comment">#自动刷新时间  </span></div><div class="line">       stats uri /stats                <span class="comment">#页面url  </span></div><div class="line">       stats auth admin:admin          <span class="comment">#设置监控页面的用户和密码:admin</span></div></pre></td></tr></table></figure></p>
<h2 id="0x24-浏览器运行效果如下"><a href="#0x24-浏览器运行效果如下" class="headerlink" title="0x24 浏览器运行效果如下"></a>0x24 浏览器运行效果如下</h2><p>   从图中可以看到系统运行的状态.<br>   <img src="/2017/06/04/design-monitor-interface-for-rsstreamer/haproxy_stats.png" alt="haproxy stats"></p>
<h1 id="0x3-系统设计"><a href="#0x3-系统设计" class="headerlink" title="0x3 系统设计"></a>0x3 系统设计</h1><p>   参考haproxy的监控模块，设计RssStreamer的监控模块如下图所示.<br>   http service基于st对外提供http服务，st是基于epoll来实现的, 接受浏览器的请求，建立和浏览器之间的tcp连接，state monitor负责收集系统各个模块的运行状态，html generator根据运行状态生成对应的html格式数据，通过tcp把html数据发送给浏览器，浏览器接收到数据以后显示RsStreamer的运行状态.<br>   <img src="/2017/06/04/design-monitor-interface-for-rsstreamer/rsstreamer_monitor_architecture.png" alt="rsstreamer stats architecture"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/16/analysis-of-rtsp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/16/analysis-of-rtsp/" itemprop="url">analysis of rtsp</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-16T20:48:20+09:00">
                2016-07-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2016/07/16/analysis-of-rtsp/" class="leancloud_visitors" data-flag-title="analysis of rtsp">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x01-RTSP和RTMP简介"><a href="#0x01-RTSP和RTMP简介" class="headerlink" title="0x01     RTSP和RTMP简介"></a>0x01     RTSP和RTMP简介</h1><p>RTSP协议是流媒体协议，通过在播放器和服务端交互建立连接以后，服务器在不同的通道通过UDP把音频/视频数据发送给播放器。<br>RTSP协议传输的数据格式一般为TS,MP4。因为音视频是分别通过不同的UDP通道传输的，所以在服务端需要把ts/mp4文件做demux，然后再传输。我们可以采用live555,vlc,ffmpeg等作为rtsp服务器。</p>
<p>而RTMP协议则是通过一个TCP通道把音视频数据从服务端发送到播放器，RTMP协议传输的一般为flv格式数据。开源的RTMP服务器有red5,nginx-rtmp-module,srs。red5是java实现的服务器，nginx-rtmp-module是基于web服务器nginx开发的rtmp流媒体服务器，而srs的实现基于st(state-threads)的单线程多协程服务器。</p>
<h1 id="0x02-RTSP交互过程"><a href="#0x02-RTSP交互过程" class="headerlink" title="0x02  RTSP交互过程"></a>0x02  RTSP交互过程</h1><p>RTSP服务端和RTSP客户端的交互过程如下。<br>C表示RTSP客户端，S表示RTSP服务端</p>
<h2 id="0x21-OPTION"><a href="#0x21-OPTION" class="headerlink" title="0x21 OPTION"></a>0x21 OPTION</h2><p>C-&gt;S: OPTION request         //C询问S有哪些方法可用<br>S-&gt;C: OPTION response        //S回应提供的所有可用方法</p>
<h2 id="0x22-DESCRIBE"><a href="#0x22-DESCRIBE" class="headerlink" title="0x22 DESCRIBE"></a>0x22 DESCRIBE</h2><p>C-&gt;S: DESCRIBE request       //C要求得到S提供的媒体初始化描述信息<br>S-&gt;C: DESCRIBE response      //S回应媒体初始化描述信息(SDP)</p>
<h2 id="0x23-SETUP"><a href="#0x23-SETUP" class="headerlink" title="0x23 SETUP"></a>0x23 SETUP</h2><p>C-&gt;S: SETUP request          //C请求S建立会话<br>S-&gt;C: SETUP response         //S建立会话，返回会话相关信息</p>
<h2 id="0x24-PLAY"><a href="#0x24-PLAY" class="headerlink" title="0x24 PLAY"></a>0x24 PLAY</h2><p>C-&gt;S: PLAY request          //C请求播放<br>S-&gt;C: PLAY response         //S回应请求<br>S-&gt;C:                       //RTP发送流媒体数据</p>
<h2 id="0x25-TEARDOWN"><a href="#0x25-TEARDOWN" class="headerlink" title="0x25 TEARDOWN"></a>0x25 TEARDOWN</h2><p>C-&gt;S: TEARDOWN request      //C请求关闭会话<br>S-&gt;C: TEARDOWN response     //S回应请求</p>
<h1 id="0x03-抓包分析"><a href="#0x03-抓包分析" class="headerlink" title="0x03  抓包分析"></a>0x03  抓包分析</h1><p>RTSP服务端和客户端的整体交互过程如下。<br><img src="/2016/07/16/analysis-of-rtsp/rtsp_sequence.png" alt="rtsp_sequence"></p>
<h2 id="0x31-OPTION"><a href="#0x31-OPTION" class="headerlink" title="0x31 OPTION"></a>0x31 OPTION</h2><p>客户端询问服务器有哪些方法可用。<br><img src="/2016/07/16/analysis-of-rtsp/options_c_s.png" alt="options_c_s"><br>服务器返回可以使用的方法。<br>DESCRIBE,SETUP,TEARDOWN,PLAY,PAUSE,GET_PARAMETER\r\n<br><img src="/2016/07/16/analysis-of-rtsp/options_s_c.png" alt="options_s_c"></p>
<h2 id="0x32-DESCRIBE"><a href="#0x32-DESCRIBE" class="headerlink" title="0x32 DESCRIBE"></a>0x32 DESCRIBE</h2><p>客户端请求服务端发送SDP，服务端发送SDP给客户端。<br>如下所示，SDP中包括H264的sps和pps信息。<br><img src="/2016/07/16/analysis-of-rtsp/describe.png" alt="describe"></p>
<h2 id="0x33-SETUP"><a href="#0x33-SETUP" class="headerlink" title="0x33 SETUP"></a>0x33 SETUP</h2><p>客户端请求建立Audio和Video的UDP连接。</p>
<p>下面的Request请求建立Video的UDP连接。<br>Request: SETUP rtsp://192.168.40.1:8554/1/trackID=0 RTSP/1.0\r\n</p>
<p>下面的Request请求建立Audio的UDP连接。<br>Request: SETUP rtsp://192.168.40.1:8554/1/trackID=1 RTSP/1.0\r\n</p>
<p><img src="/2016/07/16/analysis-of-rtsp/setup.png" alt="setup"></p>
<h2 id="0x34-PLAY"><a href="#0x34-PLAY" class="headerlink" title="0x34 PLAY"></a>0x34 PLAY</h2><p>客户端请求服务端开始提供流媒体服务，开始发送音视频数据到客户端。<br>如下所示，Payload type为DynamicRTP-Type-96 (96)的RTP包发送的是Video数据，Payload type为MPEG-I/II Audio (14)的RTP包发送的是Audio数据。<br><img src="/2016/07/16/analysis-of-rtsp/play.png" alt="play"></p>
<h2 id="0x35-RTCP包"><a href="#0x35-RTCP包" class="headerlink" title="0x35 RTCP包"></a>0x35 RTCP包</h2><p>在开始传输音视频RTP包以后，RTCP用来提供客户端和服务端之间的传输反馈。服务端发送给客户端的RTCP包是Sender Report，客户端发送给服务端的RTCP包是Receiver Report。<br><img src="/2016/07/16/analysis-of-rtsp/rtcp.png" alt="rtcp"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Kevin Wen" />
          <p class="site-author-name" itemprop="name">Kevin Wen</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kevin Wen</span>
</div>


<div> <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
访问量 <span id="busuanzi_value_site_pv"></span>
访问人数 <span id="busuanzi_value_site_uv"></span>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("orq8xxsDQDXKiHdqSRcjlflB-gzGzoHsz", "ecCFdIcWDfbJKQOCiLFf1EBm");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
