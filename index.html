<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="Kevin Wen&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Kevin Wen&#39;s Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kevin Wen&#39;s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Kevin Wen's Blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kevin Wen's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/23/How-stencil-buffer_work-in-graphics-pipeline/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/23/How-stencil-buffer_work-in-graphics-pipeline/" itemprop="url">How stencil buffer work in graphics pipeline</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-23T20:15:30+09:00">
                2019-02-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2019/02/23/How-stencil-buffer_work-in-graphics-pipeline/" class="leancloud_visitors" data-flag-title="How stencil buffer work in graphics pipeline">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-总体介绍"><a href="#0x1-总体介绍" class="headerlink" title="0x1 总体介绍"></a>0x1 总体介绍</h1><p>下图是Stencil Test在在post fragment pipeline中的位置。<br><img src="/2019/02/23/How-stencil-buffer_work-in-graphics-pipeline/post_shader_fragment_pipeline.png" alt="post_shader_fragment_pipeline"></p>
<p>Stencil Test的作用可以把绘制限定在特定的区域，这点和scissor test类似，但是stencil test支持不规则的区域，而scissor test做不到这一点。</p>
<p>Stencil Test是通过stencil buffer中记录的模板信息来完成的，stencil buffer中保存着每个位置的fragment对应的mask值，当graphics pipeline执行stencil test的时候，把通过api设定的模板参考值与相应位置的fragment对应的mask值进行比较，如果不符合条件则被丢弃，反之则进行绘制。</p>
<p>Stencil Test的使用可以看成两步操作，第一步是生成stencil buffer，通过渲染几何体并指定stencil buffer的更新方式来实现。第二步是使用stencil buffer中的内容来控制最终颜色缓存区的渲染。</p>
<h1 id="0x2-从GPU硬件的角度理解Stencil-test"><a href="#0x2-从GPU硬件的角度理解Stencil-test" class="headerlink" title="0x2 从GPU硬件的角度理解Stencil test"></a>0x2 从GPU硬件的角度理解Stencil test</h1><p>下面介绍Stencil test是如何在gpu hardware pipeline中执行的。</p>
<p>下图是broadcom <a href="https://docs.broadcom.com/docs-and-downloads/docs/support/videocore/VideoCoreIV-AG100-R.pdf" target="_blank" rel="external">v3d</a> system block图。</p>
<p>v3d是tile buffer rendering的gpu，其渲染分成两个阶段，第一阶段是计算出每个tile中有哪些triangle需要绘制，第二阶段是遍历所有的tile，对每个tile执行真正的绘制工作。</p>
<p>如下图所示，stencil buffer是gpu hardware中tile buffer的一部分，这是gpu硬件中单独的一块buffer，用来保存当前渲染过程中使用到的stencil值。</p>
<p>在每个tile的绘制过程中，都需要根据tile坐标取得stencil buffer中对应的stencil mask, 然后执行stencil test, 执行完了以后，如果必要，还需要更新stencil buffer中对应的stencil值。</p>
<p><img src="/2019/02/23/How-stencil-buffer_work-in-graphics-pipeline/v3d_system_block.png" alt="v3d system block"></p>
<h1 id="0x3-Stencil-test测试程序"><a href="#0x3-Stencil-test测试程序" class="headerlink" title="0x3 Stencil test测试程序"></a>0x3 Stencil test测试程序</h1><p>这个Stencil test测试程序分成两步操作。</p>
<p>第一步只是生成stencil buffer的内容，该过程不输出color，只更新stencil buffer的内容。</p>
<p>更新stencil buffer的策略通过下面的api来控制。<br>glStencilOp(GL_KEEP, GL_INCR, GL_INCR);</p>
<p>第一个参数是stencil test fail的时候更新stencil buffer的操作，这里的GL_KEEP表明stencil test fail时不对stencil buffer进行更新。</p>
<p>第二个参数表明stencil test pass但depth test fail的时候更新stencil buffer的操作，这里的GL_INCR表明此时对stencil buffer的相应位加1.</p>
<p>第三个参数表明stencil test pass而且depth test pass的时候更新stencil buffer的操作，这里的GL_INCR表明此时对stencil buffer的相应位加1.</p>
<p>以上的设置表明只要stencil test pass的话就对stencil buffer的相应位加1，不管depth test是pass或者fail.</p>
<p>绘制triangle1的代码<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">glEnable(GL_STENCIL_TEST);</div><div class="line">glStencilFunc(GL_ALWAYS, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">glStencilOp(GL_KEEP, GL_INCR, GL_INCR);</div><div class="line">glColorMask(GL_FALSE, GL_FALSE, GL_FALSE, GL_FALSE);</div><div class="line"></div><div class="line">glUseProgram(gProgram);</div><div class="line"></div><div class="line"><span class="comment">// draw triangle 1</span></div><div class="line">glVertexAttribPointer(gfPositionHandle, <span class="number">3</span>, GL_FLOAT, GL_FALSE,</div><div class="line">	TRIANGLE_VERTICES_DATA_STRIDE_BYTES, gTriangleVerticesData);</div><div class="line"></div><div class="line">glEnableVertexAttribArray(gfPositionHandle);</div><div class="line"></div><div class="line">glUniform4fv(gfColor, <span class="number">1</span>, gColor);</div><div class="line"></div><div class="line">glDrawArrays(GL_TRIANGLES, <span class="number">0</span>, <span class="number">3</span>);</div></pre></td></tr></table></figure></p>
<p>绘制triangle2的代码<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// draw triangl2</span></div><div class="line">glVertexAttribPointer(gfPositionHandle, <span class="number">3</span>, GL_FLOAT, GL_FALSE,</div><div class="line">	TRIANGLE_VERTICES_DATA_STRIDE_BYTES, gTriangleVerticesData1);</div><div class="line"></div><div class="line">glEnableVertexAttribArray(gfPositionHandle);</div><div class="line"></div><div class="line">glUniform4fv(gfColor, <span class="number">1</span>, gColor1);</div><div class="line"></div><div class="line">glDrawArrays(GL_TRIANGLES, <span class="number">0</span>, <span class="number">3</span>);</div></pre></td></tr></table></figure></p>
<p>第二步是根据stencil buffer中的内容为mask来绘制triangle1和triangle2的重叠区域，这个时候发送给opengles的绘制区域可以设置成整个屏幕的大小，但是只有相应的位符合stencil buffer中的条件才能使stencil test通过，这个时候才能输出color。</p>
<p>这个控制相应的位符合stencil buffer中条件的代码如下所示，也就是说stencil buffer相应的位的值需要为0x02，也就是说这个点绘制过两次（triangle1和triangle2都绘制过）。</p>
<p>glStencilFunc(GL_NOTEQUAL, 0, 0xf8 | 0x02);</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">glDisable(GL_DEPTH_TEST);</div><div class="line"></div><div class="line">glStencilOp(GL_KEEP, GL_KEEP, GL_KEEP);</div><div class="line"></div><div class="line">glVertexAttribPointer(gfPositionHandle, <span class="number">3</span>, GL_FLOAT, GL_FALSE,</div><div class="line">	TRIANGLE_VERTICES_DATA_STRIDE_BYTES, gTriangleVerticesData2);</div><div class="line"></div><div class="line">glEnableVertexAttribArray(gfPositionHandle);</div><div class="line"></div><div class="line">glUniform4fv(gfColor, <span class="number">1</span>, gColor2);</div><div class="line"></div><div class="line"><span class="comment">// draw the area with blue color</span></div><div class="line">glColorMask(GL_FALSE, GL_FALSE, GL_TRUE, GL_FALSE);</div><div class="line">glStencilFunc(GL_NOTEQUAL, <span class="number">0</span>, <span class="number">0xf8</span> | <span class="number">0x02</span>);</div><div class="line">  </div><div class="line">glDrawArrays(GL_TRIANGLE_STRIP, <span class="number">0</span>, <span class="number">4</span>);</div></pre></td></tr></table></figure>
<h1 id="0x4-程序运行效果"><a href="#0x4-程序运行效果" class="headerlink" title="0x4 程序运行效果"></a>0x4 程序运行效果</h1><p>triangle1单独绘制的效果<br><img src="/2019/02/23/How-stencil-buffer_work-in-graphics-pipeline/draw_triangle1.png" alt="draw_triangle1"></p>
<p>triangle2单独绘制的效果<br><img src="/2019/02/23/How-stencil-buffer_work-in-graphics-pipeline/draw_triangle2.png" alt="draw_triangle2"></p>
<p>triangle1和triangle2同时绘制的效果<br><img src="/2019/02/23/How-stencil-buffer_work-in-graphics-pipeline/draw_triangle1_triangle2.png" alt="draw_triangle1_triangle2"></p>
<p>triangle1和triangle2同时绘制但不更新color buffer, 然后根据stencil buffer绘制triangle1和triangle2相交区域的效果<br><img src="/2019/02/23/How-stencil-buffer_work-in-graphics-pipeline/drawing_with_stencil_buffer.png" alt="drawing_with_stencil_buffer"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/16/Mesh-support-in-Escher/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/16/Mesh-support-in-Escher/" itemprop="url">Mesh support in escher</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-16T23:21:36+09:00">
                2019-02-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2019/02/16/Mesh-support-in-Escher/" class="leancloud_visitors" data-flag-title="Mesh support in escher">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-总体介绍"><a href="#0x1-总体介绍" class="headerlink" title="0x1 总体介绍"></a>0x1 总体介绍</h1><p>Graphics中各种图形的渲染是通过许多小的三角形的渲染拼接组成的，Mesh的过程是把需要渲染的图形划分成许多小三角形的过程.<br>Escher中的mesh过程需要把Rectangle, Circle, Ring, Sphere等形状的显示对象划分成小三角形，然后把小三角形的数据通过Vulkan API来驱动GPU显示.</p>
<p>下图是escher中mesh相关类的类图</p>
<p><img src="/2019/02/16/Mesh-support-in-Escher/mesh_class_diagram.png" alt="mesh_class_diagram"></p>
<p>下面简单介绍一下这些类</p>
<p>Mesh创建过程中，<br>MeshBuilder根据MeshSpec的设置生成对应的Mesh.<br>Mesh的vertex/index数据保存到CommandBuffer中，</p>
<p>Mesh渲染过程中，<br>对应的PageRenderer生成对应的Object，每一个Object都有对应的Mesh，这些Object挂接到Model下面.<br>然后根据Model中包含的Mesh生成ModelDisplayList，然后遍历这个ModelDisplayList，把Mesh中的vertex/index数据传入CommandBuffer中，从而让GPU渲染的时候能够访问到这些数据.</p>
<h1 id="0x2-各种shape的mesh过程"><a href="#0x2-各种shape的mesh过程" class="headerlink" title="0x2 各种shape的mesh过程"></a>0x2 各种shape的mesh过程</h1><h2 id="0x21-MeshBuilder介绍"><a href="#0x21-MeshBuilder介绍" class="headerlink" title="0x21 MeshBuilder介绍"></a>0x21 MeshBuilder介绍</h2><p>MeshBuilder提供接口把vertex data和index data保存起来.</p>
<p>其中保存的数据结构如下,<br>vertex_staging<em>buffer</em>保存vertex数据，index_staging<em>buffer</em>保存index数据.<br>vertex_staging<em>buffer</em>和index_staging<em>buffer</em>的内存空间是通过GpuUploader::Writer来分配的.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> max_vertex_count_;</div><div class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> max_index_count_;</div><div class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> vertex_stride_;</div><div class="line"><span class="keyword">uint8_t</span>* vertex_staging_buffer_;</div><div class="line"><span class="keyword">uint32_t</span>* index_staging_buffer_;</div><div class="line"><span class="keyword">size_t</span> vertex_count_ = <span class="number">0</span>;</div><div class="line"><span class="keyword">size_t</span> index_count_ = <span class="number">0</span>;</div></pre></td></tr></table></figure>
<p>下面是其提供设置vertex data和index data的接口.<br>注意下面的接口都返回 *this， 这是为了链式表达式的需要.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">inline</span> MeshBuilder&amp; MeshBuilder::AddIndex(<span class="keyword">uint32_t</span> index) &#123;</div><div class="line">  FXL_DCHECK(index_count_ &lt; max_index_count_);</div><div class="line">  index_staging_buffer_[index_count_++] = index;</div><div class="line">  <span class="keyword">return</span> *<span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">inline</span> MeshBuilder&amp; MeshBuilder::AddVertexData(<span class="keyword">const</span> <span class="keyword">void</span>* ptr, <span class="keyword">size_t</span> size) &#123;</div><div class="line">  FXL_DCHECK(vertex_count_ &lt; max_vertex_count_);</div><div class="line">  FXL_DCHECK(size &lt;= vertex_stride_);</div><div class="line">  <span class="keyword">size_t</span> offset = vertex_stride_ * vertex_count_++;</div><div class="line">  <span class="built_in">memcpy</span>(vertex_staging_buffer_ + offset, ptr, size);</div><div class="line">  <span class="keyword">return</span> *<span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> VertexT&gt;</div><div class="line">MeshBuilder&amp; MeshBuilder::AddVertex(<span class="keyword">const</span> VertexT&amp; v) &#123;</div><div class="line">  AddVertexData(&amp;v, <span class="keyword">sizeof</span>(VertexT));</div><div class="line">  <span class="keyword">return</span> *<span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后调用Build()接口生成mesh对象.</p>
<h2 id="0x22-SimpleRectangle"><a href="#0x22-SimpleRectangle" class="headerlink" title="0x22 SimpleRectangle"></a>0x22 SimpleRectangle</h2><p>下面是生成SimpleRectangle的mesh的代码，SimpleRectangle是普通的非圆角Rectangle.<br>从这个代码中可以看到，该mesh过程会生成4个vertex数据，生成6个index数据(因为是2个三角形).</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function">MeshPtr <span class="title">NewSimpleRectangleMesh</span><span class="params">(MeshBuilderFactory* factory)</span> </span>&#123;</div><div class="line">  MeshSpec spec&#123;MeshAttribute::kPosition2D | MeshAttribute::kUV&#125;;</div><div class="line"></div><div class="line">  <span class="comment">// In each vertex, the first two floats represent the position and the second</span></div><div class="line">  <span class="comment">// two are UV coordinates.</span></div><div class="line">  <span class="function">vec4 <span class="title">v0</span><span class="params">(<span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span>)</span></span>;</div><div class="line">  <span class="function">vec4 <span class="title">v1</span><span class="params">(<span class="number">1.f</span>, <span class="number">0.f</span>, <span class="number">1.f</span>, <span class="number">0.f</span>)</span></span>;</div><div class="line">  <span class="function">vec4 <span class="title">v2</span><span class="params">(<span class="number">1.f</span>, <span class="number">1.f</span>, <span class="number">1.f</span>, <span class="number">1.f</span>)</span></span>;</div><div class="line">  <span class="function">vec4 <span class="title">v3</span><span class="params">(<span class="number">0.f</span>, <span class="number">1.f</span>, <span class="number">0.f</span>, <span class="number">1.f</span>)</span></span>;</div><div class="line"></div><div class="line">  MeshBuilderPtr builder = factory-&gt;NewMeshBuilder(spec, <span class="number">4</span>, <span class="number">6</span>);</div><div class="line">  <span class="keyword">return</span> builder-&gt;AddVertex(v0)</div><div class="line">      .AddVertex(v1)</div><div class="line">      .AddVertex(v2)</div><div class="line">      .AddVertex(v3)</div><div class="line">      .AddIndex(<span class="number">0</span>)</div><div class="line">      .AddIndex(<span class="number">1</span>)</div><div class="line">      .AddIndex(<span class="number">2</span>)</div><div class="line">      .AddIndex(<span class="number">0</span>)</div><div class="line">      .AddIndex(<span class="number">2</span>)</div><div class="line">      .AddIndex(<span class="number">3</span>)</div><div class="line">      .Build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>前面的mesh过程计算好了一个通用的SimpleRectangle的mesh信息，<br>具体要显示Rectangle的时候根据具体的显示位置(top_left_position.x/y/z)和显示的大小(size.x/y)来绘制Rectangle.<br>指定显示的位置可以理解为平移，指定显示的大小可以理解为缩放.<br>这个平移/缩放过程通过设置transform矩阵来实现，在shader代码中把这个矩阵和通用SimpleRectangle的vertex坐标相乘.</p>
<p>transform矩阵的设置过程如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Object Object::NewRect(<span class="keyword">const</span> vec3&amp; top_left_position, <span class="keyword">const</span> vec2&amp; size,</div><div class="line">                       MaterialPtr material) &#123;</div><div class="line">  <span class="function">mat4 <span class="title">transform</span><span class="params">(<span class="number">1</span>)</span></span>;</div><div class="line">  transform[<span class="number">0</span>][<span class="number">0</span>] = size.x;</div><div class="line">  transform[<span class="number">1</span>][<span class="number">1</span>] = size.y;</div><div class="line">  transform[<span class="number">3</span>][<span class="number">0</span>] = top_left_position.x;</div><div class="line">  transform[<span class="number">3</span>][<span class="number">1</span>] = top_left_position.y;</div><div class="line">  transform[<span class="number">3</span>][<span class="number">2</span>] = top_left_position.z;</div><div class="line">  <span class="keyword">return</span> Object(transform, Shape(Shape::Type::kRect), <span class="built_in">std</span>::move(material));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x23-Rectangle"><a href="#0x23-Rectangle" class="headerlink" title="0x23 Rectangle"></a>0x23 Rectangle</h2><p>下面的代码生成普通Rectangle的Mesh，</p>
<p>下面函数的参数中，<br>subdivisions指定Rectangle的拆分数，<br>size指定Rectangle的大小，<br>top_left指定左上角的坐标，<br>生成mesh的时候把Rectangle分成(subdivisions*2-1)个小矩形，指定这些小矩形的vertex/index设置.</p>
<p>这个普通Rectangle的mesh和SimpleRectangle的mesh不同之处在于普通Rectangle的mesh是每一个Rectangle生成一个，不具有SimpleRectangle的mesh的通用性. 另外普通Rectangle的mesh会包括更多的小三角形.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function">MeshPtr <span class="title">NewRectangleMesh</span><span class="params">(MeshBuilderFactory* factory, <span class="keyword">const</span> MeshSpec&amp; spec,</span></span></div><div class="line">                         <span class="keyword">int</span> subdivisions, vec2 size, vec2 top_left,</div><div class="line">                         <span class="keyword">float</span> top_offset_magnitude,</div><div class="line">                         <span class="keyword">float</span> bottom_offset_magnitude) &#123;</div><div class="line">  <span class="comment">// Compute the number of vertices in the tessellated circle.</span></div><div class="line">  FXL_DCHECK(subdivisions &gt;= <span class="number">0</span>);</div><div class="line">  <span class="keyword">size_t</span> vertices_per_side = <span class="number">2</span>;</div><div class="line">  <span class="keyword">while</span> (subdivisions-- &gt; <span class="number">0</span>) &#123;</div><div class="line">    vertices_per_side *= <span class="number">2</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">size_t</span> vertex_count = vertices_per_side * <span class="number">2</span>;</div><div class="line">  <span class="keyword">size_t</span> index_count = (vertices_per_side - <span class="number">1</span>) * <span class="number">6</span>;</div><div class="line"></div><div class="line">  <span class="keyword">auto</span> builder = factory-&gt;NewMeshBuilder(spec, vertex_count, index_count);</div><div class="line"></div><div class="line">  <span class="comment">// Generate vertex positions.</span></div><div class="line">  <span class="keyword">constexpr</span> <span class="keyword">size_t</span> kMaxVertexSize = <span class="number">100</span>;</div><div class="line">  <span class="keyword">uint8_t</span> vertex[kMaxVertexSize];</div><div class="line">  <span class="keyword">auto</span> vertex_p =</div><div class="line">      GetVertexAttributePointers(vertex, kMaxVertexSize, spec, builder);</div><div class="line">  FXL_CHECK(vertex_p.pos2);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keyword">float</span> vertices_per_side_reciprocal = <span class="number">1.f</span> / (vertices_per_side - <span class="number">1</span>);</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; vertices_per_side; ++i) &#123;</div><div class="line">    <span class="comment">// Build bottom vertex.</span></div><div class="line">    (*vertex_p.pos2) =</div><div class="line">        top_left + vec2(size.x * i * vertices_per_side_reciprocal, size.y);</div><div class="line">    <span class="keyword">if</span> (vertex_p.uv)</div><div class="line">      (*vertex_p.uv) = vec2(i * vertices_per_side_reciprocal, <span class="number">1.f</span>);</div><div class="line">    <span class="keyword">if</span> (vertex_p.pos_offset)</div><div class="line">      (*vertex_p.pos_offset) = vec2(<span class="number">0</span>, <span class="number">1.f</span> * bottom_offset_magnitude);</div><div class="line">    <span class="keyword">if</span> (vertex_p.perim)</div><div class="line">      (*vertex_p.perim) = i * vertices_per_side_reciprocal;</div><div class="line">    builder-&gt;AddVertexData(vertex, builder-&gt;vertex_stride());</div><div class="line"></div><div class="line">    <span class="comment">// Build top vertex.</span></div><div class="line">    (*vertex_p.pos2) =</div><div class="line">        top_left + vec2(size.x * i * vertices_per_side_reciprocal, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (vertex_p.uv)</div><div class="line">      (*vertex_p.uv) = vec2(i * vertices_per_side_reciprocal, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (vertex_p.pos_offset)</div><div class="line">      (*vertex_p.pos_offset) = vec2(<span class="number">0</span>, <span class="number">-1.f</span> * top_offset_magnitude);</div><div class="line">    <span class="keyword">if</span> (vertex_p.perim)</div><div class="line">      (*vertex_p.perim) = i * vertices_per_side_reciprocal;</div><div class="line">    builder-&gt;AddVertexData(vertex, builder-&gt;vertex_stride());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Generate vertex indices.</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">2</span>; i &lt; vertex_count; i += <span class="number">2</span>) &#123;</div><div class="line">    builder-&gt;AddIndex(i - <span class="number">2</span>);</div><div class="line">    builder-&gt;AddIndex(i - <span class="number">1</span>);</div><div class="line">    builder-&gt;AddIndex(i);</div><div class="line">    builder-&gt;AddIndex(i);</div><div class="line">    builder-&gt;AddIndex(i - <span class="number">1</span>);</div><div class="line">    builder-&gt;AddIndex(i + <span class="number">1</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">auto</span> mesh = builder-&gt;Build();</div><div class="line">  FXL_DCHECK(mesh-&gt;num_indices() == index_count);</div><div class="line">  <span class="keyword">return</span> mesh;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x24-Circle"><a href="#0x24-Circle" class="headerlink" title="0x24 Circle"></a>0x24 Circle</h2><p>下面分析circle的mesh是如何生成的.</p>
<p>下面函数的参数中，<br>subdivisions指定Circle的拆分数目，<br>center指定Circle的中心点坐标.<br>radius指定Circle的半径大小.</p>
<p>生成mesh的时候是把Circle分成(subdivisions*4)个小扇形，然后计算这些小扇形的vertex/index设置.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line">MeshPtr NewCircleMesh(MeshBuilderFactory* factory, const MeshSpec&amp; spec,</div><div class="line">                      int subdivisions, vec2 center, float radius,</div><div class="line">                      float offset_magnitude) &#123;</div><div class="line">  // Compute the number of vertices in the tessellated circle.</div><div class="line">  FXL_DCHECK(subdivisions &gt;= 0);</div><div class="line">  FXL_DCHECK(spec.IsValidOneBufferMesh());</div><div class="line">  size_t outer_vertex_count = 4;</div><div class="line">  while (subdivisions-- &gt; 0) &#123;</div><div class="line">    outer_vertex_count *= 2;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  size_t vertex_count = outer_vertex_count + 1;  // Add 1 for center vertex.</div><div class="line">  size_t index_count = outer_vertex_count * 3;</div><div class="line"></div><div class="line">  auto builder = factory-&gt;NewMeshBuilder(spec, vertex_count, index_count);</div><div class="line"></div><div class="line">  // Generate vertex positions.</div><div class="line">  constexpr size_t kMaxVertexSize = 100;</div><div class="line">  uint8_t vertex[kMaxVertexSize];</div><div class="line">  auto vertex_p =</div><div class="line">      GetVertexAttributePointers(vertex, kMaxVertexSize, spec, builder);</div><div class="line"></div><div class="line">  // Build center vertex.</div><div class="line">  FXL_CHECK(vertex_p.pos2);</div><div class="line">  (*vertex_p.pos2) = center;</div><div class="line">  if (vertex_p.uv)</div><div class="line">    (*vertex_p.uv) = vec2(0.5f, 0.5f);</div><div class="line">  if (vertex_p.pos_offset)</div><div class="line">    (*vertex_p.pos_offset) = vec2(0.f, 0.f);</div><div class="line">  // TODO: This is an undesirable singularity.  Perhaps it would be better to</div><div class="line">  // treat circles as a ring with inner radius of zero?</div><div class="line">  if (vertex_p.perim)</div><div class="line">    (*vertex_p.perim) = 0.f;</div><div class="line">  builder-&gt;AddVertexData(vertex, builder-&gt;vertex_stride());</div><div class="line"></div><div class="line">  // Outer vertices.</div><div class="line">  const float outer_vertex_count_reciprocal = 1.f / outer_vertex_count;</div><div class="line">  const float radian_step = 2 * M_PI / outer_vertex_count;</div><div class="line">  for (size_t i = 0; i &lt; outer_vertex_count; ++i) &#123;</div><div class="line">    float radians = i * radian_step;</div><div class="line"></div><div class="line">    // Direction of the current vertex from the center of the circle.</div><div class="line">    vec2 dir(sin(radians), cos(radians));</div><div class="line"></div><div class="line">    (*vertex_p.pos2) = dir * radius + center;</div><div class="line">    if (vertex_p.uv)</div><div class="line">      (*vertex_p.uv) = 0.5f * (dir + vec2(1.f, 1.f));</div><div class="line">    if (vertex_p.pos_offset)</div><div class="line">      (*vertex_p.pos_offset) = dir * offset_magnitude;</div><div class="line">    if (vertex_p.perim)</div><div class="line">      (*vertex_p.perim) = i * outer_vertex_count_reciprocal;</div><div class="line"></div><div class="line">    builder-&gt;AddVertexData(vertex, builder-&gt;vertex_stride());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Vertex indices.</div><div class="line">  for (size_t i = 1; i &lt; outer_vertex_count; ++i) &#123;</div><div class="line">    builder-&gt;AddIndex(0);</div><div class="line">    builder-&gt;AddIndex(i + 1);</div><div class="line">    builder-&gt;AddIndex(i);</div><div class="line">  &#125;</div><div class="line">  builder-&gt;AddIndex(0);</div><div class="line">  builder-&gt;AddIndex(1);</div><div class="line">  builder-&gt;AddIndex(outer_vertex_count);</div><div class="line"></div><div class="line">  auto mesh = builder-&gt;Build();</div><div class="line">  FXL_DCHECK(mesh-&gt;num_indices() == index_count);</div><div class="line">  FXL_DCHECK(mesh-&gt;bounding_box() ==</div><div class="line">             BoundingBox(vec3(center.x - radius, center.y - radius, 0),</div><div class="line">                         vec3(center.x + radius, center.y + radius, 0)));</div><div class="line">  return mesh;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>前面的mesh过程计算好了一个通用的Circle的mesh信息，<br>和SimpleRectangle的情况类似，具体绘制Circle的时候根据具体的显示位置(center_position.x/y/z)和显示的大小(radius)来绘制Circle.<br>指定显示的位置可以理解为平移，指定显示的大小可以理解为缩放.<br>这个平移/缩放过程也是通过设置transform矩阵来实现，在shader代码中把这个矩阵和通用Circle的vertex坐标相乘.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Object Object::NewCircle(<span class="keyword">const</span> vec3&amp; center_position, <span class="keyword">float</span> radius,</div><div class="line">                         MaterialPtr material) &#123;</div><div class="line">  <span class="function">mat4 <span class="title">transform</span><span class="params">(<span class="number">1</span>)</span></span>;</div><div class="line">  transform[<span class="number">0</span>][<span class="number">0</span>] = radius;</div><div class="line">  transform[<span class="number">1</span>][<span class="number">1</span>] = radius;</div><div class="line">  transform[<span class="number">3</span>][<span class="number">0</span>] = center_position.x;</div><div class="line">  transform[<span class="number">3</span>][<span class="number">1</span>] = center_position.y;</div><div class="line">  transform[<span class="number">3</span>][<span class="number">2</span>] = center_position.z;</div><div class="line">  <span class="keyword">return</span> Object(transform, Shape(Shape::Type::kCircle), <span class="built_in">std</span>::move(material));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x25-RoundRectangle"><a href="#0x25-RoundRectangle" class="headerlink" title="0x25 RoundRectangle"></a>0x25 RoundRectangle</h2><p>下面分析生成圆角Rectangle的mesh的代码.</p>
<p>该过程把圆角矩形mesh成三角形，其中的顶点分布如下图所示,</p>
<p>其中每个圆角部分被拆分成8个小扇形.</p>
<p><img src="/2019/02/16/Mesh-support-in-Escher/roundedrect.jpg" alt="RoundedRect"></p>
<p>0 ~ 12 顶点是中间部分的矩形对应的顶点.<br>13 ~ 19 顶点是左上角部分的圆角对应的顶点.<br>20 ~ 26 顶点是右上角部分的圆角对应的顶点.<br>27 ~ 33 顶点是右下角部分的圆角对应的顶点.<br>34 ~ 40 顶点是左下角部分的圆角对应的顶点.</p>
<p>NewRoundedRect是总的入口函数，其中会调用GenerateRoundedRectIndices()来根据顶点来构造三角形，调用GenerateRoundedRectVertexUVs()生成纹理坐标，最后调用GenerateRoundedRectVertexPositionsFromUVs()来生成顶点坐标.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">MeshPtr RoundedRectFactory::NewRoundedRect(</div><div class="line">    <span class="keyword">const</span> RoundedRectSpec&amp; spec, <span class="keyword">const</span> MeshSpec&amp; mesh_spec,</div><div class="line">    BatchGpuUploader* batch_gpu_uploader) &#123;</div><div class="line">  FXL_DCHECK(batch_gpu_uploader);</div><div class="line"></div><div class="line">  <span class="keyword">auto</span> index_buffer = GetIndexBuffer(spec, mesh_spec, batch_gpu_uploader);</div><div class="line"></div><div class="line">  <span class="keyword">auto</span> counts = GetRoundedRectMeshVertexAndIndexCounts(spec);</div><div class="line">  <span class="keyword">const</span> <span class="keyword">uint32_t</span> vertex_count = counts.first;</div><div class="line">  <span class="keyword">const</span> <span class="keyword">uint32_t</span> index_count = counts.second;</div><div class="line">  <span class="keyword">const</span> <span class="keyword">size_t</span> primary_buffer_stride = mesh_spec.stride(<span class="number">0</span>);</div><div class="line">  <span class="keyword">const</span> <span class="keyword">size_t</span> secondary_buffer_stride = mesh_spec.stride(<span class="number">1</span>);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keyword">size_t</span> vertex_buffer_size =</div><div class="line">      vertex_count * (primary_buffer_stride + secondary_buffer_stride);</div><div class="line"></div><div class="line">  <span class="keyword">auto</span> vertex_buffer =</div><div class="line">      buffer_factory_.NewBuffer(vertex_buffer_size,</div><div class="line">                                vk::BufferUsageFlagBits::eVertexBuffer |</div><div class="line">                                    vk::BufferUsageFlagBits::eTransferDst,</div><div class="line">                                vk::MemoryPropertyFlagBits::eDeviceLocal);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> bounding_box =</div><div class="line">      BoundingBox::NewChecked(<span class="number">-0.5f</span> * vec3(spec.width, spec.height, <span class="number">0</span>),</div><div class="line">                              <span class="number">0.5f</span> * vec3(spec.width, spec.height, <span class="number">0</span>), <span class="number">1</span>);</div><div class="line"></div><div class="line">  <span class="keyword">switch</span> (mesh_spec.vertex_buffer_count()) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="number">1</span>: &#123;</div><div class="line">      <span class="keyword">auto</span> writer = batch_gpu_uploader-&gt;AcquireWriter(vertex_buffer_size);</div><div class="line">      GenerateRoundedRectVertices(spec, mesh_spec, writer-&gt;host_ptr(),</div><div class="line">                                  writer-&gt;size());</div><div class="line">      writer-&gt;WriteBuffer(vertex_buffer, &#123;<span class="number">0</span>, <span class="number">0</span>, vertex_buffer-&gt;size()&#125;);</div><div class="line">      batch_gpu_uploader-&gt;PostWriter(<span class="built_in">std</span>::move(writer));</div><div class="line"></div><div class="line">      <span class="keyword">return</span> fxl::MakeRefCounted&lt;Mesh&gt;(</div><div class="line">          <span class="keyword">static_cast</span>&lt;ResourceRecycler*&gt;(<span class="keyword">this</span>), mesh_spec, bounding_box,</div><div class="line">          vertex_count, index_count, vertex_buffer, <span class="built_in">std</span>::move(index_buffer));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> <span class="number">2</span>: &#123;</div><div class="line">      <span class="keyword">auto</span> writer = batch_gpu_uploader-&gt;AcquireWriter(vertex_buffer_size);</div><div class="line">      GenerateRoundedRectVertices(</div><div class="line">          spec, mesh_spec, writer-&gt;host_ptr(),</div><div class="line">          vertex_count * primary_buffer_stride,</div><div class="line">          writer-&gt;host_ptr() + vertex_count * primary_buffer_stride,</div><div class="line">          vertex_count * secondary_buffer_stride);</div><div class="line">      writer-&gt;WriteBuffer(vertex_buffer, &#123;<span class="number">0</span>, <span class="number">0</span>, vertex_buffer-&gt;size()&#125;);</div><div class="line">      batch_gpu_uploader-&gt;PostWriter(<span class="built_in">std</span>::move(writer));</div><div class="line"></div><div class="line">      <span class="keyword">return</span> fxl::MakeRefCounted&lt;Mesh&gt;(</div><div class="line">          <span class="keyword">static_cast</span>&lt;ResourceRecycler*&gt;(<span class="keyword">this</span>), mesh_spec, bounding_box,</div><div class="line">          index_count, <span class="built_in">std</span>::move(index_buffer), <span class="number">0</span>, vertex_count, vertex_buffer,</div><div class="line">          <span class="number">0</span>, <span class="built_in">std</span>::move(vertex_buffer), vertex_count * primary_buffer_stride);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      FXL_CHECK(<span class="literal">false</span>) &lt;&lt; <span class="string">"unsupported vertex buffer count: "</span></div><div class="line">                       &lt;&lt; mesh_spec.vertex_buffer_count();</div><div class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面的代码是构造圆角Rectangle中的三角形的过程，indices中保存的是把这些顶点拼接成三角形的顶点索引.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GenerateRoundedRectIndices</span><span class="params">(<span class="keyword">const</span> RoundedRectSpec&amp; spec,</span></span></div><div class="line">                                <span class="keyword">const</span> MeshSpec&amp; mesh_spec, <span class="keyword">void</span>* indices_out,</div><div class="line">                                <span class="keyword">uint32_t</span> max_bytes) &#123;</div><div class="line">  TRACE_DURATION(<span class="string">"gfx"</span>, <span class="string">"escher::GenerateRoundedRectIndices"</span>);</div><div class="line"></div><div class="line">  FXL_DCHECK(max_bytes &gt;= kIndexCount * <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>));</div><div class="line">  <span class="keyword">uint32_t</span>* indices = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>*&gt;(indices_out);</div><div class="line"></div><div class="line">  <span class="comment">// Central square triangles.</span></div><div class="line">  indices[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">  indices[<span class="number">1</span>] = <span class="number">4</span>;</div><div class="line">  indices[<span class="number">2</span>] = <span class="number">1</span>;</div><div class="line">  indices[<span class="number">3</span>] = <span class="number">0</span>;</div><div class="line">  indices[<span class="number">4</span>] = <span class="number">1</span>;</div><div class="line">  indices[<span class="number">5</span>] = <span class="number">2</span>;</div><div class="line">  indices[<span class="number">6</span>] = <span class="number">0</span>;</div><div class="line">  indices[<span class="number">7</span>] = <span class="number">2</span>;</div><div class="line">  indices[<span class="number">8</span>] = <span class="number">3</span>;</div><div class="line">  indices[<span class="number">9</span>] = <span class="number">0</span>;</div><div class="line">  indices[<span class="number">10</span>] = <span class="number">3</span>;</div><div class="line">  indices[<span class="number">11</span>] = <span class="number">4</span>;</div><div class="line"></div><div class="line">  <span class="comment">// "Cross arm 1"  triangles.</span></div><div class="line">  indices[<span class="number">12</span>] = <span class="number">1</span>;</div><div class="line">  indices[<span class="number">13</span>] = <span class="number">7</span>;</div><div class="line">  indices[<span class="number">14</span>] = <span class="number">2</span>;</div><div class="line">  indices[<span class="number">15</span>] = <span class="number">1</span>;</div><div class="line">  indices[<span class="number">16</span>] = <span class="number">6</span>;</div><div class="line">  indices[<span class="number">17</span>] = <span class="number">7</span>;</div><div class="line"></div><div class="line">  <span class="comment">// "Cross arm 2"  triangles.</span></div><div class="line">  indices[<span class="number">18</span>] = <span class="number">2</span>;</div><div class="line">  indices[<span class="number">19</span>] = <span class="number">9</span>;</div><div class="line">  indices[<span class="number">20</span>] = <span class="number">3</span>;</div><div class="line">  indices[<span class="number">21</span>] = <span class="number">2</span>;</div><div class="line">  indices[<span class="number">22</span>] = <span class="number">8</span>;</div><div class="line">  indices[<span class="number">23</span>] = <span class="number">9</span>;</div><div class="line"></div><div class="line">  <span class="comment">// "Cross arm 3"  triangles.</span></div><div class="line">  indices[<span class="number">24</span>] = <span class="number">3</span>;</div><div class="line">  indices[<span class="number">25</span>] = <span class="number">11</span>;</div><div class="line">  indices[<span class="number">26</span>] = <span class="number">4</span>;</div><div class="line">  indices[<span class="number">27</span>] = <span class="number">3</span>;</div><div class="line">  indices[<span class="number">28</span>] = <span class="number">10</span>;</div><div class="line">  indices[<span class="number">29</span>] = <span class="number">11</span>;</div><div class="line"></div><div class="line">  <span class="comment">// "Cross arm 4"  triangles.</span></div><div class="line">  indices[<span class="number">30</span>] = <span class="number">4</span>;</div><div class="line">  indices[<span class="number">31</span>] = <span class="number">5</span>;</div><div class="line">  indices[<span class="number">32</span>] = <span class="number">1</span>;</div><div class="line">  indices[<span class="number">33</span>] = <span class="number">4</span>;</div><div class="line">  indices[<span class="number">34</span>] = <span class="number">12</span>;</div><div class="line">  indices[<span class="number">35</span>] = <span class="number">5</span>;</div><div class="line"></div><div class="line">  <span class="comment">// WARNING: here's where it gets confusing; the number of indices generated is</span></div><div class="line">  <span class="comment">// dependent on kCornerDivisions.</span></div><div class="line"></div><div class="line">  <span class="comment">// We've already generated output indices for the "cross triangles".</span></div><div class="line">  <span class="keyword">constexpr</span> <span class="keyword">uint32_t</span> kCrossTriangles = <span class="number">12</span>;</div><div class="line">  <span class="comment">// Holds the position of the next index to output.</span></div><div class="line">  <span class="keyword">uint32_t</span> out = kCrossTriangles * <span class="number">3</span>;</div><div class="line">  <span class="comment">// Holds the highest index of any vertex used thus far (the central "cross"</span></div><div class="line">  <span class="comment">// consists of 13 vertices, whose indices are 0-12).</span></div><div class="line">  <span class="keyword">uint32_t</span> highest_index = <span class="number">12</span>;</div><div class="line"></div><div class="line">  <span class="comment">// These are the indices of the 4 triangles that would be output if</span></div><div class="line">  <span class="comment">// kCornerDivisions were zero.</span></div><div class="line">  <span class="keyword">const</span> <span class="keyword">uint32_t</span> corner_tris[] = &#123;<span class="number">1</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">4</span>, <span class="number">12</span>, <span class="number">11</span>&#125;;</div><div class="line"></div><div class="line">  <span class="comment">// For each corner, generate wedges in clockwise order.</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">uint32_t</span> corner = <span class="number">0</span>; corner &lt; <span class="number">4</span>; ++corner) &#123;</div><div class="line">    <span class="comment">// Index of the vertex at the center of the current corner.</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">uint32_t</span> center = corner_tris[corner * <span class="number">3</span>];</div><div class="line">    <span class="comment">// As we move clockwise around the corner, this holds the index of the</span></div><div class="line">    <span class="comment">// previous perimeter vertex.</span></div><div class="line">    <span class="keyword">uint32_t</span> prev = corner_tris[corner * <span class="number">3</span> + <span class="number">2</span>];</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; kCornerDivisions; ++i) &#123;</div><div class="line">      indices[out++] = center;</div><div class="line">      indices[out++] = prev;</div><div class="line">      indices[out++] = prev = ++highest_index;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// One last triangle (or the only one, if kCornerDivisions == 0).</span></div><div class="line">    indices[out++] = center;</div><div class="line">    indices[out++] = prev;</div><div class="line">    indices[out++] = corner_tris[corner * <span class="number">3</span> + <span class="number">1</span>];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  FXL_DCHECK(out == kIndexCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面函数计算这些点(0 ~ 40)对应的纹理(uv)坐标.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> VertT&gt;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GenerateRoundedRectVertexUVs</span><span class="params">(<span class="keyword">const</span> RoundedRectSpec&amp; spec, VertT* verts)</span> </span>&#123;</div><div class="line">  TRACE_DURATION(<span class="string">"gfx"</span>, <span class="string">"escher::GenerateRoundedRectVertexUVs"</span>);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keyword">float</span> width = spec.width;</div><div class="line">  <span class="keyword">const</span> <span class="keyword">float</span> height = spec.height;</div><div class="line"></div><div class="line">  <span class="comment">// First compute UV coordinates of the four "corner centers".</span></div><div class="line">  verts[<span class="number">1</span>].uv =</div><div class="line">      vec2(spec.top_left_radius / width, spec.top_left_radius / height);</div><div class="line">  verts[<span class="number">2</span>].uv =</div><div class="line">      vec2(<span class="number">1.f</span> - spec.top_right_radius / width, spec.top_right_radius / height);</div><div class="line">  verts[<span class="number">3</span>].uv = vec2(<span class="number">1.f</span> - spec.bottom_right_radius / width,</div><div class="line">                     <span class="number">1.f</span> - spec.bottom_right_radius / height);</div><div class="line">  verts[<span class="number">4</span>].uv = vec2(spec.bottom_left_radius / width,</div><div class="line">                     <span class="number">1.f</span> - spec.bottom_left_radius / height);</div><div class="line"></div><div class="line">  <span class="comment">// The "center" vertex is the average of the four "corner centers".</span></div><div class="line">  verts[<span class="number">0</span>].uv =</div><div class="line">      <span class="number">0.25f</span> * ((verts[<span class="number">1</span>].uv + verts[<span class="number">2</span>].uv + verts[<span class="number">3</span>].uv + verts[<span class="number">4</span>].uv));</div><div class="line"></div><div class="line">  <span class="comment">// Next, compute UV coords for the 8 vertices where the rounded corners meet</span></div><div class="line">  <span class="comment">// the straight side sections.</span></div><div class="line">  verts[<span class="number">6</span>].uv = vec2(verts[<span class="number">1</span>].uv.x, <span class="number">0.f</span>);</div><div class="line">  verts[<span class="number">7</span>].uv = vec2(verts[<span class="number">2</span>].uv.x, <span class="number">0.f</span>);</div><div class="line">  verts[<span class="number">8</span>].uv = vec2(<span class="number">1.f</span>, verts[<span class="number">2</span>].uv.y);</div><div class="line">  verts[<span class="number">9</span>].uv = vec2(<span class="number">1.f</span>, verts[<span class="number">3</span>].uv.y);</div><div class="line">  verts[<span class="number">10</span>].uv = vec2(verts[<span class="number">3</span>].uv.x, <span class="number">1.f</span>);</div><div class="line">  verts[<span class="number">11</span>].uv = vec2(verts[<span class="number">4</span>].uv.x, <span class="number">1.f</span>);</div><div class="line">  verts[<span class="number">12</span>].uv = vec2(<span class="number">0.f</span>, verts[<span class="number">4</span>].uv.y);</div><div class="line">  verts[<span class="number">5</span>].uv = vec2(<span class="number">0.f</span>, verts[<span class="number">1</span>].uv.y);</div><div class="line"></div><div class="line">  <span class="comment">// Next, compute UV coords for the vertices that make up the rounded corners.</span></div><div class="line">  <span class="comment">// We start at index 13; indices 0-12 were computed above.</span></div><div class="line">  <span class="keyword">uint32_t</span> out = <span class="number">13</span>;</div><div class="line"></div><div class="line">  <span class="keyword">constexpr</span> <span class="keyword">float</span> kPI = <span class="number">3.14159265f</span>;</div><div class="line">  <span class="keyword">constexpr</span> <span class="keyword">float</span> kAngleStep = kPI / <span class="number">2</span> / (kCornerDivisions + <span class="number">1</span>);</div><div class="line"></div><div class="line">  <span class="comment">// Generate UV coordinates for top-left corner.</span></div><div class="line">  <span class="keyword">float</span> angle = kPI + kAngleStep;</div><div class="line">  vec2 scale =</div><div class="line">      vec2(spec.top_left_radius / width, spec.top_left_radius / height);</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kCornerDivisions; ++i) &#123;</div><div class="line">    verts[out++].uv = verts[<span class="number">1</span>].uv + vec2(<span class="built_in">cos</span>(angle), <span class="built_in">sin</span>(angle)) * scale;</div><div class="line">    angle += kAngleStep;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Generate UV coordinates for top-right corner.</span></div><div class="line">  angle = <span class="number">1.5f</span> * kPI + kAngleStep;</div><div class="line">  scale = vec2(spec.top_right_radius / width, spec.top_right_radius / height);</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kCornerDivisions; ++i) &#123;</div><div class="line">    verts[out++].uv = verts[<span class="number">2</span>].uv + vec2(<span class="built_in">cos</span>(angle), <span class="built_in">sin</span>(angle)) * scale;</div><div class="line">    angle += kAngleStep;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Generate UV coordinates for bottom-right corner.</span></div><div class="line">  angle = kAngleStep;</div><div class="line">  scale =</div><div class="line">      vec2(spec.bottom_right_radius / width, spec.bottom_right_radius / height);</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kCornerDivisions; ++i) &#123;</div><div class="line">    verts[out++].uv = verts[<span class="number">3</span>].uv + vec2(<span class="built_in">cos</span>(angle), <span class="built_in">sin</span>(angle)) * scale;</div><div class="line">    angle += kAngleStep;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Generate UV coordinates for bottom-right corner.</span></div><div class="line">  angle = <span class="number">0.5f</span> * kPI + kAngleStep;</div><div class="line">  scale =</div><div class="line">      vec2(spec.bottom_left_radius / width, spec.bottom_left_radius / height);</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kCornerDivisions; ++i) &#123;</div><div class="line">    verts[out++].uv = verts[<span class="number">4</span>].uv + vec2(<span class="built_in">cos</span>(angle), <span class="built_in">sin</span>(angle)) * scale;</div><div class="line">    angle += kAngleStep;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面函数计算这些点(0 ~ 40)对应的顶点坐标，根据对应的纹理坐标来计算得到.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Helper for GenerateRoundedRectVertices().</span></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> UvVertT, <span class="keyword">typename</span> PosVertT&gt;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GenerateRoundedRectVertexPositionsFromUVs</span><span class="params">(<span class="keyword">const</span> RoundedRectSpec&amp; spec,</span></span></div><div class="line">                                               UvVertT* uv_verts,</div><div class="line">                                               PosVertT* pos_verts) &#123;</div><div class="line">  TRACE_DURATION(<span class="string">"gfx"</span>, <span class="string">"escher::GenerateRoundedRectVertexPositionsFromUVs"</span>);</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">const</span> vec2 <span class="title">extent</span><span class="params">(spec.width, spec.height)</span></span>;</div><div class="line">  <span class="keyword">const</span> vec2 offset = <span class="number">-0.5f</span> * extent;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; kVertexCount; ++i) &#123;</div><div class="line">    pos_verts[i].pos = uv_verts[i].uv * extent + offset;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x26-Sphere"><a href="#0x26-Sphere" class="headerlink" title="0x26 Sphere"></a>0x26 Sphere</h2><p>下面是构造Sphere的mesh的代码.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function">MeshPtr <span class="title">NewSphereMesh</span><span class="params">(MeshBuilderFactory* factory, <span class="keyword">const</span> MeshSpec&amp; spec,</span></span></div><div class="line">                      <span class="keyword">int</span> subdivisions, vec3 center, <span class="keyword">float</span> radius) &#123;</div><div class="line">  FXL_DCHECK(subdivisions &gt;= <span class="number">0</span>);</div><div class="line">  FXL_DCHECK(spec.IsValidOneBufferMesh());</div><div class="line">  <span class="keyword">size_t</span> vertex_count = <span class="number">9</span>;</div><div class="line">  <span class="keyword">size_t</span> triangle_count = <span class="number">8</span>;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; subdivisions; ++i) &#123;</div><div class="line">    <span class="comment">// At each level of subdivision, an additional vertex is added for each</span></div><div class="line">    <span class="comment">// triangle, and each triangle is split into three.</span></div><div class="line">    vertex_count += triangle_count;</div><div class="line">    triangle_count *= <span class="number">3</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Populate initial octahedron.</span></div><div class="line">  <span class="keyword">auto</span> builder =</div><div class="line">      factory-&gt;NewMeshBuilder(spec, vertex_count, triangle_count * <span class="number">3</span>);</div><div class="line">  <span class="keyword">constexpr</span> <span class="keyword">size_t</span> kMaxVertexSize = <span class="number">100</span>;</div><div class="line">  <span class="keyword">uint8_t</span> vertex[kMaxVertexSize];</div><div class="line">  <span class="keyword">auto</span> vertex_p =</div><div class="line">      GetVertexAttributePointers(vertex, kMaxVertexSize, spec, builder);</div><div class="line">  FXL_CHECK(vertex_p.pos3);</div><div class="line"></div><div class="line">  <span class="comment">// Positions and UV-coordinates for the initial octahedron.  The vertex with</span></div><div class="line">  <span class="comment">// position (-radius, 0, 0) is replicated 4 times, with different UV-coords</span></div><div class="line">  <span class="comment">// each time.  This is a consequence of surface parameterization that is</span></div><div class="line">  <span class="comment">// described in the header file.</span></div><div class="line">  <span class="keyword">const</span> vec3 positions[] = &#123;vec3(radius, <span class="number">0.f</span>, <span class="number">0.f</span>),  vec3(<span class="number">0.f</span>, <span class="number">0.f</span>, radius),</div><div class="line">                            vec3(<span class="number">0.f</span>, -radius, <span class="number">0.f</span>), vec3(<span class="number">0.f</span>, <span class="number">0.f</span>, -radius),</div><div class="line">                            vec3(<span class="number">0.f</span>, radius, <span class="number">0.f</span>),  vec3(-radius, <span class="number">0.f</span>, <span class="number">0.f</span>),</div><div class="line">                            vec3(-radius, <span class="number">0.f</span>, <span class="number">0.f</span>), vec3(-radius, <span class="number">0.f</span>, <span class="number">0.f</span>),</div><div class="line">                            vec3(-radius, <span class="number">0.f</span>, <span class="number">0.f</span>)&#125;;</div><div class="line">  <span class="keyword">const</span> vec2 uv_coords[] = &#123;vec2(<span class="number">.5</span>f, <span class="number">.5</span>f), vec2(<span class="number">1.f</span>, <span class="number">.5</span>f), vec2(<span class="number">.5</span>f, <span class="number">0.f</span>),</div><div class="line">                            vec2(<span class="number">0.f</span>, <span class="number">.5</span>f), vec2(<span class="number">.5</span>f, <span class="number">1.f</span>), vec2(<span class="number">0.f</span>, <span class="number">0.f</span>),</div><div class="line">                            vec2(<span class="number">1.f</span>, <span class="number">0.f</span>), vec2(<span class="number">1.f</span>, <span class="number">1.f</span>), vec2(<span class="number">0.f</span>, <span class="number">1.f</span>)&#125;;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; ++i) &#123;</div><div class="line">    (*vertex_p.pos3) = positions[i] + center;</div><div class="line">    <span class="keyword">if</span> (vertex_p.uv) &#123;</div><div class="line">      (*vertex_p.uv) = uv_coords[i];</div><div class="line">    &#125;</div><div class="line">    builder-&gt;AddVertexData(vertex, builder-&gt;vertex_stride());</div><div class="line">  &#125;</div><div class="line">  builder-&gt;AddTriangle(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>)</div><div class="line">      .AddTriangle(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>)</div><div class="line">      .AddTriangle(<span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>)</div><div class="line">      .AddTriangle(<span class="number">0</span>, <span class="number">4</span>, <span class="number">1</span>)</div><div class="line">      .AddTriangle(<span class="number">5</span>, <span class="number">2</span>, <span class="number">1</span>)</div><div class="line">      .AddTriangle(<span class="number">6</span>, <span class="number">3</span>, <span class="number">2</span>)</div><div class="line">      .AddTriangle(<span class="number">7</span>, <span class="number">4</span>, <span class="number">3</span>)</div><div class="line">      .AddTriangle(<span class="number">8</span>, <span class="number">1</span>, <span class="number">4</span>);</div><div class="line"></div><div class="line">  <span class="comment">// TODO(ES-32): this is a hack to ease implementation.  We don't currently</span></div><div class="line">  <span class="comment">// need any tessellated spheres; this is just a way to verify that 3D meshes</span></div><div class="line">  <span class="comment">// are working properly.</span></div><div class="line">  FXL_DCHECK(spec.attributes[<span class="number">0</span>] ==</div><div class="line">             (MeshAttribute::kPosition3D | MeshAttribute::kUV))</div><div class="line">      &lt;&lt; <span class="string">"Tessellated sphere must have UV-coordinates."</span>;</div><div class="line">  <span class="keyword">size_t</span> position_offset = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uint8_t</span>*&gt;(vertex_p.pos3) - vertex;</div><div class="line">  <span class="keyword">size_t</span> uv_offset = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uint8_t</span>*&gt;(vertex_p.uv) - vertex;</div><div class="line">  <span class="keyword">while</span> (subdivisions-- &gt; <span class="number">0</span>) &#123;</div><div class="line">    <span class="comment">// For each level of subdivision, iterate over all existing triangles and</span></div><div class="line">    <span class="comment">// split them into three.</span></div><div class="line">    <span class="comment">// TODO(ES-32): see comment in header file... this approach is broken, but</span></div><div class="line">    <span class="comment">// sufficient for our current purpose.</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> subdiv_triangle_count = builder-&gt;index_count() / <span class="number">3</span>;</div><div class="line">    FXL_DCHECK(subdiv_triangle_count * <span class="number">3</span> == builder-&gt;index_count());</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> tri_ind = <span class="number">0</span>; tri_ind &lt; subdiv_triangle_count; ++tri_ind) &#123;</div><div class="line">      <span class="comment">// Obtain indices for the current triangle, and the position/UV coords for</span></div><div class="line">      <span class="comment">// the corresponding vertices.</span></div><div class="line">      <span class="keyword">uint32_t</span>* tri = builder-&gt;GetIndex(tri_ind * <span class="number">3</span>);</div><div class="line">      <span class="keyword">uint32_t</span> ind0 = tri[<span class="number">0</span>];</div><div class="line">      <span class="keyword">uint32_t</span> ind1 = tri[<span class="number">1</span>];</div><div class="line">      <span class="keyword">uint32_t</span> ind2 = tri[<span class="number">2</span>];</div><div class="line">      <span class="keyword">uint8_t</span>* vert0 = builder-&gt;GetVertex(ind0);</div><div class="line">      <span class="keyword">uint8_t</span>* vert1 = builder-&gt;GetVertex(ind1);</div><div class="line">      <span class="keyword">uint8_t</span>* vert2 = builder-&gt;GetVertex(ind2);</div><div class="line">      vec3 pos0 = *<span class="keyword">reinterpret_cast</span>&lt;vec3*&gt;(vert0 + position_offset);</div><div class="line">      vec3 pos1 = *<span class="keyword">reinterpret_cast</span>&lt;vec3*&gt;(vert1 + position_offset);</div><div class="line">      vec3 pos2 = *<span class="keyword">reinterpret_cast</span>&lt;vec3*&gt;(vert2 + position_offset);</div><div class="line">      vec2 uv0 = *<span class="keyword">reinterpret_cast</span>&lt;vec2*&gt;(vert0 + uv_offset);</div><div class="line">      vec2 uv1 = *<span class="keyword">reinterpret_cast</span>&lt;vec2*&gt;(vert1 + uv_offset);</div><div class="line">      vec2 uv2 = *<span class="keyword">reinterpret_cast</span>&lt;vec2*&gt;(vert2 + uv_offset);</div><div class="line"></div><div class="line">      <span class="comment">// Create a new vertex by averaging the existing vertex attributes.</span></div><div class="line">      (*vertex_p.pos3) =</div><div class="line">          center + radius * glm::normalize((pos0 + pos1 + pos2) / <span class="number">3.f</span> - center);</div><div class="line">      (*vertex_p.uv) = (uv0 + uv1 + uv2) / <span class="number">3.f</span>;</div><div class="line">      builder-&gt;AddVertexData(vertex, builder-&gt;vertex_stride());</div><div class="line"></div><div class="line">      <span class="comment">// Replace the current triangle in-place with a new triangle that refers</span></div><div class="line">      <span class="comment">// to the new vertex.  Then, add two new triangles that also refer to the</span></div><div class="line">      <span class="comment">// new vertex.</span></div><div class="line">      <span class="keyword">uint32_t</span> new_ind = builder-&gt;vertex_count() - <span class="number">1</span>;</div><div class="line">      tri[<span class="number">2</span>] = new_ind;</div><div class="line">      builder-&gt;AddTriangle(ind1, ind2, new_ind)</div><div class="line">          .AddTriangle(ind2, ind0, new_ind);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> builder-&gt;Build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x27-Ring"><a href="#0x27-Ring" class="headerlink" title="0x27 Ring"></a>0x27 Ring</h2><p>下面分析Ring的mesh是如何生成的, Ring是由内圈和外圈包含的区域组成, 内圈区域内是透明的, 实际上Ring的mesh没有包括内圈，也就是说渲染的时候不会去绘制内圈区域, 所以mesh生成的绘制区域只需要包括内圈和外圈组成的区域，mesh的过程也就是把内圈和外圈之间的区域拆分成许多小三角形.</p>
<p>下面函数的参数中，<br>subdivisions指定Ring的拆分数.<br>center指定Circle的中心点坐标.<br>outer_radius指定Ring的外圈半径.<br>inner_radius指定Ring的内圈半径.</p>
<p>生成mesh的时候把Ring分成(subdivisions*4)个小扇形，这些小扇形会和Ring的内圈和外圈相交,<br>指定相交点的vertex值，然后把这些vertex组成的triangle，vertex的index值指定给mesh的index.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">MeshPtr NewRingMesh(MeshBuilderFactory* factory, const MeshSpec&amp; spec,</div><div class="line">                    int subdivisions, vec2 center, float outer_radius,</div><div class="line">                    float inner_radius, float outer_offset_magnitude,</div><div class="line">                    float inner_offset_magnitude) &#123;</div><div class="line">  // Compute the number of vertices in the tessellated circle.</div><div class="line">  FXL_DCHECK(subdivisions &gt;= 0);</div><div class="line">  FXL_DCHECK(spec.IsValidOneBufferMesh());</div><div class="line">  size_t outer_vertex_count = 4;</div><div class="line">  while (subdivisions-- &gt; 0) &#123;</div><div class="line">    outer_vertex_count *= 2;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  size_t vertex_count = outer_vertex_count * 2;</div><div class="line">  size_t index_count = outer_vertex_count * 6;</div><div class="line"></div><div class="line">  auto builder = factory-&gt;NewMeshBuilder(spec, vertex_count, index_count);</div><div class="line"></div><div class="line">  // Generate vertex positions.</div><div class="line">  constexpr size_t kMaxVertexSize = 100;</div><div class="line">  uint8_t vertex[kMaxVertexSize];</div><div class="line">  auto vertex_p =</div><div class="line">      GetVertexAttributePointers(vertex, kMaxVertexSize, spec, builder);</div><div class="line">  FXL_CHECK(vertex_p.pos2);</div><div class="line"></div><div class="line">  const float outer_vertex_count_reciprocal = 1.f / outer_vertex_count;</div><div class="line">  const float radian_step = 2 * M_PI / outer_vertex_count;</div><div class="line">  for (size_t i = 0; i &lt; outer_vertex_count; ++i) &#123;</div><div class="line">    float radians = i * radian_step;</div><div class="line"></div><div class="line">    // Direction of the current vertex from the center of the circle.</div><div class="line">    vec2 dir(sin(radians), cos(radians));</div><div class="line"></div><div class="line">    // Build outer-ring vertex.</div><div class="line">    (*vertex_p.pos2) = dir * outer_radius + center;</div><div class="line">    if (vertex_p.uv) &#123;</div><div class="line">      // Munge the texcoords slightly to avoid wrapping artifacts.  This matters</div><div class="line">      // when both:</div><div class="line">      //   - the vk::SamplerAddressMode is eRepeat</div><div class="line">      //   - the vk::Filter is eLinear</div><div class="line">      (*vertex_p.uv) = 0.49f * (dir + vec2(1.f, 1.02f));</div><div class="line">      // TODO(ES-108): once we can specify a SamplerAddressMode of eClampToEdge,</div><div class="line">      // remove the hack above and replace it with the code below:</div><div class="line">      // (*vertex_p.uv) = 0.5f * (dir + vec2(1.f, 1.f));</div><div class="line">    &#125;</div><div class="line">    if (vertex_p.pos_offset)</div><div class="line">      (*vertex_p.pos_offset) = dir * outer_offset_magnitude;</div><div class="line">    if (vertex_p.perim)</div><div class="line">      (*vertex_p.perim) = i * outer_vertex_count_reciprocal;</div><div class="line">    builder-&gt;AddVertexData(vertex, builder-&gt;vertex_stride());</div><div class="line"></div><div class="line">    // Build inner-ring vertex.  Only the position and offset may differ from</div><div class="line">    // the corresponding outer-ring vertex.</div><div class="line">    (*vertex_p.pos2) = dir * inner_radius + center;</div><div class="line">    if (vertex_p.pos_offset) &#123;</div><div class="line">      // Positive offsets point inward, toward the center of the circle.</div><div class="line">      (*vertex_p.pos_offset) = dir * -inner_offset_magnitude;</div><div class="line">    &#125;</div><div class="line">    builder-&gt;AddVertexData(vertex, builder-&gt;vertex_stride());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Generate vertex indices.</div><div class="line">  for (size_t i = 2; i &lt; vertex_count; i += 2) &#123;</div><div class="line">    builder-&gt;AddIndex(i - 2);</div><div class="line">    builder-&gt;AddIndex(i - 1);</div><div class="line">    builder-&gt;AddIndex(i);</div><div class="line">    builder-&gt;AddIndex(i);</div><div class="line">    builder-&gt;AddIndex(i - 1);</div><div class="line">    builder-&gt;AddIndex(i + 1);</div><div class="line">  &#125;</div><div class="line">  builder-&gt;AddIndex(vertex_count - 2);</div><div class="line">  builder-&gt;AddIndex(vertex_count - 1);</div><div class="line">  builder-&gt;AddIndex(0);</div><div class="line">  builder-&gt;AddIndex(0);</div><div class="line">  builder-&gt;AddIndex(vertex_count - 1);</div><div class="line">  builder-&gt;AddIndex(1);</div><div class="line"></div><div class="line">  auto mesh = builder-&gt;Build();</div><div class="line">  FXL_DCHECK(mesh-&gt;num_indices() == index_count);</div><div class="line">  FXL_DCHECK(</div><div class="line">      mesh-&gt;bounding_box() ==</div><div class="line">      BoundingBox(vec3(center.x - outer_radius, center.y - outer_radius, 0),</div><div class="line">                  vec3(center.x + outer_radius, center.y + outer_radius, 0)));</div><div class="line">  return mesh;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/08/How-vulkan-benefit-from-multithread-on-cpu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/08/How-vulkan-benefit-from-multithread-on-cpu/" itemprop="url">How vulkan benefit from multithead on cpu</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-08T12:59:57+09:00">
                2019-02-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2019/02/08/How-vulkan-benefit-from-multithread-on-cpu/" class="leancloud_visitors" data-flag-title="How vulkan benefit from multithead on cpu">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Vulkan-mechansim-for-multithread-cpu"><a href="#0x1-Vulkan-mechansim-for-multithread-cpu" class="headerlink" title="0x1 Vulkan mechansim for multithread cpu"></a>0x1 Vulkan mechansim for multithread cpu</h1><p>Vulkan uses command buffer to record the gpu states, then execute the command buffer. on opengl, we have only one command buffer to record the gpu states, but on vulkan, we can have several command buffers to record gpu states in parallel.</p>
<p>If the draw task is cpu bounding, which means the loading is cpu heavy, and these tasks can be splitted into several threads to execute in parallel, then we can assign different command buffers to threads, and record the gpu states into these command buffers in parallel, after all threads are ready, we can submit these command buffers to gpu driver, then gpu driver executes it.</p>
<p>Here is the vulkan command buffer execution models.</p>
<p><img src="/2019/02/08/How-vulkan-benefit-from-multithread-on-cpu/vulkan_multithread.png" alt="vulkan_multithread"></p>
<p>Is it possible for every graphics draw pipeline can be benefit from the multithread command buffer mechansim?</p>
<p>It is case by case.</p>
<p>If the drawing data preparing task on cpu can’t be splited into several parallel tasks, likes it has dependency each other(one draw has to be drawed before another one), it can’t be benefited from the mulithread command buffer mechansim.</p>
<p>Otherwise it can benefit from it.</p>
<h1 id="0x2-Test-case-analysis"><a href="#0x2-Test-case-analysis" class="headerlink" title="0x2 Test case analysis"></a>0x2 Test case analysis</h1><p>We use <a href="https://github.com/SaschaWillems/Vulkan/blob/master/examples/multisampling/multisampling.cpp" target="_blank" rel="external">SaschaWillems’s Vulkan example</a> as the test case to check how vulkan can be benefited from multithread.</p>
<p>This test generates command buffers in parallel using multithreaded mechansim. these generation command buffers are configured as the vulkan secondary command buffers, they are executed and submitted together with the primary buffer once all threads have finished.</p>
<p>Here is the sequence about how it works.</p>
<p><img src="/2019/02/08/How-vulkan-benefit-from-multithread-on-cpu/draw_sequence.png" alt="draw_sequence"></p>
<p>Let’s discuss the detail sequence of this test case.</p>
<h2 id="0x21-Prepare"><a href="#0x21-Prepare" class="headerlink" title="0x21 Prepare"></a>0x21 Prepare</h2><p>It prepares the vulkan initialization, load the mesh, create the multithread for command buffer execution.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">VulkanExampleBase::prepare();</div><div class="line"><span class="comment">// Create a fence for synchronization</span></div><div class="line">VkFenceCreateInfo fenceCreateInfo = vks::initializers::fenceCreateInfo(VK_FLAGS_NONE);</div><div class="line">vkCreateFence(device, &amp;fenceCreateInfo, <span class="literal">NULL</span>, &amp;renderFence);</div><div class="line">loadMeshes();</div><div class="line">setupVertexDescriptions();</div><div class="line">setupPipelineLayout();</div><div class="line">preparePipelines();</div><div class="line">prepareMultiThreadedRenderer();</div><div class="line">updateMatrices();</div><div class="line">prepared = <span class="literal">true</span>;</div></pre></td></tr></table></figure>
<p>Here is the code of VulkanExampleBase::prepare(), it does vulkan initialization.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">createCommandPool();</div><div class="line">setupSwapChain();</div><div class="line">createCommandBuffers();</div><div class="line">setupDepthStencil();</div><div class="line">setupRenderPass();</div><div class="line">createPipelineCache();</div><div class="line">setupFrameBuffer();</div></pre></td></tr></table></figure></p>
<p>createCommandPool() creates command buffer through vkCreateCommandPool().</p>
<p>setupSwapChain() creates the swapchain.</p>
<p>createCommandBuffers() creates one command buffer for each swap chain image and reuse for rendering.</p>
<p>setupDepthStencil() steups depth and stencil setting.</p>
<p>setupRenderPass() create render pass through vkCreateRenderPass().</p>
<p>createPipelineCache() create pipeline cache through vkCreatePipelineCache().</p>
<p>setupFrameBuffer() creates frame buffers for every swap chain image through vkCreateFramebuffer().</p>
<h2 id="0x22-Command-buffer-generation"><a href="#0x22-Command-buffer-generation" class="headerlink" title="0x22 Command buffer generation"></a>0x22 Command buffer generation</h2><p>It creates primary/secondary command buffer through vkAllocateCommandBuffers.</p>
<p>It will create thread data for each thread, the thread’s number depends on its core’s number.</p>
<p>For each thread, it will create a command pool for it, then create one secondary command buffer, then create command buffers for each objects.</p>
<p>The buffer number for objcts is numObjectsPerThread, it is the number of animated objects to be rendered per thread, in this test case, the total animated objects is 512, so numObjectsPerThread is 512/numThreads, numThreads is core’s number.</p>
<p>Then it initializes push constants for each object.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// create a primar command buffer</span></div><div class="line">VK_CHECK_RESULT(vkAllocateCommandBuffers(device, &amp;cmdBufAllocateInfo, &amp;primaryCommandBuffer));</div><div class="line"></div><div class="line"><span class="comment">// create a secondary command buffer for rendering the star sphere</span></div><div class="line">cmdBufAllocateInfo.level = VK_COMMAND_BUFFER_LEVEL_SECONDARY;</div><div class="line">VK_CHECK_RESULT(vkAllocateCommandBuffers(device, &amp;cmdBufAllocateInfo, &amp;secondaryCommandBuffer));</div><div class="line">......		</div><div class="line">threadData.resize(numThreads);</div><div class="line">......</div><div class="line"><span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; numThreads; i++)</div><div class="line">&#123;</div><div class="line">	ThreadData *thread = &amp;threadData[i];</div><div class="line">		</div><div class="line">	<span class="comment">// create one command pool for each thread</span></div><div class="line">	VK_CHECK_RESULT(vkCreateCommandPool(device, &amp;cmdPoolInfo, <span class="literal">nullptr</span>, &amp;thread-&gt;commandPool));</div><div class="line"></div><div class="line">	<span class="comment">// one secondary command buffer per object that is updated by this thread</span></div><div class="line">	thread-&gt;commandBuffer.resize(numObjectsPerThread);</div><div class="line">	<span class="comment">// generate secondary command buffers for each thread</span></div><div class="line">	VkCommandBufferAllocateInfo secondaryCmdBufAllocateInfo =</div><div class="line">		vks::initializers::commandBufferAllocateInfo(</div><div class="line">			thread-&gt;commandPool,</div><div class="line">			VK_COMMAND_BUFFER_LEVEL_SECONDARY,</div><div class="line">			thread-&gt;commandBuffer.size());</div><div class="line">	VK_CHECK_RESULT(vkAllocateCommandBuffers(device, &amp;secondaryCmdBufAllocateInfo, thread-&gt;commandBuffer.data()));</div><div class="line"></div><div class="line">	thread-&gt;pushConstBlock.resize(numObjectsPerThread);</div><div class="line">	thread-&gt;objectData.resize(numObjectsPerThread);</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">uint32_t</span> j = <span class="number">0</span>; j &lt; numObjectsPerThread; j++)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">float</span> theta = <span class="number">2.0f</span> * <span class="keyword">float</span>(M_PI) * uniformDist(rndGenerator);</div><div class="line">		<span class="keyword">float</span> phi = <span class="built_in">acos</span>(<span class="number">1.0f</span> - <span class="number">2.0f</span> * uniformDist(rndGenerator));</div><div class="line">		thread-&gt;objectData[j].pos = glm::vec3(<span class="built_in">sin</span>(phi) * <span class="built_in">cos</span>(theta), <span class="number">0.0f</span>, <span class="built_in">cos</span>(phi)) * <span class="number">35.0f</span>;</div><div class="line"></div><div class="line">		thread-&gt;objectData[j].rotation = glm::vec3(<span class="number">0.0f</span>, rnd(<span class="number">360.0f</span>), <span class="number">0.0f</span>);</div><div class="line">		thread-&gt;objectData[j].deltaT = rnd(<span class="number">1.0f</span>);</div><div class="line">		thread-&gt;objectData[j].rotationDir = (rnd(<span class="number">100.0f</span>) &lt; <span class="number">50.0f</span>) ? <span class="number">1.0f</span> : <span class="number">-1.0f</span>;</div><div class="line">		thread-&gt;objectData[j].rotationSpeed = (<span class="number">2.0f</span> + rnd(<span class="number">4.0f</span>)) * thread-&gt;objectData[j].rotationDir;</div><div class="line">		thread-&gt;objectData[j].scale = <span class="number">0.75f</span> + rnd(<span class="number">0.5f</span>);</div><div class="line"></div><div class="line">		thread-&gt;pushConstBlock[j].color = glm::vec3(rnd(<span class="number">1.0f</span>), rnd(<span class="number">1.0f</span>), rnd(<span class="number">1.0f</span>));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x23-Draw"><a href="#0x23-Draw" class="headerlink" title="0x23 Draw"></a>0x23 Draw</h2><p>Here is the code about drawing.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">VulkanExampleBase::prepareFrame();</div><div class="line">updateCommandBuffers(frameBuffers[currentBuffer]);</div><div class="line">submitInfo.commandBufferCount = <span class="number">1</span>;</div><div class="line">submitInfo.pCommandBuffers = &amp;primaryCommandBuffer;</div><div class="line"></div><div class="line">VK_CHECK_RESULT(vkQueueSubmit(<span class="built_in">queue</span>, <span class="number">1</span>, &amp;submitInfo, renderFence));</div><div class="line"></div><div class="line"><span class="comment">// wait for fence to signal that all command buffers are ready</span></div><div class="line">VkResult fenceRes;</div><div class="line"><span class="keyword">do</span></div><div class="line">&#123;</div><div class="line">	fenceRes = vkWaitForFences(device, <span class="number">1</span>, &amp;renderFence, VK_TRUE, <span class="number">100000000</span>);</div><div class="line">&#125; <span class="keyword">while</span> (fenceRes == VK_TIMEOUT);</div><div class="line">VK_CHECK_RESULT(fenceRes);</div><div class="line">vkResetFences(device, <span class="number">1</span>, &amp;renderFence);</div><div class="line">VulkanExampleBase::submitFrame();</div></pre></td></tr></table></figure>
<p>The main update function is updateCommandBuffers().</p>
<p>It uses a thread pool to generate drawing command in each thread, the thread function is threadRenderCode.</p>
<p>Firstly, it start to queue command to primary command buffer through vkBeginCommandBuffer().<br>The primary command buffer didn’t contain any rendering commands, the rendering command are stored (and retrieved) from the secondary command buffers.<br>Then it calls vkCmdBeginRenderPass() to start a new RenderPass.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Updates the secondary command buffers using a thread pool </span></div><div class="line"><span class="comment">// and puts them into the primary command buffer that's </span></div><div class="line"><span class="comment">// lat submitted to the queue for rendering</span></div><div class="line">VkCommandBufferBeginInfo cmdBufInfo = vks::initializers::commandBufferBeginInfo();</div><div class="line">......</div><div class="line"><span class="comment">// Set target frame buffer</span></div><div class="line">VK_CHECK_RESULT(vkBeginCommandBuffer(primaryCommandBuffer, &amp;cmdBufInfo));</div><div class="line"></div><div class="line"><span class="comment">// The primary command buffer does not contain any rendering commands</span></div><div class="line"><span class="comment">// These are stored (and retrieved) from the secondary command buffers</span></div><div class="line">vkCmdBeginRenderPass(primaryCommandBuffer, &amp;renderPassBeginInfo, VK_SUBPASS_CONTENTS_SECONDARY_COMMAND_BUFFERS);</div></pre></td></tr></table></figure>
<p>Once the setup for primary command buffer is ready, it starts to config secondary command buffers.</p>
<p>The secondary command buffer is for star background sphere rendering.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Inheritance info for the secondary command buffers</span></div><div class="line">VkCommandBufferInheritanceInfo inheritanceInfo = vks::initializers::commandBufferInheritanceInfo();</div><div class="line">inheritanceInfo.renderPass = renderPass;</div><div class="line"><span class="comment">// Secondary command buffer also use the currently active framebuffer</span></div><div class="line">inheritanceInfo.framebuffer = frameBuffer;</div><div class="line"></div><div class="line"><span class="comment">// Contains the list of secondary command buffers to be executed</span></div><div class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;VkCommandBuffer&gt; commandBuffers;</div><div class="line"></div><div class="line"><span class="comment">// Secondary command buffer with star background sphere</span></div><div class="line">updateSecondaryCommandBuffer(inheritanceInfo);</div><div class="line">commandBuffers.push_back(secondaryCommandBuffer);</div></pre></td></tr></table></figure>
<p>Now we will see how command buffer generation through multithread.</p>
<p>Each object is executed in one thread.</p>
<p>After secondary command buffer is ready, it executes render commands from the secondary command buffer through vkCmdExecuteCommands()</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Add a job to the thread's queue for each object to be rendered</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">uint32_t</span> t = <span class="number">0</span>; t &lt; numThreads; t++)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; numObjectsPerThread; i++)</div><div class="line">	&#123;</div><div class="line">		threadPool.threads[t]-&gt;addJob([=] &#123; threadRenderCode(t, i, inheritanceInfo); &#125;);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">		</div><div class="line">threadPool.wait();</div><div class="line"></div><div class="line"><span class="comment">// Only submit if object is within the current view frustum</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">uint32_t</span> t = <span class="number">0</span>; t &lt; numThreads; t++)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; numObjectsPerThread; i++)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span> (threadData[t].objectData[i].visible)</div><div class="line">		&#123;</div><div class="line">			commandBuffers.push_back(threadData[t].commandBuffer[i]);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Execute render commands from the secondary command buffer</span></div><div class="line">vkCmdExecuteCommands(primaryCommandBuffer, commandBuffers.size(), commandBuffers.data());</div><div class="line"></div><div class="line">vkCmdEndRenderPass(primaryCommandBuffer);</div><div class="line"></div><div class="line">VK_CHECK_RESULT(vkEndCommandBuffer(primaryCommandBuffer));</div></pre></td></tr></table></figure>
<h2 id="0x24-Multithread-comand-buffer-generation"><a href="#0x24-Multithread-comand-buffer-generation" class="headerlink" title="0x24 Multithread comand buffer generation"></a>0x24 Multithread comand buffer generation</h2><p>Let’s see how the multithread function threadRenderCode work.</p>
<p>It builds the secondary command buffer for one object of each thread.</p>
<p>threadIndex is thread index.<br>cmdBufferIndex is the command buffer index.</p>
<p>It begin to push command buffer to gpu driver through vkBeginCommandBuffer().</p>
<p>Then it prepares the data for push constant. </p>
<p>And push the data to gpu driver through vkCmdPushConstants().</p>
<p>Then it pass vertex data and index data through vkCmdBindVertexBuffers() and vkCmdDrawIndexed().</p>
<p>Then it issues draw operation through vkCmdDrawIndexed().</p>
<p>Then it stops the recording of command buffer through vkEndCommandBuffer().</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Builds the secondary command buffer for each thread</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadRenderCode</span><span class="params">(<span class="keyword">uint32_t</span> threadIndex, <span class="keyword">uint32_t</span> cmdBufferIndex, VkCommandBufferInheritanceInfo inheritanceInfo)</span></span></div><div class="line">&#123;</div><div class="line">	ThreadData *thread = &amp;threadData[threadIndex];</div><div class="line">	ObjectData *objectData = &amp;thread-&gt;objectData[cmdBufferIndex];</div><div class="line"></div><div class="line">	<span class="comment">// Check visibility against view frustum</span></div><div class="line">	objectData-&gt;visible = frustum.checkSphere(objectData-&gt;pos, objectSphereDim * <span class="number">0.5f</span>); </div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!objectData-&gt;visible)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	VkCommandBufferBeginInfo commandBufferBeginInfo = vks::initializers::commandBufferBeginInfo();</div><div class="line">	commandBufferBeginInfo.flags = VK_COMMAND_BUFFER_USAGE_RENDER_PASS_CONTINUE_BIT;</div><div class="line">	commandBufferBeginInfo.pInheritanceInfo = &amp;inheritanceInfo;</div><div class="line"></div><div class="line">	VkCommandBuffer cmdBuffer = thread-&gt;commandBuffer[cmdBufferIndex];</div><div class="line"></div><div class="line">	VK_CHECK_RESULT(vkBeginCommandBuffer(cmdBuffer, &amp;commandBufferBeginInfo));</div><div class="line"></div><div class="line">	VkViewport viewport = vks::initializers::viewport((<span class="keyword">float</span>)width, (<span class="keyword">float</span>)height, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</div><div class="line">	vkCmdSetViewport(cmdBuffer, <span class="number">0</span>, <span class="number">1</span>, &amp;viewport);</div><div class="line"></div><div class="line">	VkRect2D scissor = vks::initializers::rect2D(width, height, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">	vkCmdSetScissor(cmdBuffer, <span class="number">0</span>, <span class="number">1</span>, &amp;scissor);</div><div class="line"></div><div class="line">	vkCmdBindPipeline(cmdBuffer, VK_PIPELINE_BIND_POINT_GRAPHICS, pipelines.phong);</div><div class="line"></div><div class="line">	<span class="comment">// Update objectData</span></div><div class="line">	objectData-&gt;rotation.y += <span class="number">2.5f</span> * objectData-&gt;rotationSpeed * frameTimer;</div><div class="line">	......</div><div class="line">	objectData-&gt;model = glm::scale(objectData-&gt;model, glm::vec3(objectData-&gt;scale));</div><div class="line"></div><div class="line">	thread-&gt;pushConstBlock[cmdBufferIndex].mvp = matrices.projection * matrices.view * objectData-&gt;model;</div><div class="line"></div><div class="line">	<span class="comment">// Update shader push constant block</span></div><div class="line">	<span class="comment">// Contains model view matrix</span></div><div class="line">	vkCmdPushConstants(</div><div class="line">		cmdBuffer,</div><div class="line">		pipelineLayout,</div><div class="line">		VK_SHADER_STAGE_VERTEX_BIT,</div><div class="line">		<span class="number">0</span>,</div><div class="line">		<span class="keyword">sizeof</span>(ThreadPushConstantBlock),</div><div class="line">		&amp;thread-&gt;pushConstBlock[cmdBufferIndex]);</div><div class="line"></div><div class="line">	VkDeviceSize offsets[<span class="number">1</span>] = &#123; <span class="number">0</span> &#125;;</div><div class="line">	vkCmdBindVertexBuffers(cmdBuffer, <span class="number">0</span>, <span class="number">1</span>, &amp;models.ufo.vertices.buffer, offsets);</div><div class="line">	vkCmdBindIndexBuffer(cmdBuffer, models.ufo.indices.buffer, <span class="number">0</span>, VK_INDEX_TYPE_UINT32);</div><div class="line">	vkCmdDrawIndexed(cmdBuffer, models.ufo.indexCount, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">	VK_CHECK_RESULT(vkEndCommandBuffer(cmdBuffer));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="0x3-Performance-analysis"><a href="#0x3-Performance-analysis" class="headerlink" title="0x3 Performance analysis"></a>0x3 Performance analysis</h1><p>Here we will compare the performance with/without multithread support using vulkan.</p>
<p>And then check the thread profiling data of them.</p>
<h2 id="0x31-With-multithread"><a href="#0x31-With-multithread" class="headerlink" title="0x31  With multithread"></a>0x31  With multithread</h2><p>Here is the performance of using vulkan with multithread support(4 threads), the fps is 28.</p>
<p><img src="/2019/02/08/How-vulkan-benefit-from-multithread-on-cpu/test_result_4cores.png" alt="multithread-4cores"></p>
<p>Here is the cpu profiling data of it, we can see the cpu loading is balanced to 5 threads, one is main thread, other 4 threads are working thread for generating object for vulkan command buffer, the working thread number 4 is the number of cpu cores.</p>
<p><img src="/2019/02/08/How-vulkan-benefit-from-multithread-on-cpu/profiling_4cores.png" alt="profiling-4cores"></p>
<h2 id="0x32-Without-multithread"><a href="#0x32-Without-multithread" class="headerlink" title="0x32  Without multithread"></a>0x32  Without multithread</h2><p>Here is the performance of using vulkan without multithread support(1 thread), the fps is 17.</p>
<p>We can see the fps gain from 1 thread to 4 threads is 65%(17 -&gt; 28).</p>
<p><img src="/2019/02/08/How-vulkan-benefit-from-multithread-on-cpu/test_result_1core.png" alt="multithread-1core"></p>
<p>Here is the cpu profiling data of it, we can see the cpu loading is only bounded to two threads, one is the main thread, another is the working thread.</p>
<p><img src="/2019/02/08/How-vulkan-benefit-from-multithread-on-cpu/profiling_1core.png" alt="profiling-1core"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/01/Waterfall-test-of-escher-in-fuchsia/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/" itemprop="url">Waterfall test of escher in fuchsia</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-01T23:21:36+09:00">
                2019-02-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/" class="leancloud_visitors" data-flag-title="Waterfall test of escher in fuchsia">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Escher-Introduction"><a href="#0x1-Escher-Introduction" class="headerlink" title="0x1 Escher Introduction"></a>0x1 Escher Introduction</h1><p>Escher is physical rendering engine in fuchsia os</p>
<p>It aims to support Mixed Reality(MR), MR will mix virtual 3D objects with reality world.</p>
<p>It only supports vulkan as its rendering backend.</p>
<p>Here is the escher’s architecture view.</p>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/escher.png" alt="architecture"></p>
<h1 id="0x2-Waterfall-execution-flow"><a href="#0x2-Waterfall-execution-flow" class="headerlink" title="0x2 Waterfall execution flow"></a>0x2 Waterfall execution flow</h1><p>Waterfall is the demo of how echer is running.</p>
<p>Here is the draw main loop of Waterfall.</p>
<ol>
<li><p>Create objects in scene, place them into Model</p>
</li>
<li><p>Create shadow through DrawFrameWithMomentShadowMapShadows</p>
</li>
<li><p>Draw objects with shadow in PaperRenderer</p>
</li>
</ol>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/drawloop.png" alt="main loop"></p>
<p>Here is the sequence diagram of creating shadowmap</p>
<ol>
<li><p>DrawShadowPass of ShadowMapRenderer is entrypoint for drawing shadow</p>
</li>
<li><p>Create CreateDisplayList in ModelRenderer</p>
</li>
<li><p>ModelRenderer call GetPipeline to create or reuse pipeline</p>
</li>
<li><p>It will call SPIR-V compiler if need to create a new pipeline</p>
</li>
</ol>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/createshadowmap.png" alt="create shadowmap"></p>
<p>Here is the sequence diagram of drawing objects with shadowmap</p>
<ol>
<li><p>Call DrawFrameWithMomentShadowMapShadows</p>
</li>
<li><p>Create CreateDisplayList in ModelRenderer</p>
</li>
<li><p>Draw each item in ModelRenderer::Draw()</p>
</li>
<li><p>Do following operations in command buffer</p>
<p>vk_command_buffer.bindPipeline()   </p>
<p>vk_command_buffer.setStencilReference()</p>
<p>vk_command_buffer.bindDescriptorSets()</p>
</li>
<li><p>Call CommandBuffer::DrawMesh() to draw mesh,it will bind vertex data and index data(similar as OpenGL ES)</p>
<p> command<em>buffer</em>.bindVertexBuffers()</p>
<p> command<em>buffer</em>.bindIndexBuffer()</p>
<p> command<em>buffer</em>.drawIndexed()</p>
</li>
</ol>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/drawframe.png" alt="draw frame"></p>
<h1 id="0x3-Waterfall-snapshot"><a href="#0x3-Waterfall-snapshot" class="headerlink" title="0x3 Waterfall snapshot"></a>0x3 Waterfall snapshot</h1><p>Here are snapshots when Waterfall is running.</p>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/waterfall_2.png" alt="waterfall_2"></p>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/waterfall_3.png" alt="waterfall_3"></p>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/waterfall_4.png" alt="waterfall_4"></p>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/waterfall_5.png" alt="waterfall_5"></p>
<p><img src="/2019/02/01/Waterfall-test-of-escher-in-fuchsia/waterfall_8.png" alt="waterfall_8"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/18/analysis-of-cntv-streaming/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/18/analysis-of-cntv-streaming/" itemprop="url">analysis of cntv streaming</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-18T09:02:32+09:00">
                2018-07-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/07/18/analysis-of-cntv-streaming/" class="leancloud_visitors" data-flag-title="analysis of cntv streaming">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x0-总体流程"><a href="#0x0-总体流程" class="headerlink" title="0x0 总体流程"></a>0x0 总体流程</h1><p>下图表示CBox播放的总体流程。<br>播放正式内容之前先播放广告。先访问Advertisement DNS得到视频广告文件保存的服务器，然后访问该服务器下载广告文件并播放。视频广告文件采用MP4格式保存。<br>节目内容采用HLS(HTTP Live Streaming)协议的方式进行播放，CBox先从HLS Server下载m3u8文件，得到需要下载的ts文件，然后再连接上HLS Server来下载ts文件并播放。</p>
<p><img src="/2018/07/18/analysis-of-cntv-streaming/architecture.png" alt="architecture"></p>
<h1 id="0x1-播放视频广告"><a href="#0x1-播放视频广告" class="headerlink" title="0x1 播放视频广告"></a>0x1 播放视频广告</h1><p>播放视频广告的总体流程抓包如下。<br><img src="/2018/07/18/analysis-of-cntv-streaming/playing_advertisement.png" alt="playing_advertisement"></p>
<h2 id="0x11-通过HTTP获得广告文件的URL"><a href="#0x11-通过HTTP获得广告文件的URL" class="headerlink" title="0x11 通过HTTP获得广告文件的URL"></a>0x11 通过HTTP获得广告文件的URL</h2><p>CBox通过下面的GET方法获取。<br>GET /flash/vd/473fae2b16855f408335283ec9a3e29df44d4a9499406413ccc222e91bc93d85.mp4 HTTP/1.1<br><img src="/2018/07/18/analysis-of-cntv-streaming/get_advertisement_url.png" alt="get_advertisement_url"></p>
<h2 id="0x12-服务器返回广告文件的URL"><a href="#0x12-服务器返回广告文件的URL" class="headerlink" title="0x12 服务器返回广告文件的URL"></a>0x12 服务器返回广告文件的URL</h2><p>服务器对上一步GET方法进行响应，返回广告文件的URL。<br>Location: <a href="http://218.78.185.62/v.cctv.com/flash/vd/473fae2b16855f408335283ec9a3e29df44d4a9499406413ccc222e91bc93d85.mp4?wsrid_tag=5b4dfebd_PSshzjdxiu61_28643-17287&amp;wsiphost=local\r\n" target="_blank" rel="external">http://218.78.185.62/v.cctv.com/flash/vd/473fae2b16855f408335283ec9a3e29df44d4a9499406413ccc222e91bc93d85.mp4?wsrid_tag=5b4dfebd_PSshzjdxiu61_28643-17287&amp;wsiphost=local\r\n</a></p>
<p><img src="/2018/07/18/analysis-of-cntv-streaming/advertisement_url.png" alt="advertisement_url"></p>
<h2 id="0x13-获取广告文件"><a href="#0x13-获取广告文件" class="headerlink" title="0x13 获取广告文件"></a>0x13 获取广告文件</h2><p>通过下面的GET方法获取广告文件。<br>GET /v.cctv.com/flash/vd/473fae2b16855f408335283ec9a3e29df44d4a9499406413ccc222e91bc93d85.mp4</p>
<p><img src="/2018/07/18/analysis-of-cntv-streaming/get_advertisement.png" alt="get_advertisement"></p>
<h2 id="0x14-服务器发送广告文件给CBox"><a href="#0x14-服务器发送广告文件给CBox" class="headerlink" title="0x14 服务器发送广告文件给CBox"></a>0x14 服务器发送广告文件给CBox</h2><p>服务器通过http把视频广告文件发送给CBox。<br><img src="/2018/07/18/analysis-of-cntv-streaming/playing_advertisement.png" alt="playing_advertisement"></p>
<h1 id="0x2-播放节目"><a href="#0x2-播放节目" class="headerlink" title="0x2 播放节目"></a>0x2 播放节目</h1><h2 id="0x21-更新EPG"><a href="#0x21-更新EPG" class="headerlink" title="0x21 更新EPG"></a>0x21 更新EPG</h2><p>EPG是Electronic Program Guide的英文缩写，意思是电子节目指南，提供节目播放列表功能和节目单功能。<br><img src="/2018/07/18/analysis-of-cntv-streaming/update_epg.png" alt="update_epg"></p>
<h2 id="0x22-和服务器之间进行安全认证"><a href="#0x22-和服务器之间进行安全认证" class="headerlink" title="0x22 和服务器之间进行安全认证"></a>0x22 和服务器之间进行安全认证</h2><p>在播放之前对客户端进行安全认证。<br><img src="/2018/07/18/analysis-of-cntv-streaming/tls.png" alt="tls"></p>
<h2 id="0x23-获取HLS的m3u8文件"><a href="#0x23-获取HLS的m3u8文件" class="headerlink" title="0x23 获取HLS的m3u8文件"></a>0x23 获取HLS的m3u8文件</h2><p>m3u8 是一种基于HLS的文件视频格式，它主要存放整个视频的基本信息和分片(Segment)组成。Segment一般是ts格式的视频文件。<br><img src="/2018/07/18/analysis-of-cntv-streaming/hls_m3u8.png" alt="hls_download"></p>
<h2 id="0x24-从服务器中下载ts流并播放"><a href="#0x24-从服务器中下载ts流并播放" class="headerlink" title="0x24 从服务器中下载ts流并播放"></a>0x24 从服务器中下载ts流并播放</h2><p>解析上面下载得到的m3u8文件，得到需要下载的ts文件列表，然后访问服务器，通过http下载这些ts文件到本地并播放。<br><img src="/2018/07/18/analysis-of-cntv-streaming/hls.png" alt="hls"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/27/STUN-in-P2P-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/27/STUN-in-P2P-network/" itemprop="url">STUN in P2P network</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-27T09:22:15+09:00">
                2018-06-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/06/27/STUN-in-P2P-network/" class="leancloud_visitors" data-flag-title="STUN in P2P network">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-STUN简介"><a href="#0x1-STUN简介" class="headerlink" title="0x1 STUN简介"></a>0x1 STUN简介</h1><p>STUN(Session Traversal Utilities for NAT)是一种协助穿越NAT的工具，并不独立提供穿越的解决方案。详细请参考<br><a href="https://datatracker.ietf.org/doc/rfc3489/" target="_blank" rel="external">RFC3489</a>，升级版协议是<a href="https://tools.ietf.org/html/rfc5389" target="_blank" rel="external">RFC5389</a>和<a href="https://tools.ietf.org/html/rfc7350" target="_blank" rel="external">RFC7350</a>。</p>
<p>STUN的使用场景如下，Interactive Connectivity Establishment (ICE) [MMUSIC-ICE], Client-initiated<br>connections for SIP [SIP-OUTBOUND], and NAT Behavior Discovery [BEHAVE-NAT]。</p>
<h1 id="0x2-NAT检测"><a href="#0x2-NAT检测" class="headerlink" title="0x2 NAT检测"></a>0x2 NAT检测</h1><p>RFC3489中将NAT的实现分为四大类：<br>1.Full Cone NAT （完全锥形NAT）<br>2.Restricted Cone NAT （限制锥形NAT ，可以理解为IP限制，Port不限制）<br>3.Port Restricted Cone NAT （端口限制锥形NAT，IP+Port 限制）<br>4.Symmetric NAT （对称NAT）<br>其中完全最上层的完全锥形NAT的穿透性最好，而最下层的对称形NAT需要借助TURN服务器进行数据转发，两个client之间不能进行Peer to Peer的通信。</p>
<p>NAT类型检测过程如下<br><img src="https://upload.wikimedia.org/wikipedia/commons/6/63/STUN_Algorithm3.svg" alt="nat_check"></p>
<p>如上图所示，一旦路经到达红色节点时，Peer to Peer的连接是没有可能性的，需要借助服务器进行转发。一旦通过黄色或是绿色的节点，Peer to Peer的连接是可以成功的。</p>
<p>下面介绍STUN是如何判断NAT的类型的。<br>内容来自<a href="https://www.jianshu.com/p/84e8c78ca61d" target="_blank" rel="external">ICE协议下NAT穿越的实现</a></p>
<p>假设B是客户端，C是STUN服务器，C有两个IP分别为IP1和IP2（至于为什么要两个IP，接着往下看）：</p>
<p>STEP1.判断客户端是否在NAT后：</p>
<p>B向C的IP1的pot1端口发送一个UDP包。C收到这个包后，会把它收到包的源IP和port写到UDP包中，然后把此包通过IP1和port1发还给B。这个IP和port也就是NAT的外网 IP和port（如果你不理解，那么请你去看我的BLOG里面的NAT的原理和分类），也就是说你在STEP1中就得到了NAT的外网IP。</p>
<p>熟悉NAT工作原理的朋友可以知道，C返回给B的这个UDP包B一定收到。如果在你的应用中，向一个STUN服务器发送数据包后，你没有收到STUN的任何回应包，那只有两种可能：1、STUN服务器不存在，或者你弄错了port。2、你的NAT拒绝一切UDP包从外部向内部通过。</p>
<p>当B收到此UDP后，把此UDP中的IP和自己的IP做比较，如果是一样的，就说明自己是在公网，下步NAT将去探测防火墙类型，我不想多说。如果不一样，说明有NAT的存在，系统进行STEP2的操作。</p>
<p>STEP2.判断是否处于Full Cone Nat下：</p>
<p>B向C的IP1发送一个UDP包，请求C通过另外一个IP2和PORT（不同与SETP1的IP1）向B返回一个UDP数据包（现在知道为什么C要有两个IP了吧，虽然还不理解为什么，呵呵）。</p>
<p>我们来分析一下，如果B收到了这个数据包，那说明什么？说明NAT来着不拒，不对数据包进行任何过滤，这也就是STUN标准中的full cone NAT。遗憾的是，Full Cone Nat太少了，这也意味着你能收到这个数据包的可能性不大。如果没收到，那么系统进行STEP3的操作。</p>
<p>STEP3.判断是否处于对称NAT下：</p>
<p>B向C的IP2的port2发送一个数据包，C收到数据包后，把它收到包的源IP和port写到UDP包中，然后通过自己的IP2和port2把此包发还给B。</p>
<p>和step1一样，B肯定能收到这个回应UDP包。此包中的port是我们最关心的数据，下面我们来分析：</p>
<p>如果这个port和step1中的port一样，那么可以肯定这个NAT是个CONE NAT，否则是对称NAT。道理很简单：根据对称NAT的规则，当目的地址的IP和port有任何一个改变，那么NAT都会重新分配一个port使用，而在step3中，和step1对应，我们改变了IP和port。因此，如果是对称NAT,那这两个port肯定是不同的。</p>
<p>如果在你的应用中，到此步的时候PORT是不同的，那么这个它就是处在一个对称NAT下了。如果相同，那么只剩下了restrict cone 和port restrict cone。系统用step4探测是是那一种。</p>
<p>STEP4.判断是处于Restrict Cone NAT还是Port Restrict NAT之下：</p>
<p>B向C的IP2的一个端口PD发送一个数据请求包，要求C用IP2和不同于PD的port返回一个数据包给B。</p>
<p>我们来分析结果：如果B收到了，那也就意味着只要IP相同，即使port不同，NAT也允许UDP包通过。显然这是Restrict Cone NAT。如果没收到，没别的好说，Port Restrict NAT.</p>
<h1 id="0x3-StunServer实现分析"><a href="#0x3-StunServer实现分析" class="headerlink" title="0x3 StunServer实现分析"></a>0x3 StunServer实现分析</h1><p>STUN协议是一个客户机/服务器协议。StunServer可能和其他服务器(如web server, turn server）集成在一起。而stun client也可以在p2p的客户端中实现。<br>在核心的STUN协议中，只有一种称为“Binding”的方法。STUN客户端使用Binding来创建和发现NAT映射。当STUN服务器收到STUN Binding时，它会记录请求来着哪个公网IP和端口，此公网IP和端口会发生给STUN客户端，这样收到STUN Binding响应的客户端会根据这些信息判断NAT的类型。<br><img src="/2018/06/27/STUN-in-P2P-network/stun.png" alt="stun"></p>
<h1 id="0x4-StunServer测试"><a href="#0x4-StunServer测试" class="headerlink" title="0x4 StunServer测试"></a>0x4 StunServer测试</h1><p>测试结果如下，<br>kevin@ubuntu:~/Kevin/nat/stunserver$ ./stunclient 68.xxx.xxx.xxx 3478<br>Binding test: success<br>Local address: 192.168.40.200:47045<br>Mapped address: 116.xxx.xxx.xxx:56077</p>
<p>其中68.xxx.xxx.xxx是运行StunServer服务器的公网IP地址。<br>返回给Stun客户端的信息中包括了Stun客户端的公网IP为116.xxx.xxx.xxx，和内网地址(192.168.40.200)不一致，说明位于NAT之后。至于是哪种NAT类型，需要参考前面的流程进行多次测试。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/29/check-the-execution-of-tensorflow-with-gdb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/29/check-the-execution-of-tensorflow-with-gdb/" itemprop="url">check the execution of tensorflow with gdb</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-29T09:03:29+09:00">
                2018-04-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/04/29/check-the-execution-of-tensorflow-with-gdb/" class="leancloud_visitors" data-flag-title="check the execution of tensorflow with gdb">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Here I list some callstack of tensorflow which is collected through gdb.</p>
<h1 id="0x1-Session-Run"><a href="#0x1-Session-Run" class="headerlink" title="0x1 Session::Run()"></a>0x1 Session::Run()</h1><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">(gdb) bt </div><div class="line">#0 tensorflow::DirectSession::Run (this=0x55a688ed3660, run_options=..., inputs=std::vector of length 3, capacity 3 = &#123;...&#125;,   output_names=std::vector of length 0, capacity 0, target_nodes=std::vector of length 1, capacity 1 = &#123;...&#125;, outputs=0x7f375da478e0,   run_metadata=0x7f375da47930) at tensorflow/core/common_runtime/direct_session.cc:439 </div><div class="line">#1 0x00007f3784cea307 in TF_Run_Helper (session=0x55a688ed3660, handle=0x0, run_options=0x0,   input_pairs=std::vector of length 3, capacity 3 = &#123;...&#125;, output_tensor_names=std::vector of length 0, capacity 0,   c_outputs=0x7f375da47d00, target_oper_names=std::vector of length 1, capacity 1 = &#123;...&#125;, run_metadata=0x0, status=0x7f37200d5e80)  at tensorflow/c/c_api.cc:680 </div><div class="line">#2 0x00007f3784cea874 in TF_Run (s=0x55a688ed2af0, run_options=0x0, c_input_names=0x7f375da47c60, c_inputs=0x7f375da47cb0, ninputs=3,   c_output_names=0x7f375da48060, c_outputs=0x7f375da47d00, noutputs=0, c_target_oper_names=0x7f375da480b0, ntargets=1, run_metadata=0x0,   status=0x7f37200d5e80) at tensorflow/c/c_api.cc:735 </div><div class="line">#3 0x00007f37847382dd in tensorflow::TF_Run_wrapper_helper (session=0x55a688ed2af0, handle=0x0, run_options=0x0, feed_dict=0x7f3762b029d8,   output_names=..., target_nodes=..., out_status=0x7f37200d5e80, out_values=0x7f375da48100, run_outputs=0x0)  at tensorflow/python/client/tf_session_helper.cc:96 </div><div class="line">#4 0x00007f3784738936 in tensorflow::TF_Run_wrapper (session=0x55a688ed2af0, run_options=0x0, feed_dict=0x7f3762b029d8, output_names=...,   target_nodes=..., out_status=0x7f37200d5e80, out_values=0x7f375da48100, run_outputs=0x0)  at tensorflow/python/client/tf_session_helper.cc:149 </div><div class="line">#5 0x00007f37846bf7e4 in _wrap_TF_Run (args=0x7f376350cdb0) at bazel-out/k8-py3-dbg/bin/tensorflow/python/pywrap_tensorflow_internal.cc:15067 </div><div class="line">#6 0x000055a68528b2a1 in _PyCFunction_FastCallDict () </div><div class="line">#7 0x000055a68531e0a0 in call_function () </div><div class="line">#8 0x000055a68533f62a in _PyEval_EvalFrameDefault () </div><div class="line">#9 0x000055a685318c78 in PyEval_EvalCodeEx ()</div></pre></td></tr></table></figure>
<h1 id="0x2-OpKernel-Compute"><a href="#0x2-OpKernel-Compute" class="headerlink" title="0x2 OpKernel::Compute()"></a>0x2 OpKernel::Compute()</h1><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">(gdb) bt</div><div class="line">#0 0x00007f377fe7ee70 in tensorflow::OpKernelContext::input(int)@plt ()from /home/kevin/anaconda3/lib/python3.6/site-packages/tensorflow/python/../libtensorflow_framework.so</div><div class="line">#1 0x00007f378001d8dd in tensorflow::HandleFromInput (ctx=0x7f3724169150, input=0) at tensorflow/core/framework/resource_mgr.cc:279</div><div class="line">#2 0x00007f37859298b8 in tensorflow::QueueOpKernel::ComputeAsync(tensorflow::OpKernelContext*, std::function&lt;void ()&gt;) (this=0x7f37200cbfb0, ctx=0x7f3724169150, callback=...) at tensorflow/core/kernels/queue_ops.cc:37</div><div class="line">#3 0x00007f378482cab8 in tensorflow::Device::ComputeAsync(tensorflow::AsyncOpKernel*, tensorflow::OpKernelContext*, std::function&lt;void ()&gt;)(this=0x55a688ee3260, op_kernel=0x7f37200cbfb0, context=0x7f3724169150, done=...) at ./tensorflow/core/common_runtime/device.h:89</div><div class="line">#4 0x00007f37806b1b6e in tensorflow::(anonymous namespace)::ExecutorState::Process (this=0x7f37200d3440, tagged_node=..., scheduled_usec=0)at tensorflow/core/common_runtime/executor.cc:1647</div><div class="line">#5 0x00007f37806c01a7 in std::_Mem_fn_base&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long), true&gt;::operator()&lt;tensorflow::(anonymous namespace)::ExecutorState::TaggedNode&amp;, long long&amp;, void&gt; (this=0x7f37240337a0, __object=0x7f37200d3440) at /usr/include/c++/5/functional:600</div><div class="line">#6 0x00007f37806bfc62 in std::_Bind&lt;std::_Mem_fn&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;(tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;::__call&lt;void, 0ul, 1ul, 2ul&gt;(&lt;unknown type in /home/kevin/anaconda3/lib/python3.6/site-packages/tensorflow/python/../libtensorflow_framework.so, CU 0x314f884, DIE 0x31e50c1&gt;, std::_Index_tuple&lt;0ul, 1ul, 2ul&gt;) (this=0x7f37240337a0, __args=&lt;unknown type in /home/kevin/anaconda3/lib/python3.6/site-packages/tensorflow/python/../libtensorflow_framework.so, CU 0x314f884, DIE 0x31e50c1&gt;) at /usr/include/c++/5/functional:1074</div><div class="line">#7 0x00007f37806bda06 in std::_Bind&lt;std::_Mem_fn&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;(tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;::operator()&lt;, void&gt;(void) (this=0x7f37240337a0) at /usr/include/c++/5/functional:1133</div><div class="line">#8 0x00007f37806bb2ac in std::_Function_handler&lt;void(), std::_Bind&lt;std::_Mem_fn&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;(tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt; &gt;::_M_invoke(const std::_Any_data &amp;) (__functor=...)at /usr/include/c++/5/functional:1871</div><div class="line">#9 0x00007f377ff7f984 in std::function&lt;void ()&gt;::operator()() const (this=0x7f372407f320) at /usr/include/c++/5/functional:2267</div><div class="line">#10 0x00007f3780197b9e in tensorflow::thread::EigenEnvironment::ExecuteTask (this=0x55a688ed3c58, t=...)at tensorflow/core/lib/core/threadpool.cc:81</div><div class="line">#11 0x00007f378019a65c in Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::WorkerLoop (this=0x55a688ed3c50, thread_id=1) at external/eigen_archive/unsupported/Eigen/CXX11/src/ThreadPool/NonBlockingThreadPool.h:232</div><div class="line">#12 0x00007f3780198aae in Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::NonBlockingThreadPoolTempl(int, bool, tensorflow::thread::EigenEnvironment)::&#123;lambda()#1&#125;::operator()() const ()at external/eigen_archive/unsupported/Eigen/CXX11/src/ThreadPool/NonBlockingThreadPool.h:65</div><div class="line">#13 0x00007f378019bc7c in std::_Function_handler&lt;void (), Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::NonBlockingThreadPoolTempl(int, bool, tensorflow::thread::EigenEnvironment)::&#123;lambda()#1&#125;&gt;::_M_invoke(std::_Any_data const&amp;) (__functor=...)at /usr/include/c++/5/functional:1871</div><div class="line">#14 0x00007f377ff7f984 in std::function&lt;void ()&gt;::operator()() const (this=0x55a688ed3050) at /usr/include/c++/5/functional:2267</div><div class="line">#15 0x00007f3780197907 in tensorflow::thread::EigenEnvironment::CreateThread(std::function&lt;void ()&gt;)::&#123;lambda()#1&#125;::operator()() const (__closure=0x55a688ed3050) at tensorflow/core/lib/core/threadpool.cc:56</div><div class="line">#16 0x00007f37801998d8 in std::_Function_handler&lt;void (), tensorflow::thread::EigenEnvironment::CreateThread(std::function&lt;void ()&gt;)::&#123;lambda()#1&#125;&gt;::_M_invoke(std::_Any_data const&amp;) (__functor=...) at /usr/include/c++/5/functional:1871</div><div class="line">#17 0x00007f377ff7f984 in std::function&lt;void ()&gt;::operator()() const (this=0x55a688f199b8) at /usr/include/c++/5/functional:2267</div><div class="line">#18 0x00007f37801dcf38 in std::_Bind_simple&lt;std::function&lt;void ()&gt; ()&gt;::_M_invoke&lt;&gt;(std::_Index_tuple&lt;&gt;) (this=0x55a688f199b8)at /usr/include/c++/5/functional:1531</div><div class="line">#19 0x00007f37801dcea1 in std::_Bind_simple&lt;std::function&lt;void ()&gt; ()&gt;::operator()() (this=0x55a688f199b8)at /usr/include/c++/5/functional:1520</div><div class="line">#20 0x00007f37801dce40 in std::thread::_Impl&lt;std::_Bind_simple&lt;std::function&lt;void ()&gt; ()&gt; &gt;::_M_run() (this=0x55a688f199a0)at /usr/include/c++/5/thread:115</div><div class="line">#21 0x00007f377ed4fc80 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6</div><div class="line">#22 0x00007f3796f746ba in start_thread (arg=0x7f3760247700) at pthread_create.c:333#23 0x00007f3796caa3dd in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109</div></pre></td></tr></table></figure>
<h1 id="0x3-Producer-of-tenforflow"><a href="#0x3-Producer-of-tenforflow" class="headerlink" title="0x3 Producer of tenforflow"></a>0x3 Producer of tenforflow</h1><p>It is trigged by test.py to send command to tenforflow native code.<br><img src="/2018/04/29/check-the-execution-of-tensorflow-with-gdb/producer.jpg" alt="producer"></p>
<h1 id="0x4-Consumer-of-tenforflow"><a href="#0x4-Consumer-of-tenforflow" class="headerlink" title="0x4 Consumer of tenforflow"></a>0x4 Consumer of tenforflow</h1><p>Tensorflow’s thread pull task from the queue then execute it<br><img src="/2018/04/29/check-the-execution-of-tensorflow-with-gdb/consumer.jpg" alt="consumer"></p>
<h1 id="0x5-gdb-debug-of-convolutional-network-py"><a href="#0x5-gdb-debug-of-convolutional-network-py" class="headerlink" title="0x5 gdb debug of convolutional_network.py"></a>0x5 gdb debug of convolutional_network.py</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(gdb) bt</div><div class="line">#<span class="number">0</span> <span class="number">0x00007f90a7e2d8f0</span> in tensorflow::ConvBackpropComputeDimensions(tensorflow::StringPiece, <span class="keyword">int</span>, tensorflow::TensorShape <span class="keyword">const</span>&amp;, tensorflow::TensorShape <span class="keyword">const</span>&amp;, tensorflow::TensorShape <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt; &gt; <span class="keyword">const</span>&amp;, tensorflow::Padding, tensorflow::TensorFormat, tensorflow::ConvBackpropDimensions*)@plt ()  from /home/kevin/anaconda3/lib/python3<span class="number">.6</span>/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so </div><div class="line">#<span class="number">1</span> <span class="number">0x00007f90ab73bb73</span> in tensorflow::Conv2DCustomBackpropInputOp&lt;Eigen::ThreadPoolDevice, <span class="keyword">float</span>&gt;::Compute (<span class="keyword">this</span>=<span class="number">0x556909e28fa0</span>, context=<span class="number">0x7f9083774840</span>)  at tensorflow/core/kernels/conv_grad_input_ops.cc:<span class="number">311</span> </div><div class="line">#<span class="number">2</span> <span class="number">0x00007f90a3ee091b</span> in tensorflow::ThreadPoolDevice::Compute (  <span class="keyword">this</span>=<span class="number">0x5569092d1f30</span>, op_kernel=<span class="number">0x556909e28fa0</span>, context=<span class="number">0x7f9083774840</span>)  at tensorflow/core/common_runtime/threadpool_device.cc:<span class="number">59</span> </div><div class="line">#<span class="number">3</span> <span class="number">0x00007f90a3e7bc0a</span> in tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::Process (<span class="keyword">this</span>=<span class="number">0x556909f04770</span>, tagged_node=..., scheduled_usec=<span class="number">0</span>)  at tensorflow/core/common_runtime/executor.cc:<span class="number">1652</span> </div><div class="line">#<span class="number">4</span> <span class="number">0x00007f90a3e8a1a7</span> in <span class="built_in">std</span>::_Mem_fn_base&lt;<span class="keyword">void</span> (tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::*)(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span>), <span class="literal">true</span>&gt;::<span class="keyword">operator</span>()&lt;tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode&amp;, <span class="keyword">long</span> <span class="keyword">long</span>&amp;, <span class="keyword">void</span>&gt; (<span class="keyword">this</span>=<span class="number">0x7f904c695d50</span>,   __object=<span class="number">0x556909f04770</span>) at /usr/include/c++/<span class="number">5</span>/functional:<span class="number">600</span> </div><div class="line">#<span class="number">5</span> <span class="number">0x00007f90a3e89c62</span> in <span class="built_in">std</span>::_Bind&lt;<span class="built_in">std</span>::_Mem_fn&lt;<span class="keyword">void</span> (tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::*)(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt;(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState*, tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt;::__call&lt;<span class="keyword">void</span>, <span class="number">0u</span>l, <span class="number">1u</span>l, <span class="number">2u</span>l&gt;(&lt;unknown type in /home/kevin/anaconda3/lib/python3<span class="number">.6</span>/site-packages/tensorflow/python/../libtensorflow_framework.so, CU <span class="number">0x314f884</span>, DIE <span class="number">0x31e50c1</span>&gt;, <span class="built_in">std</span>::_Index_tuple&lt;<span class="number">0u</span>l, <span class="number">1u</span>l, <span class="number">2u</span>l&gt;) (<span class="keyword">this</span>=<span class="number">0x7f904c695d50</span>,  ---Type &lt;<span class="keyword">return</span>&gt; to <span class="keyword">continue</span>, <span class="keyword">or</span> q &lt;<span class="keyword">return</span>&gt; to quit---  __args=&lt;unknown type in /home/kevin/anaconda3/lib/python3<span class="number">.6</span>/site-packages/tensorflow/python/../libtensorflow_framework.so, CU <span class="number">0x314f884</span>, DIE <span class="number">0x31e50c1</span>&gt;)  at /usr/include/c++/<span class="number">5</span>/functional:<span class="number">1074</span> </div><div class="line">#<span class="number">6</span> <span class="number">0x00007f90a3e87a06</span> in <span class="built_in">std</span>::_Bind&lt;<span class="built_in">std</span>::_Mem_fn&lt;<span class="keyword">void</span> (tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::*)(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt;(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState*, tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt;::<span class="keyword">operator</span>()&lt;, <span class="keyword">void</span>&gt;(<span class="keyword">void</span>) (<span class="keyword">this</span>=<span class="number">0x7f904c695d50</span>)  at /usr/include/c++/<span class="number">5</span>/functional:<span class="number">1133</span> </div><div class="line">#<span class="number">7</span> <span class="number">0x00007f90a3e852ac</span> in <span class="built_in">std</span>::_Function_handler&lt;<span class="keyword">void</span>(), <span class="built_in">std</span>::_Bind&lt;<span class="built_in">std</span>::_Mem_fn&lt;<span class="keyword">void</span> (tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::*)(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt;(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState*, tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt; &gt;::_M_invoke(<span class="keyword">const</span> <span class="built_in">std</span>::_Any_data &amp;) (__functor=...)  at /usr/include/c++/<span class="number">5</span>/functional:<span class="number">1871</span> </div><div class="line">#<span class="number">8</span> <span class="number">0x00007f90a3749984</span> in <span class="built_in">std</span>::function&lt;<span class="keyword">void</span> ()&gt;::<span class="keyword">operator</span>()() <span class="keyword">const</span> (  <span class="keyword">this</span>=<span class="number">0x7f904c6c5d40</span>) at /usr/include/c++/<span class="number">5</span>/functional:<span class="number">2267</span> #<span class="number">9</span> <span class="number">0x00007f90a3961b9e</span> in tensorflow::thread::EigenEnvironment::ExecuteTask (  <span class="keyword">this</span>=<span class="number">0x5569091d82c8</span>, t=...) at tensorflow/core/lib/core/threadpool.cc:<span class="number">81</span> </div><div class="line">#<span class="number">10</span> <span class="number">0x00007f90a396465c</span> in Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::WorkerLoop (<span class="keyword">this</span>=<span class="number">0x5569091d82c0</span>, thread_id=<span class="number">1</span>)  at external/eigen_archive/unsupported/Eigen/CXX11/src/ThreadPool/NonBlockingThreadPool.h:<span class="number">232</span> </div><div class="line">#<span class="number">11</span> <span class="number">0x00007f90a3962aae</span> in Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::NonBlockingThreadPoolTempl(<span class="keyword">int</span>, <span class="keyword">bool</span>, tensorflow::thread::EigenEnvironment)::&#123;lambda()#<span class="number">1</span>&#125;::<span class="keyword">operator</span>()() <span class="keyword">const</span> ()  at external/eigen_archive/unsupported/Eigen/CXX11/src/ThreadPool/NonBlockingThreadPool.h:<span class="number">65</span></div></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(gdb) c Continuing. </div><div class="line">[Switching to Thread <span class="number">0x7f9083775700</span> (LWP <span class="number">3586</span>)]   </div><div class="line">Thread <span class="number">13</span> <span class="string">"python"</span> hit Breakpoint <span class="number">5</span>, <span class="number">0x00007f90a7e2d8f0</span> in tensorflow::ConvBackpropComputeDimensions(tensorflow::StringPiece, <span class="keyword">int</span>, tensorflow::TensorShape <span class="keyword">const</span>&amp;, tensorflow::TensorShape <span class="keyword">const</span>&amp;, tensorflow::TensorShape <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt; &gt; <span class="keyword">const</span>&amp;, tensorflow::Padding, tensorflow::TensorFormat, tensorflow::ConvBackpropDimensions*)@plt ()  from /home/kevin/anaconda3/lib/python3<span class="number">.6</span>/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so </div><div class="line">(gdb) n </div><div class="line">Single stepping until <span class="built_in">exit</span> from function _ZN10tensorflow29ConvBackpropComputeDimensionsENS_11StringPieceEiRKNS_11TensorShapeES3_S3_RKSt6vectorIiSaIiEENS_7PaddingENS_12TensorFormatEPNS_22ConvBackpropDimensionsE@plt, which has no line number information. [Switching to Thread <span class="number">0x7f90819b9700</span> (LWP <span class="number">3587</span>)]   Thread <span class="number">14</span> <span class="string">"python"</span> hit Breakpoint <span class="number">5</span>, <span class="number">0x00007f90a7e2d8f0</span> in tensorflow::ConvBackpropComputeDimensions(tensorflow::StringPiece, <span class="keyword">int</span>, tensorflow::TensorShape <span class="keyword">const</span>&amp;, tensorflow::TensorShape <span class="keyword">const</span>&amp;, tensorflow::TensorShape <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::allocator&lt;<span class="keyword">int</span>&gt; &gt; <span class="keyword">const</span>&amp;, tensorflow::Padding, tensorflow::TensorFormat, tensorflow::ConvBackpropDimensions*)@plt ()  from /home/kevin/anaconda3/lib/python3<span class="number">.6</span>/site-packages/tensorflow/python/_pywrap_tensorflow_internal.so </div><div class="line">(gdb)  </div><div class="line">Single stepping until <span class="built_in">exit</span> from function _ZN10tensorflow29ConvBackpropComputeDimensionsENS_11StringPieceEiRKNS_11TensorShapeES3_S3_RKSt6vectorIiSaIiEENS_7PaddingENS_12TensorFormatEPNS_22ConvBackpropDimensionsE@plt, which has no line number information. tensorflow::ConvBackpropComputeDimensions (label=..., num_spatial_dims=<span class="number">32656</span>,   input_shape=..., filter_shape=..., out_backprop_shape=...,   strides=<span class="built_in">std</span>::<span class="built_in">vector</span> of length <span class="number">4</span>, capacity <span class="number">4</span> = &#123;...&#125;,   padding=tensorflow::VALID, data_format=tensorflow::FORMAT_NHWC,   dims=<span class="number">0x7f90819b8240</span>) at tensorflow/core/kernels/conv_grad_ops.cc:<span class="number">156</span> <span class="number">156</span>  ConvBackpropDimensions* dims) &#123; (gdb) n [Switching to Thread <span class="number">0x7f9083775700</span> (LWP <span class="number">3586</span>)]   Thread <span class="number">13</span> <span class="string">"python"</span> hit Breakpoint <span class="number">5</span>, tensorflow::ConvBackpropComputeDimensions  (label=..., num_spatial_dims=<span class="number">2</span>, input_shape=..., filter_shape=...,   out_backprop_shape=...,   strides=<span class="built_in">std</span>::<span class="built_in">vector</span> of length <span class="number">4</span>, capacity <span class="number">4</span> = &#123;...&#125;,   padding=tensorflow::VALID, data_format=tensorflow::FORMAT_NHWC,   dims=<span class="number">0x7f9083774240</span>) at tensorflow/core/kernels/conv_grad_ops.cc:<span class="number">160</span> <span class="number">160</span>  one_dilations, strides, padding, data_format, dims);</div></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">(gdb)</div><div class="line">#<span class="number">0</span> <span class="built_in">std</span>::<span class="keyword">operator</span>==&lt;tensorflow::Status::State, <span class="built_in">std</span>::default_delete&lt;tensorflow::Status::State&gt; &gt;(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;tensorflow::Status::State, <span class="built_in">std</span>::default_delete&lt;tensorflow::Status::State&gt; &gt; <span class="keyword">const</span>&amp;, <span class="keyword">decltype</span>(<span class="literal">nullptr</span>)) (  __x=<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;tensorflow::Status::State&gt; containing <span class="number">0x0</span>)  at /usr/include/c++/<span class="number">5</span>/bits/<span class="built_in">unique_ptr</span>.h:<span class="number">631</span> </div><div class="line">#<span class="number">1</span> <span class="number">0x00007f90a7e9e41d</span> in tensorflow::Status::ok (<span class="keyword">this</span>=<span class="number">0x7f90819b8150</span>)  at ./tensorflow/core/lib/core/status.h:<span class="number">53</span> </div><div class="line">#<span class="number">2</span> <span class="number">0x00007f90ab73bb86</span> in tensorflow::Conv2DCustomBackpropInputOp&lt;Eigen::ThreadPoolDevice, <span class="keyword">float</span>&gt;::Compute (<span class="keyword">this</span>=<span class="number">0x556909e5c730</span>, context=<span class="number">0x7f90819b8840</span>)  at tensorflow/core/kernels/conv_grad_input_ops.cc:<span class="number">311</span> </div><div class="line">#<span class="number">3</span> <span class="number">0x00007f90a3ee091b</span> in tensorflow::ThreadPoolDevice::Compute (  <span class="keyword">this</span>=<span class="number">0x5569092d1f30</span>, op_kernel=<span class="number">0x556909e5c730</span>, context=<span class="number">0x7f90819b8840</span>)  at tensorflow/core/common_runtime/threadpool_device.cc:<span class="number">59</span> </div><div class="line">#<span class="number">4</span> <span class="number">0x00007f90a3e7bc0a</span> in tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::Process (<span class="keyword">this</span>=<span class="number">0x55690a0f5150</span>, tagged_node=..., scheduled_usec=<span class="number">0</span>)  at tensorflow/core/common_runtime/executor.cc:<span class="number">1652</span> </div><div class="line">#<span class="number">5</span> <span class="number">0x00007f90a3e8a1a7</span> in <span class="built_in">std</span>::_Mem_fn_base&lt;<span class="keyword">void</span> (tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::*)(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span>), <span class="literal">true</span>&gt;::<span class="keyword">operator</span>()&lt;tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode&amp;, <span class="keyword">long</span> <span class="keyword">long</span>&amp;, <span class="keyword">void</span>&gt; (<span class="keyword">this</span>=<span class="number">0x7f90508b25b0</span>,   __object=<span class="number">0x55690a0f5150</span>) at /usr/include/c++/<span class="number">5</span>/functional:<span class="number">600</span> </div><div class="line">#<span class="number">6</span> <span class="number">0x00007f90a3e89c62</span> in <span class="built_in">std</span>::_Bind&lt;<span class="built_in">std</span>::_Mem_fn&lt;<span class="keyword">void</span> (tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::*)(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt;(tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState*, tensorflow::(anonymous <span class="keyword">namespace</span>)::ExecutorState::TaggedNode, <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)&gt;::__call&lt;<span class="keyword">void</span>, <span class="number">0u</span>l, <span class="number">1u</span>l, <span class="number">2u</span>l&gt;(&lt;unknown type in /home/kevin/anaconda3/lib/python3<span class="number">.6</span>/site-packages/tensorflow/python/../libtensorflow_framework.so, CU <span class="number">0x314f884</span>, DIE <span class="number">0x31e50c1</span>&gt;, <span class="built_in">std</span>::_Index_tuple&lt;<span class="number">0u</span>l, <span class="number">1u</span>l, <span class="number">2u</span>l&gt;) (<span class="keyword">this</span>=<span class="number">0x7f90508b25b0</span>,   __args=&lt;unknown type in /home/kevin/anaconda3/lib/python3<span class="number">.6</span>/site-packages/tensorflow/python/../libtensorflow_framework.so, CU <span class="number">0x314f884</span>, DIE <span class="number">0x31e50c1</span>&gt;)  at /usr/include/c++/<span class="number">5</span>/functional:<span class="number">1074</span> ---Type &lt;<span class="keyword">return</span>&gt; to <span class="keyword">continue</span>, <span class="keyword">or</span> q &lt;<span class="keyword">return</span>&gt; to quit---   </div><div class="line">(gdb) n </div><div class="line">tensorflow::Conv2DCustomBackpropInputOp&lt;Eigen::ThreadPoolDevice, <span class="keyword">float</span>&gt;::Compute (<span class="keyword">this</span>=<span class="number">0x556909e5c730</span>, context=<span class="number">0x7f90819b8840</span>)  at tensorflow/core/kernels/conv_grad_input_ops.cc:<span class="number">317</span> <span class="number">317</span>  Tensor* in_backprop = <span class="literal">nullptr</span>;</div><div class="line">(gdb) <span class="built_in">list</span></div><div class="line"> <span class="number">312</span>  ConvBackpropComputeDimensions( <span class="number">313</span>  <span class="string">"Conv2DCustomBackpropInput"</span>, <span class="comment">/*num_spatial_dims=*/</span><span class="number">2</span>, <span class="number">314</span>  input_shape, filter.shape(), out_backprop.shape(), <span class="number">315</span>  strides_, padding_, data_format_, &amp;dims)); <span class="number">316</span>  <span class="number">317</span>  Tensor* in_backprop = <span class="literal">nullptr</span>; <span class="number">318</span>  OP_REQUIRES_OK(context, <span class="number">319</span>  context-&gt;allocate_output(<span class="number">0</span>, input_shape, &amp;in_backprop)); <span class="number">320</span>  <span class="number">321</span> <span class="comment">// TODO(andydavis) Consider moving code shared with </span></div><div class="line">(gdb) n</div><div class="line"><span class="number">318</span>  OP_REQUIRES_OK(context, </div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Thread info</div><div class="line">(gdb) info threads</div><div class="line">  Id Target Id Frame   </div><div class="line">  1 Thread 0x7f90bab09700 (LWP 3530) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  2 Thread 0x7f90b6a6a700 (LWP 3531) "python" 0x00007f90ba6f387f in __libc_recv (fd=4, buf=0x7f90b6a7afc8, n=4, flags=0)  at ../sysdeps/unix/sysv/linux/x86_64/recv.c:28  </div><div class="line">  3 Thread 0x7f908fc55700 (LWP 3560) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  4 Thread 0x7f908f454700 (LWP 3561) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  5 Thread 0x7f908ec53700 (LWP 3562) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  6 Thread 0x7f908e452700 (LWP 3563) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  7 Thread 0x7f908693b700 (LWP 3578) "python" 0x00007f90ba6f2827 in futex_abstimed_wait_cancelable (private=0, abstime=0x0, expected=0,   futex_word=0x7f9068013280)  at ../sysdeps/unix/sysv/linux/futex-internal.h:205 </div><div class="line">  8 Thread 0x7f9085f7a700 (LWP 3581) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  9 Thread 0x7f9085779700 (LWP 3582) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  10 Thread 0x7f9084f78700 (LWP 3583) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  11 Thread 0x7f9084777700 (LWP 3584) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  12 Thread 0x7f9083f76700 (LWP 3585) "python" tensorflow::ConvBackpropComputeDimensions (label=..., num_spatial_dims=2, input_shape=...,   filter_shape=..., out_backprop_shape=...,   strides=std::vector of length 4, capacity 4 = &#123;...&#125;,   padding=tensorflow::VALID, data_format=tensorflow::FORMAT_NHWC,  ---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---  dims=0x7f9083f75240) at tensorflow/core/kernels/conv_grad_ops.cc:160  </div><div class="line">  13 Thread 0x7f9083775700 (LWP 3586) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185 * </div><div class="line">  14 Thread 0x7f90819b9700 (LWP 3587) "python" tensorflow::ConvBackpropComputeDimensions (label=..., num_spatial_dims=2, input_shape=...,   filter_shape=..., out_backprop_shape=...,   strides=std::vector of length 4, capacity 4 = &#123;...&#125;,   padding=tensorflow::VALID, data_format=tensorflow::FORMAT_NHWC,   dims=0x7f90819b8240) at tensorflow/core/kernels/conv_grad_ops.cc:160  </div><div class="line">  15 Thread 0x7f90811b8700 (LWP 3588) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  16 Thread 0x7f90809b7700 (LWP 3589) "python" pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185  </div><div class="line">  17 Thread 0x7f907dde7700 (LWP 3590) "python" 0x00007f90ba6f2827 in futex_abstimed_wait_cancelable (private=0, abstime=0x0, expected=0,   futex_word=0x7f9038001380)  at ../sysdeps/unix/sysv/linux/futex-internal.h:205</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/" itemprop="url">Design p2p streaming capturer based on flv</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-22T09:36:10+09:00">
                2018-04-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/" class="leancloud_visitors" data-flag-title="Design p2p streaming capturer based on flv">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Introduction"><a href="#0x1-Introduction" class="headerlink" title="0x1     Introduction"></a>0x1     Introduction</h1><p>streaming capturer用于接收client端发送过来的媒体数据，client端类似于目前市面上的直播客户端，通过RTMP/RTSP协议把数据发送给streaming capturer。streaming capturer对接收到的数据进行解包，如果需要可以进行transcoding，然后把数据发送给后续的模块进行处理，这些模块可以把数据发送给其他服务器提供流媒体服务。下面介绍的p2p streaming capturer是把接收到和转码后的数据打包成P2P协议包，这些P2P协议包被发送给种子节点p2p seed node，p2p seed node提供p2p streaming的种子节点功能。播放器先连接到这个p2p seed node，获取播放所需要的媒体数据，而且后面进来的播放器可以从前面的播放器中得到部分播放数据，不需要都从p2p seed node处获取数据，从而显著地降低流媒体服务器的带宽负担。<br>Adobe FLV格式是一种流媒体格式，p2p streaming capturer接收到client发送过来的数据流以后，打包成FLV格式, 然后在FLV的基础上打包成P2P数据包的格式。</p>
<p>下面是系统架构图。<br><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/architecture.png" alt="architecture"></p>
<h1 id="0x2-flv数据格式"><a href="#0x2-flv数据格式" class="headerlink" title="0x2   flv数据格式"></a>0x2   flv数据格式</h1><p>下面简单介绍一下FLV数据格式。<br>如下所示，首先是9个byte的flv header。</p>
<h2 id="0x21-The-flv-header"><a href="#0x21-The-flv-header" class="headerlink" title="0x21  The flv header"></a>0x21  The flv header</h2><p><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/flv_header.png" alt="flv_header"></p>
<p>在flv header之后，是Tag和Size交织组成的数据部分。</p>
<h2 id="0x22-The-flv-file-body"><a href="#0x22-The-flv-file-body" class="headerlink" title="0x22  The flv file body"></a>0x22  The flv file body</h2><p><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/flv_file_body.png" alt="flv_file_body"></p>
<h2 id="0x23-flv-tag"><a href="#0x23-flv-tag" class="headerlink" title="0x23  flv tag"></a>0x23  flv tag</h2><p>下面是flv tag数据部分。<br><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/flv_tag.png" alt="flv_tag"></p>
<h1 id="0x3-基于flv的p2p-streaming-capturer的设计"><a href="#0x3-基于flv的p2p-streaming-capturer的设计" class="headerlink" title="0x3  基于flv的p2p streaming capturer的设计"></a>0x3  基于flv的p2p streaming capturer的设计</h1><p>流程图如下，</p>
<p><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/sequence.png" alt="sequence"></p>
<p>左边是p2p streaming capturer, 它与p2p seed node进行交互，p2p streaming capturer接收client发送的RTMP/RTSP数据包，经过解包/转码以后生成FLV数据，这个时候需要把FLV header和类似SPS/PPS之类的媒体类型信息保存起来，p2p streaming capturer还需要实现内部缓存buffer, 把打包好的FLV数据缓存起来，为了后面打包成P2P数据包发送给p2p seed node。<br>p2p streaming capturer连接上p2p seed node以后，先发送注册(Register)信息，然后发送媒体类型(MediaType)信息，MediaType包括SPS/PPS等信息，然后开始把前面缓存起来的数据按固定大小(16384)打包成P2P格式，然后发送给p2p seed node.<br>p2p seed node在p2p streaming capturer连接上来以后，需要把相关信息发送给tracker server，这样相当于tracker server增加了一个节目源。<br>播放器player可以连接到p2p seed node来得到播放数据。对于直播来说，由于player刚连接到p2p seed node的时候获取的数据可能并不是关键帧，这个时候不能立即播放，需要等待下一个关键帧的到来。为了减少播放等待时候，可以在p2p seed node上实现gop cache的功能，把最近一个关键帧开始的数据都保存到gop cache中，等播放器连接上来的时候，把gop cache中的数据发送给播放器，这样播放器就不需要等待。当有新的关键帧到来的时候，需要把gop cache中的数据清空，然后保存当前关键帧开始的数据。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/Implement-yuv2rgb-gpu-filter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/Implement-yuv2rgb-gpu-filter/" itemprop="url">Implement yuv2rgb gpu filter</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-15T21:02:13+09:00">
                2018-04-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/04/15/Implement-yuv2rgb-gpu-filter/" class="leancloud_visitors" data-flag-title="Implement yuv2rgb gpu filter">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Introduction"><a href="#0x1-Introduction" class="headerlink" title="0x1     Introduction"></a>0x1     Introduction</h1><p>本文我们将在GPU上实现yuv420p到rgb的转换，转换代码采用opengl es glsl实现。该转换代码在GPU上运行，为了更好地展示这个实现过程和体现转换效果，我们在Android平台上实现一个app应用。<br>详细代码请参考 <a href="https://github.com/wenxiaoming/YUVRender" target="_blank" rel="external">YUVRender</a></p>
<p>YUV2RGB转换的算法原理如下，其中Y/U/V是从yuv420p数据中读取的三个分量。<br>    B=1.164(Y−16)+2.018(U−128)<br>    G=1.164(Y−16)−0.813(V−128)−0.391(U−128)<br>    R=1.164(Y−16)+1.596(V−128)</p>
<h1 id="0x2-Shader代码"><a href="#0x2-Shader代码" class="headerlink" title="0x2     Shader代码"></a>0x2     Shader代码</h1><h2 id="0x21-vertex-shader代码"><a href="#0x21-vertex-shader代码" class="headerlink" title="0x21 vertex shader代码"></a>0x21 vertex shader代码</h2><p>vertex shader代码首先输入顶点坐标和纹理坐标。<br>输出变量gl_Position用于在计算顶点位置以后将其写入裁剪坐标。<br>输出变量vtexcoord是输入给fragment shader作为纹理坐标的。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">precision mediump <span class="keyword">float</span>;</div><div class="line">varying   mediump vec2 vtexcoord;</div><div class="line">attribute mediump vec4 position;</div><div class="line">attribute mediump vec2 texcoord;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">	gl_Position  = position;</div><div class="line">	vtexcoord = texcoord;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x22-fragment-shader代码"><a href="#0x22-fragment-shader代码" class="headerlink" title="0x22 fragment shader代码"></a>0x22 fragment shader代码</h2><p>fragment shader代码首先输入texture坐标, 该坐标首先经过了vertex shader处理，<br>然后又经过了Primitive Assembly阶段的clip和插值处理。<br>然后输入三个sampler2D，这三个sampler2D分别对应yuv420p的Y/U/V数据，通过texture2D这个内置的纹理访问函数，我们可以读取对应纹理坐标下的Y/U/V数据。<br>接下面的代码就是执行YUV到RGB的转换矩阵了，具体的矩阵可以参考前面的介绍。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">precision mediump <span class="keyword">float</span>;</div><div class="line">varying   mediump vec2 vtexcoord;</div><div class="line">uniform   lowp  sampler2D samplerY;</div><div class="line">uniform   lowp  sampler2D samplerU;</div><div class="line">uniform   lowp  sampler2D samplerV;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    mediump <span class="keyword">float</span> y;</div><div class="line">    mediump <span class="keyword">float</span> u;</div><div class="line">    mediump <span class="keyword">float</span> v;</div><div class="line">    lowp  vec3 rgb;</div><div class="line">    mat3 convmatrix = mat3(vec3(<span class="number">1.164</span>,  <span class="number">1.164</span>, <span class="number">1.164</span>),</div><div class="line">                           vec3(<span class="number">0.0</span>,   <span class="number">-0.392</span>, <span class="number">2.017</span>),</div><div class="line">                           vec3(<span class="number">1.596</span>, <span class="number">-0.813</span>, <span class="number">0.0</span>));</div><div class="line"></div><div class="line">    y = (texture2D(samplerY, vtexcoord).r - (<span class="number">16.0</span> / <span class="number">255.0</span>));</div><div class="line">    u = (texture2D(samplerU, vtexcoord).r - (<span class="number">128.0</span> / <span class="number">255.0</span>));</div><div class="line">    v = (texture2D(samplerV, vtexcoord).r - (<span class="number">128.0</span> / <span class="number">255.0</span>));</div><div class="line"></div><div class="line">    rgb = convmatrix * vec3(y, u, v);</div><div class="line">    gl_FragColor = vec4(rgb, <span class="number">1.0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="0x3-具体实现"><a href="#0x3-具体实现" class="headerlink" title="0x3     具体实现"></a>0x3     具体实现</h1><h2 id="0x31-texture的创建"><a href="#0x31-texture的创建" class="headerlink" title="0x31 texture的创建"></a>0x31 texture的创建</h2><p>为了让GPU能读取到YUV的数据，需要创建3个texture, 这三个texture分别存放Y/U/V分量。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">GLES20.glGenTextures(<span class="number">3</span>, mTexture, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</div><div class="line">&#123;</div><div class="line">    GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + i);</div><div class="line">    GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, mTexture[i]);</div><div class="line">    GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR);</div><div class="line">    GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_LINEAR);</div><div class="line">    GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_CLAMP_TO_EDGE);</div><div class="line">    GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_CLAMP_TO_EDGE);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x32-yuv420p数据的读取"><a href="#0x32-yuv420p数据的读取" class="headerlink" title="0x32 yuv420p数据的读取"></a>0x32 yuv420p数据的读取</h2><p>我们读取的yuv420p数据是foreman.qcif，分辨率是qcif(176x144), 从数据布局来看，首先是176x144大小的Y分量，然后是88x72大小的U分量, 最后是88x72大小的V分量。下面是读取YUV数据的详细代码。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getYuvData</span><span class="params">(String fileName)</span></span></div><div class="line">&#123;</div><div class="line">    String res=<span class="string">""</span>;</div><div class="line">    <span class="keyword">try</span>&#123;</div><div class="line">        InputStream in = getResources().getAssets().open(fileName);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> length = in.available();</div><div class="line">        byte [] buffer = <span class="keyword">new</span> byte[length];</div><div class="line"></div><div class="line">        ByteBuffer byteBuffer = ByteBuffer.allocateDirect(length);</div><div class="line">        mYuvBuffer = byteBuffer;</div><div class="line"></div><div class="line">        in.read(buffer);</div><div class="line">        in.close();</div><div class="line"></div><div class="line">        mYuvBuffer.put(buffer);</div><div class="line">        mYuvBuffer.position(<span class="number">0</span>);</div><div class="line"></div><div class="line">        mBufferU = ByteBuffer.allocateDirect(<span class="number">88</span>*<span class="number">72</span>);</div><div class="line">        mBufferV = ByteBuffer.allocateDirect(<span class="number">88</span>*<span class="number">72</span>);</div><div class="line"></div><div class="line">        mBufferU.put(buffer,<span class="number">176</span>*<span class="number">144</span>,<span class="number">88</span>*<span class="number">72</span>);</div><div class="line">        mBufferU.position(<span class="number">0</span>);</div><div class="line"></div><div class="line">        mBufferV.put(buffer,<span class="number">176</span>*<span class="number">144</span>+<span class="number">88</span>*<span class="number">72</span>,<span class="number">88</span>*<span class="number">72</span>);</div><div class="line">        mBufferV.position(<span class="number">0</span>);</div><div class="line">    &#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x33-texture的更新"><a href="#0x33-texture的更新" class="headerlink" title="0x33 texture的更新"></a>0x33 texture的更新</h2><p>YUV数据保持在pixels数组中，通过调用glTexImage2D把YUV数据输入到GPU driver中。<br>因为需要给YUV的三个texture分别输入，所以需要循环3次。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span>[] planes    = &#123; <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span> &#125;;</div><div class="line"><span class="keyword">int</span>[] widths    = &#123; width, width/<span class="number">2</span>, width/<span class="number">2</span> &#125;;</div><div class="line"><span class="keyword">int</span>[] heights  = &#123; height, height/<span class="number">2</span>, height/<span class="number">2</span> &#125;;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> plane = planes[i];</div><div class="line">    GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + i);</div><div class="line"></div><div class="line">    GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, mTexture[i]);</div><div class="line">    ShaderManager.checkGlError(<span class="string">"glBindTexture"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(pixels[plane] == null)</div><div class="line">        Log.e(<span class="string">"YUV2RGBFilter"</span>, <span class="string">"pixels[plane] == null"</span>);</div><div class="line"></div><div class="line">    GLES20.glTexImage2D(</div><div class="line">            GLES20.GL_TEXTURE_2D,</div><div class="line">            <span class="number">0</span>,</div><div class="line">            GLES20.GL_LUMINANCE,</div><div class="line">            widths[plane],</div><div class="line">            heights[plane],</div><div class="line">            <span class="number">0</span>,</div><div class="line">            GLES20.GL_LUMINANCE,</div><div class="line">            GLES20.GL_UNSIGNED_BYTE,</div><div class="line">            pixels[plane]);</div><div class="line"></div><div class="line">    ShaderManager.checkGlError(<span class="string">"glTexImage2D"</span>);</div><div class="line"></div><div class="line">    GLES20.glUniform1i(mTextureHandle[i], i);</div><div class="line"></div><div class="line">    ShaderManager.checkGlError(<span class="string">"glUniform1i"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x34-更新其他参数"><a href="#0x34-更新其他参数" class="headerlink" title="0x34 更新其他参数"></a>0x34 更新其他参数</h2><p>下面的代码是把顶点坐标和纹理坐标输入给GPU driver。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">GLES20.glVertexAttribPointer(mPositionHandle, <span class="number">3</span>, GLES20.GL_FLOAT,</div><div class="line">        <span class="literal">false</span>, <span class="number">0</span>, mVertexBuffer);</div><div class="line">ShaderManager.checkGlError(<span class="string">"glVertexAttribPointer"</span>);</div><div class="line"></div><div class="line">GLES20.glEnableVertexAttribArray(mPositionHandle);</div><div class="line"></div><div class="line">ShaderManager.checkGlError(<span class="string">"glEnableVertexAttribArray"</span>);</div><div class="line"></div><div class="line">GLES20.glVertexAttribPointer(mTexCoordHandle, <span class="number">2</span>, GLES20.GL_FLOAT,</div><div class="line">        <span class="literal">false</span>, <span class="number">0</span>, mTexCoorBuffer);</div><div class="line">ShaderManager.checkGlError(<span class="string">"glVertexAttribPointer"</span>);</div><div class="line"></div><div class="line">GLES20.glEnableVertexAttribArray(mTexCoordHandle);</div></pre></td></tr></table></figure></p>
<h1 id="0x4-调试中碰到的问题"><a href="#0x4-调试中碰到的问题" class="headerlink" title="0x4 调试中碰到的问题"></a>0x4 调试中碰到的问题</h1><p>代码写好以后，一运行，不能出来正确的图像，一直是绿屏。下面介绍一下解决绿屏的过程。<br>首先检查api调用是否正确，通过启用swiftshader，我们可以打印出所有的opengl es api调用log, 检查该app调用的opengl es api，没有发现问题。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.439</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: ClearColor external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">710</span> ((GLclampf red = <span class="number">1.000000</span>, GLclampf green = <span class="number">0.000000</span>, GLclampf blue = <span class="number">1.000000</span>, GLclampf alpha = <span class="number">1.000000</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.439</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Clear external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">692</span> ((GLbitfield mask = <span class="number">4100</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.451</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: UseProgram external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">5925</span> ((GLuint program = <span class="number">3</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.451</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: BindTexture external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">354</span> ((GLenum target = <span class="number">0xDE1</span>, GLuint texture = <span class="number">1</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Uniform1iv external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">5545</span> ((GLint location = <span class="number">0</span>, GLsizei count = <span class="number">1</span>, <span class="keyword">const</span> GLint* v = <span class="number">0x7b00d3a1621c</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: BindTexture external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">354</span> ((GLenum target = <span class="number">0xDE1</span>, GLuint texture = <span class="number">2</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Uniform1iv external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">5545</span> ((GLint location = <span class="number">1</span>, GLsizei count = <span class="number">1</span>, <span class="keyword">const</span> GLint* v = <span class="number">0x7b00d3a1621c</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: BindTexture external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">354</span> ((GLenum target = <span class="number">0xDE1</span>, GLuint texture = <span class="number">3</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Uniform1iv external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">5545</span> ((GLint location = <span class="number">2</span>, GLsizei count = <span class="number">1</span>, <span class="keyword">const</span> GLint* v = <span class="number">0x7b00d3a1621c</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: VertexAttribPointer external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">6127</span> ((GLuint index = <span class="number">0</span>, GLint size = <span class="number">3</span>, GLenum type = <span class="number">0x1406</span>, GLboolean normalized = <span class="number">0</span>, GLsizei stride = <span class="number">0</span>, <span class="keyword">const</span> GLvoid* ptr = <span class="number">0x740e1d10</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">3300</span>  <span class="number">3300</span> E libGLESv2_swiftshader: BindTexture external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">354</span> ((GLenum target = <span class="number">0x8D65</span>, GLuint texture = <span class="number">4</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">3300</span>  <span class="number">3300</span> E libGLESv2_swiftshader: EGLImageTargetTexture2DOES external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">6659</span> ((GLenum target = <span class="number">0x8D65</span>, GLeglImageOES image = <span class="number">0x8</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: EnableVertexAttribArray external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1865</span> ((GLuint index = <span class="number">0</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: VertexAttribPointer external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">6127</span> ((GLuint index = <span class="number">1</span>, GLint size = <span class="number">2</span>, GLenum type = <span class="number">0x1406</span>, GLboolean normalized = <span class="number">0</span>, GLsizei stride = <span class="number">0</span>, <span class="keyword">const</span> GLvoid* ptr = <span class="number">0x740e0b80</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.453</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: EnableVertexAttribArray external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1865</span> ((GLuint index = <span class="number">1</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.453</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: DrawArrays external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1537</span> ((GLenum mode = <span class="number">0x5</span>, GLint first = <span class="number">0</span>, GLsizei count = <span class="number">4</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.453</span>  <span class="number">3300</span>  <span class="number">3300</span> E libGLESv2_swiftshader: Disable external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1493</span> ((GLenum cap = <span class="number">0xC11</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.454</span>  <span class="number">3300</span>  <span class="number">3300</span> E libGLESv2_swiftshader: Viewport external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">6189</span> ((GLint x = <span class="number">0</span>, GLint y = <span class="number">0</span>, GLsizei width = <span class="number">1080</span>, GLsizei height = <span class="number">1920</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.468</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Finish external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1922</span> (())</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.728</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: DisableVertexAttribArray external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1520</span> ((GLuint index = <span class="number">0</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.729</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: DisableVertexAttribArray external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1520</span> ((GLuint index = <span class="number">1</span>))</div></pre></td></tr></table></figure></p>
<p>再怀疑是因为texture没有被正确地送入到GPU中，通过dump glTexImage2D()输入的pixel，发现也是正确的。</p>
<p>最后在fragment shader中写hard code, 强制输出某种颜色，也是正确的，说明整个流程没有问题。</p>
<p>最后怀疑是texture的坐标没有正确地设置，在打印glVertexAttribPointer()的输入参数，发现这个时候的texture坐标都是0，明显不是正确的值，一步一步往上debug， 发现是因为Java ByteBuffer的order没有被设置成本机字节顺序(ByteOrder.nativeOrder()), 设置了以后，texture的坐标就正确了。</p>
<p>解决了绿屏的问题以后，yuv420p的数据能在Android上正确显示了，显示效果如下<br><img src="/2018/04/15/Implement-yuv2rgb-gpu-filter/screencap.jpg" alt="result"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/08/How-swiftshader-supports-texture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/08/How-swiftshader-supports-texture/" itemprop="url">How swiftshader supports texture</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-08T12:59:57+09:00">
                2018-04-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/04/08/How-swiftshader-supports-texture/" class="leancloud_visitors" data-flag-title="How swiftshader supports texture">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Introduction"><a href="#0x1-Introduction" class="headerlink" title="0x1     Introduction"></a>0x1     Introduction</h1><p>Here is the OpenGL ES pipeline, the pink color box represents the data buffer in the pipeline, the gray blue box represents the operation in the pipeline.</p>
<p>In the following of this article, I will show you how texture is used in the OpenGL ES pipeline. In order to explains it more clearly, I will dig into the texture support in Swiftshader, since Swiftshader is the software implementation of OpenGL ES pipeline, we can see the detail implementation of it.</p>
<p><img src="/2018/04/08/How-swiftshader-supports-texture/pipeline.png" alt="pipeline"></p>
<h1 id="0x2-Application-code"><a href="#0x2-Application-code" class="headerlink" title="0x2    Application code."></a>0x2    Application code.</h1><p>Here is the code for texture generation.<br>It generates and binds texture, and sets the parameter for it.<br>GL_TEXTURE_MAG_FILTER and GL_TEXTURE_MIN_FILTER is used to set up the filtering mode for mipmaps. GL_TEXTURE_WRAP_S and GL_TEXTURE_WRAP_T is used to set up texture wrap modes when texture coordinate is outside the range[0.0, 1.0].</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">glGenTextures(<span class="number">1</span>, mTexture, <span class="number">0</span>);</div><div class="line">glActiveTexture(GL_TEXTURE0);</div><div class="line">glBindTexture(GL_TEXTURE_2D, mTexture);</div><div class="line">glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</div><div class="line">glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</div><div class="line">glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);</div><div class="line">glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);</div></pre></td></tr></table></figure>
<p>Here is the code for texture upload.<br>The texture’s content is passed by parameter pixel, the GPU driver will copy pixel into its managed internal buffer, If the GPU hardware supports tile rendering, typically there is a conversion from linear buffer to tile buffer at the same time.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">glBindTexture(GL_TEXTURE_2D, mTexture);</div><div class="line">glTexImage2D(GL_TEXTURE_2D,</div><div class="line">            <span class="number">0</span>,</div><div class="line">            GL_LUMINANCE,</div><div class="line">            width,</div><div class="line">            height,</div><div class="line">            <span class="number">0</span>,</div><div class="line">            GL_LUMINANCE,</div><div class="line">            GL_UNSIGNED_BYTE,</div><div class="line">            pixel);</div><div class="line"></div><div class="line">glUniform1i(mTextureHandle, i);</div></pre></td></tr></table></figure></p>
<h1 id="0x3-Texture-in-Shader-code"><a href="#0x3-Texture-in-Shader-code" class="headerlink" title="0x3    Texture in Shader code."></a>0x3    Texture in Shader code.</h1><p>Here is one example of glsl shader code.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">static const char simplevs[] =</div><div class="line">    attribute vec4 position;</div><div class="line">    attribute vec2 texCoords;</div><div class="line">    varying vec2 outTexCoords;</div><div class="line">    void main(void) &#123;</div><div class="line">        outTexCoords = texCoords;</div><div class="line">        gl_Position = position;</div><div class="line">    &#125;";</div><div class="line">static const char simplefs[] =</div><div class="line">    precision mediump float;</div><div class="line">    varying vec2 outTexCoords;</div><div class="line">    uniform sampler2D texture;</div><div class="line">    void main(void) &#123;</div><div class="line">        gl_FragColor = texture2D(texture, outTexCoords);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>In the vertex shader code, the texture’s coordinate is input by attribute texCoords, then it is output in vertex shader as outTexCoords,<br>Then in primitive assembly and rasterization stage, it is clipped and interpolated.<br>Then in fragment shader code, the clipped and interpolated texture coordinate is used to fetching specific position’s pixel from the texture.<br>Here is the diagram to explain the execution sequence.<br><img src="/2018/04/08/How-swiftshader-supports-texture/sequence.png" alt="sequence"></p>
<h1 id="0x4-Texture-support-in-swiftshader"><a href="#0x4-Texture-support-in-swiftshader" class="headerlink" title="0x4    Texture support in swiftshader"></a>0x4    Texture support in swiftshader</h1><p>Let’s to see how texture is supported in swiftshader, Here is the draft diagram in swiftshader about texture support.</p>
<p><img src="/2018/04/08/How-swiftshader-supports-texture/texture_in_swiftshader.png" alt="texture_in_swiftshader"></p>
<h2 id="0x41-Set-texture-for-pipeline-in-glDrawXX"><a href="#0x41-Set-texture-for-pipeline-in-glDrawXX" class="headerlink" title="0x41 Set texture for pipeline in glDrawXX()"></a>0x41 Set texture for pipeline in glDrawXX()</h2><p>At this time, texture is uploaded through glTexImage2D(), glDrawXX() is triggered. applyTexture() is used to setup texture for current draw context.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Context::applyTexture(sw::SamplerType type, <span class="keyword">int</span> index, Texture *baseTexture)</div><div class="line">&#123;</div><div class="line">        ……</div><div class="line">		<span class="keyword">switch</span>(baseTexture-&gt;getTarget())</div><div class="line">		&#123;</div><div class="line">		<span class="keyword">case</span> GL_TEXTURE_2D:</div><div class="line">		&#123;</div><div class="line">			Texture2D *texture = <span class="keyword">static_cast</span>&lt;Texture2D*&gt;(baseTexture);</div><div class="line"></div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> mipmapLevel = <span class="number">0</span>; mipmapLevel &lt; sw::MIPMAP_LEVELS; mipmapLevel++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">int</span> surfaceLevel = mipmapLevel + baseLevel;</div><div class="line"></div><div class="line">				<span class="keyword">if</span>(surfaceLevel &gt; maxLevel)</div><div class="line">				&#123;</div><div class="line">					surfaceLevel = maxLevel;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				egl::Image *surface = texture-&gt;getImage(surfaceLevel);</div><div class="line">				device-&gt;setTextureLevel(sampler, <span class="number">0</span>, mipmapLevel, surface, sw::TEXTURE_2D);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">        ……</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x42-Calculate-texture’s-coordinate-in-VertexProcessor"><a href="#0x42-Calculate-texture’s-coordinate-in-VertexProcessor" class="headerlink" title="0x42 Calculate texture’s coordinate in VertexProcessor."></a>0x42 Calculate texture’s coordinate in VertexProcessor.</h2><p>It generate LLVM IR for texture coordinate calculation in vertex shader code.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> VertexProgram::program(UInt&amp; index)</div><div class="line">&#123;</div><div class="line">    ……</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; shader-&gt;getLength(); i++)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">const</span> Shader::Instruction *instruction = shader-&gt;getInstruction(i);</div><div class="line">		Shader::Opcode opcode = instruction-&gt;opcode;</div><div class="line">        ……</div><div class="line">    &#125;</div><div class="line">    ……</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x43-Clip-and-interpolate-texture-coordinate-in-SetupProcessor"><a href="#0x43-Clip-and-interpolate-texture-coordinate-in-SetupProcessor" class="headerlink" title="0x43 Clip and interpolate texture coordinate in SetupProcessor()"></a>0x43 Clip and interpolate texture coordinate in SetupProcessor()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> SetupRoutine::generate()</div><div class="line">&#123;</div><div class="line">    <span class="comment">// Culling</span></div><div class="line">	<span class="keyword">if</span>(solidTriangle)</div><div class="line">	&#123;</div><div class="line">        Float A = (y2 - y0) * x1 + (y1 - y2) * x0 + (y0 - y1) * x2; <span class="comment">// Area</span></div><div class="line"></div><div class="line">		If(A == <span class="number">0.0f</span>)</div><div class="line">		&#123;</div><div class="line">			Return(<span class="literal">false</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Int w0w1w2 = *Pointer&lt;Int&gt;(v0 + pos * <span class="number">16</span> + <span class="number">12</span>) ^</div><div class="line">				 *Pointer&lt;Int&gt;(v1 + pos * <span class="number">16</span> + <span class="number">12</span>) ^</div><div class="line">				 *Pointer&lt;Int&gt;(v2 + pos * <span class="number">16</span> + <span class="number">12</span>);</div><div class="line"></div><div class="line">		A = IfThenElse(w0w1w2 &lt; <span class="number">0</span>, -A, A);</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(state.cullMode == CULL_CLOCKWISE)</div><div class="line">		&#123;</div><div class="line">			If(A &gt;= <span class="number">0.0f</span>) Return(<span class="literal">false</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(state.cullMode == CULL_COUNTERCLOCKWISE)</div><div class="line">		&#123;</div><div class="line">			If(A &lt;= <span class="number">0.0f</span>) Return(<span class="literal">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    ……</div><div class="line">	Int n = *Pointer&lt;Int&gt;(polygon + OFFSET(Polygon,n));</div><div class="line">	Int m = *Pointer&lt;Int&gt;(polygon + OFFSET(Polygon,i));</div><div class="line"></div><div class="line">    If(m != <span class="number">0</span> || Bool(!solidTriangle))<span class="comment">// Clipped triangle</span></div><div class="line">	&#123;</div><div class="line">        ……</div><div class="line">        For(Int q = <span class="number">0</span>, q &lt; state.multiSample, q++)</div><div class="line">		&#123;</div><div class="line">            ……</div><div class="line">			Xq[n] = Xq[<span class="number">0</span>];</div><div class="line">			Yq[n] = Yq[<span class="number">0</span>];</div><div class="line"></div><div class="line">			<span class="comment">// Setup edge for Rasterize</span></div><div class="line">			&#123;</div><div class="line">				Int i = <span class="number">0</span>;</div><div class="line"></div><div class="line">                Do</div><div class="line">				&#123;</div><div class="line">					edge(primitive, data, Xq[i + <span class="number">1</span> - d], Yq[i + <span class="number">1</span> - d], Xq[i + d], Yq[i + d], q);</div><div class="line"></div><div class="line">					i++;</div><div class="line">				&#125;</div><div class="line">				Until(i &gt;= n)</div><div class="line">			&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">        </div><div class="line">    ……</div><div class="line">	<span class="keyword">if</span>(state.interpolateW)</div><div class="line">	&#123;</div><div class="line">        ……</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(state.interpolateZ)</div><div class="line">	&#123;</div><div class="line">        ……</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> interpolant = <span class="number">0</span>; interpolant &lt; MAX_FRAGMENT_INPUTS; interpolant++)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> component = <span class="number">0</span>; component &lt; <span class="number">4</span>; component++)</div><div class="line">		&#123;</div><div class="line">            <span class="keyword">int</span> attribute = state.gradient[interpolant][component].attribute;</div><div class="line">                </div><div class="line">			<span class="keyword">bool</span> flat = state.gradient[interpolant][component].flat;</div><div class="line">			<span class="keyword">bool</span> wrap = state.gradient[interpolant][component].wrap;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(attribute != Unused)</div><div class="line">			&#123;</div><div class="line">				setupGradient(primitive, tri, w012, M, v0, v1, v2, OFFSET(Vertex,v[attribute][component]), OFFSET(Primitive,V[interpolant][component]), flat, sprite, state.perspective, wrap, component);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x44-Pass-parameter-for-pixel-shader"><a href="#0x44-Pass-parameter-for-pixel-shader" class="headerlink" title="0x44 Pass parameter for pixel shader"></a>0x44 Pass parameter for pixel shader</h2><p> The parameter includes texture sampler and texture’s coordinate. These parameter is encapsulated in DrawData.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DrawData</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">const</span> Constants *constants;</div><div class="line">	<span class="keyword">const</span> <span class="keyword">void</span> *input[MAX_VERTEX_INPUTS];</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> stride[MAX_VERTEX_INPUTS];</div><div class="line">	Texture mipmap[TOTAL_IMAGE_UNITS];</div><div class="line">	<span class="keyword">const</span> <span class="keyword">void</span> *indices;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> Renderer::executeTask(<span class="keyword">int</span> threadIndex)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">switch</span>(task[threadIndex].type)</div><div class="line">	&#123;</div><div class="line">	    <span class="keyword">case</span> Task::PRIMITIVES:</div><div class="line">            ……</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> Task::PIXELS:</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">int</span> unit = task[threadIndex].primitiveUnit;</div><div class="line">				<span class="keyword">int</span> visible = primitiveProgress[unit].visible;</div><div class="line"></div><div class="line">				<span class="keyword">if</span>(visible &gt; <span class="number">0</span>)</div><div class="line">				&#123;</div><div class="line">					<span class="keyword">int</span> cluster = task[threadIndex].pixelCluster;</div><div class="line">					Primitive *primitive = primitiveBatch[unit];</div><div class="line">					DrawCall *draw = drawList[pixelProgress[cluster].drawCall &amp; DRAW_COUNT_BITS];</div><div class="line">					DrawData *data = draw-&gt;data;</div><div class="line">					PixelProcessor::RoutinePointer pixelRoutine = draw-&gt;pixelPointer;</div><div class="line"></div><div class="line">					pixelRoutine(primitive, visible, cluster, data);</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				finishRendering(task[threadIndex]);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">        ……</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">``` C++</div><div class="line"></div><div class="line">## <span class="number">0x45</span> Fetch pixel from texture</div><div class="line">PixelProgram fetch pixel from texture by passing the clipped <span class="keyword">and</span> interpolated texture coordinate. </div><div class="line">uvwq is the texture coordinate. the following code is executed in LLVM JIT.</div><div class="line"></div><div class="line">``` C++</div><div class="line">Vector4f PixelProgram::sampleTexture(<span class="keyword">int</span> samplerIndex, Vector4f &amp;uvwq, Float4 &amp;bias, Vector4f &amp;dsx, Vector4f &amp;dsy, Vector4f &amp;offset, SamplerFunction function)</div><div class="line">&#123;</div><div class="line">	</div><div class="line">	Pointer&lt;Byte&gt; texture = data + OFFSET(DrawData, mipmap) + samplerIndex * <span class="keyword">sizeof</span>(Texture);</div><div class="line">	Vector4f c = SamplerCore(constants, state.sampler[samplerIndex]).sampleTexture(texture, uvwq.x, uvwq.y, uvwq.z, uvwq.w, bias, dsx, dsy, offset, function);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> c;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Here is the detail texture sample algorithm, from the following code, we can see SwiftShader uses Bilinear interpolation to sample the texture.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">Vector4s SamplerCore::sampleQuad2D(Pointer&lt;Byte&gt; &amp;texture, Float4 &amp;u, Float4 &amp;v, Float4 &amp;w, Vector4f &amp;offset, Float &amp;lod, Int face[<span class="number">4</span>], <span class="keyword">bool</span> secondLOD, SamplerFunction function)</div><div class="line">&#123;</div><div class="line">	<span class="comment">// Bilinear interpolation</span></div><div class="line">	<span class="keyword">if</span>(componentCount &gt;= <span class="number">1</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span>(has16bitTextureComponents() &amp;&amp; hasUnsignedTextureComponent(<span class="number">0</span>))</div><div class="line">		&#123;</div><div class="line">			c0.x = As&lt;UShort4&gt;(c0.x) - MulHigh(As&lt;UShort4&gt;(c0.x), f0u) + MulHigh(As&lt;UShort4&gt;(c1.x), f0u);</div><div class="line">			c2.x = As&lt;UShort4&gt;(c2.x) - MulHigh(As&lt;UShort4&gt;(c2.x), f0u) + MulHigh(As&lt;UShort4&gt;(c3.x), f0u);</div><div class="line">			c.x  = As&lt;UShort4&gt;(c0.x) - MulHigh(As&lt;UShort4&gt;(c0.x), f0v) + MulHigh(As&lt;UShort4&gt;(c2.x), f0v);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span>(hasUnsignedTextureComponent(<span class="number">0</span>))</div><div class="line">			&#123;</div><div class="line">				c0.x = MulHigh(As&lt;UShort4&gt;(c0.x), f1u1v);</div><div class="line">				c1.x = MulHigh(As&lt;UShort4&gt;(c1.x), f0u1v);</div><div class="line">				c2.x = MulHigh(As&lt;UShort4&gt;(c2.x), f1u0v);</div><div class="line">				c3.x = MulHigh(As&lt;UShort4&gt;(c3.x), f0u0v);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				c0.x = MulHigh(c0.x, f1u1vs);</div><div class="line">				c1.x = MulHigh(c1.x, f0u1vs);</div><div class="line">				c2.x = MulHigh(c2.x, f1u0vs);</div><div class="line">				c3.x = MulHigh(c3.x, f0u0vs);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">            c.x = (c0.x + c1.x) + (c2.x + c3.x);</div><div class="line">			<span class="keyword">if</span>(!hasUnsignedTextureComponent(<span class="number">0</span>)) c.x = AddSat(c.x, c.x);<span class="comment">// Correct for signed fractions</span></div><div class="line">	    &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Kevin Wen" />
          <p class="site-author-name" itemprop="name">Kevin Wen</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kevin Wen</span>
</div>


<div> <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
访问量 <span id="busuanzi_value_site_pv"></span>
访问人数 <span id="busuanzi_value_site_uv"></span>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("orq8xxsDQDXKiHdqSRcjlflB-gzGzoHsz", "ecCFdIcWDfbJKQOCiLFf1EBm");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
