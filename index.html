<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="Kevin Wen&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Kevin Wen&#39;s Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kevin Wen&#39;s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Kevin Wen's Blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kevin Wen's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/18/analysis-of-cntv-streaming/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/18/analysis-of-cntv-streaming/" itemprop="url">analysis of cntv streaming</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-18T09:02:32+09:00">
                2018-07-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/07/18/analysis-of-cntv-streaming/" class="leancloud_visitors" data-flag-title="analysis of cntv streaming">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x0-总体流程"><a href="#0x0-总体流程" class="headerlink" title="0x0 总体流程"></a>0x0 总体流程</h1><p>下图表示CBox播放的总体流程。<br>播放正式内容之前先播放广告。先访问Advertisement DNS得到视频广告文件保存的服务器，然后访问该服务器下载广告文件并播放。视频广告文件采用MP4格式保存。<br>节目内容采用HLS(HTTP Live Streaming)协议的方式进行播放，CBox先从HLS Server下载m3u8文件，得到需要下载的ts文件，然后再连接上HLS Server来下载ts文件并播放。</p>
<p><img src="/2018/07/18/analysis-of-cntv-streaming/architecture.png" alt="architecture"></p>
<h1 id="0x1-播放视频广告"><a href="#0x1-播放视频广告" class="headerlink" title="0x1 播放视频广告"></a>0x1 播放视频广告</h1><p>播放视频广告的总体流程抓包如下。<br><img src="/2018/07/18/analysis-of-cntv-streaming/playing_advertisement.png" alt="playing_advertisement"></p>
<h2 id="0x11-通过HTTP获得广告文件的URL"><a href="#0x11-通过HTTP获得广告文件的URL" class="headerlink" title="0x11 通过HTTP获得广告文件的URL"></a>0x11 通过HTTP获得广告文件的URL</h2><p>CBox通过下面的GET方法获取。<br>GET /flash/vd/473fae2b16855f408335283ec9a3e29df44d4a9499406413ccc222e91bc93d85.mp4 HTTP/1.1<br><img src="/2018/07/18/analysis-of-cntv-streaming/get_advertisement_url.png" alt="get_advertisement_url"></p>
<h2 id="0x12-服务器返回广告文件的URL"><a href="#0x12-服务器返回广告文件的URL" class="headerlink" title="0x12 服务器返回广告文件的URL"></a>0x12 服务器返回广告文件的URL</h2><p>服务器对上一步GET方法进行响应，返回广告文件的URL。<br>Location: <a href="http://218.78.185.62/v.cctv.com/flash/vd/473fae2b16855f408335283ec9a3e29df44d4a9499406413ccc222e91bc93d85.mp4?wsrid_tag=5b4dfebd_PSshzjdxiu61_28643-17287&amp;wsiphost=local\r\n" target="_blank" rel="external">http://218.78.185.62/v.cctv.com/flash/vd/473fae2b16855f408335283ec9a3e29df44d4a9499406413ccc222e91bc93d85.mp4?wsrid_tag=5b4dfebd_PSshzjdxiu61_28643-17287&amp;wsiphost=local\r\n</a></p>
<p><img src="/2018/07/18/analysis-of-cntv-streaming/advertisement_url.png" alt="advertisement_url"></p>
<h2 id="0x13-获取广告文件"><a href="#0x13-获取广告文件" class="headerlink" title="0x13 获取广告文件"></a>0x13 获取广告文件</h2><p>通过下面的GET方法获取广告文件。<br>GET /v.cctv.com/flash/vd/473fae2b16855f408335283ec9a3e29df44d4a9499406413ccc222e91bc93d85.mp4</p>
<p><img src="/2018/07/18/analysis-of-cntv-streaming/get_advertisement.png" alt="get_advertisement"></p>
<h2 id="0x14-服务器发送广告文件给CBox"><a href="#0x14-服务器发送广告文件给CBox" class="headerlink" title="0x14 服务器发送广告文件给CBox"></a>0x14 服务器发送广告文件给CBox</h2><p>服务器通过http把视频广告文件发送给CBox。<br><img src="/2018/07/18/analysis-of-cntv-streaming/playing_advertisement.png" alt="playing_advertisement"></p>
<h1 id="0x2-播放节目"><a href="#0x2-播放节目" class="headerlink" title="0x2 播放节目"></a>0x2 播放节目</h1><h2 id="0x21-更新EPG"><a href="#0x21-更新EPG" class="headerlink" title="0x21 更新EPG"></a>0x21 更新EPG</h2><p>EPG是Electronic Program Guide的英文缩写，意思是电子节目指南，提供节目播放列表功能和节目单功能。<br><img src="/2018/07/18/analysis-of-cntv-streaming/update_epg.png" alt="update_epg"></p>
<h2 id="0x22-和服务器之间进行安全认证"><a href="#0x22-和服务器之间进行安全认证" class="headerlink" title="0x22 和服务器之间进行安全认证"></a>0x22 和服务器之间进行安全认证</h2><p>在播放之前对客户端进行安全认证。<br><img src="/2018/07/18/analysis-of-cntv-streaming/tls.png" alt="tls"></p>
<h2 id="0x23-获取HLS的m3u8文件"><a href="#0x23-获取HLS的m3u8文件" class="headerlink" title="0x23 获取HLS的m3u8文件"></a>0x23 获取HLS的m3u8文件</h2><p>m3u8 是一种基于HLS的文件视频格式，它主要存放整个视频的基本信息和分片(Segment)组成。Segment一般是ts格式的视频文件。<br><img src="/2018/07/18/analysis-of-cntv-streaming/hls_m3u8.png" alt="hls_download"></p>
<h2 id="0x24-从服务器中下载ts流并播放"><a href="#0x24-从服务器中下载ts流并播放" class="headerlink" title="0x24 从服务器中下载ts流并播放"></a>0x24 从服务器中下载ts流并播放</h2><p>解析上面下载得到的m3u8文件，得到需要下载的ts文件列表，然后访问服务器，通过http下载这些ts文件到本地并播放。<br><img src="/2018/07/18/analysis-of-cntv-streaming/hls.png" alt="hls"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/27/STUN-in-P2P-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/27/STUN-in-P2P-network/" itemprop="url">STUN in P2P network</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-27T09:22:15+09:00">
                2018-06-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/06/27/STUN-in-P2P-network/" class="leancloud_visitors" data-flag-title="STUN in P2P network">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-STUN简介"><a href="#0x1-STUN简介" class="headerlink" title="0x1 STUN简介"></a>0x1 STUN简介</h1><p>STUN(Session Traversal Utilities for NAT)是一种协助穿越NAT的工具，并不独立提供穿越的解决方案。详细请参考<br><a href="https://datatracker.ietf.org/doc/rfc3489/" target="_blank" rel="external">RFC3489</a>，升级版协议是<a href="https://tools.ietf.org/html/rfc5389" target="_blank" rel="external">RFC5389</a>和<a href="https://tools.ietf.org/html/rfc7350" target="_blank" rel="external">RFC7350</a>。</p>
<p>STUN的使用场景如下，Interactive Connectivity Establishment (ICE) [MMUSIC-ICE], Client-initiated<br>connections for SIP [SIP-OUTBOUND], and NAT Behavior Discovery [BEHAVE-NAT]。</p>
<h1 id="0x2-NAT检测"><a href="#0x2-NAT检测" class="headerlink" title="0x2 NAT检测"></a>0x2 NAT检测</h1><p>RFC3489中将NAT的实现分为四大类：<br>1.Full Cone NAT （完全锥形NAT）<br>2.Restricted Cone NAT （限制锥形NAT ，可以理解为IP限制，Port不限制）<br>3.Port Restricted Cone NAT （端口限制锥形NAT，IP+Port 限制）<br>4.Symmetric NAT （对称NAT）<br>其中完全最上层的完全锥形NAT的穿透性最好，而最下层的对称形NAT需要借助TURN服务器进行数据转发，两个client之间不能进行Peer to Peer的通信。</p>
<p>NAT类型检测过程如下<br><img src="https://upload.wikimedia.org/wikipedia/commons/6/63/STUN_Algorithm3.svg" alt="nat_check"></p>
<p>如上图所示，一旦路经到达红色节点时，Peer to Peer的连接是没有可能性的，需要借助服务器进行转发。一旦通过黄色或是绿色的节点，Peer to Peer的连接是可以成功的。</p>
<p>下面介绍STUN是如何判断NAT的类型的。<br>内容来自<a href="https://www.jianshu.com/p/84e8c78ca61d" target="_blank" rel="external">ICE协议下NAT穿越的实现</a></p>
<p>假设B是客户端，C是STUN服务器，C有两个IP分别为IP1和IP2（至于为什么要两个IP，接着往下看）：</p>
<p>STEP1.判断客户端是否在NAT后：</p>
<p>B向C的IP1的pot1端口发送一个UDP包。C收到这个包后，会把它收到包的源IP和port写到UDP包中，然后把此包通过IP1和port1发还给B。这个IP和port也就是NAT的外网 IP和port（如果你不理解，那么请你去看我的BLOG里面的NAT的原理和分类），也就是说你在STEP1中就得到了NAT的外网IP。</p>
<p>熟悉NAT工作原理的朋友可以知道，C返回给B的这个UDP包B一定收到。如果在你的应用中，向一个STUN服务器发送数据包后，你没有收到STUN的任何回应包，那只有两种可能：1、STUN服务器不存在，或者你弄错了port。2、你的NAT拒绝一切UDP包从外部向内部通过。</p>
<p>当B收到此UDP后，把此UDP中的IP和自己的IP做比较，如果是一样的，就说明自己是在公网，下步NAT将去探测防火墙类型，我不想多说。如果不一样，说明有NAT的存在，系统进行STEP2的操作。</p>
<p>STEP2.判断是否处于Full Cone Nat下：</p>
<p>B向C的IP1发送一个UDP包，请求C通过另外一个IP2和PORT（不同与SETP1的IP1）向B返回一个UDP数据包（现在知道为什么C要有两个IP了吧，虽然还不理解为什么，呵呵）。</p>
<p>我们来分析一下，如果B收到了这个数据包，那说明什么？说明NAT来着不拒，不对数据包进行任何过滤，这也就是STUN标准中的full cone NAT。遗憾的是，Full Cone Nat太少了，这也意味着你能收到这个数据包的可能性不大。如果没收到，那么系统进行STEP3的操作。</p>
<p>STEP3.判断是否处于对称NAT下：</p>
<p>B向C的IP2的port2发送一个数据包，C收到数据包后，把它收到包的源IP和port写到UDP包中，然后通过自己的IP2和port2把此包发还给B。</p>
<p>和step1一样，B肯定能收到这个回应UDP包。此包中的port是我们最关心的数据，下面我们来分析：</p>
<p>如果这个port和step1中的port一样，那么可以肯定这个NAT是个CONE NAT，否则是对称NAT。道理很简单：根据对称NAT的规则，当目的地址的IP和port有任何一个改变，那么NAT都会重新分配一个port使用，而在step3中，和step1对应，我们改变了IP和port。因此，如果是对称NAT,那这两个port肯定是不同的。</p>
<p>如果在你的应用中，到此步的时候PORT是不同的，那么这个它就是处在一个对称NAT下了。如果相同，那么只剩下了restrict cone 和port restrict cone。系统用step4探测是是那一种。</p>
<p>STEP4.判断是处于Restrict Cone NAT还是Port Restrict NAT之下：</p>
<p>B向C的IP2的一个端口PD发送一个数据请求包，要求C用IP2和不同于PD的port返回一个数据包给B。</p>
<p>我们来分析结果：如果B收到了，那也就意味着只要IP相同，即使port不同，NAT也允许UDP包通过。显然这是Restrict Cone NAT。如果没收到，没别的好说，Port Restrict NAT.</p>
<h1 id="0x3-StunServer实现分析"><a href="#0x3-StunServer实现分析" class="headerlink" title="0x3 StunServer实现分析"></a>0x3 StunServer实现分析</h1><p>STUN协议是一个客户机/服务器协议。StunServer可能和其他服务器(如web server, turn server）集成在一起。而stun client也可以在p2p的客户端中实现。<br>在核心的STUN协议中，只有一种称为“Binding”的方法。STUN客户端使用Binding来创建和发现NAT映射。当STUN服务器收到STUN Binding时，它会记录请求来着哪个公网IP和端口，此公网IP和端口会发生给STUN客户端，这样收到STUN Binding响应的客户端会根据这些信息判断NAT的类型。<br><img src="/2018/06/27/STUN-in-P2P-network/stun.png" alt="stun"></p>
<h1 id="0x4-StunServer测试"><a href="#0x4-StunServer测试" class="headerlink" title="0x4 StunServer测试"></a>0x4 StunServer测试</h1><p>测试结果如下，<br>kevin@ubuntu:~/Kevin/nat/stunserver$ ./stunclient 68.xxx.xxx.xxx 3478<br>Binding test: success<br>Local address: 192.168.40.200:47045<br>Mapped address: 116.xxx.xxx.xxx:56077</p>
<p>其中68.xxx.xxx.xxx是运行StunServer服务器的公网IP地址。<br>返回给Stun客户端的信息中包括了Stun客户端的公网IP为116.xxx.xxx.xxx，和内网地址(192.168.40.200)不一致，说明位于NAT之后。至于是哪种NAT类型，需要参考前面的流程进行多次测试。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/" itemprop="url">Design p2p streaming capturer based on flv</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-22T09:36:10+09:00">
                2018-04-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/" class="leancloud_visitors" data-flag-title="Design p2p streaming capturer based on flv">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Introduction"><a href="#0x1-Introduction" class="headerlink" title="0x1     Introduction"></a>0x1     Introduction</h1><p>streaming capturer用于接收client端发送过来的媒体数据，client端类似于目前市面上的直播客户端，通过RTMP/RTSP协议把数据发送给streaming capturer。streaming capturer对接收到的数据进行解包，如果需要可以进行transcoding，然后把数据发送给后续的模块进行处理，这些模块可以把数据发送给其他服务器提供流媒体服务。下面介绍的p2p streaming capturer是把接收到和转码后的数据打包成P2P协议包，这些P2P协议包被发送给种子节点p2p seed node，p2p seed node提供p2p streaming的种子节点功能。播放器先连接到这个p2p seed node，获取播放所需要的媒体数据，而且后面进来的播放器可以从前面的播放器中得到部分播放数据，不需要都从p2p seed node处获取数据，从而显著地降低流媒体服务器的带宽负担。<br>Adobe FLV格式是一种流媒体格式，p2p streaming capturer接收到client发送过来的数据流以后，打包成FLV格式, 然后在FLV的基础上打包成P2P数据包的格式。</p>
<p>下面是系统架构图。<br><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/architecture.png" alt="architecture"></p>
<h1 id="0x2-flv数据格式"><a href="#0x2-flv数据格式" class="headerlink" title="0x2   flv数据格式"></a>0x2   flv数据格式</h1><p>下面简单介绍一下FLV数据格式。<br>如下所示，首先是9个byte的flv header。</p>
<h2 id="0x21-The-flv-header"><a href="#0x21-The-flv-header" class="headerlink" title="0x21  The flv header"></a>0x21  The flv header</h2><p><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/flv_header.png" alt="flv_header"></p>
<p>在flv header之后，是Tag和Size交织组成的数据部分。</p>
<h2 id="0x22-The-flv-file-body"><a href="#0x22-The-flv-file-body" class="headerlink" title="0x22  The flv file body"></a>0x22  The flv file body</h2><p><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/flv_file_body.png" alt="flv_file_body"></p>
<h2 id="0x23-flv-tag"><a href="#0x23-flv-tag" class="headerlink" title="0x23  flv tag"></a>0x23  flv tag</h2><p>下面是flv tag数据部分。<br><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/flv_tag.png" alt="flv_tag"></p>
<h1 id="0x3-基于flv的p2p-streaming-capturer的设计"><a href="#0x3-基于flv的p2p-streaming-capturer的设计" class="headerlink" title="0x3  基于flv的p2p streaming capturer的设计"></a>0x3  基于flv的p2p streaming capturer的设计</h1><p>流程图如下，</p>
<p><img src="/2018/04/22/Design-p2p-streaming-capturer-based-on-flv/sequence.png" alt="sequence"></p>
<p>左边是p2p streaming capturer, 它与p2p seed node进行交互，p2p streaming capturer接收client发送的RTMP/RTSP数据包，经过解包/转码以后生成FLV数据，这个时候需要把FLV header和类似SPS/PPS之类的媒体类型信息保存起来，p2p streaming capturer还需要实现内部缓存buffer, 把打包好的FLV数据缓存起来，为了后面打包成P2P数据包发送给p2p seed node。<br>p2p streaming capturer连接上p2p seed node以后，先发送注册(Register)信息，然后发送媒体类型(MediaType)信息，MediaType包括SPS/PPS等信息，然后开始把前面缓存起来的数据按固定大小(16384)打包成P2P格式，然后发送给p2p seed node.<br>p2p seed node在p2p streaming capturer连接上来以后，需要把相关信息发送给tracker server，这样相当于tracker server增加了一个节目源。<br>播放器player可以连接到p2p seed node来得到播放数据。对于直播来说，由于player刚连接到p2p seed node的时候获取的数据可能并不是关键帧，这个时候不能立即播放，需要等待下一个关键帧的到来。为了减少播放等待时候，可以在p2p seed node上实现gop cache的功能，把最近一个关键帧开始的数据都保存到gop cache中，等播放器连接上来的时候，把gop cache中的数据发送给播放器，这样播放器就不需要等待。当有新的关键帧到来的时候，需要把gop cache中的数据清空，然后保存当前关键帧开始的数据。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/Implement-yuv2rgb-gpu-filter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/Implement-yuv2rgb-gpu-filter/" itemprop="url">Implement yuv2rgb gpu filter</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-15T21:02:13+09:00">
                2018-04-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/04/15/Implement-yuv2rgb-gpu-filter/" class="leancloud_visitors" data-flag-title="Implement yuv2rgb gpu filter">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Introduction"><a href="#0x1-Introduction" class="headerlink" title="0x1     Introduction"></a>0x1     Introduction</h1><p>本文我们将在GPU上实现yuv420p到rgb的转换，转换代码采用opengl es glsl实现。该转换代码在GPU上运行，为了更好地展示这个实现过程和体现转换效果，我们在Android平台上实现一个app应用。<br>详细代码请参考 <a href="https://github.com/wenxiaoming/YUVRender" target="_blank" rel="external">YUVRender</a></p>
<p>YUV2RGB转换的算法原理如下，其中Y/U/V是从yuv420p数据中读取的三个分量。<br>    B=1.164(Y−16)+2.018(U−128)<br>    G=1.164(Y−16)−0.813(V−128)−0.391(U−128)<br>    R=1.164(Y−16)+1.596(V−128)</p>
<h1 id="0x2-Shader代码"><a href="#0x2-Shader代码" class="headerlink" title="0x2     Shader代码"></a>0x2     Shader代码</h1><h2 id="0x21-vertex-shader代码"><a href="#0x21-vertex-shader代码" class="headerlink" title="0x21 vertex shader代码"></a>0x21 vertex shader代码</h2><p>vertex shader代码首先输入顶点坐标和纹理坐标。<br>输出变量gl_Position用于在计算顶点位置以后将其写入裁剪坐标。<br>输出变量vtexcoord是输入给fragment shader作为纹理坐标的。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">precision mediump <span class="keyword">float</span>;</div><div class="line">varying   mediump vec2 vtexcoord;</div><div class="line">attribute mediump vec4 position;</div><div class="line">attribute mediump vec2 texcoord;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">	gl_Position  = position;</div><div class="line">	vtexcoord = texcoord;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x22-fragment-shader代码"><a href="#0x22-fragment-shader代码" class="headerlink" title="0x22 fragment shader代码"></a>0x22 fragment shader代码</h2><p>fragment shader代码首先输入texture坐标, 该坐标首先经过了vertex shader处理，<br>然后又经过了Primitive Assembly阶段的clip和插值处理。<br>然后输入三个sampler2D，这三个sampler2D分别对应yuv420p的Y/U/V数据，通过texture2D这个内置的纹理访问函数，我们可以读取对应纹理坐标下的Y/U/V数据。<br>接下面的代码就是执行YUV到RGB的转换矩阵了，具体的矩阵可以参考前面的介绍。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">precision mediump <span class="keyword">float</span>;</div><div class="line">varying   mediump vec2 vtexcoord;</div><div class="line">uniform   lowp  sampler2D samplerY;</div><div class="line">uniform   lowp  sampler2D samplerU;</div><div class="line">uniform   lowp  sampler2D samplerV;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    mediump <span class="keyword">float</span> y;</div><div class="line">    mediump <span class="keyword">float</span> u;</div><div class="line">    mediump <span class="keyword">float</span> v;</div><div class="line">    lowp  vec3 rgb;</div><div class="line">    mat3 convmatrix = mat3(vec3(<span class="number">1.164</span>,  <span class="number">1.164</span>, <span class="number">1.164</span>),</div><div class="line">                           vec3(<span class="number">0.0</span>,   <span class="number">-0.392</span>, <span class="number">2.017</span>),</div><div class="line">                           vec3(<span class="number">1.596</span>, <span class="number">-0.813</span>, <span class="number">0.0</span>));</div><div class="line"></div><div class="line">    y = (texture2D(samplerY, vtexcoord).r - (<span class="number">16.0</span> / <span class="number">255.0</span>));</div><div class="line">    u = (texture2D(samplerU, vtexcoord).r - (<span class="number">128.0</span> / <span class="number">255.0</span>));</div><div class="line">    v = (texture2D(samplerV, vtexcoord).r - (<span class="number">128.0</span> / <span class="number">255.0</span>));</div><div class="line"></div><div class="line">    rgb = convmatrix * vec3(y, u, v);</div><div class="line">    gl_FragColor = vec4(rgb, <span class="number">1.0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="0x3-具体实现"><a href="#0x3-具体实现" class="headerlink" title="0x3     具体实现"></a>0x3     具体实现</h1><h2 id="0x31-texture的创建"><a href="#0x31-texture的创建" class="headerlink" title="0x31 texture的创建"></a>0x31 texture的创建</h2><p>为了让GPU能读取到YUV的数据，需要创建3个texture, 这三个texture分别存放Y/U/V分量。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">GLES20.glGenTextures(<span class="number">3</span>, mTexture, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</div><div class="line">&#123;</div><div class="line">    GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + i);</div><div class="line">    GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, mTexture[i]);</div><div class="line">    GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR);</div><div class="line">    GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_LINEAR);</div><div class="line">    GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_CLAMP_TO_EDGE);</div><div class="line">    GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_CLAMP_TO_EDGE);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x32-yuv420p数据的读取"><a href="#0x32-yuv420p数据的读取" class="headerlink" title="0x32 yuv420p数据的读取"></a>0x32 yuv420p数据的读取</h2><p>我们读取的yuv420p数据是foreman.qcif，分辨率是qcif(176x144), 从数据布局来看，首先是176x144大小的Y分量，然后是88x72大小的U分量, 最后是88x72大小的V分量。下面是读取YUV数据的详细代码。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getYuvData</span><span class="params">(String fileName)</span></span></div><div class="line">&#123;</div><div class="line">    String res=<span class="string">""</span>;</div><div class="line">    <span class="keyword">try</span>&#123;</div><div class="line">        InputStream in = getResources().getAssets().open(fileName);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> length = in.available();</div><div class="line">        byte [] buffer = <span class="keyword">new</span> byte[length];</div><div class="line"></div><div class="line">        ByteBuffer byteBuffer = ByteBuffer.allocateDirect(length);</div><div class="line">        mYuvBuffer = byteBuffer;</div><div class="line"></div><div class="line">        in.read(buffer);</div><div class="line">        in.close();</div><div class="line"></div><div class="line">        mYuvBuffer.put(buffer);</div><div class="line">        mYuvBuffer.position(<span class="number">0</span>);</div><div class="line"></div><div class="line">        mBufferU = ByteBuffer.allocateDirect(<span class="number">88</span>*<span class="number">72</span>);</div><div class="line">        mBufferV = ByteBuffer.allocateDirect(<span class="number">88</span>*<span class="number">72</span>);</div><div class="line"></div><div class="line">        mBufferU.put(buffer,<span class="number">176</span>*<span class="number">144</span>,<span class="number">88</span>*<span class="number">72</span>);</div><div class="line">        mBufferU.position(<span class="number">0</span>);</div><div class="line"></div><div class="line">        mBufferV.put(buffer,<span class="number">176</span>*<span class="number">144</span>+<span class="number">88</span>*<span class="number">72</span>,<span class="number">88</span>*<span class="number">72</span>);</div><div class="line">        mBufferV.position(<span class="number">0</span>);</div><div class="line">    &#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x33-texture的更新"><a href="#0x33-texture的更新" class="headerlink" title="0x33 texture的更新"></a>0x33 texture的更新</h2><p>YUV数据保持在pixels数组中，通过调用glTexImage2D把YUV数据输入到GPU driver中。<br>因为需要给YUV的三个texture分别输入，所以需要循环3次。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span>[] planes    = &#123; <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span> &#125;;</div><div class="line"><span class="keyword">int</span>[] widths    = &#123; width, width/<span class="number">2</span>, width/<span class="number">2</span> &#125;;</div><div class="line"><span class="keyword">int</span>[] heights  = &#123; height, height/<span class="number">2</span>, height/<span class="number">2</span> &#125;;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> plane = planes[i];</div><div class="line">    GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + i);</div><div class="line"></div><div class="line">    GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, mTexture[i]);</div><div class="line">    ShaderManager.checkGlError(<span class="string">"glBindTexture"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(pixels[plane] == null)</div><div class="line">        Log.e(<span class="string">"YUV2RGBFilter"</span>, <span class="string">"pixels[plane] == null"</span>);</div><div class="line"></div><div class="line">    GLES20.glTexImage2D(</div><div class="line">            GLES20.GL_TEXTURE_2D,</div><div class="line">            <span class="number">0</span>,</div><div class="line">            GLES20.GL_LUMINANCE,</div><div class="line">            widths[plane],</div><div class="line">            heights[plane],</div><div class="line">            <span class="number">0</span>,</div><div class="line">            GLES20.GL_LUMINANCE,</div><div class="line">            GLES20.GL_UNSIGNED_BYTE,</div><div class="line">            pixels[plane]);</div><div class="line"></div><div class="line">    ShaderManager.checkGlError(<span class="string">"glTexImage2D"</span>);</div><div class="line"></div><div class="line">    GLES20.glUniform1i(mTextureHandle[i], i);</div><div class="line"></div><div class="line">    ShaderManager.checkGlError(<span class="string">"glUniform1i"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x34-更新其他参数"><a href="#0x34-更新其他参数" class="headerlink" title="0x34 更新其他参数"></a>0x34 更新其他参数</h2><p>下面的代码是把顶点坐标和纹理坐标输入给GPU driver。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">GLES20.glVertexAttribPointer(mPositionHandle, <span class="number">3</span>, GLES20.GL_FLOAT,</div><div class="line">        <span class="literal">false</span>, <span class="number">0</span>, mVertexBuffer);</div><div class="line">ShaderManager.checkGlError(<span class="string">"glVertexAttribPointer"</span>);</div><div class="line"></div><div class="line">GLES20.glEnableVertexAttribArray(mPositionHandle);</div><div class="line"></div><div class="line">ShaderManager.checkGlError(<span class="string">"glEnableVertexAttribArray"</span>);</div><div class="line"></div><div class="line">GLES20.glVertexAttribPointer(mTexCoordHandle, <span class="number">2</span>, GLES20.GL_FLOAT,</div><div class="line">        <span class="literal">false</span>, <span class="number">0</span>, mTexCoorBuffer);</div><div class="line">ShaderManager.checkGlError(<span class="string">"glVertexAttribPointer"</span>);</div><div class="line"></div><div class="line">GLES20.glEnableVertexAttribArray(mTexCoordHandle);</div></pre></td></tr></table></figure></p>
<h1 id="0x4-调试中碰到的问题"><a href="#0x4-调试中碰到的问题" class="headerlink" title="0x4 调试中碰到的问题"></a>0x4 调试中碰到的问题</h1><p>代码写好以后，一运行，不能出来正确的图像，一直是绿屏。下面介绍一下解决绿屏的过程。<br>首先检查api调用是否正确，通过启用swiftshader，我们可以打印出所有的opengl es api调用log, 检查该app调用的opengl es api，没有发现问题。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.439</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: ClearColor external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">710</span> ((GLclampf red = <span class="number">1.000000</span>, GLclampf green = <span class="number">0.000000</span>, GLclampf blue = <span class="number">1.000000</span>, GLclampf alpha = <span class="number">1.000000</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.439</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Clear external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">692</span> ((GLbitfield mask = <span class="number">4100</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.451</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: UseProgram external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">5925</span> ((GLuint program = <span class="number">3</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.451</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: BindTexture external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">354</span> ((GLenum target = <span class="number">0xDE1</span>, GLuint texture = <span class="number">1</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Uniform1iv external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">5545</span> ((GLint location = <span class="number">0</span>, GLsizei count = <span class="number">1</span>, <span class="keyword">const</span> GLint* v = <span class="number">0x7b00d3a1621c</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: BindTexture external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">354</span> ((GLenum target = <span class="number">0xDE1</span>, GLuint texture = <span class="number">2</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Uniform1iv external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">5545</span> ((GLint location = <span class="number">1</span>, GLsizei count = <span class="number">1</span>, <span class="keyword">const</span> GLint* v = <span class="number">0x7b00d3a1621c</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: BindTexture external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">354</span> ((GLenum target = <span class="number">0xDE1</span>, GLuint texture = <span class="number">3</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Uniform1iv external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">5545</span> ((GLint location = <span class="number">2</span>, GLsizei count = <span class="number">1</span>, <span class="keyword">const</span> GLint* v = <span class="number">0x7b00d3a1621c</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: VertexAttribPointer external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">6127</span> ((GLuint index = <span class="number">0</span>, GLint size = <span class="number">3</span>, GLenum type = <span class="number">0x1406</span>, GLboolean normalized = <span class="number">0</span>, GLsizei stride = <span class="number">0</span>, <span class="keyword">const</span> GLvoid* ptr = <span class="number">0x740e1d10</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">3300</span>  <span class="number">3300</span> E libGLESv2_swiftshader: BindTexture external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">354</span> ((GLenum target = <span class="number">0x8D65</span>, GLuint texture = <span class="number">4</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">3300</span>  <span class="number">3300</span> E libGLESv2_swiftshader: EGLImageTargetTexture2DOES external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">6659</span> ((GLenum target = <span class="number">0x8D65</span>, GLeglImageOES image = <span class="number">0x8</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: EnableVertexAttribArray external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1865</span> ((GLuint index = <span class="number">0</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.452</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: VertexAttribPointer external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">6127</span> ((GLuint index = <span class="number">1</span>, GLint size = <span class="number">2</span>, GLenum type = <span class="number">0x1406</span>, GLboolean normalized = <span class="number">0</span>, GLsizei stride = <span class="number">0</span>, <span class="keyword">const</span> GLvoid* ptr = <span class="number">0x740e0b80</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.453</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: EnableVertexAttribArray external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1865</span> ((GLuint index = <span class="number">1</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.453</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: DrawArrays external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1537</span> ((GLenum mode = <span class="number">0x5</span>, GLint first = <span class="number">0</span>, GLsizei count = <span class="number">4</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.453</span>  <span class="number">3300</span>  <span class="number">3300</span> E libGLESv2_swiftshader: Disable external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1493</span> ((GLenum cap = <span class="number">0xC11</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.454</span>  <span class="number">3300</span>  <span class="number">3300</span> E libGLESv2_swiftshader: Viewport external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">6189</span> ((GLint x = <span class="number">0</span>, GLint y = <span class="number">0</span>, GLsizei width = <span class="number">1080</span>, GLsizei height = <span class="number">1920</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.468</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: Finish external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1922</span> (())</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.728</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: DisableVertexAttribArray external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1520</span> ((GLuint index = <span class="number">0</span>))</div><div class="line"><span class="number">01</span><span class="number">-01</span> <span class="number">04</span>:<span class="number">50</span>:<span class="number">52.729</span>  <span class="number">8547</span>  <span class="number">8615</span> E libGLESv2_swiftshader: DisableVertexAttribArray external/swiftshader/src/OpenGL/libGLESv2/libGLESv2.cpp:<span class="number">1520</span> ((GLuint index = <span class="number">1</span>))</div></pre></td></tr></table></figure></p>
<p>再怀疑是因为texture没有被正确地送入到GPU中，通过dump glTexImage2D()输入的pixel，发现也是正确的。</p>
<p>最后在fragment shader中写hard code, 强制输出某种颜色，也是正确的，说明整个流程没有问题。</p>
<p>最后怀疑是texture的坐标没有正确地设置，在打印glVertexAttribPointer()的输入参数，发现这个时候的texture坐标都是0，明显不是正确的值，一步一步往上debug， 发现是因为Java ByteBuffer的order没有被设置成本机字节顺序(ByteOrder.nativeOrder()), 设置了以后，texture的坐标就正确了。</p>
<p>解决了绿屏的问题以后，yuv420p的数据能在Android上正确显示了，显示效果如下<br><img src="/2018/04/15/Implement-yuv2rgb-gpu-filter/screencap.jpg" alt="result"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/08/How-swiftshader-supports-texture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/08/How-swiftshader-supports-texture/" itemprop="url">How swiftshader supports texture</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-08T12:59:57+09:00">
                2018-04-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/04/08/How-swiftshader-supports-texture/" class="leancloud_visitors" data-flag-title="How swiftshader supports texture">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Introduction"><a href="#0x1-Introduction" class="headerlink" title="0x1     Introduction"></a>0x1     Introduction</h1><p>Here is the OpenGL ES pipeline, the pink color box represents the data buffer in the pipeline, the gray blue box represents the operation in the pipeline.</p>
<p>In the following of this article, I will show you how texture is used in the OpenGL ES pipeline. In order to explains it more clearly, I will dig into the texture support in Swiftshader, since Swiftshader is the software implementation of OpenGL ES pipeline, we can see the detail implementation of it.</p>
<p><img src="/2018/04/08/How-swiftshader-supports-texture/pipeline.png" alt="pipeline"></p>
<h1 id="0x2-Application-code"><a href="#0x2-Application-code" class="headerlink" title="0x2    Application code."></a>0x2    Application code.</h1><p>Here is the code for texture generation.<br>It generates and binds texture, and sets the parameter for it.<br>GL_TEXTURE_MAG_FILTER and GL_TEXTURE_MIN_FILTER is used to set up the filtering mode for mipmaps. GL_TEXTURE_WRAP_S and GL_TEXTURE_WRAP_T is used to set up texture wrap modes when texture coordinate is outside the range[0.0, 1.0].</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">glGenTextures(<span class="number">1</span>, mTexture, <span class="number">0</span>);</div><div class="line">glActiveTexture(GL_TEXTURE0);</div><div class="line">glBindTexture(GL_TEXTURE_2D, mTexture);</div><div class="line">glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</div><div class="line">glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</div><div class="line">glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);</div><div class="line">glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);</div></pre></td></tr></table></figure>
<p>Here is the code for texture upload.<br>The texture’s content is passed by parameter pixel, the GPU driver will copy pixel into its managed internal buffer, If the GPU hardware supports tile rendering, typically there is a conversion from linear buffer to tile buffer at the same time.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">glBindTexture(GL_TEXTURE_2D, mTexture);</div><div class="line">glTexImage2D(GL_TEXTURE_2D,</div><div class="line">            <span class="number">0</span>,</div><div class="line">            GL_LUMINANCE,</div><div class="line">            width,</div><div class="line">            height,</div><div class="line">            <span class="number">0</span>,</div><div class="line">            GL_LUMINANCE,</div><div class="line">            GL_UNSIGNED_BYTE,</div><div class="line">            pixel);</div><div class="line"></div><div class="line">glUniform1i(mTextureHandle, i);</div></pre></td></tr></table></figure></p>
<h1 id="0x3-Texture-in-Shader-code"><a href="#0x3-Texture-in-Shader-code" class="headerlink" title="0x3    Texture in Shader code."></a>0x3    Texture in Shader code.</h1><p>Here is one example of glsl shader code.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">static const char simplevs[] =</div><div class="line">    attribute vec4 position;</div><div class="line">    attribute vec2 texCoords;</div><div class="line">    varying vec2 outTexCoords;</div><div class="line">    void main(void) &#123;</div><div class="line">        outTexCoords = texCoords;</div><div class="line">        gl_Position = position;</div><div class="line">    &#125;";</div><div class="line">static const char simplefs[] =</div><div class="line">    precision mediump float;</div><div class="line">    varying vec2 outTexCoords;</div><div class="line">    uniform sampler2D texture;</div><div class="line">    void main(void) &#123;</div><div class="line">        gl_FragColor = texture2D(texture, outTexCoords);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>In the vertex shader code, the texture’s coordinate is input by attribute texCoords, then it is output in vertex shader as outTexCoords,<br>Then in primitive assembly and rasterization stage, it is clipped and interpolated.<br>Then in fragment shader code, the clipped and interpolated texture coordinate is used to fetching specific position’s pixel from the texture.<br>Here is the diagram to explain the execution sequence.<br><img src="/2018/04/08/How-swiftshader-supports-texture/sequence.png" alt="sequence"></p>
<h1 id="0x4-Texture-support-in-swiftshader"><a href="#0x4-Texture-support-in-swiftshader" class="headerlink" title="0x4    Texture support in swiftshader"></a>0x4    Texture support in swiftshader</h1><p>Let’s to see how texture is supported in swiftshader, Here is the draft diagram in swiftshader about texture support.</p>
<p><img src="/2018/04/08/How-swiftshader-supports-texture/texture_in_swiftshader.png" alt="texture_in_swiftshader"></p>
<h2 id="0x41-Set-texture-for-pipeline-in-glDrawXX"><a href="#0x41-Set-texture-for-pipeline-in-glDrawXX" class="headerlink" title="0x41 Set texture for pipeline in glDrawXX()"></a>0x41 Set texture for pipeline in glDrawXX()</h2><p>At this time, texture is uploaded through glTexImage2D(), glDrawXX() is triggered. applyTexture() is used to setup texture for current draw context.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Context::applyTexture(sw::SamplerType type, <span class="keyword">int</span> index, Texture *baseTexture)</div><div class="line">&#123;</div><div class="line">        ……</div><div class="line">		<span class="keyword">switch</span>(baseTexture-&gt;getTarget())</div><div class="line">		&#123;</div><div class="line">		<span class="keyword">case</span> GL_TEXTURE_2D:</div><div class="line">		&#123;</div><div class="line">			Texture2D *texture = <span class="keyword">static_cast</span>&lt;Texture2D*&gt;(baseTexture);</div><div class="line"></div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> mipmapLevel = <span class="number">0</span>; mipmapLevel &lt; sw::MIPMAP_LEVELS; mipmapLevel++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">int</span> surfaceLevel = mipmapLevel + baseLevel;</div><div class="line"></div><div class="line">				<span class="keyword">if</span>(surfaceLevel &gt; maxLevel)</div><div class="line">				&#123;</div><div class="line">					surfaceLevel = maxLevel;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				egl::Image *surface = texture-&gt;getImage(surfaceLevel);</div><div class="line">				device-&gt;setTextureLevel(sampler, <span class="number">0</span>, mipmapLevel, surface, sw::TEXTURE_2D);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">        ……</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x42-Calculate-texture’s-coordinate-in-VertexProcessor"><a href="#0x42-Calculate-texture’s-coordinate-in-VertexProcessor" class="headerlink" title="0x42 Calculate texture’s coordinate in VertexProcessor."></a>0x42 Calculate texture’s coordinate in VertexProcessor.</h2><p>It generate LLVM IR for texture coordinate calculation in vertex shader code.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> VertexProgram::program(UInt&amp; index)</div><div class="line">&#123;</div><div class="line">    ……</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; shader-&gt;getLength(); i++)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">const</span> Shader::Instruction *instruction = shader-&gt;getInstruction(i);</div><div class="line">		Shader::Opcode opcode = instruction-&gt;opcode;</div><div class="line">        ……</div><div class="line">    &#125;</div><div class="line">    ……</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x43-Clip-and-interpolate-texture-coordinate-in-SetupProcessor"><a href="#0x43-Clip-and-interpolate-texture-coordinate-in-SetupProcessor" class="headerlink" title="0x43 Clip and interpolate texture coordinate in SetupProcessor()"></a>0x43 Clip and interpolate texture coordinate in SetupProcessor()</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> SetupRoutine::generate()</div><div class="line">&#123;</div><div class="line">    <span class="comment">// Culling</span></div><div class="line">	<span class="keyword">if</span>(solidTriangle)</div><div class="line">	&#123;</div><div class="line">        Float A = (y2 - y0) * x1 + (y1 - y2) * x0 + (y0 - y1) * x2; <span class="comment">// Area</span></div><div class="line"></div><div class="line">		If(A == <span class="number">0.0f</span>)</div><div class="line">		&#123;</div><div class="line">			Return(<span class="literal">false</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Int w0w1w2 = *Pointer&lt;Int&gt;(v0 + pos * <span class="number">16</span> + <span class="number">12</span>) ^</div><div class="line">				 *Pointer&lt;Int&gt;(v1 + pos * <span class="number">16</span> + <span class="number">12</span>) ^</div><div class="line">				 *Pointer&lt;Int&gt;(v2 + pos * <span class="number">16</span> + <span class="number">12</span>);</div><div class="line"></div><div class="line">		A = IfThenElse(w0w1w2 &lt; <span class="number">0</span>, -A, A);</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(state.cullMode == CULL_CLOCKWISE)</div><div class="line">		&#123;</div><div class="line">			If(A &gt;= <span class="number">0.0f</span>) Return(<span class="literal">false</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(state.cullMode == CULL_COUNTERCLOCKWISE)</div><div class="line">		&#123;</div><div class="line">			If(A &lt;= <span class="number">0.0f</span>) Return(<span class="literal">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    ……</div><div class="line">	Int n = *Pointer&lt;Int&gt;(polygon + OFFSET(Polygon,n));</div><div class="line">	Int m = *Pointer&lt;Int&gt;(polygon + OFFSET(Polygon,i));</div><div class="line"></div><div class="line">    If(m != <span class="number">0</span> || Bool(!solidTriangle))<span class="comment">// Clipped triangle</span></div><div class="line">	&#123;</div><div class="line">        ……</div><div class="line">        For(Int q = <span class="number">0</span>, q &lt; state.multiSample, q++)</div><div class="line">		&#123;</div><div class="line">            ……</div><div class="line">			Xq[n] = Xq[<span class="number">0</span>];</div><div class="line">			Yq[n] = Yq[<span class="number">0</span>];</div><div class="line"></div><div class="line">			<span class="comment">// Setup edge for Rasterize</span></div><div class="line">			&#123;</div><div class="line">				Int i = <span class="number">0</span>;</div><div class="line"></div><div class="line">                Do</div><div class="line">				&#123;</div><div class="line">					edge(primitive, data, Xq[i + <span class="number">1</span> - d], Yq[i + <span class="number">1</span> - d], Xq[i + d], Yq[i + d], q);</div><div class="line"></div><div class="line">					i++;</div><div class="line">				&#125;</div><div class="line">				Until(i &gt;= n)</div><div class="line">			&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">        </div><div class="line">    ……</div><div class="line">	<span class="keyword">if</span>(state.interpolateW)</div><div class="line">	&#123;</div><div class="line">        ……</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(state.interpolateZ)</div><div class="line">	&#123;</div><div class="line">        ……</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> interpolant = <span class="number">0</span>; interpolant &lt; MAX_FRAGMENT_INPUTS; interpolant++)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> component = <span class="number">0</span>; component &lt; <span class="number">4</span>; component++)</div><div class="line">		&#123;</div><div class="line">            <span class="keyword">int</span> attribute = state.gradient[interpolant][component].attribute;</div><div class="line">                </div><div class="line">			<span class="keyword">bool</span> flat = state.gradient[interpolant][component].flat;</div><div class="line">			<span class="keyword">bool</span> wrap = state.gradient[interpolant][component].wrap;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(attribute != Unused)</div><div class="line">			&#123;</div><div class="line">				setupGradient(primitive, tri, w012, M, v0, v1, v2, OFFSET(Vertex,v[attribute][component]), OFFSET(Primitive,V[interpolant][component]), flat, sprite, state.perspective, wrap, component);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x44-Pass-parameter-for-pixel-shader"><a href="#0x44-Pass-parameter-for-pixel-shader" class="headerlink" title="0x44 Pass parameter for pixel shader"></a>0x44 Pass parameter for pixel shader</h2><p> The parameter includes texture sampler and texture’s coordinate. These parameter is encapsulated in DrawData.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DrawData</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">const</span> Constants *constants;</div><div class="line">	<span class="keyword">const</span> <span class="keyword">void</span> *input[MAX_VERTEX_INPUTS];</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> stride[MAX_VERTEX_INPUTS];</div><div class="line">	Texture mipmap[TOTAL_IMAGE_UNITS];</div><div class="line">	<span class="keyword">const</span> <span class="keyword">void</span> *indices;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> Renderer::executeTask(<span class="keyword">int</span> threadIndex)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">switch</span>(task[threadIndex].type)</div><div class="line">	&#123;</div><div class="line">	    <span class="keyword">case</span> Task::PRIMITIVES:</div><div class="line">            ……</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> Task::PIXELS:</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">int</span> unit = task[threadIndex].primitiveUnit;</div><div class="line">				<span class="keyword">int</span> visible = primitiveProgress[unit].visible;</div><div class="line"></div><div class="line">				<span class="keyword">if</span>(visible &gt; <span class="number">0</span>)</div><div class="line">				&#123;</div><div class="line">					<span class="keyword">int</span> cluster = task[threadIndex].pixelCluster;</div><div class="line">					Primitive *primitive = primitiveBatch[unit];</div><div class="line">					DrawCall *draw = drawList[pixelProgress[cluster].drawCall &amp; DRAW_COUNT_BITS];</div><div class="line">					DrawData *data = draw-&gt;data;</div><div class="line">					PixelProcessor::RoutinePointer pixelRoutine = draw-&gt;pixelPointer;</div><div class="line"></div><div class="line">					pixelRoutine(primitive, visible, cluster, data);</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				finishRendering(task[threadIndex]);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">        ……</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">``` C++</div><div class="line"></div><div class="line">## <span class="number">0x45</span> Fetch pixel from texture</div><div class="line">PixelProgram fetch pixel from texture by passing the clipped <span class="keyword">and</span> interpolated texture coordinate. </div><div class="line">uvwq is the texture coordinate. the following code is executed in LLVM JIT.</div><div class="line"></div><div class="line">``` C++</div><div class="line">Vector4f PixelProgram::sampleTexture(<span class="keyword">int</span> samplerIndex, Vector4f &amp;uvwq, Float4 &amp;bias, Vector4f &amp;dsx, Vector4f &amp;dsy, Vector4f &amp;offset, SamplerFunction function)</div><div class="line">&#123;</div><div class="line">	</div><div class="line">	Pointer&lt;Byte&gt; texture = data + OFFSET(DrawData, mipmap) + samplerIndex * <span class="keyword">sizeof</span>(Texture);</div><div class="line">	Vector4f c = SamplerCore(constants, state.sampler[samplerIndex]).sampleTexture(texture, uvwq.x, uvwq.y, uvwq.z, uvwq.w, bias, dsx, dsy, offset, function);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> c;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Here is the detail texture sample algorithm, from the following code, we can see SwiftShader uses Bilinear interpolation to sample the texture.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">Vector4s SamplerCore::sampleQuad2D(Pointer&lt;Byte&gt; &amp;texture, Float4 &amp;u, Float4 &amp;v, Float4 &amp;w, Vector4f &amp;offset, Float &amp;lod, Int face[<span class="number">4</span>], <span class="keyword">bool</span> secondLOD, SamplerFunction function)</div><div class="line">&#123;</div><div class="line">	<span class="comment">// Bilinear interpolation</span></div><div class="line">	<span class="keyword">if</span>(componentCount &gt;= <span class="number">1</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span>(has16bitTextureComponents() &amp;&amp; hasUnsignedTextureComponent(<span class="number">0</span>))</div><div class="line">		&#123;</div><div class="line">			c0.x = As&lt;UShort4&gt;(c0.x) - MulHigh(As&lt;UShort4&gt;(c0.x), f0u) + MulHigh(As&lt;UShort4&gt;(c1.x), f0u);</div><div class="line">			c2.x = As&lt;UShort4&gt;(c2.x) - MulHigh(As&lt;UShort4&gt;(c2.x), f0u) + MulHigh(As&lt;UShort4&gt;(c3.x), f0u);</div><div class="line">			c.x  = As&lt;UShort4&gt;(c0.x) - MulHigh(As&lt;UShort4&gt;(c0.x), f0v) + MulHigh(As&lt;UShort4&gt;(c2.x), f0v);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span>(hasUnsignedTextureComponent(<span class="number">0</span>))</div><div class="line">			&#123;</div><div class="line">				c0.x = MulHigh(As&lt;UShort4&gt;(c0.x), f1u1v);</div><div class="line">				c1.x = MulHigh(As&lt;UShort4&gt;(c1.x), f0u1v);</div><div class="line">				c2.x = MulHigh(As&lt;UShort4&gt;(c2.x), f1u0v);</div><div class="line">				c3.x = MulHigh(As&lt;UShort4&gt;(c3.x), f0u0v);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				c0.x = MulHigh(c0.x, f1u1vs);</div><div class="line">				c1.x = MulHigh(c1.x, f0u1vs);</div><div class="line">				c2.x = MulHigh(c2.x, f1u0vs);</div><div class="line">				c3.x = MulHigh(c3.x, f0u0vs);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">            c.x = (c0.x + c1.x) + (c2.x + c3.x);</div><div class="line">			<span class="keyword">if</span>(!hasUnsignedTextureComponent(<span class="number">0</span>)) c.x = AddSat(c.x, c.x);<span class="comment">// Correct for signed fractions</span></div><div class="line">	    &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/01/learning-rate-in-neural-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/01/learning-rate-in-neural-network/" itemprop="url">learning rate in neural network</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-01T20:58:40+09:00">
                2018-04-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/04/01/learning-rate-in-neural-network/" class="leancloud_visitors" data-flag-title="learning rate in neural network">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-学习率简介"><a href="#0x1-学习率简介" class="headerlink" title="0x1 学习率简介"></a>0x1 学习率简介</h1><p>学习率是一个重要的超参数，在大多数神经网络优化算法（如SGD、Adam）中都会用到，它控制着我们基于损失梯度调整神经网络权值的速度。如果学习率过大，可能会错过最小值，并且可能造成不能收敛，损失在某一个值附近反复震荡。如果学习率过小，我们沿着损失梯度下降的速度就很慢，收敛的速度也很慢。</p>
<p>神经网络优化算法的功能是，控制方差，寻找最小值，更新模型参数，最终使模型收敛。<br>神经网络更新参数的公式为：θ=θ−η×∇(θ).J(θ)，其中η是学习率，∇(θ).J(θ)是损失函数J(θ)的梯度。</p>
<p>学习率是神经网络中难以设置的超参数之一，它对模型的性能有很大的影响。目前出现了很多自适应学习率算法，如下文测试中用到的Adam。在下面的测试中发现，虽然Adam会在优化的过程中动态调整学习率，初始的学习率设置还是会对模型的准确率有很大影响。</p>
<h1 id="0x2-构造计算图"><a href="#0x2-构造计算图" class="headerlink" title="0x2 构造计算图"></a>0x2 构造计算图</h1><p>用python编写tensorflow测试代码，构造如下图所示的卷积神经网络，用来对MNIST数据集进行0～9分类。</p>
<p>从下图神经网络图可知，首先载入MNIST数据，然后进行处理，包括卷积层layer1, 卷积层layer2, 接下来是一个全连接层fc_layer, 接下来是dropout层，最后连接上softmax层layer3, 得到概率输出。</p>
<p>优化算法采用Adam，在设置Adam优化器的时候设置需要初始学习率，其代码如下。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">train_step = tf.train.AdamOptimizer(learning_rate).minimize(cross_entropy)</div></pre></td></tr></table></figure></p>
<p>总体网络图如下<br><img src="/2018/04/01/learning-rate-in-neural-network/computation graph.png" alt="computation_graph"><br>layer1内部结构如下所示<br>首先初始化权重和偏置参数。然后使用conv2d进行卷积操作并加上偏置，卷积参数为[5, 5, 1, 32], 代表卷积核的大小为5x5, 1个颜色通道，32个不同的卷积核。然后使用relu激活函数进行非线性化处理。然后使用池化函数对卷积的结果进行1/2下采样处理，MNIST数据中图片大小为28x28，经过下采样以后变为14x14。<br><img src="/2018/04/01/learning-rate-in-neural-network/layer1.png" alt="layer1"><br>layer2内部结构如下所示<br>和layer1结构类似，只是卷积参数设置为[5, 5, 32, 64]，因为layer1中经过32个不同卷积核的处理，所以每个数据的通道变成了32，另外卷积核的数量变成64，经过池化函数以后，数据由14x14变成7x7。<br><img src="/2018/04/01/learning-rate-in-neural-network/layer2.png" alt="layer2"><br>后面再连接一个全连接层fc_layer，输出为1024个隐含节点，并使用relu激活函数。</p>
<p>下面是dropout层，使用keep_prob参数来控制以减轻过拟合。</p>
<p>接下来是layer3层，首先把1024个隐含节点通过矩阵变换转换成10个节点，矩阵变换的参数是权重参数和偏置参数，然后再连接softmax函数，得到对应数字0~9的概率输出。</p>
<p>优化器是Adam，该优化器对定义好的损失函数进行优化。</p>
<h1 id="0x3-高学习率的测试结果"><a href="#0x3-高学习率的测试结果" class="headerlink" title="0x3 高学习率的测试结果"></a>0x3 高学习率的测试结果</h1><p>这个时候初始学习率被设置为0.5，从训练集上的测试准确率上来看，准确率是很低的，在0.05～0.15之间来回震荡。<br><img src="/2018/04/01/learning-rate-in-neural-network/high_learning_rate.png" alt="high_learning_rate"></p>
<h1 id="0x4-低学习率的测试结果"><a href="#0x4-低学习率的测试结果" class="headerlink" title="0x4 低学习率的测试结果"></a>0x4 低学习率的测试结果</h1><p>这个时候初始学习率被设置为0.001，从训练集上的测试准确率上来看，准确率是慢慢升高的，最后稳定在0.95以上。<br><img src="/2018/04/01/learning-rate-in-neural-network/low_learning_rate.png" alt="low_learning_rate"></p>
<h1 id="0x5-Adam优化器"><a href="#0x5-Adam优化器" class="headerlink" title="0x5 Adam优化器"></a>0x5 Adam优化器</h1><p>通过gdb调试可知，tensorflow中Adam优化器调用堆栈如下。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">(gdb) bt</div><div class="line">#0  tensorflow::functor::ApplyAdamNonCuda&lt;Eigen::ThreadPoolDevice, float&gt;::operator()(Eigen::ThreadPoolDevice const&amp;, Eigen::TensorMap&lt;Eigen::Tensor&lt;float, 1, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::Tensor&lt;float, 1, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::Tensor&lt;float, 1, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::TensorFixedSize&lt;float const, Eigen::Sizes&lt;&gt;, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::TensorFixedSize&lt;float const, Eigen::Sizes&lt;&gt;, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::TensorFixedSize&lt;float const, Eigen::Sizes&lt;&gt;, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::TensorFixedSize&lt;float const, Eigen::Sizes&lt;&gt;, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::TensorFixedSize&lt;float const, Eigen::Sizes&lt;&gt;, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::TensorFixedSize&lt;float const, Eigen::Sizes&lt;&gt;, 1, long&gt;, 16, Eigen::MakePointer&gt;, Eigen::TensorMap&lt;Eigen::Tensor&lt;float const, 1, 1, long&gt;, 16, Eigen::MakePointer&gt;, bool) (this=0x7fffc58d8260, d=..., var=..., m=..., v=..., beta1_power=..., </div><div class="line">    beta2_power=..., lr=..., beta1=..., beta2=..., epsilon=..., grad=..., use_nesterov=false) at tensorflow/core/kernels/training_ops.cc:293</div><div class="line">#1  0x00007fffede52e6d in tensorflow::ApplyAdamOp&lt;Eigen::ThreadPoolDevice, float&gt;::Compute (this=0x555558f61cf0, ctx=0x7fffc58d8840)</div><div class="line">    at tensorflow/core/kernels/training_ops.cc:2523</div><div class="line">#2  0x00007fffe6a2e91b in tensorflow::ThreadPoolDevice::Compute (this=0x555557f25fa0, op_kernel=0x555558f61cf0, context=0x7fffc58d8840)</div><div class="line">    at tensorflow/core/common_runtime/threadpool_device.cc:59</div><div class="line">#3  0x00007fffe69c9c0a in tensorflow::(anonymous namespace)::ExecutorState::Process (this=0x55555945b6c0, tagged_node=..., scheduled_usec=0)</div><div class="line">    at tensorflow/core/common_runtime/executor.cc:1652</div><div class="line">#4  0x00007fffe69d81a7 in std::_Mem_fn_base&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long), true&gt;::operator()&lt;tensorflow::(anonymous namespace)::ExecutorState::TaggedNode&amp;, long long&amp;, void&gt; (</div><div class="line">    this=0x7fff8c04b440, __object=0x55555945b6c0) at /usr/include/c++/5/functional:600</div><div class="line">#5  0x00007fffe69d7c62 in std::_Bind&lt;std::_Mem_fn&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;(tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;::__call&lt;void, 0ul, 1ul, 2ul&gt;(&lt;unknown type in /home/kevin/anaconda3/lib/python3.6/site-packages/tensorflow/python/../libtensorflow_framework.so, CU 0x314f884, DIE 0x31e50c1&gt;, std::_Index_tuple&lt;0ul, 1ul, 2ul&gt;) (this=0x7fff8c04b440, </div><div class="line">    __args=&lt;unknown type in /home/kevin/anaconda3/lib/python3.6/site-packages/tensorflow/python/../libtensorflow_framework.so, CU 0x314f884, DIE 0x31e50c1&gt;) at /usr/include/c++/5/functional:1074</div><div class="line">#6  0x00007fffe69d5a06 in std::_Bind&lt;std::_Mem_fn&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;(tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;::operator()&lt;, void&gt;(void) (this=0x7fff8c04b440) at /usr/include/c++/5/functional:1133</div><div class="line">#7  0x00007fffe69d32ac in std::_Function_handler&lt;void(), std::_Bind&lt;std::_Mem_fn&lt;void (tensorflow::(anonymous namespace)::ExecutorState::*)(tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt;(tensorflow::(anonymous namespace)::ExecutorState*, tensorflow::(anonymous namespace)::ExecutorState::TaggedNode, long long int)&gt; &gt;::_M_invoke(const std::_Any_data &amp;) (__functor=...)</div><div class="line">    at /usr/include/c++/5/functional:1871</div><div class="line">#8  0x00007fffe6297984 in std::function&lt;void ()&gt;::operator()() const (this=0x7fff8c04a930) at /usr/include/c++/5/functional:2267</div><div class="line">#9  0x00007fffe64afb9e in tensorflow::thread::EigenEnvironment::ExecuteTask (this=0x555557f5ca48, t=...)</div><div class="line">    at tensorflow/core/lib/core/threadpool.cc:81</div><div class="line">#10 0x00007fffe64b265c in Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::WorkerLoop (this=0x555557f5ca40, </div><div class="line">    thread_id=1) at external/eigen_archive/unsupported/Eigen/CXX11/src/ThreadPool/NonBlockingThreadPool.h:232</div><div class="line">#11 0x00007fffe64b0aae in Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::NonBlockingThreadPoolTempl(int, bool, tensorflow::thread::EigenEnvironment)::&#123;lambda()#1&#125;::operator()() const ()</div><div class="line">    at external/eigen_archive/unsupported/Eigen/CXX11/src/ThreadPool/NonBlockingThreadPool.h:65</div><div class="line">#12 0x00007fffe64b3c7c in std::_Function_handler&lt;void (), Eigen::NonBlockingThreadPoolTempl&lt;tensorflow::thread::EigenEnvironment&gt;::NonBlockingThreadPoolTempl(int, bool, tensorflow::thread::EigenEnvironment)::&#123;lambda()#1&#125;&gt;::_M_invoke(std::_Any_data const&amp;) (__functor=...)</div><div class="line">    at /usr/include/c++/5/functional:1871</div><div class="line">#13 0x00007fffe6297984 in std::function&lt;void ()&gt;::operator()() const (this=0x555557f6d0b0) at /usr/include/c++/5/functional:2267</div><div class="line">#14 0x00007fffe64af907 in tensorflow::thread::EigenEnvironment::CreateThread(std::function&lt;void ()&gt;)::&#123;lambda()#1&#125;::operator()() const (</div><div class="line">    __closure=0x555557f6d0b0) at tensorflow/core/lib/core/threadpool.cc:56</div><div class="line">#15 0x00007fffe64b18d8 in std::_Function_handler&lt;void (), tensorflow::thread::EigenEnvironment::CreateThread(std::function&lt;void ()&gt;)::&#123;lambda()#1&#125;&gt;::_M_invoke(std::_Any_data const&amp;) (__functor=...) at /usr/include/c++/5/functional:1871</div><div class="line">#16 0x00007fffe6297984 in std::function&lt;void ()&gt;::operator()() const (this=0x555557f6d108) at /usr/include/c++/5/functional:2267</div><div class="line">#17 0x00007fffe64f4f38 in std::_Bind_simple&lt;std::function&lt;void ()&gt; ()&gt;::_M_invoke&lt;&gt;(std::_Index_tuple&lt;&gt;) (this=0x555557f6d108)</div><div class="line">    at /usr/include/c++/5/functional:1531</div><div class="line">#18 0x00007fffe64f4ea1 in std::_Bind_simple&lt;std::function&lt;void ()&gt; ()&gt;::operator()() (this=0x555557f6d108)</div><div class="line">    at /usr/include/c++/5/functional:1520</div><div class="line">#19 0x00007fffe64f4e40 in std::thread::_Impl&lt;std::_Bind_simple&lt;std::function&lt;void ()&gt; ()&gt; &gt;::_M_run() (this=0x555557f6d0f0)</div><div class="line">    at /usr/include/c++/5/thread:115</div><div class="line">#20 0x00007fffe5067c80 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6</div><div class="line">#21 0x00007ffff7bc16ba in start_thread (arg=0x7fffc58d9700) at pthread_create.c:333</div><div class="line">#22 0x00007ffff78f741d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109</div></pre></td></tr></table></figure></p>
<p>tensorflow中Adam优化器更新参数的代码如下。<br>tensorflow/core/kernels/training_ops.cc<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Device, <span class="keyword">typename</span> T&gt;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ApplyAdamNonCuda</span> &#123;</span></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">const</span> Device&amp; d, <span class="keyword">typename</span> TTypes&lt;T&gt;::Flat var,</span></span></div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::Flat m, <span class="keyword">typename</span> TTypes&lt;T&gt;::Flat v,</div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::ConstScalar beta1_power,</div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::ConstScalar beta2_power,</div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::ConstScalar lr,</div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::ConstScalar beta1,</div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::ConstScalar beta2,</div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::ConstScalar epsilon,</div><div class="line">                  <span class="keyword">typename</span> TTypes&lt;T&gt;::ConstFlat grad, <span class="keyword">bool</span> use_nesterov) &#123;</div><div class="line">    <span class="keyword">const</span> T alpha = lr() * Eigen::numext::<span class="built_in">sqrt</span>(T(<span class="number">1</span>) - beta2_power()) /</div><div class="line">                    (T(<span class="number">1</span>) - beta1_power());</div><div class="line">    <span class="comment">// beta1 == μ</span></div><div class="line">    <span class="comment">// beta2 == ν</span></div><div class="line">    <span class="comment">// v     == n</span></div><div class="line">    <span class="comment">// var   == θ</span></div><div class="line"></div><div class="line">    m.device(d) += (grad - m) * (T(<span class="number">1</span>) - beta1());</div><div class="line">    v.device(d) += (grad.square() - v) * (T(<span class="number">1</span>) - beta2());</div><div class="line">    <span class="keyword">if</span> (use_nesterov) &#123;</div><div class="line">      var.device(d) -= ((grad * (T(<span class="number">1</span>) - beta1()) + beta1() * m) * alpha) /</div><div class="line">                       (v.<span class="built_in">sqrt</span>() + epsilon());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      var.device(d) -= (m * alpha) / (v.<span class="built_in">sqrt</span>() + epsilon());</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>算法描述如下<br>如下所示，虽然在Adam算法中，学习率lr_t是动态调整的，但是也是和初始设置的学习率learning_rate有关，如果learning_rate设置不当，也会影响训练模型的收敛。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">t &lt;- t + 1</div><div class="line">lr_t &lt;- learning_rate * sqrt(1 - beta2^t) / (1 - beta1^t)//计算动态学习率</div><div class="line"></div><div class="line">m_t &lt;- beta1 * m_&#123;t-1&#125; + (1 - beta1) * g</div><div class="line">v_t &lt;- beta2 * v_&#123;t-1&#125; + (1 - beta2) * g * g</div><div class="line">variable &lt;- variable - lr_t * m_t / (sqrt(v_t) + epsilon)//更新参数</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/25/douyin-streaming-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/25/douyin-streaming-analysis/" itemprop="url">douyin streaming analysis</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-25T22:11:03+09:00">
                2018-03-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/03/25/douyin-streaming-analysis/" class="leancloud_visitors" data-flag-title="douyin streaming analysis">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-简介"><a href="#0x1-简介" class="headerlink" title="0x1    简介"></a>0x1    简介</h1><p>抖音是最近火热的短视频app, 本文通过抓包来分析douyin的在线视频播放过程。<br>通过分析，可以知道其播放流程如下，<br><img src="/2018/03/25/douyin-streaming-analysis/architecture.png" alt="architecture"><br>server是指保存用户上传内容(UGC)的服务器，客户端连接到该服务器下载需要播放的内容。</p>
<p>其它三个模块(downloader, local streamer, local player)都是在客户端实现的, 其中downloader负责把数据从远端server下载下来，并把下载下来的数据送给local streamer进行本地streaming, 然后local player连接到local streamer来得到需要播放的数据进行播放。通过下面的抓包分析可知，downloader是通过http协议来从远端server下载数据，local streamer也是通过提供本地http服务把播放数据提供给local player.</p>
<p>下面分析android平台上douyin下载数据并播放的过程。</p>
<h1 id="0x2-下载"><a href="#0x2-下载" class="headerlink" title="0x2  下载"></a>0x2  下载</h1><h2 id="0x21-dns查询服务器的ip地址"><a href="#0x21-dns查询服务器的ip地址" class="headerlink" title="0x21 dns查询服务器的ip地址"></a>0x21 dns查询服务器的ip地址</h2><p>通过dns查询v1-dy.ixiguavideo.com的ip地址，这一步是为后面的http连接服务的。<br>如下图所示，第49号包是发送dns查询请求，第56号包是返回dns查询结果。<br><img src="/2018/03/25/douyin-streaming-analysis/dns.png" alt="dns"></p>
<p>dns查询结果如下，可以看到对应服务器的ip地址, 其中返回好几个ip地址，下面的http连接采用的是第一个ip地址。<br><img src="/2018/03/25/douyin-streaming-analysis/dns_result.png" alt="dns_result"></p>
<h2 id="0x22-http连接到服务器并下载数据"><a href="#0x22-http连接到服务器并下载数据" class="headerlink" title="0x22 http连接到服务器并下载数据"></a>0x22 http连接到服务器并下载数据</h2><p>如下所示，通过http连接到服务器。<br>可以看到http url如下, 这个地址是经过加密的，直接在浏览器中去访问是连接不上去的。<br><a href="http://v1-dy.ixiguavideo.com/9980b014844ac5185d899a1af1e41554/5acf7425/video/m/220fea4bc73a1c54023a9819c71b52a9b3e115640520000a8c154141acc/?device_platform=android&amp;device_type=myandroid&amp;version_code=179" target="_blank" rel="external">http://v1-dy.ixiguavideo.com/9980b014844ac5185d899a1af1e41554/5acf7425/video/m/220fea4bc73a1c54023a9819c71b52a9b3e115640520000a8c154141acc/?device_platform=android&amp;device_type=myandroid&amp;version_code=179</a><br><img src="/2018/03/25/douyin-streaming-analysis/connection.png" alt="http_connection"></p>
<p>然后可以看到客户端不停地从服务器上下载数据。<br><img src="/2018/03/25/douyin-streaming-analysis/download.png" alt="http_download"></p>
<h1 id="0x3-播放"><a href="#0x3-播放" class="headerlink" title="0x3  播放"></a>0x3  播放</h1><p>下载过程中，启动本地http服务, 播放器通过访问这个http服务来得到播放数据，<br>前面三个包(1130, 1131, 1132)是三次握手的过程。<br>后面的包是发送给播放器的播放数据。<br><img src="/2018/03/25/douyin-streaming-analysis/local_playback.png" alt="http_playback"></p>
<p>下面是douyin app中的lib，从其中可以看到其播放架构是基于ffmpeg实现的。通过分析可知，这里面有好几个库都包括了ffmpeg的代码，感觉模块之间划分不是很清楚，代码有冗余。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">libaudiocore.so             libdaemon.so          libijkffmpeg.so      libst_mobile.so     libttnativecrash.so</div><div class="line">libaudiofp.so               libdys.so             libijkplayer.so      libstatic-webp.so   libttvideouploader.so</div><div class="line">libbdEASRAndroid.v1<span class="number">.5</span><span class="number">.6</span>.so  libeffect.so          libijksdl.so         libsupervisor.so    libuserinfo.so</div><div class="line">libbspatch.so               libffmpeg.so          libimagepipeline.so  libtnet<span class="number">-3.1</span><span class="number">.11</span>.so   libweibosdkcore.so</div><div class="line">libBugly.so                 libffmpeg-invoker.so  liblivestream.so     libtongdun.so       libyuv.so</div><div class="line">libcocklogic<span class="number">-1.1</span><span class="number">.3</span>.so       libffmpeg-main.so     libmain.so           libttEncrypt.so</div><div class="line">libcrashlytics.so           libgif.so             libNailSLAM_jni.so   libttmplayer.so</div><div class="line">libcrashlytics-envelope.so  libgifimage.so        libSDL2.so           libttmplayer_mc.so</div></pre></td></tr></table></figure>
<p>其中libeffect.so实现了对用户拍摄好的视频内容进行编辑，加特效等工作，如下所示，其中包括了CV相关的代码。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="number">00493</span>ecd T cvGetImage</div><div class="line"><span class="number">00494511</span> T cvGetImageCOI</div><div class="line"><span class="number">0049439</span>d T cvGetImageROI</div><div class="line"><span class="number">00491261</span> T cvGetMat</div><div class="line"><span class="number">0048f</span>e41 T cvGetND</div><div class="line"><span class="number">0053</span>d33d T cvGetNumThreads</div><div class="line"><span class="number">004b</span>a981 T cvGetOptimalDFTSize</div><div class="line"><span class="number">0041f</span>609 T cvGetPerspectiveTransform</div><div class="line"><span class="number">0048f</span>4f5 T cvGetRawData</div><div class="line"><span class="number">0048f</span>ea1 T cvGetReal1D</div><div class="line"><span class="number">004900</span>d9 T cvGetReal2D</div><div class="line"><span class="number">00545685</span> T cvGetRootFileNode</div><div class="line"><span class="number">00490321</span> T cvGetReal3D</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/19/analysis-of-ijkplayer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/19/analysis-of-ijkplayer/" itemprop="url">ijkplayer介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-19T22:12:28+09:00">
                2018-03-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/03/19/analysis-of-ijkplayer/" class="leancloud_visitors" data-flag-title="ijkplayer介绍">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-系统架构"><a href="#0x1-系统架构" class="headerlink" title="0x1    系统架构"></a>0x1    系统架构</h1><p>ijkplayer是由b站开源的播放器项目，底层基于ffmpeg, 支持Android和iOS。下面我们来简单介绍一下Android上的实现。<br>Android上的系统架构图如下。<br><img src="/2018/03/19/analysis-of-ijkplayer/architecture.png" alt="architecture"><br>下面分别对各个模块进行介绍。<br>ijkplayer-example是app的实现，主要是ui逻辑的实现，包括activity的实现，ui控件的组织，窗口的定制，数据的存储。<br>ijkplayer-example通过调用ijkmediaplayer，android mediaplayer， google exoplayer这三种mediaplayer来实现媒体播放。<br>ijkplayer-java是对底层实现的ijkmediaplayer和android mediaplayer的java封装，对ijkmediaplayer的封装是通过调用底层jni对应的java接口，对android mediaplayer的封装是调用android系统实现的默认mediaplayer接口。<br>ijkplayer-exo是对google exoplayer的封装，除了android默认的播放器之外，ExoPlayer是Google提供的在android平台上的另外一种播放器。<br>libijkplayer提供了ijkmediaplayer的jni实现ijkplayer_jni.c，然后调用封装过的ffplayer.c, 再调用底层实现的解码库libijkffmpeg和显示库libijksdl。<br>libijkffmpeg实现了媒体文件的demux, decode等功能。<br>libijksdl实现对解码后的数据进行显示。</p>
<h1 id="0x2-Java层关键模块分析"><a href="#0x2-Java层关键模块分析" class="headerlink" title="0x2   Java层关键模块分析"></a>0x2   Java层关键模块分析</h1><h2 id="0x21-三种不同的mediaplayer实现"><a href="#0x21-三种不同的mediaplayer实现" class="headerlink" title="0x21 三种不同的mediaplayer实现."></a>0x21 三种不同的mediaplayer实现.</h2><p>这三种mediaplayer的类图如下图所示。<br><img src="/2018/03/19/analysis-of-ijkplayer/mediaplayer.png" alt="mediaplayers"><br>AndroidMediaPlayer是对Andoid默认播放器的封装。<br>IjkMediaPlayer是基于ffmpeg的播放器实现。<br>IjkExoMediaPlayer是基于Goodle开源的ExoPlayer的封装。</p>
<h2 id="0x22-设置不同的Render"><a href="#0x22-设置不同的Render" class="headerlink" title="0x22    设置不同的Render"></a>0x22    设置不同的Render</h2><p>不同Render的类图如下图所示。<br><img src="/2018/03/19/analysis-of-ijkplayer/render.png" alt="renders"><br>SurfaceRenderView是基于SurfaceView的显示实现。<br>TextureRenderView是基于TextureView的显示实现。<br>上述两种显示实现方式都实现了接口IRenderView。</p>
<h2 id="0x23-IjkMediaPlayer的JNI接口"><a href="#0x23-IjkMediaPlayer的JNI接口" class="headerlink" title="0x23    IjkMediaPlayer的JNI接口"></a>0x23    IjkMediaPlayer的JNI接口</h2><p>详细的JNI接口如下图所示。<br> <img src="/2018/03/19/analysis-of-ijkplayer/jni.png" alt="jni"><br>这些JNI接口提供了播放器的基本接口，包括播放准备(_setDataSource, _setVideoSurface, setVolume，_prepareAsync), 播放控制(_start, _stop, seekTo，_release， _reset)等功能。</p>
<h1 id="0x3-关键流程"><a href="#0x3-关键流程" class="headerlink" title="0x3    关键流程"></a>0x3    关键流程</h1><h2 id="0x31-设置surface"><a href="#0x31-设置surface" class="headerlink" title="0x31    设置surface"></a>0x31    设置surface</h2><p>设置surface的流程图如下图所示。<br><img src="/2018/03/19/analysis-of-ijkplayer/setsurface.png" alt="setsurface"><br>从上面的流程图可知，通过接口_setVideoSurface(), 把UI层的Surface对象(可以理解为显示窗口)设置给SDL显示对象，作为其显示窗口(native_window), 这样SDL有需要显示的内容可以直接在这个显示窗口上显示输出即可。</p>
<h2 id="0x32-显示流程"><a href="#0x32-显示流程" class="headerlink" title="0x32    显示流程"></a>0x32    显示流程</h2><p>显示的流程图如下图所示。<br><img src="/2018/03/19/analysis-of-ijkplayer/display.png" alt="display"><br>下面对上面的流程图简单说明。<br>解码线程ffp_video_thread解码完成以后，调用接口queue_picture把需要显示的buffer往SDL模块发送。<br>然后调用func_fill_frame()填充显示buffer, 这个时候需要判断是通过ffmpeg还是mediacodec实现的解码。<br>如果是ffmpeg实现的话则调用ijksdl_vout_overlay_ffmpeg.c中的函数func_fill_frame()。<br>否则调用ijksdl_vout_overlay_android_mediacodec.c中的func_fill_frame()。<br>然后显示线程video_refresh_thread就可以开始显示了。如果是GPU支持的格式则调用GPU进行输出，这个时候调用的是IJK_EGL_display，否则调用ANativeWindow_lock和ANativeWindow_unlockAndPost进行输出。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/13/how-renderscript-supports-parallel-compution/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/13/how-renderscript-supports-parallel-compution/" itemprop="url">How renderscript supports parallel compution</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-13T20:47:43+09:00">
                2018-03-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/03/13/how-renderscript-supports-parallel-compution/" class="leancloud_visitors" data-flag-title="How renderscript supports parallel compution">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Architecture"><a href="#0x1-Architecture" class="headerlink" title="0x1 Architecture"></a>0x1 Architecture</h1><p>RenderScript is a framework for running computationally intensive tasks at high performance on Android. It is similar to OpenCL which is cross platform spec for parallel computation. RenderScript is primarily oriented for use with data-parallel computation. The RenderScript runtime will parallelize work across all processors available on a device, such as multi-core CPUs, GPUs, or DSPs. RenderScript is especially useful for applications performing image processing, computational photography, or computer vision. <a href="https://developer.android.com/guide/topics/renderscript/compute.html" target="_blank" rel="external">Android’s doc</a></p>
<p>Here is the architecture of RenderScript.<br><img src="/2018/03/13/how-renderscript-supports-parallel-compution/architecture.png" alt="architecture"></p>
<p>RS Wrapper acts as the wrapper layer for RenderScript, provides the RenderScript api mapping and resource management.<br>cpu ref is the software implementation of RenderScript on CPU.<br>gpu rs is the hardware implementation of RenderScript on GPU.<br>slang/llvm provides the front and backend compiler support for RenderScript’s C99-derived language.</p>
<p>In this article, we will discuss how software RenderScript is suported on multi-core CPU.</p>
<h1 id="0x2-Software-Implementation"><a href="#0x2-Software-Implementation" class="headerlink" title="0x2 Software Implementation"></a>0x2 Software Implementation</h1><p><img src="/2018/03/13/how-renderscript-supports-parallel-compution/cpu_rs.png" alt="cpu_rs"></p>
<h2 id="0x21-Create-Threads"><a href="#0x21-Create-Threads" class="headerlink" title="0x21 Create Threads"></a>0x21 Create Threads</h2><p>Create threads for parallel computing based on cpu core’s number<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> RsdCpuReferenceImpl::init(<span class="keyword">uint32_t</span> version_major, <span class="keyword">uint32_t</span> version_minor,</div><div class="line">                               <span class="keyword">sym_lookup_t</span> lfn, <span class="keyword">script_lookup_t</span> slfn) &#123;</div><div class="line">    … …</div><div class="line">    GetCpuInfo();</div><div class="line"></div><div class="line">    <span class="keyword">int</span> cpu = sysconf(_SC_NPROCESSORS_CONF);</div><div class="line">    <span class="keyword">if</span>(mRSC-&gt;props.mDebugMaxThreads) &#123;</div><div class="line">        cpu = mRSC-&gt;props.mDebugMaxThreads;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (cpu &lt; <span class="number">2</span>) &#123;</div><div class="line">        mWorkers.mCount = <span class="number">0</span>;</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Subtract one from the cpu count because we also use the command thread as a worker.</span></div><div class="line">    mWorkers.mCount = (<span class="keyword">uint32_t</span>)(cpu - <span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> ct=<span class="number">0</span>; ct &lt; mWorkers.mCount; ct++) &#123;</div><div class="line">        status = pthread_create(&amp;mWorkers.mThreadId[ct], &amp;threadAttr, helperThreadProc, <span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (status) &#123;</div><div class="line">            mWorkers.mCount = ct;</div><div class="line">            ALOGE(<span class="string">"Created fewer than expected number of RS threads."</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x22-Thread-implementation"><a href="#0x22-Thread-implementation" class="headerlink" title="0x22 Thread implementation"></a>0x22 Thread implementation</h2><p>Here is the thread’s source code.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> * RsdCpuReferenceImpl::helperThreadProc(<span class="keyword">void</span> *vrsc) &#123;</div><div class="line">    RsdCpuReferenceImpl *dc = (RsdCpuReferenceImpl *)vrsc;</div><div class="line"></div><div class="line">    <span class="keyword">uint32_t</span> idx = __sync_fetch_and_add(&amp;dc-&gt;mWorkers.mLaunchCount, <span class="number">1</span>);</div><div class="line"></div><div class="line">    dc-&gt;mWorkers.mLaunchSignals[idx].init();</div><div class="line">    dc-&gt;mWorkers.mNativeThreadId[idx] = gettid();</div><div class="line"></div><div class="line">    <span class="built_in">memset</span>(&amp;dc-&gt;mTlsStruct, <span class="number">0</span>, <span class="keyword">sizeof</span>(dc-&gt;mTlsStruct));</div><div class="line">    <span class="keyword">int</span> status = pthread_setspecific(gThreadTLSKey, &amp;dc-&gt;mTlsStruct);</div><div class="line">    <span class="keyword">if</span> (status) &#123;</div><div class="line">        ALOGE(<span class="string">"pthread_setspecific %i"</span>, status);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span> (!dc-&gt;mExit) &#123;</div><div class="line">        dc-&gt;mWorkers.mLaunchSignals[idx].wait();</div><div class="line">        <span class="keyword">if</span> (dc-&gt;mWorkers.mLaunchCallback) &#123;</div><div class="line">           <span class="comment">// idx +1 is used because the calling thread is always worker 0.</span></div><div class="line">           dc-&gt;mWorkers.mLaunchCallback(dc-&gt;mWorkers.mLaunchData, idx+<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        __sync_fetch_and_sub(&amp;dc-&gt;mWorkers.mRunningCount, <span class="number">1</span>);</div><div class="line">        dc-&gt;mWorkers.mCompleteSignal.<span class="built_in">set</span>();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>dc-&gt;mWorkers.mLaunchSignals[idx].wait() is used to wait for the task to be processed.</p>
<p>dc-&gt;mWorkers.mLaunchCallback will call the actual processing routine.</p>
<p>dc-&gt;mWorkers.mCompleteSignal.set() is used to indicate the processing is complete.</p>
<h2 id="0x23-Launch-Thread"><a href="#0x23-Launch-Thread" class="headerlink" title="0x23 Launch Thread"></a>0x23 Launch Thread</h2><p>dc-&gt;mWorkers.mLaunchSignals[idx].wait() is signed in RsdCpuReferenceImpl::launchThreads().</p>
<p>And in RsdCpuReferenceImpl::launchThreads(), we can see mWorkers.mCompleteSignal.wait() is used to wait for the finish of the executing threads.</p>
<p>And the ‘WorkerCallback_t cbk’ is passed in to do the actual processing.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> RsdCpuReferenceImpl::launchThreads(WorkerCallback_t cbk, <span class="keyword">void</span> *data) &#123;</div><div class="line">    mWorkers.mLaunchData = data;</div><div class="line">    mWorkers.mLaunchCallback = cbk;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> ct = <span class="number">0</span>; ct &lt; mWorkers.mCount; ct++) &#123;</div><div class="line">        mWorkers.mLaunchSignals[ct].<span class="built_in">set</span>();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// We use the calling thread as one of the workers so we can start without</span></div><div class="line">    <span class="comment">// the delay of the thread wakeup.</span></div><div class="line">    <span class="keyword">if</span> (mWorkers.mLaunchCallback) &#123;</div><div class="line">        mWorkers.mLaunchCallback(mWorkers.mLaunchData, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (__sync_fetch_and_or(&amp;mWorkers.mRunningCount, <span class="number">0</span>) != <span class="number">0</span>) &#123;</div><div class="line">        mWorkers.mCompleteSignal.wait();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here is the code about how launchThreads is used.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Line <span class="number">767</span>:             launchThreads(walk_3d_reduce, mtls);</div><div class="line">Line <span class="number">770</span>:             launchThreads(walk_2d_reduce, mtls);</div><div class="line">Line <span class="number">773</span>:             launchThreads(walk_1d_reduce, mtls);</div><div class="line">Line <span class="number">851</span>:             launchThreads(walk_general_foreach, mtls);</div><div class="line">Line <span class="number">873</span>:             launchThreads(walk_2d_foreach, mtls);</div><div class="line">Line <span class="number">895</span>:             launchThreads(walk_1d_foreach, mtls);</div></pre></td></tr></table></figure></p>
<h2 id="0x24-Thread-Execution"><a href="#0x24-Thread-Execution" class="headerlink" title="0x24 Thread Execution"></a>0x24 Thread Execution</h2><p>Each thread setups the task according to the current mSliceNum,<br>Then it setups yStart and yEnd, then executes kernel from yStart to yEnd.<br>The kernel is set in RsdCpuScriptIntrinsic::invokeForEach()<br>or RsdCpuScriptImpl::forEachKernelSetup.</p>
<p>RsdCpuScriptIntrinsic::invokeForEach() is used to setup kernel for Intrinsic.</p>
<p>RsdCpuScriptImpl::forEachKernelSetup() is used to setup user defined kernel in *.rs files.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">walk_2d_foreach</span><span class="params">(<span class="keyword">void</span> *usr, <span class="keyword">uint32_t</span> idx)</span> </span>&#123;</div><div class="line">    MTLaunchStructForEach *mtls = (MTLaunchStructForEach *)usr;</div><div class="line">    RsExpandKernelDriverInfo fep = mtls-&gt;fep;</div><div class="line">    fep.lid = idx;</div><div class="line">    ForEachFunc_t fn = mtls-&gt;kernel;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">uint32_t</span> slice  = (<span class="keyword">uint32_t</span>)__sync_fetch_and_add(&amp;mtls-&gt;mSliceNum, <span class="number">1</span>);</div><div class="line">        <span class="keyword">uint32_t</span> yStart = mtls-&gt;start.y + slice * mtls-&gt;mSliceSize;</div><div class="line">        <span class="keyword">uint32_t</span> yEnd   = yStart + mtls-&gt;mSliceSize;</div><div class="line"></div><div class="line">        yEnd = rsMin(yEnd, mtls-&gt;end.y);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (yEnd &lt;= yStart) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (fep.current.y = yStart; fep.current.y &lt; yEnd; fep.current.y++) &#123;</div><div class="line">            FepPtrSetup(mtls, &amp;fep, mtls-&gt;start.x, fep.current.y);</div><div class="line"></div><div class="line">            fn(&amp;fep, mtls-&gt;start.x, mtls-&gt;end.x, fep.outStride[<span class="number">0</span>]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x25-Kernel-implementation"><a href="#0x25-Kernel-implementation" class="headerlink" title="0x25 Kernel implementation"></a>0x25 Kernel implementation</h2><p>Let’s use IntrinsicBlur as the example, in its kernel function kernelU1(), it will produce output pixel from xstart to xend.<br>the algorithm is based on Gaussian Weights which are initialized in ComputeGaussianWeights().</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> RsdCpuScriptIntrinsicBlur::kernelU1(<span class="keyword">const</span> RsExpandKernelDriverInfo *info,</div><div class="line">                                         <span class="keyword">uint32_t</span> xstart, <span class="keyword">uint32_t</span> xend,</div><div class="line">                                         <span class="keyword">uint32_t</span> outstep) &#123;</div><div class="line">    <span class="keyword">float</span> buf[<span class="number">4</span> * <span class="number">2048</span>];</div><div class="line">    RsdCpuScriptIntrinsicBlur *cp = (RsdCpuScriptIntrinsicBlur *)info-&gt;usr;</div><div class="line">    <span class="keyword">if</span> (!cp-&gt;mAlloc.get()) &#123;</div><div class="line">        ALOGE(<span class="string">"Blur executed without input, skipping"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">const</span> uchar *pin = (<span class="keyword">const</span> uchar *)cp-&gt;mAlloc-&gt;mHal.drvState.lod[<span class="number">0</span>].mallocPtr;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> stride = cp-&gt;mAlloc-&gt;mHal.drvState.lod[<span class="number">0</span>].stride;</div><div class="line"></div><div class="line">    uchar *out = (uchar *)info-&gt;outPtr[<span class="number">0</span>];</div><div class="line">    <span class="keyword">uint32_t</span> x1 = xstart;</div><div class="line">    <span class="keyword">uint32_t</span> x2 = xend;</div><div class="line"></div><div class="line">    <span class="keyword">float</span> *fout = (<span class="keyword">float</span> *)buf;</div><div class="line">    <span class="keyword">int</span> y = info-&gt;current.y;</div><div class="line">    <span class="keyword">if</span> ((y &gt; cp-&gt;mIradius) &amp;&amp; (y &lt; ((<span class="keyword">int</span>)info-&gt;dim.y - cp-&gt;mIradius <span class="number">-1</span>))) &#123;</div><div class="line">        <span class="keyword">const</span> uchar *pi = pin + (y - cp-&gt;mIradius) * stride;</div><div class="line">        OneVFU1(fout, pi, stride, cp-&gt;mFp, cp-&gt;mIradius * <span class="number">2</span> + <span class="number">1</span>, <span class="number">0</span>, info-&gt;dim.x);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        x1 = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>(info-&gt;dim.x &gt; x1) &#123;</div><div class="line">            OneVU1(info, fout, x1, y, pin, stride, cp-&gt;mFp, cp-&gt;mIradius);</div><div class="line">            fout++;</div><div class="line">            x1++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    x1 = xstart;</div><div class="line">    <span class="keyword">while</span> ((x1 &lt; x2) &amp;&amp;</div><div class="line">           ((x1 &lt; (<span class="keyword">uint32_t</span>)cp-&gt;mIradius) || (((<span class="keyword">uintptr_t</span>)out) &amp; <span class="number">0x3</span>))) &#123;</div><div class="line">        OneHU1(info, out, x1, buf, cp-&gt;mFp, cp-&gt;mIradius);</div><div class="line">        out++;</div><div class="line">        x1++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">while</span>(x2 &gt; x1) &#123;</div><div class="line">        OneHU1(info, out, x1, buf, cp-&gt;mFp, cp-&gt;mIradius);</div><div class="line">        out++;</div><div class="line">        x1++;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/25/Analysis-of-SwiftShader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin Wen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/25/Analysis-of-SwiftShader/" itemprop="url">Analysis of SwiftShader</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-25T20:50:24+09:00">
                2018-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/02/25/Analysis-of-SwiftShader/" class="leancloud_visitors" data-flag-title="Analysis of SwiftShader">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="0x1-Architecture"><a href="#0x1-Architecture" class="headerlink" title="0x1 Architecture"></a>0x1 Architecture</h1><p>From the doc of swiftshader in the following link, we can see the architecture introduction of it.<br><a href="https://github.com/google/swiftshader/blob/master/docs/Index.md" target="_blank" rel="external">https://github.com/google/swiftshader/blob/master/docs/Index.md</a><br><img src="/2018/02/25/Analysis-of-SwiftShader/architecture.png" alt="swiftshader1"></p>
<p>The API layer is an implementation of a graphics API, such as OpenGL (ES) or Direct3D, on top of the Renderer interface. It is responsible for managing API-level resources and rendering state, as well as compiling high-level shaders to bytecode form.</p>
<p>The Renderer layer generates specialized processing routines for draw calls and coordinates the execution of rendering tasks. It defines the data structures used and how the processing is performed.</p>
<p>Reactor is an embedded language for C++ to dynamically generate code in a WYSIWYG fashion. It allows to specialize the processing routines for the state and shaders used by each draw call. Its syntax closely resembles C and shading languages, to make the code generation easily readable.</p>
<p>The JIT layer is a run-time compiler, such as LLVM’s JIT, or Subzero. Reactor records its operations in an in-memory intermediate form which can be materialized by the JIT into a function which can be called directly.</p>
<p>To achieve exceptional performance, SwiftShader is built around two major optimizations that affect its architecture: dynamic code generation, and parallel processing. Generating code at run-time allows to eliminate code branches and optimizes register usage, specializing the processing routines for exactly the operations required by each draw call. Parallel processing means both utilizing the CPU’s multiple cores and processing multiple elements accoss the width of the SIMD vector units.</p>
<h1 id="0x2-Graphics-Pipeline"><a href="#0x2-Graphics-Pipeline" class="headerlink" title="0x2 Graphics Pipeline"></a>0x2 Graphics Pipeline</h1><p>Here is the graphics pipeline diagram from the following OpenGL ES spec. SwiftShader supports the pipeline by JIT through LLVM then executes it on CPU.<br><a href="https://www.khronos.org/registry/OpenGL/specs/es/2.0/es_full_spec_2.0.pdf" target="_blank" rel="external">https://www.khronos.org/registry/OpenGL/specs/es/2.0/es_full_spec_2.0.pdf</a></p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/graphic_pipeline.png" alt="swiftshader2"></p>
<h1 id="0x3-JIT-through-LLVM"><a href="#0x3-JIT-through-LLVM" class="headerlink" title="0x3 JIT through LLVM"></a>0x3 JIT through LLVM</h1><h2 id="0x31-GLSL-compiler-frontend"><a href="#0x31-GLSL-compiler-frontend" class="headerlink" title="0x31 GLSL compiler frontend"></a>0x31 GLSL compiler frontend</h2><p>SwiftShader uses glslang as its glsl compiler frontend, it consumes glsl source code, and produces AST, then outputs its IR with recursive traverse method, here is the IR definition.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> Opcode</div><div class="line">&#123;</div><div class="line">	<span class="comment">// Matches order in d3d9types.h</span></div><div class="line">	OPCODE_NOP = <span class="number">0</span>,</div><div class="line">	OPCODE_MOV,</div><div class="line">	OPCODE_ADD,</div><div class="line">	OPCODE_SUB,</div><div class="line">	OPCODE_MAD,</div><div class="line">	OPCODE_MUL,</div><div class="line">	OPCODE_RCPX,</div><div class="line">	OPCODE_RSQX,</div><div class="line">	OPCODE_DP3,</div><div class="line">	OPCODE_DP4,</div><div class="line">	OPCODE_MIN,</div><div class="line">	OPCODE_MAX,</div><div class="line">	OPCODE_SLT,</div><div class="line">	OPCODE_SGE,</div><div class="line">	OPCODE_EXP2X,   <span class="comment">// D3DSIO_EXP</span></div><div class="line">	OPCODE_LOG2X,   <span class="comment">// D3DSIO_LOG</span></div><div class="line">	OPCODE_LIT,</div><div class="line">	OPCODE_ATT,   <span class="comment">// D3DSIO_DST</span></div><div class="line">	OPCODE_LRP,</div><div class="line">	OPCODE_FRC,</div><div class="line">	OPCODE_M4X4,</div><div class="line">	OPCODE_M4X3,</div><div class="line">	OPCODE_M3X4,</div><div class="line">	OPCODE_M3X3,</div><div class="line">	OPCODE_M3X2,</div><div class="line">	OPCODE_CALL,</div><div class="line">	OPCODE_CALLNZ,</div><div class="line">	OPCODE_LOOP,</div><div class="line">	OPCODE_RET,</div><div class="line">	OPCODE_ENDLOOP,</div><div class="line">	OPCODE_LABEL,</div><div class="line">	OPCODE_DCL,</div><div class="line">	OPCODE_POWX,</div><div class="line">	OPCODE_CRS,</div><div class="line">	OPCODE_SGN,</div><div class="line">	OPCODE_ABS,</div><div class="line">	OPCODE_NRM3,   <span class="comment">// D3DSIO_NRM</span></div><div class="line">	OPCODE_SINCOS,</div><div class="line">	OPCODE_REP,</div><div class="line">	OPCODE_ENDREP,</div><div class="line">	OPCODE_IF,</div><div class="line">	OPCODE_IFC,</div><div class="line">	OPCODE_ELSE,</div><div class="line">	OPCODE_ENDIF,</div><div class="line">	OPCODE_BREAK,</div><div class="line">	OPCODE_BREAKC,</div><div class="line">	OPCODE_MOVA,</div><div class="line">	OPCODE_DEFB,</div><div class="line">	OPCODE_DEFI,</div><div class="line"></div><div class="line">	OPCODE_TEXCOORD = <span class="number">64</span>,</div><div class="line">	OPCODE_TEXKILL,</div><div class="line">	OPCODE_TEX,</div><div class="line">	OPCODE_TEXBEM,</div><div class="line">	OPCODE_TEXBEML,</div><div class="line">	OPCODE_TEXREG2AR,</div><div class="line">	OPCODE_TEXREG2GB,</div><div class="line">	OPCODE_TEXM3X2PAD,</div><div class="line">	OPCODE_TEXM3X2TEX,</div><div class="line">	OPCODE_TEXM3X3PAD,</div><div class="line">	OPCODE_TEXM3X3TEX,</div><div class="line">	OPCODE_RESERVED0,</div><div class="line">	OPCODE_TEXM3X3SPEC,</div><div class="line">	OPCODE_TEXM3X3VSPEC,</div><div class="line">	OPCODE_EXPP,</div><div class="line">	OPCODE_LOGP,</div><div class="line">	OPCODE_CND,</div><div class="line">	OPCODE_DEF,</div><div class="line">	OPCODE_TEXREG2RGB,</div><div class="line">	OPCODE_TEXDP3TEX,</div><div class="line">	OPCODE_TEXM3X2DEPTH,</div><div class="line">	OPCODE_TEXDP3,</div><div class="line">	OPCODE_TEXM3X3,</div><div class="line">	OPCODE_TEXDEPTH,</div><div class="line">	OPCODE_CMP0,   <span class="comment">// D3DSIO_CMP</span></div><div class="line">	OPCODE_BEM,</div><div class="line">	OPCODE_DP2ADD,</div><div class="line">	OPCODE_DFDX,   <span class="comment">// D3DSIO_DSX</span></div><div class="line">	OPCODE_DFDY,   <span class="comment">// D3DSIO_DSY</span></div><div class="line">	OPCODE_TEXLDD,</div><div class="line">	OPCODE_CMP,   <span class="comment">// D3DSIO_SETP</span></div><div class="line">	OPCODE_TEXLDL,</div><div class="line">	OPCODE_BREAKP,</div><div class="line"></div><div class="line">	OPCODE_PHASE = <span class="number">0xFFFD</span>,</div><div class="line">	OPCODE_COMMENT = <span class="number">0xFFFE</span>,</div><div class="line">	OPCODE_END = <span class="number">0xFFFF</span>,</div><div class="line"></div><div class="line">	OPCODE_PS_1_0 = <span class="number">0xFFFF0100</span>,</div><div class="line">	OPCODE_PS_1_1 = <span class="number">0xFFFF0101</span>,</div><div class="line">	OPCODE_PS_1_2 = <span class="number">0xFFFF0102</span>,</div><div class="line">	OPCODE_PS_1_3 = <span class="number">0xFFFF0103</span>,</div><div class="line">	OPCODE_PS_1_4 = <span class="number">0xFFFF0104</span>,</div><div class="line">	OPCODE_PS_2_0 = <span class="number">0xFFFF0200</span>,</div><div class="line">	OPCODE_PS_2_x = <span class="number">0xFFFF0201</span>,</div><div class="line">	OPCODE_PS_3_0 = <span class="number">0xFFFF0300</span>,</div><div class="line"></div><div class="line">	OPCODE_VS_1_0 = <span class="number">0xFFFE0100</span>,</div><div class="line">	OPCODE_VS_1_1 = <span class="number">0xFFFE0101</span>,</div><div class="line">	OPCODE_VS_2_0 = <span class="number">0xFFFE0200</span>,</div><div class="line">	OPCODE_VS_2_x = <span class="number">0xFFFE0201</span>,</div><div class="line">	OPCODE_VS_2_sw = <span class="number">0xFFFE02FF</span>,</div><div class="line">	OPCODE_VS_3_0 = <span class="number">0xFFFE0300</span>,</div><div class="line">	OPCODE_VS_3_sw = <span class="number">0xFFFE03FF</span>,</div><div class="line"></div><div class="line">	OPCODE_NULL = <span class="number">0x10000000</span>,   <span class="comment">// Dead instruction, to be eliminated</span></div><div class="line">	OPCODE_WHILE,</div><div class="line">	OPCODE_ENDWHILE,</div><div class="line">	OPCODE_COS,</div><div class="line">	OPCODE_SIN,</div><div class="line">	OPCODE_TAN,</div><div class="line">	OPCODE_ACOS,</div><div class="line">	OPCODE_ASIN,</div><div class="line">	OPCODE_ATAN,</div><div class="line">	OPCODE_ATAN2,</div><div class="line">	OPCODE_COSH,</div><div class="line">	OPCODE_SINH,</div><div class="line">	OPCODE_TANH,</div><div class="line">	OPCODE_ACOSH,</div><div class="line">	OPCODE_ASINH,</div><div class="line">	OPCODE_ATANH,</div><div class="line">	OPCODE_DP1,</div><div class="line">	OPCODE_DP2,</div><div class="line">	OPCODE_TRUNC,</div><div class="line">	OPCODE_FLOOR,</div><div class="line">	OPCODE_ROUND,</div><div class="line">	OPCODE_ROUNDEVEN,</div><div class="line">	OPCODE_CEIL,</div><div class="line">	OPCODE_SQRT,</div><div class="line">	OPCODE_RSQ,</div><div class="line">	OPCODE_LEN2,</div><div class="line">	OPCODE_LEN3,</div><div class="line">	OPCODE_LEN4,</div><div class="line">	OPCODE_DIST1,</div><div class="line">	OPCODE_DIST2,</div><div class="line">	OPCODE_DIST3,</div><div class="line">	OPCODE_DIST4,</div><div class="line">	OPCODE_NRM2,</div><div class="line">	OPCODE_NRM4,</div><div class="line">	OPCODE_DIV,</div><div class="line">	OPCODE_MOD,</div><div class="line">	OPCODE_EXP2,</div><div class="line">	OPCODE_LOG2,</div><div class="line">	OPCODE_EXP,</div><div class="line">	OPCODE_LOG,</div><div class="line">	OPCODE_POW,</div><div class="line">	OPCODE_F2B,   <span class="comment">// Float to bool</span></div><div class="line">	OPCODE_B2F,   <span class="comment">// Bool to float</span></div><div class="line">	OPCODE_F2I,   <span class="comment">// Float to int</span></div><div class="line">	OPCODE_I2F,   <span class="comment">// Int to float</span></div><div class="line">	OPCODE_F2U,   <span class="comment">// Float to uint</span></div><div class="line">	OPCODE_U2F,   <span class="comment">// Uint to float</span></div><div class="line">	OPCODE_I2B,   <span class="comment">// Int to bool</span></div><div class="line">	OPCODE_B2I,   <span class="comment">// Bool to int</span></div><div class="line">	OPCODE_DET2,</div><div class="line">	OPCODE_DET3,</div><div class="line">	OPCODE_DET4,</div><div class="line">	OPCODE_ALL,</div><div class="line">	OPCODE_ANY,</div><div class="line">	OPCODE_NEG,</div><div class="line">	OPCODE_NOT,</div><div class="line">	OPCODE_OR,</div><div class="line">	OPCODE_XOR,</div><div class="line">	OPCODE_AND,</div><div class="line">	OPCODE_EQ,</div><div class="line">	OPCODE_NE,</div><div class="line">	OPCODE_STEP,</div><div class="line">	OPCODE_SMOOTH,</div><div class="line">	OPCODE_ISNAN,</div><div class="line">	OPCODE_ISINF,</div><div class="line">	OPCODE_TEXOFFSET,</div><div class="line">	OPCODE_TEXLODOFFSET,</div><div class="line">	OPCODE_TEXELFETCH,</div><div class="line">	OPCODE_TEXELFETCHOFFSET,</div><div class="line">	OPCODE_TEXGRAD,</div><div class="line">	OPCODE_TEXGRADOFFSET,</div><div class="line">	OPCODE_TEXBIAS,</div><div class="line">	OPCODE_TEXLOD,</div><div class="line">	OPCODE_TEXOFFSETBIAS,</div><div class="line">	OPCODE_TEXRECT,</div><div class="line">	OPCODE_TEXSIZE,</div><div class="line">	OPCODE_FLOATBITSTOINT,</div><div class="line">	OPCODE_FLOATBITSTOUINT,</div><div class="line">	OPCODE_INTBITSTOFLOAT,</div><div class="line">	OPCODE_UINTBITSTOFLOAT,</div><div class="line">	OPCODE_PACKSNORM2x16,</div><div class="line">	OPCODE_PACKUNORM2x16,</div><div class="line">	OPCODE_PACKHALF2x16,</div><div class="line">	OPCODE_UNPACKSNORM2x16,</div><div class="line">	OPCODE_UNPACKUNORM2x16,</div><div class="line">	OPCODE_UNPACKHALF2x16,</div><div class="line">	OPCODE_FORWARD1,</div><div class="line">	OPCODE_FORWARD2,</div><div class="line">	OPCODE_FORWARD3,</div><div class="line">	OPCODE_FORWARD4,</div><div class="line">	OPCODE_REFLECT1,</div><div class="line">	OPCODE_REFLECT2,</div><div class="line">	OPCODE_REFLECT3,</div><div class="line">	OPCODE_REFLECT4,</div><div class="line">	OPCODE_REFRACT1,</div><div class="line">	OPCODE_REFRACT2,</div><div class="line">	OPCODE_REFRACT3,</div><div class="line">	OPCODE_REFRACT4,</div><div class="line">	OPCODE_ICMP,</div><div class="line">	OPCODE_UCMP,</div><div class="line">	OPCODE_SELECT,</div><div class="line">	OPCODE_EXTRACT,</div><div class="line">	OPCODE_INSERT,</div><div class="line">	OPCODE_DISCARD,</div><div class="line">	OPCODE_FWIDTH,</div><div class="line">	OPCODE_LEAVE,   <span class="comment">// Return before the end of the function</span></div><div class="line">	OPCODE_CONTINUE,</div><div class="line">	OPCODE_TEST,   <span class="comment">// Marks the end of the code that can be skipped by 'continue'</span></div><div class="line">	OPCODE_SWITCH,</div><div class="line">	OPCODE_ENDSWITCH,</div><div class="line"></div><div class="line">	<span class="comment">// Integer opcodes</span></div><div class="line">	OPCODE_INEG,</div><div class="line">	OPCODE_IABS,</div><div class="line">	OPCODE_ISGN,</div><div class="line">	OPCODE_IADD,</div><div class="line">	OPCODE_ISUB,</div><div class="line">	OPCODE_IMUL,</div><div class="line">	OPCODE_IDIV,</div><div class="line">	OPCODE_IMAD,</div><div class="line">	OPCODE_IMOD,</div><div class="line">	OPCODE_SHL,</div><div class="line">	OPCODE_ISHR,</div><div class="line">	OPCODE_IMIN,</div><div class="line">	OPCODE_IMAX,</div><div class="line"></div><div class="line">	<span class="comment">// Unsigned integer opcodes</span></div><div class="line">	OPCODE_UDIV,</div><div class="line">	OPCODE_UMOD,</div><div class="line">	OPCODE_USHR,</div><div class="line">	OPCODE_UMIN,</div><div class="line">	OPCODE_UMAX,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>Here is the callstack about how IR is generated, it is done by traversing the AST.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/generate_ir.png" alt="swiftshader3"></p>
<p>Once IR is ready, swiftshader will consume those IR and generate LLVM IR, some fixed pipeline and graphic state will also be programmed into LLVM IR at the same time.</p>
<p>We will discuss the three processors, vertex processor, setup processor and pixel processor, all the three processor will generate LLVM IR accoring to graphic state.</p>
<h2 id="0x31-Vertex-processor"><a href="#0x31-Vertex-processor" class="headerlink" title="0x31 Vertex processor"></a>0x31 Vertex processor</h2><p>Here is diagram about how vertex processor produces LLVM IR.<br><img src="/2018/02/25/Analysis-of-SwiftShader/vertex_processor.png" alt="swiftshader4"></p>
<h3 id="Prepare-the-draw-state"><a href="#Prepare-the-draw-state" class="headerlink" title="Prepare the draw state"></a>Prepare the draw state</h3><p>It prepare thes draw state by updating the structe State according to the graphic state.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> VertexProcessor::State VertexProcessor::update(DrawType drawType)</div><div class="line">&#123;</div><div class="line">		<span class="keyword">if</span>(isFixedFunction())</div><div class="line">		&#123;</div><div class="line">			updateTransform();</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(updateLighting)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</div><div class="line">				&#123;</div><div class="line">					<span class="keyword">if</span>(context-&gt;vertexLightActive(i))</div><div class="line">					&#123;</div><div class="line">						<span class="comment">// Light position in camera coordinates</span></div><div class="line">						setLightViewPosition(i, B * V * context-&gt;getLightPosition(i));</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				updateLighting = <span class="literal">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		State state;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(context-&gt;vertexShader)</div><div class="line">		&#123;</div><div class="line">			state.shaderID = context-&gt;vertexShader-&gt;getSerialID();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			state.shaderID = <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		state.fixedFunction = !context-&gt;vertexShader &amp;&amp; context-&gt;pixelShaderModel() &lt; <span class="number">0x0300</span>;</div><div class="line">		state.textureSampling = context-&gt;vertexShader ? context-&gt;vertexShader-&gt;containsTextureSampling() : <span class="literal">false</span>;</div><div class="line">		state.positionRegister = context-&gt;vertexShader ? context-&gt;vertexShader-&gt;getPositionRegister() : Pos;</div><div class="line">		state.pointSizeRegister = context-&gt;vertexShader ? context-&gt;vertexShader-&gt;getPointSizeRegister() : Pts;</div><div class="line"></div><div class="line">		state.vertexBlendMatrixCount = context-&gt;vertexBlendMatrixCountActive();</div><div class="line">		state.indexedVertexBlendEnable = context-&gt;indexedVertexBlendActive();</div><div class="line">		state.vertexNormalActive = context-&gt;vertexNormalActive();</div><div class="line">		state.normalizeNormals = context-&gt;normalizeNormalsActive();</div><div class="line">		state.vertexLightingActive = context-&gt;vertexLightingActive();</div><div class="line">		state.diffuseActive = context-&gt;diffuseActive();</div><div class="line">		state.specularActive = context-&gt;specularActive();</div><div class="line">		state.vertexSpecularActive = context-&gt;vertexSpecularActive();</div><div class="line"></div><div class="line">		state.vertexLightActive = context-&gt;vertexLightActive(<span class="number">0</span>) &lt;&lt; <span class="number">0</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">1</span>) &lt;&lt; <span class="number">1</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">2</span>) &lt;&lt; <span class="number">2</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">3</span>) &lt;&lt; <span class="number">3</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">4</span>) &lt;&lt; <span class="number">4</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">5</span>) &lt;&lt; <span class="number">5</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">6</span>) &lt;&lt; <span class="number">6</span> |</div><div class="line">		                          context-&gt;vertexLightActive(<span class="number">7</span>) &lt;&lt; <span class="number">7</span>;</div><div class="line"></div><div class="line">		state.vertexDiffuseMaterialSourceActive = context-&gt;vertexDiffuseMaterialSourceActive();</div><div class="line">		state.vertexSpecularMaterialSourceActive = context-&gt;vertexSpecularMaterialSourceActive();</div><div class="line">		state.vertexAmbientMaterialSourceActive = context-&gt;vertexAmbientMaterialSourceActive();</div><div class="line">		state.vertexEmissiveMaterialSourceActive = context-&gt;vertexEmissiveMaterialSourceActive();</div><div class="line">		state.fogActive = context-&gt;fogActive();</div><div class="line">		state.vertexFogMode = context-&gt;vertexFogModeActive();</div><div class="line">		state.rangeFogActive = context-&gt;rangeFogActive();</div><div class="line">		state.localViewerActive = context-&gt;localViewerActive();</div><div class="line">		state.pointSizeActive = context-&gt;pointSizeActive();</div><div class="line">		state.pointScaleActive = context-&gt;pointScaleActive();</div><div class="line"></div><div class="line">		state.preTransformed = context-&gt;preTransformed;</div><div class="line">		state.superSampling = context-&gt;getSuperSampleCount() &gt; <span class="number">1</span>;</div><div class="line">		state.multiSampling = context-&gt;getMultiSampleCount() &gt; <span class="number">1</span>;</div><div class="line"></div><div class="line">		state.transformFeedbackQueryEnabled = context-&gt;transformFeedbackQueryEnabled;</div><div class="line">		state.transformFeedbackEnabled = context-&gt;transformFeedbackEnabled;</div><div class="line"></div><div class="line">		<span class="comment">// Note: Quads aren't handled for verticesPerPrimitive, but verticesPerPrimitive is used for transform feedback,</span></div><div class="line">		<span class="comment">//       which is an OpenGL ES 3.0 feature, and OpenGL ES 3.0 doesn't support quads as a primitive type.</span></div><div class="line">		DrawType type = <span class="keyword">static_cast</span>&lt;DrawType&gt;(<span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(drawType) &amp; <span class="number">0xF</span>);</div><div class="line">		state.verticesPerPrimitive = <span class="number">1</span> + (type &gt;= DRAW_LINELIST) + (type &gt;= DRAW_TRIANGLELIST);</div><div class="line"></div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_VERTEX_INPUTS; i++)</div><div class="line">		&#123;</div><div class="line">			state.input[i].type = context-&gt;input[i].type;</div><div class="line">			state.input[i].count = context-&gt;input[i].count;</div><div class="line">			state.input[i].normalized = context-&gt;input[i].normalized;</div><div class="line">			state.input[i].attribType = context-&gt;vertexShader ? context-&gt;vertexShader-&gt;getAttribType(i) : VertexShader::ATTRIBTYPE_FLOAT;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(!context-&gt;vertexShader)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</div><div class="line">			&#123;</div><div class="line">			<span class="comment">//	state.textureState[i].vertexTextureActive = context-&gt;vertexTextureActive(i, 0);</span></div><div class="line">				state.textureState[i].texGenActive = context-&gt;texGenActive(i);</div><div class="line">				state.textureState[i].textureTransformCountActive = context-&gt;textureTransformCountActive(i);</div><div class="line">				state.textureState[i].texCoordIndexActive = context-&gt;texCoordIndexActive(i);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; VERTEX_TEXTURE_IMAGE_UNITS; i++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span>(context-&gt;vertexShader-&gt;usesSampler(i))</div><div class="line">				&#123;</div><div class="line">					state.sampler[i] = context-&gt;sampler[TEXTURE_IMAGE_UNITS + i].samplerState();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(context-&gt;vertexShader)   <span class="comment">// <span class="doctag">FIXME:</span> Also when pre-transformed?</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_VERTEX_OUTPUTS; i++)</div><div class="line">			&#123;</div><div class="line">				state.output[i].xWrite = context-&gt;vertexShader-&gt;getOutput(i, <span class="number">0</span>).active();</div><div class="line">				state.output[i].yWrite = context-&gt;vertexShader-&gt;getOutput(i, <span class="number">1</span>).active();</div><div class="line">				state.output[i].zWrite = context-&gt;vertexShader-&gt;getOutput(i, <span class="number">2</span>).active();</div><div class="line">				state.output[i].wWrite = context-&gt;vertexShader-&gt;getOutput(i, <span class="number">3</span>).active();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(!context-&gt;preTransformed || context-&gt;pixelShaderModel() &lt; <span class="number">0x0300</span>)</div><div class="line">		&#123;</div><div class="line">			state.output[Pos].write = <span class="number">0xF</span>;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;diffuseActive() &amp;&amp; (context-&gt;lightingEnable || context-&gt;input[Color0]))</div><div class="line">			&#123;</div><div class="line">				state.output[C0].write = <span class="number">0xF</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;specularActive())</div><div class="line">			&#123;</div><div class="line">				state.output[C1].write = <span class="number">0xF</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> stage = <span class="number">0</span>; stage &lt; <span class="number">8</span>; stage++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span>(context-&gt;texCoordActive(stage, <span class="number">0</span>)) state.output[T0 + stage].write |= <span class="number">0x01</span>;</div><div class="line">				<span class="keyword">if</span>(context-&gt;texCoordActive(stage, <span class="number">1</span>)) state.output[T0 + stage].write |= <span class="number">0x02</span>;</div><div class="line">				<span class="keyword">if</span>(context-&gt;texCoordActive(stage, <span class="number">2</span>)) state.output[T0 + stage].write |= <span class="number">0x04</span>;</div><div class="line">				<span class="keyword">if</span>(context-&gt;texCoordActive(stage, <span class="number">3</span>)) state.output[T0 + stage].write |= <span class="number">0x08</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;fogActive())</div><div class="line">			&#123;</div><div class="line">				state.output[Fog].xWrite = <span class="literal">true</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;pointSizeActive())</div><div class="line">			&#123;</div><div class="line">				state.output[Pts].yWrite = <span class="literal">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			state.output[Pos].write = <span class="number">0xF</span>;</div><div class="line"></div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span>(context-&gt;input[Color0 + i])</div><div class="line">				&#123;</div><div class="line">					state.output[C0 + i].write = <span class="number">0xF</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span>(context-&gt;input[TexCoord0 + i])</div><div class="line">				&#123;</div><div class="line">					state.output[T0 + i].write = <span class="number">0xF</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(context-&gt;input[PointSize])</div><div class="line">			&#123;</div><div class="line">				state.output[Pts].yWrite = <span class="literal">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(context-&gt;vertexShaderModel() &lt; <span class="number">0x0300</span>)</div><div class="line">		&#123;</div><div class="line">			state.output[C0].clamp = <span class="number">0xF</span>;</div><div class="line">			state.output[C1].clamp = <span class="number">0xF</span>;</div><div class="line">			state.output[Fog].xClamp = <span class="literal">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		state.hash = state.computeHash();</div><div class="line"></div><div class="line">		<span class="keyword">return</span> state;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Generate-LLVM-IR"><a href="#Generate-LLVM-IR" class="headerlink" title="Generate LLVM IR"></a>Generate LLVM IR</h3><p>Then it generates the LLVM IR with reactor method based on the state which is updated in the previous step.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> VertexRoutine::generate()</div><div class="line">&#123;</div><div class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> textureSampling = state.textureSampling;</div><div class="line"></div><div class="line">		Pointer&lt;Byte&gt; cache = task + OFFSET(VertexTask,vertexCache);</div><div class="line">		Pointer&lt;Byte&gt; vertexCache = cache + OFFSET(VertexCache,vertex);</div><div class="line">		Pointer&lt;Byte&gt; tagCache = cache + OFFSET(VertexCache,tag);</div><div class="line"></div><div class="line">		UInt vertexCount = *Pointer&lt;UInt&gt;(task + OFFSET(VertexTask,vertexCount));</div><div class="line">		UInt primitiveNumber = *Pointer&lt;UInt&gt;(task + OFFSET(VertexTask, primitiveStart));</div><div class="line">		UInt indexInPrimitive = <span class="number">0</span>;</div><div class="line"></div><div class="line">		constants = *Pointer&lt;Pointer&lt;Byte&gt;&gt;(data + OFFSET(DrawData,constants));</div><div class="line"></div><div class="line">		Do</div><div class="line">		&#123;</div><div class="line">			UInt index = *Pointer&lt;UInt&gt;(batch);</div><div class="line">			UInt tagIndex = index &amp; <span class="number">0x0000003C</span>;</div><div class="line">			UInt indexQ = !textureSampling ? UInt(index &amp; <span class="number">0xFFFFFFFC</span>) : index;   <span class="comment">// <span class="doctag">FIXME:</span> TEXLDL hack to have independent LODs, hurts performance.</span></div><div class="line"></div><div class="line">			If(*Pointer&lt;UInt&gt;(tagCache + tagIndex) != indexQ)</div><div class="line">			&#123;</div><div class="line">				*Pointer&lt;UInt&gt;(tagCache + tagIndex) = indexQ;</div><div class="line"></div><div class="line">				readInput(indexQ);</div><div class="line">				pipeline(indexQ);</div><div class="line">				postTransform();</div><div class="line">				computeClipFlags();</div><div class="line"></div><div class="line">				Pointer&lt;Byte&gt; cacheLine0 = vertexCache + tagIndex * UInt((<span class="keyword">int</span>)<span class="keyword">sizeof</span>(Vertex));</div><div class="line">				writeCache(cacheLine0);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			UInt cacheIndex = index &amp; <span class="number">0x0000003F</span>;</div><div class="line">			Pointer&lt;Byte&gt; cacheLine = vertexCache + cacheIndex * UInt((<span class="keyword">int</span>)<span class="keyword">sizeof</span>(Vertex));</div><div class="line">			writeVertex(vertex, cacheLine);</div><div class="line"></div><div class="line">			<span class="keyword">if</span>(state.transformFeedbackEnabled != <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				transformFeedback(vertex, primitiveNumber, indexInPrimitive);</div><div class="line"></div><div class="line">				indexInPrimitive++;</div><div class="line">				If(indexInPrimitive == <span class="number">3</span>)</div><div class="line">				&#123;</div><div class="line">					primitiveNumber++;</div><div class="line">					indexInPrimitive = <span class="number">0</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			vertex += <span class="keyword">sizeof</span>(Vertex);</div><div class="line">			batch += <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span>);</div><div class="line">			vertexCount--;</div><div class="line">		&#125;</div><div class="line">		Until(vertexCount == <span class="number">0</span>)</div><div class="line"></div><div class="line">		Return();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="0x32-Setup-processor"><a href="#0x32-Setup-processor" class="headerlink" title="0x32 Setup processor"></a>0x32 Setup processor</h2><p>The LLVM IR generation process of setup processor is similar to Vertex processor’s.</p>
<h2 id="0x33-Pixel-processor"><a href="#0x33-Pixel-processor" class="headerlink" title="0x33 Pixel processor"></a>0x33 Pixel processor</h2><p>The LLVM IR generation process of pixel processor is similar to Vertex processor’s.</p>
<h1 id="0x4-Multithread"><a href="#0x4-Multithread" class="headerlink" title="0x4 Multithread"></a>0x4 Multithread</h1><p>Here is the timeline diagram about how multithread is supported in swiftshader.<br>It split the draw task into several batches, each batch is executed in one thread.vertex processor and setup processor is executed together, pixel processor is executed after that.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/multithread.png" alt="swiftshader6"></p>
<h2 id="0x41-Task-producer"><a href="#0x41-Task-producer" class="headerlink" title="0x41 Task producer."></a>0x41 Task producer.</h2><p>Task producer produces the task in the main thread, then push the task in the queue and waits for the consumer to get those task for cosuming.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/task_producer.png" alt="swiftshader7"></p>
<h2 id="0x42-Task-consumer"><a href="#0x42-Task-consumer" class="headerlink" title="0x42 Task consumer."></a>0x42 Task consumer.</h2><p>Task consumer finds the task in the queue, then exeucute the task in the specific thread.<br>Here is the diagram about how vertex processor and setup processor is executed in one thread.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/task_consumer.png" alt="swiftshader8"></p>
<p>Here is the diagram about how pixel processor is executed in one thread.</p>
<p><img src="/2018/02/25/Analysis-of-SwiftShader/task_consumer_pixel.png" alt="swiftshader9"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Kevin Wen" />
          <p class="site-author-name" itemprop="name">Kevin Wen</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kevin Wen</span>
</div>


<div> <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
访问量 <span id="busuanzi_value_site_pv"></span>
访问人数 <span id="busuanzi_value_site_uv"></span>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("orq8xxsDQDXKiHdqSRcjlflB-gzGzoHsz", "ecCFdIcWDfbJKQOCiLFf1EBm");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
