<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="883px" preserveAspectRatio="none" style="width:666px;height:883px;" version="1.1" viewBox="0 0 666 883" width="666px" zoomAndPan="magnify"><defs><filter height="300%" id="f24xge3utsnfy" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="26" x2="26" y1="43.1201" y2="837.7695"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="140.5" x2="140.5" y1="43.1201" y2="837.7695"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="261.5" x2="261.5" y1="43.1201" y2="837.7695"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="382.5" x2="382.5" y1="43.1201" y2="837.7695"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="494" x2="494" y1="43.1201" y2="837.7695"/><rect fill="#FEFECE" filter="url(#f24xge3utsnfy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="38" x="5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="24" x="12" y="28.0439">app</text><rect fill="#FEFECE" filter="url(#f24xge3utsnfy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="38" x="5" y="836.7695"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="24" x="12" y="859.8135">app</text><rect fill="#FEFECE" filter="url(#f24xge3utsnfy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="101.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="108.5" y="28.0439">libEGL.so</text><rect fill="#FEFECE" filter="url(#f24xge3utsnfy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="101.5" y="836.7695"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="108.5" y="859.8135">libEGL.so</text><rect fill="#FEFECE" filter="url(#f24xge3utsnfy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="222.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="229.5" y="28.0439">iris_dri.so</text><rect fill="#FEFECE" filter="url(#f24xge3utsnfy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="75" x="222.5" y="836.7695"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="229.5" y="859.8135">iris_dri.so</text><rect fill="#FEFECE" filter="url(#f24xge3utsnfy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="95" x="333.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="81" x="340.5" y="28.0439">iris_bufmgr.c</text><rect fill="#FEFECE" filter="url(#f24xge3utsnfy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="95" x="333.5" y="836.7695"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="81" x="340.5" y="859.8135">iris_bufmgr.c</text><rect fill="#FEFECE" filter="url(#f24xge3utsnfy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="78" x="453" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="460" y="28.0439">drm driver</text><rect fill="#FEFECE" filter="url(#f24xge3utsnfy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="78" x="453" y="836.7695"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="460" y="859.8135">drm driver</text><polygon fill="#A80036" points="129,72.8745,139,76.8745,129,80.8745,133,76.8745" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="26" x2="135" y1="76.8745" y2="76.8745"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="33" y="72.0181">eglMakeCurrent</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="141" x2="183" y1="108.6289" y2="108.6289"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="183" x2="183" y1="108.6289" y2="121.6289"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="142" x2="183" y1="121.6289" y2="121.6289"/><polygon fill="#A80036" points="152,117.6289,142,121.6289,152,125.6289,148,121.6289" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="148" y="103.7725">dri2_make_current</text><polygon fill="#A80036" points="250,149.3833,260,153.3833,250,157.3833,254,153.3833" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="141" x2="256" y1="153.3833" y2="153.3833"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="148" y="148.5269">driBindContext</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="262" x2="304" y1="185.1377" y2="185.1377"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="304" x2="304" y1="185.1377" y2="198.1377"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="263" x2="304" y1="198.1377" y2="198.1377"/><polygon fill="#A80036" points="273,194.1377,263,198.1377,273,202.1377,269,198.1377" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="269" y="180.2813">dri_make_current</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="262" x2="304" y1="450.322" y2="450.322"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="304" x2="304" y1="450.322" y2="463.322"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="263" x2="304" y1="463.322" y2="463.322"/><polygon fill="#A80036" points="273,459.322,263,463.322,273,467.322,269,463.322" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="269" y="445.4656">dri3_get_buffer</text><path d="M365,211.1377 L365,682.1377 L657,682.1377 L657,221.1377 L647,211.1377 L365,211.1377 " fill="#ADD8E6" filter="url(#f24xge3utsnfy)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M647,211.1377 L647,221.1377 L657,221.1377 L647,211.1377 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="371" y="231.0356">int buf_id;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="375" y="248.79"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="371" y="266.5444">if (buffer_type == loader_dri3_buffer_back) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="383" y="284.2988">draw-&gt;back_format = format;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="375" y="302.0532"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="383" y="319.8076">buf_id = dri3_find_back(draw);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="375" y="337.562"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="383" y="355.3164">if (buf_id &lt; 0)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="395" y="373.0708">return NULL;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="371" y="390.8252">} else {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="383" y="408.5796">buf_id = LOADER_DRI3_FRONT_ID;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="371" y="426.334">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="375" y="444.0884"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="371" y="461.8428">buffer = draw-&gt;buffers[buf_id];</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="375" y="479.5972"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="371" y="497.3516">if (!buffer || buffer-&gt;width != draw-&gt;width ||</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="387" y="515.106">buffer-&gt;height != draw-&gt;height ||</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="387" y="532.8604">buffer-&gt;reallocate) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="383" y="550.6147">struct loader_dri3_buffer *new_buffer;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="375" y="568.3691"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="383" y="586.1235">new_buffer = dri3_alloc_render_buffer(draw,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="563" y="603.8779">format,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="563" y="621.6323">draw-&gt;width,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="563" y="639.3867">draw-&gt;height,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="563" y="657.1411">draw-&gt;depth);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="387" y="674.8955">}</text><polygon fill="#A80036" points="371,711.5063,381,715.5063,371,719.5063,375,715.5063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="262" x2="377" y1="715.5063" y2="715.5063"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="269" y="710.6499">bo_alloc_internal</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="425" y1="747.2607" y2="747.2607"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="425" y1="747.2607" y2="760.2607"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="384" x2="425" y1="760.2607" y2="760.2607"/><polygon fill="#A80036" points="394,756.2607,384,760.2607,394,764.2607,390,760.2607" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="390" y="742.4043">bo_alloc_internal</text><polygon fill="#A80036" points="482,801.8923,492,805.8923,482,809.8923,486,805.8923" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="488" y1="805.8923" y2="805.8923"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="390" y="801.0359">gen_ioctl</text><path d="M97,773.2607 L97,818.2607 L374,818.2607 L374,783.2607 L364,773.2607 L97,773.2607 " fill="#ADD8E6" filter="url(#f24xge3utsnfy)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M364,773.2607 L364,783.2607 L374,783.2607 L364,773.2607 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="103" y="793.1587">gen_ioctl(bufmgr-&gt;fd,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="103" y="810.9131">DRM_IOCTL_I915_GEM_CREATE, &amp;create)</text><!--MD5=[a23681992a2c6206e5ad1531a49077f7]
@startuml  eglMakeCurrent
app -> libEGL.so : eglMakeCurrent
libEGL.so -> libEGL.so : dri2_make_current
libEGL.so -> iris_dri.so : driBindContext
iris_dri.so -> iris_dri.so: dri_make_current
iris_dri.so -> iris_dri.so: dri3_get_buffer
note right #LightBlue
   int buf_id;

   if (buffer_type == loader_dri3_buffer_back) {
      draw->back_format = format;

      buf_id = dri3_find_back(draw);

      if (buf_id < 0)
         return NULL;
   } else {
      buf_id = LOADER_DRI3_FRONT_ID;
   }

   buffer = draw->buffers[buf_id];

   if (!buffer || buffer->width != draw->width ||
       buffer->height != draw->height ||
       buffer->reallocate) {
      struct loader_dri3_buffer *new_buffer;

      new_buffer = dri3_alloc_render_buffer(draw,
                                                   format,
                                                   draw->width,
                                                   draw->height,
                                                   draw->depth);
       }
end note

iris_dri.so -> iris_bufmgr.c: bo_alloc_internal

iris_bufmgr.c -> iris_bufmgr.c: bo_alloc_internal

iris_bufmgr.c -> "drm driver": gen_ioctl
note left #LightBlue
gen_ioctl(bufmgr->fd, 
DRM_IOCTL_I915_GEM_CREATE, &create)
end note

@enduml

PlantUML version 1.2020.18(Thu Oct 01 03:40:44 GMT+08:00 2020)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: GBK
Language: zh
Country: CN
--></g></svg>